2018-06-20 10:28:07,429: Tracking: tracking
2018-06-20 10:28:07,432: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087d2438>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087d20f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087d2da0>]}
2018-06-20 10:28:09,693: Loading dependency project from /usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/include
2018-06-20 10:28:09,735: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/agency-data-pipeline/dbt_modules
2018-06-20 10:28:09,739: Parsing get_column_values.sql
2018-06-20 10:28:09,768: Parsing core.sql
2018-06-20 10:28:09,797: Parsing adapters/bigquery.sql
2018-06-20 10:28:09,813: Parsing adapters/common.sql
2018-06-20 10:28:09,863: Parsing adapters/redshift.sql
2018-06-20 10:28:09,918: Parsing adapters/snowflake.sql
2018-06-20 10:28:09,927: Parsing etc/bigquery.sql
2018-06-20 10:28:09,937: Parsing etc/datetime.sql
2018-06-20 10:28:10,009: Parsing etc/get_custom_schema.sql
2018-06-20 10:28:10,018: Parsing materializations/helpers.sql
2018-06-20 10:28:10,046: Parsing materializations/archive/archive.sql
2018-06-20 10:28:10,115: Parsing materializations/incremental/incremental.sql
2018-06-20 10:28:10,164: Parsing materializations/seed/bigquery.sql
2018-06-20 10:28:10,177: Parsing materializations/seed/seed.sql
2018-06-20 10:28:10,267: Parsing materializations/table/bigquery_table.sql
2018-06-20 10:28:10,313: Parsing materializations/table/table.sql
2018-06-20 10:28:10,363: Parsing materializations/view/bigquery_view.sql
2018-06-20 10:28:10,397: Parsing materializations/view/view.sql
2018-06-20 10:28:10,429: Parsing schema_tests/accepted_values.sql
2018-06-20 10:28:10,434: Parsing schema_tests/not_null.sql
2018-06-20 10:28:10,446: Parsing schema_tests/relationships.sql
2018-06-20 10:28:10,460: Parsing schema_tests/unique.sql
2018-06-20 10:28:10,634: Parsing model.agency_data_pipeline.accounts_proc
2018-06-20 10:28:10,647: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-06-20 10:28:10,657: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-06-20 10:28:10,663: Parsing model.agency_data_pipeline.adwords_campaigns
2018-06-20 10:28:10,667: Parsing model.agency_data_pipeline.adwords_join
2018-06-20 10:28:10,680: Parsing model.agency_data_pipeline.adwords_stats
2018-06-20 10:28:10,688: Parsing model.agency_data_pipeline.adwords_urls
2018-06-20 10:28:10,698: Parsing model.agency_data_pipeline.fb_adcreative
2018-06-20 10:28:10,718: Parsing model.agency_data_pipeline.fb_ads
2018-06-20 10:28:10,783: Parsing model.agency_data_pipeline.fb_ads_insights
2018-06-20 10:28:10,853: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-20 10:28:10,892: Parsing model.agency_data_pipeline.fb_ads_stats
2018-06-20 10:28:10,904: Parsing model.agency_data_pipeline.fb_conversions
2018-06-20 10:28:10,913: Parsing model.agency_data_pipeline.ga_conversions
2018-06-20 10:28:10,919: Parsing model.agency_data_pipeline.ga_proc
2018-06-20 10:28:10,975: Parsing model.agency_data_pipeline.ga_stats
2018-06-20 10:28:10,984: Parsing model.agency_data_pipeline.gsc_stats
2018-06-20 10:28:10,991: Parsing model.agency_data_pipeline.youtube_stats
2018-06-20 10:28:10,994: Parsing model.agency_data_pipeline.agg_platforms_ga
2018-06-20 10:28:11,000: Parsing model.agency_data_pipeline.agg_platforms_site
2018-06-20 10:28:11,026: Parsing model.agency_data_pipeline.agg_platforms_union
2018-06-20 10:28:11,035: Parsing model.agency_data_pipeline.landing_page_by_month
2018-06-20 10:28:11,043: Parsing model.agency_data_pipeline.landing_page_index
2018-06-20 10:28:11,048: Parsing model.agency_data_pipeline.platform_by_month
2018-06-20 10:28:11,051: Parsing model.agency_data_pipeline.platform_index
2018-06-20 10:28:11,057: Parsing model.agency_data_pipeline.landing_page_viz
2018-06-20 10:28:11,061: Parsing model.agency_data_pipeline.platform_viz
2018-06-20 10:28:11,088: Found 27 models, 0 tests, 0 archives, 0 analyses, 57 macros, 0 operations, 0 seed files
2018-06-20 10:28:11,106: 
2018-06-20 10:28:11,125: Acquiring new bigquery connection "master".
2018-06-20 10:28:11,126: Opening a new connection (0 currently allocated)
2018-06-20 10:28:14,524: 10:28:14 | Concurrency: 4 threads (target='prod')
2018-06-20 10:28:14,524: 10:28:14 | 
2018-06-20 10:28:14,681: 10:28:14 | 1 of 27 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-06-20 10:28:14,682: 10:28:14 | 2 of 27 START table model agency_data_pipeline.gsc_stats............. [RUN]
2018-06-20 10:28:14,682: Compiling model.agency_data_pipeline.adwords_urls
2018-06-20 10:28:14,683: Compiling model.agency_data_pipeline.gsc_stats
2018-06-20 10:28:14,682: 10:28:14 | 3 of 27 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-06-20 10:28:14,691: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-20 10:28:14,682: 10:28:14 | 4 of 27 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-06-20 10:28:14,697: Compiling model.agency_data_pipeline.accounts_proc
2018-06-20 10:28:14,700: Writing injected SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-20 10:28:14,701: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-06-20 10:28:14,710: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-20 10:28:14,723: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-20 10:28:14,725: Acquiring new bigquery connection "adwords_urls".
2018-06-20 10:28:14,728: Acquiring new bigquery connection "gsc_stats".
2018-06-20 10:28:14,729: Opening a new connection (1 currently allocated)
2018-06-20 10:28:14,732: Acquiring new bigquery connection "conversion_goals_proc".
2018-06-20 10:28:14,735: Acquiring new bigquery connection "accounts_proc".
2018-06-20 10:28:14,737: Opening a new connection (2 currently allocated)
2018-06-20 10:28:14,746: Opening a new connection (3 currently allocated)
2018-06-20 10:28:14,749: Opening a new connection (4 currently allocated)
2018-06-20 10:28:16,730: Writing runtime SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-20 10:28:16,739: Writing runtime SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-20 10:28:16,739: Fetching data for query accounts_proc:
create or replace table `agency_data_pipeline`.`accounts_proc`
  
  as (
    SELECT
site,
bigquery_name,
account,
platform
FROM  (
 
	SELECT  
	site,
	bigquery_name,
	account,
	platform,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.accounts`
) 

WHERE lv = time_of_entry
  );

    
2018-06-20 10:28:16,741: Fetching data for query adwords_urls:
create or replace table `agency_data_pipeline`.`adwords_urls`
  
  as (
    SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url
FROM 
(
	SELECT  
	campaignid,
	max(finalurl) finalurl
	FROM `adp-apprenticeship.adwords.FINAL_URL_REPORT`
	GROUP BY campaignid
)
  );

    
2018-06-20 10:28:17,186: Writing runtime SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-20 10:28:17,187: Writing runtime SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-20 10:28:17,190: Fetching data for query conversion_goals_proc:
create or replace table `agency_data_pipeline`.`conversion_goals_proc`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
FROM  ( 

	SELECT  
	site,
	bigquery_name,
	platform,
	trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
	goal_type,
	account,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by site, bigquery_name, platform, account, goal_name
  );

    
2018-06-20 10:28:17,192: Fetching data for query gsc_stats:
create or replace table `agency_data_pipeline`.`gsc_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
0 as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
0 as conversions
FROM 
  ( 
	SELECT  
	date, 
	site as account,
	'Organic' as channel,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(replace(landing_page_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
	max(impressions) as impressions, 
	max(clicks) as clicks
	FROM `adp-apprenticeship.agency_data_pipeline.gsc`
	GROUP BY date, account, channel, platform, url
  ) 
GROUP BY date, account, channel, platform, url
  );

    
2018-06-20 10:28:19,244: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105e7de48>]}
2018-06-20 10:28:19,372: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10896ea58>]}
2018-06-20 10:28:19,782: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105e7d9b0>]}
2018-06-20 10:28:20,173: 10:28:20 | 3 of 27 OK created table model agency_data_pipeline.accounts_proc.... [OK in 4.55s]
2018-06-20 10:28:20,173: 10:28:20 | 5 of 27 START table model agency_data_pipeline.mappings_ga_proc...... [RUN]
2018-06-20 10:28:20,174: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-06-20 10:28:20,182: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-20 10:28:20,186: Acquiring new bigquery connection "mappings_ga_proc".
2018-06-20 10:28:20,186: Re-using an available connection from the pool.
2018-06-20 10:28:20,256: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10898f550>]}
2018-06-20 10:28:20,477: Writing runtime SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-20 10:28:20,478: Fetching data for query mappings_ga_proc:
create or replace table `agency_data_pipeline`.`mappings_ga_proc`
  
  as (
    SELECT
site,
account,
bigquery_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
FROM  ( 

	SELECT  
	site,
	account,
	bigquery_name,
	source,
	medium,
	platform as platform_n,
	channel as channel_n,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
group by site, account, bigquery_name, source, medium, platform_n, channel_n, time_of_entry
  );

    
2018-06-20 10:28:21,224: 10:28:21 | 1 of 27 OK created table model agency_data_pipeline.adwords_urls..... [OK in 4.69s]
2018-06-20 10:28:21,225: 10:28:21 | 6 of 27 START table model agency_data_pipeline.youtube_stats......... [RUN]
2018-06-20 10:28:21,226: Compiling model.agency_data_pipeline.youtube_stats
2018-06-20 10:28:21,235: Writing injected SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-20 10:28:21,239: Acquiring new bigquery connection "youtube_stats".
2018-06-20 10:28:21,240: Re-using an available connection from the pool.
2018-06-20 10:28:21,755: Writing runtime SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-20 10:28:21,756: Fetching data for query youtube_stats:
create or replace table `agency_data_pipeline`.`youtube_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
FROM 
  ( 
	SELECT  
	date, 
	'Social' as channel,
	'YouTube' as platform,
	'Coding is for Losers' as account,  
	0 as cost, 
	max(views) as impressions, 
	max(clicks) as clicks, 
	max(subscribers) as conversions,
	regexp_replace(regexp_replace(replace(replace(replace(landing_page_url,'http://',''),'https://',''),'.html',''),r'\?.*$',''),r'([/]$)','') as url,
	video_url
	FROM `adp-apprenticeship.agency_data_pipeline.youtube`
	group by channel, platform, account, date, video_url, url
  ) 
GROUP BY date, account, channel, platform, url
  );

    
2018-06-20 10:28:22,273: 10:28:22 | 4 of 27 OK created table model agency_data_pipeline.conversion_goals_proc [OK in 5.08s]
2018-06-20 10:28:22,274: 10:28:22 | 7 of 27 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-06-20 10:28:22,274: Compiling model.agency_data_pipeline.adwords_campaigns
2018-06-20 10:28:22,286: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-20 10:28:22,293: Acquiring new bigquery connection "adwords_campaigns".
2018-06-20 10:28:22,293: Re-using an available connection from the pool.
2018-06-20 10:28:22,956: Writing runtime SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-20 10:28:22,959: Fetching data for query adwords_campaigns:
create or replace table `agency_data_pipeline`.`adwords_campaigns`
  
  as (
    SELECT
day,
campaignid,
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM
( 
	SELECT  
	'Paid' as channel,
	'Adwords' as platform,
	day,
	campaignid,
	campaign,
	account as account,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	conversions,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `adp-apprenticeship.adwords.CAMPAIGN_PERFORMANCE_REPORT`
)
WHERE lv = _sdc_sequence
GROUP BY day, campaignid, account, channel, platform, campaign
  );

    
2018-06-20 10:28:23,428: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1055a47f0>]}
2018-06-20 10:28:23,507: 10:28:23 | 2 of 27 OK created table model agency_data_pipeline.gsc_stats........ [OK in 5.57s]
2018-06-20 10:28:24,520: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108ae4278>]}
2018-06-20 10:28:24,613: 10:28:24 | 5 of 27 OK created table model agency_data_pipeline.mappings_ga_proc. [OK in 3.25s]
2018-06-20 10:28:25,599: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108ad8ac8>]}
2018-06-20 10:28:25,677: 10:28:25 | 6 of 27 OK created table model agency_data_pipeline.youtube_stats.... [OK in 3.29s]
2018-06-20 10:28:26,693: 10:28:26 | 7 of 27 OK created table model agency_data_pipeline.adwords_campaigns [OK in 3.32s]
2018-06-20 10:28:26,693: 10:28:26 | 8 of 27 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-06-20 10:28:26,694: Compiling model.agency_data_pipeline.ga_conversions
2018-06-20 10:28:26,700: 10:28:26 | 9 of 27 START table model agency_data_pipeline.fb_ads_insights....... [RUN]
2018-06-20 10:28:26,700: 10:28:26 | 10 of 27 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-06-20 10:28:26,700: 10:28:26 | 11 of 27 START table model agency_data_pipeline.fb_conversions....... [RUN]
2018-06-20 10:28:26,702: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-20 10:28:26,702: Compiling model.agency_data_pipeline.fb_ads_insights
2018-06-20 10:28:26,702: Compiling model.agency_data_pipeline.fb_adcreative
2018-06-20 10:28:26,702: Compiling model.agency_data_pipeline.fb_conversions
2018-06-20 10:28:26,734: Writing injected SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-20 10:28:26,737: Acquiring new bigquery connection "fb_conversions".
2018-06-20 10:28:26,738: Acquiring new bigquery connection "fb_adcreative".
2018-06-20 10:28:26,744: Acquiring new bigquery connection "ga_conversions".
2018-06-20 10:28:26,752: Acquiring new bigquery connection "fb_ads_insights".
2018-06-20 10:28:26,752: Re-using an available connection from the pool.
2018-06-20 10:28:26,753: Re-using an available connection from the pool.
2018-06-20 10:28:26,753: Fetching data for query fb_adcreative:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-20 10:28:26,754: Re-using an available connection from the pool.
2018-06-20 10:28:26,771: Re-using an available connection from the pool.
2018-06-20 10:28:26,777: Fetching data for query fb_ads_insights:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-20 10:28:27,307: Writing runtime SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-20 10:28:27,307: Fetching data for query fb_conversions:
create or replace table `agency_data_pipeline`.`fb_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'FB Ads'
  );

    
2018-06-20 10:28:27,683: Writing runtime SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-20 10:28:27,690: Fetching data for query ga_conversions:
create or replace table `agency_data_pipeline`.`ga_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'Google Analytics'
  );

    
2018-06-20 10:28:29,731: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089aeda0>]}
2018-06-20 10:28:30,336: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-20 10:28:30,665: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108ad8438>]}
2018-06-20 10:28:30,859: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-20 10:28:30,860: Fetching data for query fb_ads_insights:
create or replace table `agency_data_pipeline`.`fb_ads_insights`
  
  as (
    



with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


  );

    
2018-06-20 10:28:30,935: 10:28:30 | 11 of 27 OK created table model agency_data_pipeline.fb_conversions.. [OK in 3.03s]
2018-06-20 10:28:32,231: 10:28:32 | 8 of 27 OK created table model agency_data_pipeline.ga_conversions... [OK in 3.97s]
2018-06-20 10:28:33,548: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089f5cc0>]}
2018-06-20 10:28:35,068: 10:28:35 | 9 of 27 OK created table model agency_data_pipeline.fb_ads_insights.. [OK in 6.85s]
2018-06-20 10:28:37,594: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-20 10:28:38,136: Writing runtime SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-20 10:28:38,137: Fetching data for query fb_adcreative:
create or replace table `agency_data_pipeline`.`fb_adcreative`
  
  as (
    



with fb_adcreative as (


	    
		   	SELECT 
			id,
			link_url object_url,
			url_tags,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


  );

    
2018-06-20 10:28:40,704: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089cf5c0>]}
2018-06-20 10:28:41,669: 10:28:41 | 10 of 27 OK created table model agency_data_pipeline.fb_adcreative... [OK in 14.00s]
2018-06-20 10:28:41,670: 10:28:41 | 12 of 27 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-06-20 10:28:41,671: Compiling model.agency_data_pipeline.adwords_join
2018-06-20 10:28:41,670: 10:28:41 | 13 of 27 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-06-20 10:28:41,682: Compiling model.agency_data_pipeline.fb_ads
2018-06-20 10:28:41,682: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-20 10:28:41,695: Acquiring new bigquery connection "fb_ads".
2018-06-20 10:28:41,695: Re-using an available connection from the pool.
2018-06-20 10:28:41,695: Fetching data for query fb_ads:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-20 10:28:41,699: Acquiring new bigquery connection "adwords_join".
2018-06-20 10:28:41,699: Re-using an available connection from the pool.
2018-06-20 10:28:42,209: Writing runtime SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-20 10:28:42,210: Fetching data for query adwords_join:
create or replace table `agency_data_pipeline`.`adwords_join`
  
  as (
    SELECT
day,
a.campaign,
a.campaignid, 
account, 
channel,
platform,
b.url,
cost,
impressions,
clicks,
conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_campaigns` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`adwords_urls` b
ON a.campaignid = b.campaignid
  );

    
2018-06-20 10:28:43,777: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-20 10:28:44,149: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-20 10:28:44,150: Fetching data for query fb_ads:
create or replace table `agency_data_pipeline`.`fb_ads`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


  );

    
2018-06-20 10:28:44,916: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089f5e48>]}
2018-06-20 10:28:46,101: 10:28:46 | 12 of 27 OK created table model agency_data_pipeline.adwords_join.... [OK in 3.25s]
2018-06-20 10:28:47,041: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1089f5da0>]}
2018-06-20 10:28:48,153: 10:28:48 | 13 of 27 OK created table model agency_data_pipeline.fb_ads.......... [OK in 5.36s]
2018-06-20 10:28:48,154: 10:28:48 | 14 of 27 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-06-20 10:28:48,155: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-20 10:28:48,154: 10:28:48 | 15 of 27 START table model agency_data_pipeline.ga_proc.............. [RUN]
2018-06-20 10:28:48,154: 10:28:48 | 16 of 27 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-06-20 10:28:48,168: Compiling model.agency_data_pipeline.adwords_stats
2018-06-20 10:28:48,162: Compiling model.agency_data_pipeline.ga_proc
2018-06-20 10:28:48,199: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-20 10:28:48,205: Acquiring new bigquery connection "adwords_stats".
2018-06-20 10:28:48,223: Re-using an available connection from the pool.
2018-06-20 10:28:48,223: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-06-20 10:28:48,266: Re-using an available connection from the pool.
2018-06-20 10:28:48,267: Fetching data for query fb_ads_insights_conversions:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-20 10:28:48,308: Acquiring new bigquery connection "ga_proc".
2018-06-20 10:28:48,312: Re-using an available connection from the pool.
2018-06-20 10:28:48,312: Fetching data for query ga_proc:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-20 10:28:48,803: Writing runtime SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-20 10:28:48,804: Fetching data for query adwords_stats:
create or replace table `agency_data_pipeline`.`adwords_stats`
  
  as (
    SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_join`
GROUP BY date, account, platform, channel, url, campaign
  );

    
2018-06-20 10:28:50,723: Fetching data for query fb_ads_insights_conversions:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`
        where goal_name is not null
        and goal_name != ''

        
        ##where 1 = 1
        and goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-20 10:28:51,260: Fetching data for query ga_proc:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`
        where goal_name is not null
        and goal_name != ''

        
        ##where 1 = 1
        and goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-20 10:28:51,264: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105ed2cc0>]}
2018-06-20 10:28:52,446: 10:28:52 | 16 of 27 OK created table model agency_data_pipeline.adwords_stats... [OK in 3.10s]
2018-06-20 10:28:53,922: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-06-20 10:28:53,930: Writing injected SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-20 10:28:54,476: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-06-20 10:28:54,479: Writing runtime SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-20 10:28:54,479: Fetching data for query fb_ads_insights_conversions:
create or replace table `agency_data_pipeline`.`fb_ads_insights_conversions`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`





with fb_ads_insights_conversions as (

	    

	    	

		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			_sdc_sequence,
			action_type,
			_28d_click conversions,
			null as revenue
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
			cross join unnest(actions)

			## goal completion columns
			
				where action_type in (
				
					'offsite_conversion.fb_pixel_lead'
					 
				
				)
			
			
			UNION ALL

		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			_sdc_sequence,
			action_type,
			null as conversions,
			_28d_click as revenue
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
			cross join unnest(action_values)
			
			## goal completion columns
			
				where action_type in (
				
					'offsite_conversion.fb_pixel_lead'
					 
				
				)
			

		    
	   

)

SELECT 
date,
campaign_id,
campaign,
ad_id,
account,
sum(conversions) conversions,
sum(revenue) revenue
FROM 
		(
	    SELECT
	    date_start date,
	    campaign_id,
	    campaign_name campaign,
	    ad_id,
	    account_name account,
	    action_type,
	    conversions,
	    revenue,
	    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
	    _sdc_sequence
	    FROM fb_ads_insights_conversions
	   	)
where lv = _sdc_sequence
group by date, campaign_id, campaign, ad_id, account



  );

    
2018-06-20 10:28:54,480: Fetching data for query ga_proc:
create or replace table `agency_data_pipeline`.`ga_proc`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`




with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'cifl' as bigquery_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			sessions,
			## goal completion columns
			
				
					cast(goal1completions as int64) 
					 
					 as goal_completions,  
				
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, campaign ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.ga_cifl.report` 

		    
	   

)


SELECT 
bigquery_name,
lookup_platform,
date,
url,
source,
medium,
sum(sessions) sessions,
sum(goal_completions) goal_completions
FROM ga_report
where lv = _sdc_sequence
group by bigquery_name, lookup_platform, date, url, source, medium


  );

    
2018-06-20 10:28:57,027: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105ea40b8>]}
2018-06-20 10:28:57,517: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105e6f5c0>]}
2018-06-20 10:28:58,150: 10:28:58 | 15 of 27 OK created table model agency_data_pipeline.ga_proc......... [OK in 8.87s]
2018-06-20 10:28:59,748: 10:28:59 | 14 of 27 OK created table model agency_data_pipeline.fb_ads_insights_conversions [OK in 9.36s]
2018-06-20 10:28:59,749: 10:28:59 | 17 of 27 START table model agency_data_pipeline.ga_stats............. [RUN]
2018-06-20 10:28:59,749: Compiling model.agency_data_pipeline.ga_stats
2018-06-20 10:28:59,757: Writing injected SQL for node "model.agency_data_pipeline.ga_stats"
2018-06-20 10:28:59,760: Acquiring new bigquery connection "ga_stats".
2018-06-20 10:28:59,760: Re-using an available connection from the pool.
2018-06-20 10:29:00,221: Writing runtime SQL for node "model.agency_data_pipeline.ga_stats"
2018-06-20 10:29:00,221: Fetching data for query ga_stats:
create or replace table `agency_data_pipeline`.`ga_stats`
  
  as (
    SELECT  
cast(date as date) date,
b.account,
b.site site,
c.source source,
c.medium medium,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
url,
sum(sessions) sessions,
sum(goal_completions) goal_completions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`ga_proc` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.bigquery_name = b.bigquery_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.bigquery_name = c.bigquery_name )
GROUP BY date, account, site, source, medium, source_medium, platform, channel, url
  );

    
2018-06-20 10:29:03,813: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105eb0240>]}
2018-06-20 10:29:05,268: 10:29:05 | 17 of 27 OK created table model agency_data_pipeline.ga_stats........ [OK in 4.06s]
2018-06-20 10:29:05,271: 10:29:05 | 18 of 27 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-06-20 10:29:05,271: Compiling model.agency_data_pipeline.fb_ads_stats
2018-06-20 10:29:05,287: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-06-20 10:29:05,289: Acquiring new bigquery connection "fb_ads_stats".
2018-06-20 10:29:05,289: Re-using an available connection from the pool.
2018-06-20 10:29:05,979: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-06-20 10:29:05,980: Fetching data for query fb_ads_stats:
create or replace table `agency_data_pipeline`.`fb_ads_stats`
  
  as (
    with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) conversions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign
  );

    
2018-06-20 10:29:08,553: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105e6f5c0>]}
2018-06-20 10:29:11,031: 10:29:11 | 18 of 27 OK created table model agency_data_pipeline.fb_ads_stats.... [OK in 3.28s]
2018-06-20 10:29:11,032: 10:29:11 | 19 of 27 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-06-20 10:29:11,032: Compiling model.agency_data_pipeline.agg_platforms_union
2018-06-20 10:29:11,043: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-06-20 10:29:11,046: Acquiring new bigquery connection "agg_platforms_union".
2018-06-20 10:29:11,046: Re-using an available connection from the pool.
2018-06-20 10:29:11,702: Writing runtime SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-06-20 10:29:11,703: Fetching data for query agg_platforms_union:
create or replace table `agency_data_pipeline`.`agg_platforms_union`
  
  as (
    SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`adwords_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`gsc_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`youtube_stats`
  );

    
2018-06-20 10:29:14,396: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108ad8fd0>]}
2018-06-20 10:29:15,518: 10:29:15 | 19 of 27 OK created table model agency_data_pipeline.agg_platforms_union [OK in 3.36s]
2018-06-20 10:29:15,519: 10:29:15 | 20 of 27 START table model agency_data_pipeline.agg_platforms_site... [RUN]
2018-06-20 10:29:15,519: Compiling model.agency_data_pipeline.agg_platforms_site
2018-06-20 10:29:15,526: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_site"
2018-06-20 10:29:15,529: Acquiring new bigquery connection "agg_platforms_site".
2018-06-20 10:29:15,529: Re-using an available connection from the pool.
2018-06-20 10:29:16,037: Writing runtime SQL for node "model.agency_data_pipeline.agg_platforms_site"
2018-06-20 10:29:16,038: Fetching data for query agg_platforms_site:
create or replace table `agency_data_pipeline`.`agg_platforms_site`
  
  as (
    SELECT 
date, 
a.account account, 
b.site site,
a.platform platform,
a.channel channel,
url,
cost,
impressions,
clicks,
conversions
FROM 
  `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_union` a
LEFT JOIN 
  `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc` b
ON ( 
  a.account = b.account AND
  a.platform = b.platform
)
  );

    
2018-06-20 10:29:19,016: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105e6f5c0>]}
2018-06-20 10:29:19,968: 10:29:19 | 20 of 27 OK created table model agency_data_pipeline.agg_platforms_site [OK in 3.50s]
2018-06-20 10:29:19,969: 10:29:19 | 21 of 27 START table model agency_data_pipeline.agg_platforms_ga..... [RUN]
2018-06-20 10:29:19,969: Compiling model.agency_data_pipeline.agg_platforms_ga
2018-06-20 10:29:19,978: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_ga"
2018-06-20 10:29:19,980: Acquiring new bigquery connection "agg_platforms_ga".
2018-06-20 10:29:19,980: Re-using an available connection from the pool.
2018-06-20 10:29:20,562: Writing runtime SQL for node "model.agency_data_pipeline.agg_platforms_ga"
2018-06-20 10:29:20,562: Fetching data for query agg_platforms_ga:
create or replace table `agency_data_pipeline`.`agg_platforms_ga`
  
  as (
    with ga as (

	select 
		date, account, site, channel, platform, url,
		sessions, goal_completions,
		null as cost, null as impressions, null as clicks, null as conversions
	from `adp-apprenticeship`.`agency_data_pipeline`.`ga_stats`

),

platforms as (

	select 
		date, account, site, channel, platform, url,
		null as sessions, null as goal_completions,
		cost, impressions, clicks, conversions
	from `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_site`

)


SELECT
    date, 
    site,
    platform,
    channel, 
    url,
    sum(cost) cost,
	sum(impressions) impressions,
	sum(clicks) clicks,
	sum(conversions) conversions,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      platforms 
) 
GROUP BY
    date, site, platform, channel, url
  );

    
2018-06-20 10:29:23,284: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108ad8fd0>]}
2018-06-20 10:29:24,912: 10:29:24 | 21 of 27 OK created table model agency_data_pipeline.agg_platforms_ga [OK in 3.31s]
2018-06-20 10:29:24,915: 10:29:24 | 22 of 27 START table model agency_data_pipeline.landing_page_by_month [RUN]
2018-06-20 10:29:24,916: Compiling model.agency_data_pipeline.landing_page_by_month
2018-06-20 10:29:24,915: 10:29:24 | 23 of 27 START table model agency_data_pipeline.platform_by_month.... [RUN]
2018-06-20 10:29:24,925: Compiling model.agency_data_pipeline.platform_by_month
2018-06-20 10:29:24,928: Writing injected SQL for node "model.agency_data_pipeline.landing_page_by_month"
2018-06-20 10:29:24,940: Writing injected SQL for node "model.agency_data_pipeline.platform_by_month"
2018-06-20 10:29:24,942: Acquiring new bigquery connection "platform_by_month".
2018-06-20 10:29:24,944: Acquiring new bigquery connection "landing_page_by_month".
2018-06-20 10:29:24,945: Re-using an available connection from the pool.
2018-06-20 10:29:24,946: Re-using an available connection from the pool.
2018-06-20 10:29:25,430: Writing runtime SQL for node "model.agency_data_pipeline.platform_by_month"
2018-06-20 10:29:25,441: Writing runtime SQL for node "model.agency_data_pipeline.landing_page_by_month"
2018-06-20 10:29:25,442: Fetching data for query platform_by_month:
create or replace table `agency_data_pipeline`.`platform_by_month`
  
  as (
    SELECT
yyyymm, 
site,
platform,
channel, 
cost,
impressions,
clicks,
conversions,
sessions,
sum(sessions) OVER w1 total_sessions,
goal_completions,
sum(goal_completions) OVER w1 total_goal_completions
FROM (
    SELECT 
    FORMAT_DATE("%Y-%m", date) AS yyyymm,
    site,
    platform,
    channel, 
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) conversions,
    sum(sessions) sessions,
    sum(goal_completions) goal_completions
    FROM `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_ga`
    GROUP BY yyyymm, site, channel, platform
)
WINDOW w1 as (PARTITION BY yyyymm, site)
  );

    
2018-06-20 10:29:25,442: Fetching data for query landing_page_by_month:
create or replace table `agency_data_pipeline`.`landing_page_by_month`
  
  as (
    SELECT
yyyymm, 
site,
platform,
channel, 
url,
cost,
impressions,
clicks,
conversions,
sessions,
sum(sessions) OVER w1 total_sessions,
goal_completions,
sum(goal_completions) OVER w1 total_goal_completions
FROM (
    SELECT 
    FORMAT_DATE("%Y-%m", date) AS yyyymm,
    site,
    platform,
    channel, 
    url,
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) conversions,
    sum(sessions) sessions,
    sum(goal_completions) goal_completions
    FROM `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_ga`
    GROUP BY yyyymm, site, platform, channel, url
)
WINDOW w1 as (PARTITION BY yyyymm, site)
  );

    
2018-06-20 10:29:27,954: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105e6f5c0>]}
2018-06-20 10:29:28,566: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108990358>]}
2018-06-20 10:29:29,618: 10:29:29 | 22 of 27 OK created table model agency_data_pipeline.landing_page_by_month [OK in 3.04s]
2018-06-20 10:29:30,953: 10:29:30 | 23 of 27 OK created table model agency_data_pipeline.platform_by_month [OK in 3.64s]
2018-06-20 10:29:30,954: 10:29:30 | 24 of 27 START table model agency_data_pipeline.landing_page_index... [RUN]
2018-06-20 10:29:30,955: Compiling model.agency_data_pipeline.landing_page_index
2018-06-20 10:29:30,954: 10:29:30 | 25 of 27 START table model agency_data_pipeline.platform_index....... [RUN]
2018-06-20 10:29:30,957: Compiling model.agency_data_pipeline.platform_index
2018-06-20 10:29:30,974: Writing injected SQL for node "model.agency_data_pipeline.platform_index"
2018-06-20 10:29:30,976: Writing injected SQL for node "model.agency_data_pipeline.landing_page_index"
2018-06-20 10:29:30,977: Acquiring new bigquery connection "landing_page_index".
2018-06-20 10:29:30,979: Re-using an available connection from the pool.
2018-06-20 10:29:30,978: Acquiring new bigquery connection "platform_index".
2018-06-20 10:29:30,982: Re-using an available connection from the pool.
2018-06-20 10:29:31,501: Writing runtime SQL for node "model.agency_data_pipeline.landing_page_index"
2018-06-20 10:29:31,502: Fetching data for query landing_page_index:
create or replace table `agency_data_pipeline`.`landing_page_index`
  
  as (
    SELECT 
yyyymm, 
site,
platform,
channel, 
url,
cost,
impressions,
clicks,
conversions,
sessions,
pct_sessions,
goal_completions,
pct_goal_completions,
case when pct_sessions > 0 then pct_goal_completions / pct_sessions else null end as conversion_index
FROM (
    SELECT
    yyyymm, 
    site,
    platform,
    channel, 
    url,
    cost,
    impressions,
    clicks,
    conversions,
    sessions,
    case when total_sessions > 0 then sessions / total_sessions else null end as pct_sessions,
    goal_completions,
    case when total_goal_completions > 0 then goal_completions / total_goal_completions else null end as pct_goal_completions
    FROM `adp-apprenticeship`.`agency_data_pipeline`.`landing_page_by_month`
)
  );

    
2018-06-20 10:29:31,640: Writing runtime SQL for node "model.agency_data_pipeline.platform_index"
2018-06-20 10:29:31,642: Fetching data for query platform_index:
create or replace table `agency_data_pipeline`.`platform_index`
  
  as (
    SELECT 
yyyymm, 
site,
platform,
channel, 
cost,
impressions,
clicks,
conversions,
sessions,
pct_sessions,
goal_completions,
pct_goal_completions,
case when pct_sessions > 0 then pct_goal_completions / pct_sessions else null end as conversion_index
FROM (
    SELECT
    yyyymm, 
    site,
    platform,
    channel, 
    cost,
    impressions,
    clicks,
    conversions,
    sessions,
    case when total_sessions > 0 then sessions / total_sessions else null end as pct_sessions,
    goal_completions,
    case when total_goal_completions > 0 then goal_completions / total_goal_completions else null end as pct_goal_completions
    FROM `adp-apprenticeship`.`agency_data_pipeline`.`platform_by_month`
)
  );

    
2018-06-20 10:29:34,253: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108ae4278>]}
2018-06-20 10:29:35,428: 10:29:35 | 24 of 27 OK created table model agency_data_pipeline.landing_page_index [OK in 3.30s]
2018-06-20 10:29:36,867: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108ad8ac8>]}
2018-06-20 10:29:38,297: 10:29:38 | 25 of 27 OK created table model agency_data_pipeline.platform_index.. [OK in 5.91s]
2018-06-20 10:29:38,300: 10:29:38 | 26 of 27 START table model agency_data_pipeline.platform_viz......... [RUN]
2018-06-20 10:29:38,300: Compiling model.agency_data_pipeline.platform_viz
2018-06-20 10:29:38,300: 10:29:38 | 27 of 27 START table model agency_data_pipeline.landing_page_viz..... [RUN]
2018-06-20 10:29:38,308: Writing injected SQL for node "model.agency_data_pipeline.platform_viz"
2018-06-20 10:29:38,308: Compiling model.agency_data_pipeline.landing_page_viz
2018-06-20 10:29:38,316: Writing injected SQL for node "model.agency_data_pipeline.landing_page_viz"
2018-06-20 10:29:38,318: Acquiring new bigquery connection "platform_viz".
2018-06-20 10:29:38,318: Re-using an available connection from the pool.
2018-06-20 10:29:38,322: Acquiring new bigquery connection "landing_page_viz".
2018-06-20 10:29:38,322: Re-using an available connection from the pool.
2018-06-20 10:29:38,992: Writing runtime SQL for node "model.agency_data_pipeline.landing_page_viz"
2018-06-20 10:29:39,002: Writing runtime SQL for node "model.agency_data_pipeline.platform_viz"
2018-06-20 10:29:39,002: Fetching data for query landing_page_viz:
create or replace table `agency_data_pipeline`.`landing_page_viz`
  
  as (
    SELECT 
yyyymm Month, 
site Site,
platform Platform,
channel Channel, 
url URL,
ifnull(cost, 0) Cost,
ifnull(impressions, 0) Impressions,
ifnull(clicks, 0) Clicks,
ifnull(conversions, 0) Conversions,
ifnull(sessions, 0) Sessions,
ifnull(pct_sessions, 0) PctSessions,
ifnull(goal_completions, 0) GoalCompletions,
ifnull(pct_goal_completions, 0) PctGoalCompletions,
ifnull(conversion_index, 0) ConversionIndex
FROM `adp-apprenticeship`.`agency_data_pipeline`.`landing_page_index`
  );

    
2018-06-20 10:29:39,003: Fetching data for query platform_viz:
create or replace table `agency_data_pipeline`.`platform_viz`
  
  as (
    SELECT 
yyyymm Month, 
site Site,
platform Platform,
channel Channel, 
ifnull(cost, 0) Cost,
ifnull(impressions, 0) Impressions,
ifnull(clicks, 0) Clicks,
ifnull(conversions, 0) Conversions,
ifnull(sessions, 0) Sessions,
ifnull(pct_sessions, 0) PctSessions,
ifnull(goal_completions, 0) GoalCompletions,
ifnull(pct_goal_completions, 0) PctGoalCompletions,
ifnull(conversion_index, 0) ConversionIndex
FROM `adp-apprenticeship`.`agency_data_pipeline`.`platform_index`
WHERE yyyymm >= '2017-06'
  );

    
2018-06-20 10:29:40,999: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108990358>]}
2018-06-20 10:29:42,181: 10:29:42 | 26 of 27 OK created table model agency_data_pipeline.platform_viz.... [OK in 2.70s]
2018-06-20 10:29:43,141: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c2aa54e9-3f0a-488d-b766-26dadecf7b8b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105e441d0>]}
2018-06-20 10:29:44,065: 10:29:44 | 27 of 27 OK created table model agency_data_pipeline.landing_page_viz [OK in 4.83s]
2018-06-20 10:29:44,103: 10:29:44 | 
2018-06-20 10:29:44,103: 10:29:44 | Finished running 27 table models in 93.00s.
2018-06-20 10:29:44,104: Connection 'master' was left open.
2018-06-20 10:29:44,105: 
2018-06-20 10:29:44,105: Completed successfully
2018-06-20 10:29:44,105: 
Done. PASS=27 ERROR=0 SKIP=0 TOTAL=27
2018-06-20 10:29:44,106: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087d2438>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105e38748>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105e38a20>]}
2018-06-20 10:29:45,111: Flushing usage events
2018-06-20 10:29:45,395: sys:1: ResourceWarning: unclosed <socket.socket fd=12, family=AddressFamily.AF_INET6, type=SocketKind.SOCK_STREAM, proto=6, laddr=('2600:1011:b055:854c:6907:73b8:20c9:92d', 51889, 0, 0), raddr=('2607:f8b0:4007:80b::200a', 443, 0, 0)>

2018-06-20 10:29:45,396: sys:1: ResourceWarning: unclosed <socket.socket fd=11, family=AddressFamily.AF_INET6, type=SocketKind.SOCK_STREAM, proto=6, laddr=('2600:1011:b055:854c:6907:73b8:20c9:92d', 51888, 0, 0), raddr=('2607:f8b0:4007:80b::200d', 443, 0, 0)>

2018-06-20 10:29:45,397: sys:1: ResourceWarning: unclosed <socket.socket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('172.20.10.4', 51898), raddr=('172.217.11.170', 443)>

2018-06-20 10:29:45,398: sys:1: ResourceWarning: unclosed <socket.socket fd=17, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('172.20.10.4', 51895), raddr=('172.217.11.170', 443)>

2018-06-20 10:29:45,399: sys:1: ResourceWarning: unclosed <socket.socket fd=18, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('172.20.10.4', 51896), raddr=('172.217.11.170', 443)>

2018-06-20 10:29:45,399: sys:1: ResourceWarning: unclosed <socket.socket fd=22, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('172.20.10.4', 51899), raddr=('172.217.11.170', 443)>

2018-06-20 10:29:45,400: sys:1: ResourceWarning: unclosed <socket.socket fd=16, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('172.20.10.4', 51891), raddr=('216.58.193.205', 443)>

2018-06-20 10:29:45,401: sys:1: ResourceWarning: unclosed <socket.socket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('172.20.10.4', 51892), raddr=('216.58.193.205', 443)>

2018-06-20 10:29:45,401: sys:1: ResourceWarning: unclosed <socket.socket fd=14, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('172.20.10.4', 51890), raddr=('216.58.193.205', 443)>

2018-06-20 10:29:45,402: sys:1: ResourceWarning: unclosed <socket.socket fd=15, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('172.20.10.4', 51893), raddr=('216.58.193.205', 443)>

