2018-06-15 16:08:35,745: Tracking: tracking
2018-06-15 16:08:35,746: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111098da0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1111bf550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1111bf080>]}
2018-06-15 16:08:36,664: Loading dependency project from /usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/include
2018-06-15 16:08:36,696: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/agency-data-pipeline/dbt_modules
2018-06-15 16:08:36,703: Parsing core.sql
2018-06-15 16:08:36,734: Parsing adapters/bigquery.sql
2018-06-15 16:08:36,752: Parsing adapters/common.sql
2018-06-15 16:08:36,788: Parsing adapters/redshift.sql
2018-06-15 16:08:36,812: Parsing adapters/snowflake.sql
2018-06-15 16:08:36,818: Parsing etc/bigquery.sql
2018-06-15 16:08:36,823: Parsing etc/datetime.sql
2018-06-15 16:08:36,854: Parsing etc/get_custom_schema.sql
2018-06-15 16:08:36,863: Parsing materializations/helpers.sql
2018-06-15 16:08:36,886: Parsing materializations/archive/archive.sql
2018-06-15 16:08:36,930: Parsing materializations/incremental/incremental.sql
2018-06-15 16:08:36,972: Parsing materializations/seed/bigquery.sql
2018-06-15 16:08:36,981: Parsing materializations/seed/seed.sql
2018-06-15 16:08:37,038: Parsing materializations/table/bigquery_table.sql
2018-06-15 16:08:37,070: Parsing materializations/table/table.sql
2018-06-15 16:08:37,103: Parsing materializations/view/bigquery_view.sql
2018-06-15 16:08:37,123: Parsing materializations/view/view.sql
2018-06-15 16:08:37,150: Parsing schema_tests/accepted_values.sql
2018-06-15 16:08:37,154: Parsing schema_tests/not_null.sql
2018-06-15 16:08:37,159: Parsing schema_tests/relationships.sql
2018-06-15 16:08:37,167: Parsing schema_tests/unique.sql
2018-06-15 16:08:37,181: Parsing model.agency_data_pipeline.accounts_proc
2018-06-15 16:08:37,199: Found 1 models, 0 tests, 0 archives, 0 analyses, 56 macros, 0 operations, 0 seed files
2018-06-15 16:08:37,211: 
2018-06-15 16:08:37,229: Acquiring new bigquery connection "master".
2018-06-15 16:08:37,229: Opening a new connection (0 currently allocated)
2018-06-15 16:08:39,179: 16:08:39 | Concurrency: 4 threads (target='dev')
2018-06-15 16:08:39,179: 16:08:39 | 
2018-06-15 16:08:39,186: 16:08:39 | 1 of 1 START table model agency_data_pipeline.accounts_proc.......... [RUN]
2018-06-15 16:08:39,187: Compiling model.agency_data_pipeline.accounts_proc
2018-06-15 16:08:39,197: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 16:08:39,199: Acquiring new bigquery connection "accounts_proc".
2018-06-15 16:08:39,200: Opening a new connection (1 currently allocated)
2018-06-15 16:08:39,854: Writing runtime SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 16:08:39,855: Fetching data for query accounts_proc:
create or replace table `agency_data_pipeline`.`accounts_proc`
  
  as (
    SELECT
site,
bigquery_name,
account,
platform
FROM  (
 
	SELECT  
	site,
	bigquery_name,
	account,
	platform,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.accounts`
) 

WHERE lv = time_of_entry
  );

    
2018-06-15 16:08:42,042: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '51300f5e-3f4f-4cb1-b27d-d15aeef3624e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dfaa400>]}
2018-06-15 16:08:42,379: 16:08:42 | 1 of 1 OK created table model agency_data_pipeline.accounts_proc..... [OK in 2.86s]
2018-06-15 16:08:42,475: 16:08:42 | 
2018-06-15 16:08:42,476: 16:08:42 | Finished running 1 table models in 5.26s.
2018-06-15 16:08:42,476: Connection 'master' was left open.
2018-06-15 16:08:42,476: 
2018-06-15 16:08:42,476: Completed successfully
2018-06-15 16:08:42,476: 
Done. PASS=1 ERROR=0 SKIP=0 TOTAL=1
2018-06-15 16:08:42,477: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111098da0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10df55748>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10df558d0>]}
2018-06-15 16:08:42,803: Flushing usage events
2018-06-15 16:08:42,840: sys:1: ResourceWarning: unclosed <socket.socket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51518), raddr=('172.217.12.13', 443)>

2018-06-15 16:08:42,841: sys:1: ResourceWarning: unclosed <socket.socket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51519), raddr=('172.217.12.10', 443)>

2018-06-15 16:08:42,841: sys:1: ResourceWarning: unclosed <socket.socket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51520), raddr=('172.217.12.13', 443)>

2018-06-15 16:08:42,841: sys:1: ResourceWarning: unclosed <socket.socket fd=14, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51521), raddr=('172.217.12.10', 443)>

2018-06-15 16:30:58,721: Tracking: tracking
2018-06-15 16:30:58,723: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106c5e0b8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106c5e630>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106c5ed30>]}
2018-06-15 16:30:59,754: Loading dependency project from /usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/include
2018-06-15 16:30:59,788: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/agency-data-pipeline/dbt_modules
2018-06-15 16:30:59,795: Parsing core.sql
2018-06-15 16:30:59,818: Parsing adapters/bigquery.sql
2018-06-15 16:30:59,827: Parsing adapters/common.sql
2018-06-15 16:30:59,852: Parsing adapters/redshift.sql
2018-06-15 16:30:59,873: Parsing adapters/snowflake.sql
2018-06-15 16:30:59,878: Parsing etc/bigquery.sql
2018-06-15 16:30:59,885: Parsing etc/datetime.sql
2018-06-15 16:30:59,915: Parsing etc/get_custom_schema.sql
2018-06-15 16:30:59,928: Parsing materializations/helpers.sql
2018-06-15 16:30:59,948: Parsing materializations/archive/archive.sql
2018-06-15 16:30:59,986: Parsing materializations/incremental/incremental.sql
2018-06-15 16:31:00,024: Parsing materializations/seed/bigquery.sql
2018-06-15 16:31:00,033: Parsing materializations/seed/seed.sql
2018-06-15 16:31:00,083: Parsing materializations/table/bigquery_table.sql
2018-06-15 16:31:00,126: Parsing materializations/table/table.sql
2018-06-15 16:31:00,160: Parsing materializations/view/bigquery_view.sql
2018-06-15 16:31:00,185: Parsing materializations/view/view.sql
2018-06-15 16:31:00,214: Parsing schema_tests/accepted_values.sql
2018-06-15 16:31:00,223: Parsing schema_tests/not_null.sql
2018-06-15 16:31:00,231: Parsing schema_tests/relationships.sql
2018-06-15 16:31:00,239: Parsing schema_tests/unique.sql
2018-06-15 16:31:00,267: Parsing model.agency_data_pipeline.accounts_proc
2018-06-15 16:31:00,271: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-06-15 16:31:00,273: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-06-15 16:31:00,275: Parsing model.agency_data_pipeline.adwords_campaigns
2018-06-15 16:31:00,278: Parsing model.agency_data_pipeline.adwords_join
2018-06-15 16:31:00,282: Parsing model.agency_data_pipeline.adwords_stats
2018-06-15 16:31:00,286: Parsing model.agency_data_pipeline.adwords_urls
2018-06-15 16:31:00,288: Parsing model.agency_data_pipeline.fb_adcreative
2018-06-15 16:31:00,301: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d2fa90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d7cc88>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d922e8>]}
2018-06-15 16:31:00,627: Encountered an error:
2018-06-15 16:31:00,628: 'bool' object is not iterable
2018-06-15 16:31:00,657: Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/main.py", line 41, in main
    results, succeeded = handle_and_check(args)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/main.py", line 85, in handle_and_check
    task, res = run_from_args(parsed)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/main.py", line 139, in run_from_args
    results = run_from_task(task, proj, parsed)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/main.py", line 147, in run_from_task
    result = task.run()
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/task/run.py", line 26, in run
    results = runner.run(query, ModelRunner)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/runner.py", line 217, in run
    return self.run_from_graph(Selector, Runner, query)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/runner.py", line 177, in run_from_graph
    flat_graph, linker = self.compile(self.project)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/runner.py", line 173, in compile
    (flat_graph, linker) = compiler.compile()
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/compilation.py", line 287, in compile
    root_project, all_projects)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/loader.py", line 23, in load_all
    loader.load_all(root_project, all_projects, macros))
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/loader.py", line 83, in load_all
    macros)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/loader.py", line 99, in load_project
    macros=macros)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/parser.py", line 350, in load_and_parse_sql
    return parse_sql_nodes(result, root_project, all_projects, tags, macros)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/parser.py", line 282, in parse_sql_nodes
    macros=macros)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/parser.py", line 232, in parse_node
    capture_macros=True)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 171, in get_rendered
    return render_template(template, ctx, node)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 158, in render_template
    return template.render(ctx)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/jinja2/asyncsupport.py", line 76, in render
    return original_render(self, *args, **kwargs)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/jinja2/environment.py", line 1008, in render
    return self.environment.handle_exception(exc_info, True)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/jinja2/environment.py", line 780, in handle_exception
    reraise(exc_type, exc_value, tb)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/jinja2/_compat.py", line 37, in reraise
    raise value.with_traceback(tb)
  File "<template>", line 8, in top-level template code
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 425, in __init__
    self._iterator = iter(iterable)
TypeError: 'bool' object is not iterable

2018-06-15 16:31:22,891: Tracking: tracking
2018-06-15 16:31:22,893: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112549550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1125497f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1125493c8>]}
2018-06-15 16:31:23,340: Loading dependency project from /usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/include
2018-06-15 16:31:23,378: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/agency-data-pipeline/dbt_modules
2018-06-15 16:31:23,384: Parsing core.sql
2018-06-15 16:31:23,408: Parsing adapters/bigquery.sql
2018-06-15 16:31:23,417: Parsing adapters/common.sql
2018-06-15 16:31:23,441: Parsing adapters/redshift.sql
2018-06-15 16:31:23,462: Parsing adapters/snowflake.sql
2018-06-15 16:31:23,468: Parsing etc/bigquery.sql
2018-06-15 16:31:23,474: Parsing etc/datetime.sql
2018-06-15 16:31:23,505: Parsing etc/get_custom_schema.sql
2018-06-15 16:31:23,518: Parsing materializations/helpers.sql
2018-06-15 16:31:23,548: Parsing materializations/archive/archive.sql
2018-06-15 16:31:23,591: Parsing materializations/incremental/incremental.sql
2018-06-15 16:31:23,628: Parsing materializations/seed/bigquery.sql
2018-06-15 16:31:23,636: Parsing materializations/seed/seed.sql
2018-06-15 16:31:23,695: Parsing materializations/table/bigquery_table.sql
2018-06-15 16:31:23,734: Parsing materializations/table/table.sql
2018-06-15 16:31:23,764: Parsing materializations/view/bigquery_view.sql
2018-06-15 16:31:23,778: Parsing materializations/view/view.sql
2018-06-15 16:31:23,802: Parsing schema_tests/accepted_values.sql
2018-06-15 16:31:23,808: Parsing schema_tests/not_null.sql
2018-06-15 16:31:23,812: Parsing schema_tests/relationships.sql
2018-06-15 16:31:23,818: Parsing schema_tests/unique.sql
2018-06-15 16:31:23,853: Parsing model.agency_data_pipeline.accounts_proc
2018-06-15 16:31:23,858: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-06-15 16:31:23,861: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-06-15 16:31:23,865: Parsing model.agency_data_pipeline.adwords_campaigns
2018-06-15 16:31:23,870: Parsing model.agency_data_pipeline.adwords_join
2018-06-15 16:31:23,875: Parsing model.agency_data_pipeline.adwords_stats
2018-06-15 16:31:23,879: Parsing model.agency_data_pipeline.adwords_urls
2018-06-15 16:31:23,882: Parsing model.agency_data_pipeline.fb_adcreative
2018-06-15 16:31:23,891: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1125493c8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112671e80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112671ba8>]}
2018-06-15 16:31:24,232: Encountered an error:
2018-06-15 16:31:24,232: 'bool' object is not iterable
2018-06-15 16:31:24,277: Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/main.py", line 41, in main
    results, succeeded = handle_and_check(args)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/main.py", line 85, in handle_and_check
    task, res = run_from_args(parsed)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/main.py", line 139, in run_from_args
    results = run_from_task(task, proj, parsed)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/main.py", line 147, in run_from_task
    result = task.run()
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/task/run.py", line 26, in run
    results = runner.run(query, ModelRunner)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/runner.py", line 217, in run
    return self.run_from_graph(Selector, Runner, query)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/runner.py", line 177, in run_from_graph
    flat_graph, linker = self.compile(self.project)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/runner.py", line 173, in compile
    (flat_graph, linker) = compiler.compile()
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/compilation.py", line 287, in compile
    root_project, all_projects)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/loader.py", line 23, in load_all
    loader.load_all(root_project, all_projects, macros))
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/loader.py", line 83, in load_all
    macros)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/loader.py", line 99, in load_project
    macros=macros)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/parser.py", line 350, in load_and_parse_sql
    return parse_sql_nodes(result, root_project, all_projects, tags, macros)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/parser.py", line 282, in parse_sql_nodes
    macros=macros)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/parser.py", line 232, in parse_node
    capture_macros=True)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 171, in get_rendered
    return render_template(template, ctx, node)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 158, in render_template
    return template.render(ctx)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/jinja2/asyncsupport.py", line 76, in render
    return original_render(self, *args, **kwargs)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/jinja2/environment.py", line 1008, in render
    return self.environment.handle_exception(exc_info, True)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/jinja2/environment.py", line 780, in handle_exception
    reraise(exc_type, exc_value, tb)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/jinja2/_compat.py", line 37, in reraise
    raise value.with_traceback(tb)
  File "<template>", line 8, in top-level template code
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 425, in __init__
    self._iterator = iter(iterable)
TypeError: 'bool' object is not iterable

2018-06-15 16:32:57,095: Tracking: tracking
2018-06-15 16:32:57,097: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e632e8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e639e8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e63eb8>]}
2018-06-15 16:32:58,092: Loading dependency project from /usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/include
2018-06-15 16:32:58,122: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/agency-data-pipeline/dbt_modules
2018-06-15 16:32:58,126: Parsing get_column_values.sql
2018-06-15 16:32:58,153: Parsing core.sql
2018-06-15 16:32:58,176: Parsing adapters/bigquery.sql
2018-06-15 16:32:58,186: Parsing adapters/common.sql
2018-06-15 16:32:58,210: Parsing adapters/redshift.sql
2018-06-15 16:32:58,230: Parsing adapters/snowflake.sql
2018-06-15 16:32:58,237: Parsing etc/bigquery.sql
2018-06-15 16:32:58,241: Parsing etc/datetime.sql
2018-06-15 16:32:58,275: Parsing etc/get_custom_schema.sql
2018-06-15 16:32:58,284: Parsing materializations/helpers.sql
2018-06-15 16:32:58,303: Parsing materializations/archive/archive.sql
2018-06-15 16:32:58,342: Parsing materializations/incremental/incremental.sql
2018-06-15 16:32:58,377: Parsing materializations/seed/bigquery.sql
2018-06-15 16:32:58,385: Parsing materializations/seed/seed.sql
2018-06-15 16:32:58,433: Parsing materializations/table/bigquery_table.sql
2018-06-15 16:32:58,478: Parsing materializations/table/table.sql
2018-06-15 16:32:58,507: Parsing materializations/view/bigquery_view.sql
2018-06-15 16:32:58,523: Parsing materializations/view/view.sql
2018-06-15 16:32:58,557: Parsing schema_tests/accepted_values.sql
2018-06-15 16:32:58,566: Parsing schema_tests/not_null.sql
2018-06-15 16:32:58,572: Parsing schema_tests/relationships.sql
2018-06-15 16:32:58,579: Parsing schema_tests/unique.sql
2018-06-15 16:32:58,600: Parsing model.agency_data_pipeline.accounts_proc
2018-06-15 16:32:58,602: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-06-15 16:32:58,605: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-06-15 16:32:58,607: Parsing model.agency_data_pipeline.adwords_campaigns
2018-06-15 16:32:58,609: Parsing model.agency_data_pipeline.adwords_join
2018-06-15 16:32:58,613: Parsing model.agency_data_pipeline.adwords_stats
2018-06-15 16:32:58,616: Parsing model.agency_data_pipeline.adwords_urls
2018-06-15 16:32:58,618: Parsing model.agency_data_pipeline.fb_adcreative
2018-06-15 16:32:58,624: Parsing model.agency_data_pipeline.fb_ads
2018-06-15 16:32:58,631: Parsing model.agency_data_pipeline.fb_ads_insights
2018-06-15 16:32:58,639: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-15 16:32:58,652: Parsing model.agency_data_pipeline.fb_ads_stats
2018-06-15 16:32:58,658: Parsing model.agency_data_pipeline.fb_conversions
2018-06-15 16:32:58,661: Parsing model.agency_data_pipeline.ga_conversions
2018-06-15 16:32:58,664: Parsing model.agency_data_pipeline.ga_proc
2018-06-15 16:32:58,679: Parsing model.agency_data_pipeline.ga_stats
2018-06-15 16:32:58,685: Parsing model.agency_data_pipeline.gsc_stats
2018-06-15 16:32:58,688: Parsing model.agency_data_pipeline.youtube_stats
2018-06-15 16:32:58,691: Parsing model.agency_data_pipeline.agg_platforms_ga
2018-06-15 16:32:58,694: Parsing model.agency_data_pipeline.agg_platforms_site
2018-06-15 16:32:58,698: Parsing model.agency_data_pipeline.agg_platforms_union
2018-06-15 16:32:58,714: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104f5c5c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104fac2b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104fac940>]}
2018-06-15 16:32:59,050: Encountered an error:
2018-06-15 16:32:59,050: Compilation Error in model ga_stats (models/base/ga/ga_stats.sql)
  Model 'model.agency_data_pipeline.ga_stats' depends on model 'clients_proc' which was not found or is disabled
2018-06-15 16:32:59,075: Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/main.py", line 41, in main
    results, succeeded = handle_and_check(args)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/main.py", line 85, in handle_and_check
    task, res = run_from_args(parsed)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/main.py", line 139, in run_from_args
    results = run_from_task(task, proj, parsed)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/main.py", line 147, in run_from_task
    result = task.run()
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/task/run.py", line 26, in run
    results = runner.run(query, ModelRunner)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/runner.py", line 217, in run
    return self.run_from_graph(Selector, Runner, query)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/runner.py", line 177, in run_from_graph
    flat_graph, linker = self.compile(self.project)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/runner.py", line 173, in compile
    (flat_graph, linker) = compiler.compile()
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/compilation.py", line 292, in compile
    root_project.get('name'))
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/parser.py", line 101, in process_refs
    target_model_package)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/utils.py", line 390, in invalid_ref_fail_unless_test
    target_model_package)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/exceptions.py", line 190, in ref_target_not_found
    raise_compiler_error(msg, model)
  File "/usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/exceptions.py", line 137, in raise_compiler_error
    raise CompilationException(msg, node)
dbt.exceptions.CompilationException: Compilation Error in model ga_stats (models/base/ga/ga_stats.sql)
  Model 'model.agency_data_pipeline.ga_stats' depends on model 'clients_proc' which was not found or is disabled

2018-06-15 16:33:29,245: Tracking: tracking
2018-06-15 16:33:29,248: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da95860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da95630>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da95d68>]}
2018-06-15 16:33:29,679: Loading dependency project from /usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/include
2018-06-15 16:33:29,710: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/agency-data-pipeline/dbt_modules
2018-06-15 16:33:29,710: Parsing get_column_values.sql
2018-06-15 16:33:29,727: Parsing core.sql
2018-06-15 16:33:29,753: Parsing adapters/bigquery.sql
2018-06-15 16:33:29,763: Parsing adapters/common.sql
2018-06-15 16:33:29,790: Parsing adapters/redshift.sql
2018-06-15 16:33:29,823: Parsing adapters/snowflake.sql
2018-06-15 16:33:29,828: Parsing etc/bigquery.sql
2018-06-15 16:33:29,833: Parsing etc/datetime.sql
2018-06-15 16:33:29,859: Parsing etc/get_custom_schema.sql
2018-06-15 16:33:29,868: Parsing materializations/helpers.sql
2018-06-15 16:33:29,889: Parsing materializations/archive/archive.sql
2018-06-15 16:33:29,928: Parsing materializations/incremental/incremental.sql
2018-06-15 16:33:29,969: Parsing materializations/seed/bigquery.sql
2018-06-15 16:33:29,979: Parsing materializations/seed/seed.sql
2018-06-15 16:33:30,032: Parsing materializations/table/bigquery_table.sql
2018-06-15 16:33:30,062: Parsing materializations/table/table.sql
2018-06-15 16:33:30,088: Parsing materializations/view/bigquery_view.sql
2018-06-15 16:33:30,103: Parsing materializations/view/view.sql
2018-06-15 16:33:30,124: Parsing schema_tests/accepted_values.sql
2018-06-15 16:33:30,130: Parsing schema_tests/not_null.sql
2018-06-15 16:33:30,135: Parsing schema_tests/relationships.sql
2018-06-15 16:33:30,141: Parsing schema_tests/unique.sql
2018-06-15 16:33:30,193: Parsing model.agency_data_pipeline.accounts_proc
2018-06-15 16:33:30,199: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-06-15 16:33:30,202: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-06-15 16:33:30,205: Parsing model.agency_data_pipeline.adwords_campaigns
2018-06-15 16:33:30,208: Parsing model.agency_data_pipeline.adwords_join
2018-06-15 16:33:30,211: Parsing model.agency_data_pipeline.adwords_stats
2018-06-15 16:33:30,213: Parsing model.agency_data_pipeline.adwords_urls
2018-06-15 16:33:30,218: Parsing model.agency_data_pipeline.fb_adcreative
2018-06-15 16:33:30,230: Parsing model.agency_data_pipeline.fb_ads
2018-06-15 16:33:30,241: Parsing model.agency_data_pipeline.fb_ads_insights
2018-06-15 16:33:30,247: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-15 16:33:30,268: Parsing model.agency_data_pipeline.fb_ads_stats
2018-06-15 16:33:30,273: Parsing model.agency_data_pipeline.fb_conversions
2018-06-15 16:33:30,277: Parsing model.agency_data_pipeline.ga_conversions
2018-06-15 16:33:30,281: Parsing model.agency_data_pipeline.ga_proc
2018-06-15 16:33:30,293: Parsing model.agency_data_pipeline.ga_stats
2018-06-15 16:33:30,297: Parsing model.agency_data_pipeline.gsc_stats
2018-06-15 16:33:30,300: Parsing model.agency_data_pipeline.youtube_stats
2018-06-15 16:33:30,302: Parsing model.agency_data_pipeline.agg_platforms_ga
2018-06-15 16:33:30,306: Parsing model.agency_data_pipeline.agg_platforms_site
2018-06-15 16:33:30,309: Parsing model.agency_data_pipeline.agg_platforms_union
2018-06-15 16:33:30,323: Found 21 models, 0 tests, 0 archives, 0 analyses, 57 macros, 0 operations, 0 seed files
2018-06-15 16:33:30,329: 
2018-06-15 16:33:30,335: Acquiring new bigquery connection "master".
2018-06-15 16:33:30,335: Opening a new connection (0 currently allocated)
2018-06-15 16:33:31,749: 16:33:31 | Concurrency: 4 threads (target='dev')
2018-06-15 16:33:31,749: 16:33:31 | 
2018-06-15 16:33:31,812: 16:33:31 | 1 of 21 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-06-15 16:33:31,813: Compiling model.agency_data_pipeline.accounts_proc
2018-06-15 16:33:31,818: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 16:33:31,812: 16:33:31 | 2 of 21 START table model agency_data_pipeline.youtube_stats......... [RUN]
2018-06-15 16:33:31,812: 16:33:31 | 3 of 21 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-06-15 16:33:31,818: Compiling model.agency_data_pipeline.youtube_stats
2018-06-15 16:33:31,813: 16:33:31 | 4 of 21 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-06-15 16:33:31,820: Acquiring new bigquery connection "accounts_proc".
2018-06-15 16:33:31,820: Compiling model.agency_data_pipeline.adwords_urls
2018-06-15 16:33:31,825: Writing injected SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-15 16:33:31,825: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-06-15 16:33:31,825: Opening a new connection (1 currently allocated)
2018-06-15 16:33:31,831: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-15 16:33:31,839: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-15 16:33:31,842: Acquiring new bigquery connection "conversion_goals_proc".
2018-06-15 16:33:31,844: Acquiring new bigquery connection "youtube_stats".
2018-06-15 16:33:31,846: Acquiring new bigquery connection "adwords_urls".
2018-06-15 16:33:31,846: Opening a new connection (2 currently allocated)
2018-06-15 16:33:31,853: Opening a new connection (3 currently allocated)
2018-06-15 16:33:31,862: Opening a new connection (4 currently allocated)
2018-06-15 16:33:32,390: Writing runtime SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 16:33:32,391: Fetching data for query accounts_proc:
create or replace table `agency_data_pipeline`.`accounts_proc`
  
  as (
    SELECT
site,
bigquery_name,
account,
platform
FROM  (
 
	SELECT  
	site,
	bigquery_name,
	account,
	platform,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.accounts`
) 

WHERE lv = time_of_entry
  );

    
2018-06-15 16:33:32,406: Writing runtime SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-15 16:33:32,410: Fetching data for query conversion_goals_proc:
create or replace table `agency_data_pipeline`.`conversion_goals_proc`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
FROM  ( 

	SELECT  
	site,
	bigquery_name,
	platform,
	trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
	goal_type,
	account,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by site, site_name, platform, account, goal_name
  );

    
2018-06-15 16:33:32,426: Writing runtime SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-15 16:33:32,428: Fetching data for query adwords_urls:
create or replace table `agency_data_pipeline`.`adwords_urls`
  
  as (
    SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url
FROM 
(
	SELECT  
	campaignid,
	max(finalurl) finalurl
	FROM `adp-apprenticeship.adwords.FINAL_URL_REPORT`
	GROUP BY campaignid
)
  );

    
2018-06-15 16:33:32,440: Writing runtime SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-15 16:33:32,445: Fetching data for query youtube_stats:
create or replace table `agency_data_pipeline`.`youtube_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
FROM 
  ( 
	SELECT  
	date, 
	'Social' as channel,
	'YouTube' as platform,
	'Coding is for Losers' as account,  
	date, 
	0 as cost, 
	max(views) as impressions, 
	max(clicks) as clicks, 
	max(subscribers) as conversions,
	regexp_replace(regexp_replace(replace(replace(replace(landing_page_url,'http://',''),'https://',''),'.html',''),r'\?.*$',''),r'([/]$)','') as url,
	video_url
	FROM `adp-apprenticeship.agency_data_pipeline.youtube`
	group by channel, platform, campaign, account, date, video_url, url
  ) 
GROUP BY date, account, channel, platform, url
  );

    
2018-06-15 16:33:32,998: Bad request while running:
create dataset
2018-06-15 16:33:32,998: 400 GET https://www.googleapis.com/bigquery/v2/projects/adp-apprenticeship/queries/91e0ecf4-8926-4882-a711-613a40f00b27?maxResults=0: Unrecognized name: campaign at [29:37]
2018-06-15 16:33:32,999: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d2686b7-5b32-48dc-ac02-ffaa7cf4031e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dd12ef0>]}
2018-06-15 16:33:33,007: Bad request while running:
create dataset
2018-06-15 16:33:33,008: 400 GET https://www.googleapis.com/bigquery/v2/projects/adp-apprenticeship/queries/620a0073-cf15-44ad-8805-072fa58cddbb?maxResults=0: Unrecognized name: site_name at [28:16]
2018-06-15 16:33:33,008: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d2686b7-5b32-48dc-ac02-ffaa7cf4031e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dca81d0>]}
2018-06-15 16:33:33,317: 16:33:33 | 2 of 21 ERROR creating table model agency_data_pipeline.youtube_stats [ERROR in 1.18s]
2018-06-15 16:33:33,319: 16:33:33 | 5 of 21 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-06-15 16:33:33,321: Compiling model.agency_data_pipeline.adwords_campaigns
2018-06-15 16:33:33,331: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-15 16:33:33,335: Acquiring new bigquery connection "adwords_campaigns".
2018-06-15 16:33:33,335: Re-using an available connection from the pool.
2018-06-15 16:33:33,451: Writing runtime SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-15 16:33:33,451: Fetching data for query adwords_campaigns:
create or replace table `agency_data_pipeline`.`adwords_campaigns`
  
  as (
    SELECT
day,
campaignid,
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM
( 
	SELECT  
	'Paid' as channel,
	'Adwords' as platform,
	day,
	campaignid,
	campaign,
	account as account,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	conversions,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `adp-apprenticeship.adwords.CAMPAIGN_PERFORMANCE_REPORT`
)
WHERE lv = _sdc_sequence
GROUP BY day, campaignid, account, channel, platform, campaign
  );

    
2018-06-15 16:33:33,652: 16:33:33 | 4 of 21 ERROR creating table model agency_data_pipeline.conversion_goals_proc [ERROR in 1.18s]
2018-06-15 16:33:33,653: 16:33:33 | 6 of 21 START table model agency_data_pipeline.mappings_ga_proc...... [RUN]
2018-06-15 16:33:33,653: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-06-15 16:33:33,664: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-15 16:33:33,669: Acquiring new bigquery connection "mappings_ga_proc".
2018-06-15 16:33:33,670: Re-using an available connection from the pool.
2018-06-15 16:33:33,793: Writing runtime SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-15 16:33:33,794: Fetching data for query mappings_ga_proc:
create or replace table `agency_data_pipeline`.`mappings_ga_proc`
  
  as (
    SELECT
client,
account,
bigquery_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
FROM  ( 

	SELECT  
	client,
	account,
	bigquery_name,
	source,
	medium,
	platform as platform_n,
	channel as channel_n,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
group by client, account, bigquery_name, source, medium, platform_n, channel_n, time_of_entry
  );

    
2018-06-15 16:33:34,445: Bad request while running:
create dataset
2018-06-15 16:33:34,445: 400 GET https://www.googleapis.com/bigquery/v2/projects/adp-apprenticeship/queries/074b2db3-8e39-46a4-9523-75fc09190ed0?maxResults=0: Unrecognized name: client at [16:9]
2018-06-15 16:33:34,445: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d2686b7-5b32-48dc-ac02-ffaa7cf4031e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dc65be0>]}
2018-06-15 16:33:34,504: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d2686b7-5b32-48dc-ac02-ffaa7cf4031e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dbd6860>]}
2018-06-15 16:33:34,541: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d2686b7-5b32-48dc-ac02-ffaa7cf4031e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dbb8828>]}
2018-06-15 16:33:34,767: 16:33:34 | 6 of 21 ERROR creating table model agency_data_pipeline.mappings_ga_proc [ERROR in 0.79s]
2018-06-15 16:33:34,768: 16:33:34 | 7 of 21 START table model agency_data_pipeline.gsc_stats............. [RUN]
2018-06-15 16:33:34,768: Compiling model.agency_data_pipeline.gsc_stats
2018-06-15 16:33:34,778: Writing injected SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-15 16:33:34,784: Acquiring new bigquery connection "gsc_stats".
2018-06-15 16:33:34,784: Re-using an available connection from the pool.
2018-06-15 16:33:34,909: Writing runtime SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-15 16:33:34,909: Fetching data for query gsc_stats:
create or replace table `agency_data_pipeline`.`gsc_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
FROM 
  ( 
	SELECT  
	date, 
	site as account,
	'Organic' as channel,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
	0.00 as cost, 
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	0 as conversions
	FROM `adp-apprenticeship.agency_data_pipeline.gsc`
	GROUP BY date, account, channel, platform, url
  ) 
GROUP BY date, account, channel, platform, url
ORDER BY account asc, date asc, url asc
  );

    
2018-06-15 16:33:35,097: 16:33:35 | 3 of 21 OK created table model agency_data_pipeline.adwords_urls..... [OK in 2.68s]
2018-06-15 16:33:35,261: Bad request while running:
create dataset
2018-06-15 16:33:35,262: 400 GET https://www.googleapis.com/bigquery/v2/projects/adp-apprenticeship/queries/14410bd7-e388-4fc6-8308-070911272108?maxResults=0: Unrecognized name: url at [21:67]
2018-06-15 16:33:35,262: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d2686b7-5b32-48dc-ac02-ffaa7cf4031e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c3ba320>]}
2018-06-15 16:33:35,303: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d2686b7-5b32-48dc-ac02-ffaa7cf4031e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dba1668>]}
2018-06-15 16:33:35,422: 16:33:35 | 1 of 21 OK created table model agency_data_pipeline.accounts_proc.... [OK in 2.73s]
2018-06-15 16:33:35,741: 16:33:35 | 7 of 21 ERROR creating table model agency_data_pipeline.gsc_stats.... [ERROR in 0.49s]
2018-06-15 16:33:36,062: 16:33:36 | 5 of 21 OK created table model agency_data_pipeline.adwords_campaigns [OK in 1.98s]
2018-06-15 16:33:36,063: 16:33:36 | 8 of 21 SKIP relation agency_data_pipeline.fb_conversions............ [SKIP]
2018-06-15 16:33:36,063: 16:33:36 | 9 of 21 START table model agency_data_pipeline.fb_adcreative......... [RUN]
2018-06-15 16:33:36,064: Compiling model.agency_data_pipeline.fb_adcreative
2018-06-15 16:33:36,077: Acquiring new bigquery connection "fb_adcreative".
2018-06-15 16:33:36,063: 16:33:36 | 10 of 21 SKIP relation agency_data_pipeline.ga_conversions........... [SKIP]
2018-06-15 16:33:36,078: Re-using an available connection from the pool.
2018-06-15 16:33:36,063: 16:33:36 | 11 of 21 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-06-15 16:33:36,063: 16:33:36 | 12 of 21 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-06-15 16:33:36,078: Fetching data for query fb_adcreative:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:33:36,078: Compiling model.agency_data_pipeline.fb_ads_insights
2018-06-15 16:33:36,079: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-15 16:33:36,099: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-06-15 16:33:36,099: Re-using an available connection from the pool.
2018-06-15 16:33:36,100: Fetching data for query fb_ads_insights_conversions:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:33:36,123: Acquiring new bigquery connection "fb_ads_insights".
2018-06-15 16:33:36,124: Re-using an available connection from the pool.
2018-06-15 16:33:36,124: Fetching data for query fb_ads_insights:


        select
            site_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:33:36,339: Bad request while running:
create dataset
2018-06-15 16:33:36,339: 400 Unrecognized name: site_name at [4:13]
2018-06-15 16:33:36,347: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d2686b7-5b32-48dc-ac02-ffaa7cf4031e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dca8240>]}
2018-06-15 16:33:36,667: 16:33:36 | 11 of 21 ERROR creating table model agency_data_pipeline.fb_ads_insights [ERROR in 0.27s]
2018-06-15 16:33:39,018: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d2686b7-5b32-48dc-ac02-ffaa7cf4031e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dc17668>]}
2018-06-15 16:33:39,037: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d2686b7-5b32-48dc-ac02-ffaa7cf4031e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dbf8908>]}
2018-06-15 16:33:39,330: 16:33:39 | 9 of 21 ERROR creating table model agency_data_pipeline.fb_adcreative [ERROR in 2.95s]
2018-06-15 16:33:39,654: 16:33:39 | 12 of 21 ERROR creating table model agency_data_pipeline.fb_ads_insights_conversions [ERROR in 2.96s]
2018-06-15 16:33:39,655: 16:33:39 | 13 of 21 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-06-15 16:33:39,656: 16:33:39 | 14 of 21 SKIP relation agency_data_pipeline.fb_ads................... [SKIP]
2018-06-15 16:33:39,656: Compiling model.agency_data_pipeline.adwords_join
2018-06-15 16:33:39,669: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-15 16:33:39,671: Acquiring new bigquery connection "adwords_join".
2018-06-15 16:33:39,671: Re-using an available connection from the pool.
2018-06-15 16:33:39,779: Writing runtime SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-15 16:33:39,780: Fetching data for query adwords_join:
create or replace table `agency_data_pipeline`.`adwords_join`
  
  as (
    SELECT
day,
a.campaign,
a.campaignid, 
account, 
channel,
platform,
b.url,
cost,
impressions,
clicks,
conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_campaigns` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`adwords_urls` b
ON a.campaignid = b.campaignid
  );

    
2018-06-15 16:33:44,639: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d2686b7-5b32-48dc-ac02-ffaa7cf4031e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dba1668>]}
2018-06-15 16:33:44,966: 16:33:44 | 13 of 21 OK created table model agency_data_pipeline.adwords_join.... [OK in 4.98s]
2018-06-15 16:33:44,966: 16:33:44 | 15 of 21 SKIP relation agency_data_pipeline.ga_proc.................. [SKIP]
2018-06-15 16:33:44,966: 16:33:44 | 16 of 21 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-06-15 16:33:44,967: Compiling model.agency_data_pipeline.adwords_stats
2018-06-15 16:33:44,976: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-15 16:33:44,978: Acquiring new bigquery connection "adwords_stats".
2018-06-15 16:33:44,979: Re-using an available connection from the pool.
2018-06-15 16:33:45,095: Writing runtime SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-15 16:33:45,096: Fetching data for query adwords_stats:
create or replace table `agency_data_pipeline`.`adwords_stats`
  
  as (
    SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_join`
GROUP BY date, account, platform, channel, url, campaign
  );

    
2018-06-15 16:33:46,914: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9d2686b7-5b32-48dc-ac02-ffaa7cf4031e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dc3de80>]}
2018-06-15 16:33:47,236: 16:33:47 | 16 of 21 OK created table model agency_data_pipeline.adwords_stats... [OK in 1.95s]
2018-06-15 16:33:47,236: 16:33:47 | 17 of 21 SKIP relation agency_data_pipeline.fb_ads_stats............. [SKIP]
2018-06-15 16:33:47,237: 16:33:47 | 18 of 21 SKIP relation agency_data_pipeline.ga_stats................. [SKIP]
2018-06-15 16:33:47,237: 16:33:47 | 19 of 21 SKIP relation agency_data_pipeline.agg_platforms_union...... [SKIP]
2018-06-15 16:33:47,238: 16:33:47 | 20 of 21 SKIP relation agency_data_pipeline.agg_platforms_site....... [SKIP]
2018-06-15 16:33:47,239: 16:33:47 | 21 of 21 SKIP relation agency_data_pipeline.agg_platforms_ga......... [SKIP]
2018-06-15 16:33:47,341: 16:33:47 | 
2018-06-15 16:33:47,342: 16:33:47 | Finished running 21 table models in 17.01s.
2018-06-15 16:33:47,342: Connection 'master' was left open.
2018-06-15 16:33:47,343: 
2018-06-15 16:33:47,343: Completed with 7 errors:
2018-06-15 16:33:47,343: 
2018-06-15 16:33:47,344: Database Error in model youtube_stats (models/base/youtube/youtube_stats.sql)
2018-06-15 16:33:47,344:   Unrecognized name: campaign at [29:37]
2018-06-15 16:33:47,344:   compiled SQL at target/run/agency_data_pipeline/base/youtube/youtube_stats.sql
2018-06-15 16:33:47,344: 
2018-06-15 16:33:47,345: Database Error in model conversion_goals_proc (models/admin/conversion_goals_proc.sql)
2018-06-15 16:33:47,345:   Unrecognized name: site_name at [28:16]
2018-06-15 16:33:47,345:   compiled SQL at target/run/agency_data_pipeline/admin/conversion_goals_proc.sql
2018-06-15 16:33:47,346: 
2018-06-15 16:33:47,346: Database Error in model mappings_ga_proc (models/admin/mappings_ga_proc.sql)
2018-06-15 16:33:47,346:   Unrecognized name: client at [16:9]
2018-06-15 16:33:47,346:   compiled SQL at target/run/agency_data_pipeline/admin/mappings_ga_proc.sql
2018-06-15 16:33:47,347: 
2018-06-15 16:33:47,347: Database Error in model gsc_stats (models/base/search-console/gsc_stats.sql)
2018-06-15 16:33:47,347:   Unrecognized name: url at [21:67]
2018-06-15 16:33:47,347:   compiled SQL at target/run/agency_data_pipeline/base/search-console/gsc_stats.sql
2018-06-15 16:33:47,347: 
2018-06-15 16:33:47,348: Database Error in model fb_ads_insights (models/base/fb-ads/fb_ads_insights.sql)
2018-06-15 16:33:47,348:   Unrecognized name: site_name at [4:13]
2018-06-15 16:33:47,348: 
2018-06-15 16:33:47,348: Compilation Error in model fb_adcreative (models/base/fb-ads/fb_adcreative.sql)
2018-06-15 16:33:47,349:   Required var 'bigquery-project' not found in config:
2018-06-15 16:33:47,349:   Vars supplied to fb_adcreative = {}
2018-06-15 16:33:47,349: 
2018-06-15 16:33:47,349: Compilation Error in model fb_ads_insights_conversions (models/base/fb-ads/fb_ads_insights_conversions.sql)
2018-06-15 16:33:47,350:   dbt was unable to infer all dependencies for the model "fb_ads_insights_conversions".
2018-06-15 16:33:47,350:   This typically happens when ref() is placed within a conditional block.
2018-06-15 16:33:47,351:   
2018-06-15 16:33:47,351:   To fix this, add the following hint to the top of the model "fb_ads_insights_conversions":
2018-06-15 16:33:47,352:   
2018-06-15 16:33:47,352:   -- depends_on: {{ ref('fb_conversions') }}
2018-06-15 16:33:47,352: 
Done. PASS=5 ERROR=7 SKIP=9 TOTAL=21
2018-06-15 16:33:47,352: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10db5a898>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10db5a5f8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10db5a6d8>]}
2018-06-15 16:33:47,668: Flushing usage events
2018-06-15 16:33:47,714: sys:1: ResourceWarning: unclosed <socket.socket fd=16, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51569), raddr=('172.217.12.13', 443)>

2018-06-15 16:33:47,715: sys:1: ResourceWarning: unclosed <socket.socket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51570), raddr=('172.217.1.74', 443)>

2018-06-15 16:33:47,715: sys:1: ResourceWarning: unclosed <socket.socket fd=17, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51572), raddr=('172.217.1.74', 443)>

2018-06-15 16:33:47,716: sys:1: ResourceWarning: unclosed <socket.socket fd=20, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51573), raddr=('172.217.1.74', 443)>

2018-06-15 16:33:47,716: sys:1: ResourceWarning: unclosed <socket.socket fd=14, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51566), raddr=('172.217.12.13', 443)>

2018-06-15 16:33:47,717: sys:1: ResourceWarning: unclosed <socket.socket fd=18, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51571), raddr=('172.217.1.74', 443)>

2018-06-15 16:33:47,717: sys:1: ResourceWarning: unclosed <socket.socket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51567), raddr=('172.217.12.13', 443)>

2018-06-15 16:33:47,718: sys:1: ResourceWarning: unclosed <socket.socket fd=15, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51568), raddr=('172.217.12.13', 443)>

2018-06-15 16:33:47,718: sys:1: ResourceWarning: unclosed <socket.socket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51565), raddr=('172.217.2.10', 443)>

2018-06-15 16:33:47,719: sys:1: ResourceWarning: unclosed <socket.socket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51564), raddr=('172.217.12.13', 443)>

2018-06-15 16:37:39,956: Tracking: tracking
2018-06-15 16:37:39,956: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a4c5eb8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a4c5f60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a4c55c0>]}
2018-06-15 16:37:40,936: Loading dependency project from /usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/include
2018-06-15 16:37:40,959: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/agency-data-pipeline/dbt_modules
2018-06-15 16:37:40,963: Parsing get_column_values.sql
2018-06-15 16:37:40,980: Parsing core.sql
2018-06-15 16:37:40,994: Parsing adapters/bigquery.sql
2018-06-15 16:37:41,003: Parsing adapters/common.sql
2018-06-15 16:37:41,025: Parsing adapters/redshift.sql
2018-06-15 16:37:41,045: Parsing adapters/snowflake.sql
2018-06-15 16:37:41,051: Parsing etc/bigquery.sql
2018-06-15 16:37:41,055: Parsing etc/datetime.sql
2018-06-15 16:37:41,080: Parsing etc/get_custom_schema.sql
2018-06-15 16:37:41,088: Parsing materializations/helpers.sql
2018-06-15 16:37:41,107: Parsing materializations/archive/archive.sql
2018-06-15 16:37:41,148: Parsing materializations/incremental/incremental.sql
2018-06-15 16:37:41,180: Parsing materializations/seed/bigquery.sql
2018-06-15 16:37:41,189: Parsing materializations/seed/seed.sql
2018-06-15 16:37:41,234: Parsing materializations/table/bigquery_table.sql
2018-06-15 16:37:41,263: Parsing materializations/table/table.sql
2018-06-15 16:37:41,287: Parsing materializations/view/bigquery_view.sql
2018-06-15 16:37:41,301: Parsing materializations/view/view.sql
2018-06-15 16:37:41,321: Parsing schema_tests/accepted_values.sql
2018-06-15 16:37:41,327: Parsing schema_tests/not_null.sql
2018-06-15 16:37:41,331: Parsing schema_tests/relationships.sql
2018-06-15 16:37:41,336: Parsing schema_tests/unique.sql
2018-06-15 16:37:41,377: Parsing model.agency_data_pipeline.accounts_proc
2018-06-15 16:37:41,382: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-06-15 16:37:41,386: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-06-15 16:37:41,389: Parsing model.agency_data_pipeline.adwords_campaigns
2018-06-15 16:37:41,391: Parsing model.agency_data_pipeline.adwords_join
2018-06-15 16:37:41,394: Parsing model.agency_data_pipeline.adwords_stats
2018-06-15 16:37:41,397: Parsing model.agency_data_pipeline.adwords_urls
2018-06-15 16:37:41,398: Parsing model.agency_data_pipeline.fb_adcreative
2018-06-15 16:37:41,404: Parsing model.agency_data_pipeline.fb_ads
2018-06-15 16:37:41,411: Parsing model.agency_data_pipeline.fb_ads_insights
2018-06-15 16:37:41,419: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-15 16:37:41,432: Parsing model.agency_data_pipeline.fb_ads_stats
2018-06-15 16:37:41,436: Parsing model.agency_data_pipeline.fb_conversions
2018-06-15 16:37:41,438: Parsing model.agency_data_pipeline.ga_conversions
2018-06-15 16:37:41,441: Parsing model.agency_data_pipeline.ga_proc
2018-06-15 16:37:41,454: Parsing model.agency_data_pipeline.ga_stats
2018-06-15 16:37:41,462: Parsing model.agency_data_pipeline.gsc_stats
2018-06-15 16:37:41,465: Parsing model.agency_data_pipeline.youtube_stats
2018-06-15 16:37:41,467: Parsing model.agency_data_pipeline.agg_platforms_ga
2018-06-15 16:37:41,470: Parsing model.agency_data_pipeline.agg_platforms_site
2018-06-15 16:37:41,473: Parsing model.agency_data_pipeline.agg_platforms_union
2018-06-15 16:37:41,487: Found 21 models, 0 tests, 0 archives, 0 analyses, 57 macros, 0 operations, 0 seed files
2018-06-15 16:37:41,493: 
2018-06-15 16:37:41,498: Acquiring new bigquery connection "master".
2018-06-15 16:37:41,498: Opening a new connection (0 currently allocated)
2018-06-15 16:37:42,225: 16:37:42 | Concurrency: 4 threads (target='dev')
2018-06-15 16:37:42,225: 16:37:42 | 
2018-06-15 16:37:42,278: 16:37:42 | 1 of 21 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-06-15 16:37:42,278: 16:37:42 | 2 of 21 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-06-15 16:37:42,278: Compiling model.agency_data_pipeline.adwords_campaigns
2018-06-15 16:37:42,278: 16:37:42 | 3 of 21 START table model agency_data_pipeline.mappings_ga_proc...... [RUN]
2018-06-15 16:37:42,279: Compiling model.agency_data_pipeline.adwords_urls
2018-06-15 16:37:42,278: 16:37:42 | 4 of 21 START table model agency_data_pipeline.gsc_stats............. [RUN]
2018-06-15 16:37:42,285: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-06-15 16:37:42,288: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-15 16:37:42,294: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-15 16:37:42,294: Compiling model.agency_data_pipeline.gsc_stats
2018-06-15 16:37:42,299: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-15 16:37:42,304: Writing injected SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-15 16:37:42,306: Acquiring new bigquery connection "adwords_urls".
2018-06-15 16:37:42,306: Opening a new connection (1 currently allocated)
2018-06-15 16:37:42,308: Acquiring new bigquery connection "mappings_ga_proc".
2018-06-15 16:37:42,309: Acquiring new bigquery connection "gsc_stats".
2018-06-15 16:37:42,311: Acquiring new bigquery connection "adwords_campaigns".
2018-06-15 16:37:42,312: Opening a new connection (2 currently allocated)
2018-06-15 16:37:42,314: Opening a new connection (3 currently allocated)
2018-06-15 16:37:42,318: Opening a new connection (4 currently allocated)
2018-06-15 16:37:42,795: Writing runtime SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-15 16:37:42,796: Fetching data for query adwords_campaigns:
create or replace table `agency_data_pipeline`.`adwords_campaigns`
  
  as (
    SELECT
day,
campaignid,
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM
( 
	SELECT  
	'Paid' as channel,
	'Adwords' as platform,
	day,
	campaignid,
	campaign,
	account as account,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	conversions,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `adp-apprenticeship.adwords.CAMPAIGN_PERFORMANCE_REPORT`
)
WHERE lv = _sdc_sequence
GROUP BY day, campaignid, account, channel, platform, campaign
  );

    
2018-06-15 16:37:42,943: Writing runtime SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-15 16:37:42,944: Fetching data for query mappings_ga_proc:
create or replace table `agency_data_pipeline`.`mappings_ga_proc`
  
  as (
    SELECT
site,
account,
bigquery_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
FROM  ( 

	SELECT  
	site,
	account,
	bigquery_name,
	source,
	medium,
	platform as platform_n,
	channel as channel_n,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
group by site, account, bigquery_name, source, medium, platform_n, channel_n, time_of_entry
  );

    
2018-06-15 16:37:42,959: Writing runtime SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-15 16:37:42,960: Fetching data for query gsc_stats:
create or replace table `agency_data_pipeline`.`gsc_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
FROM 
  ( 
	SELECT  
	date, 
	site as account,
	'Organic' as channel,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(replace(landing_page_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
	0.00 as cost, 
	max(impressions) as impressions, 
	max(clicks) as clicks, 
	0 as conversions
	FROM `adp-apprenticeship.agency_data_pipeline.gsc`
	GROUP BY date, account, channel, platform, url
  ) 
GROUP BY date, account, channel, platform, url
ORDER BY account asc, date asc, url asc
  );

    
2018-06-15 16:37:43,236: Writing runtime SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-15 16:37:43,237: Fetching data for query adwords_urls:
create or replace table `agency_data_pipeline`.`adwords_urls`
  
  as (
    SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url
FROM 
(
	SELECT  
	campaignid,
	max(finalurl) finalurl
	FROM `adp-apprenticeship.adwords.FINAL_URL_REPORT`
	GROUP BY campaignid
)
  );

    
2018-06-15 16:37:43,519: Bad request while running:
create dataset
2018-06-15 16:37:43,520: 400 GET https://www.googleapis.com/bigquery/v2/projects/adp-apprenticeship/queries/5e305e4d-c6ec-4b75-bebf-bad6e9cf681d?maxResults=0: No matching signature for aggregate function SUM for argument types: STRING. Supported signatures: SUM(INT64); SUM(FLOAT64); SUM(NUMERIC) at [11:1]
2018-06-15 16:37:43,520: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c6f4b993-5d72-42e8-99f6-8b40137e0ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108d27198>]}
2018-06-15 16:37:43,838: 16:37:43 | 4 of 21 ERROR creating table model agency_data_pipeline.gsc_stats.... [ERROR in 1.23s]
2018-06-15 16:37:43,838: 16:37:43 | 5 of 21 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-06-15 16:37:43,838: Compiling model.agency_data_pipeline.accounts_proc
2018-06-15 16:37:43,845: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 16:37:43,846: Acquiring new bigquery connection "accounts_proc".
2018-06-15 16:37:43,846: Re-using an available connection from the pool.
2018-06-15 16:37:44,007: Writing runtime SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 16:37:44,007: Fetching data for query accounts_proc:
create or replace table `agency_data_pipeline`.`accounts_proc`
  
  as (
    SELECT
site,
bigquery_name,
account,
platform
FROM  (
 
	SELECT  
	site,
	bigquery_name,
	account,
	platform,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.accounts`
) 

WHERE lv = time_of_entry
  );

    
2018-06-15 16:37:44,664: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c6f4b993-5d72-42e8-99f6-8b40137e0ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a6d82e8>]}
2018-06-15 16:37:44,949: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c6f4b993-5d72-42e8-99f6-8b40137e0ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a6d82b0>]}
2018-06-15 16:37:44,982: 16:37:44 | 1 of 21 OK created table model agency_data_pipeline.adwords_campaigns [OK in 2.39s]
2018-06-15 16:37:44,984: 16:37:44 | 6 of 21 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-06-15 16:37:44,986: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-06-15 16:37:44,996: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-15 16:37:44,999: Acquiring new bigquery connection "conversion_goals_proc".
2018-06-15 16:37:45,000: Re-using an available connection from the pool.
2018-06-15 16:37:45,085: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c6f4b993-5d72-42e8-99f6-8b40137e0ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a6d8320>]}
2018-06-15 16:37:45,161: Writing runtime SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-15 16:37:45,162: Fetching data for query conversion_goals_proc:
create or replace table `agency_data_pipeline`.`conversion_goals_proc`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
FROM  ( 

	SELECT  
	site,
	bigquery_name,
	platform,
	trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
	goal_type,
	account,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by site, bigquery_name, platform, account, goal_name
  );

    
2018-06-15 16:37:45,317: 16:37:45 | 2 of 21 OK created table model agency_data_pipeline.adwords_urls..... [OK in 2.67s]
2018-06-15 16:37:45,318: 16:37:45 | 7 of 21 START table model agency_data_pipeline.youtube_stats......... [RUN]
2018-06-15 16:37:45,319: Compiling model.agency_data_pipeline.youtube_stats
2018-06-15 16:37:45,326: Writing injected SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-15 16:37:45,328: Acquiring new bigquery connection "youtube_stats".
2018-06-15 16:37:45,329: Re-using an available connection from the pool.
2018-06-15 16:37:45,470: Writing runtime SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-15 16:37:45,471: Fetching data for query youtube_stats:
create or replace table `agency_data_pipeline`.`youtube_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
FROM 
  ( 
	SELECT  
	date, 
	'Social' as channel,
	'YouTube' as platform,
	'Coding is for Losers' as account,  
	date, 
	0 as cost, 
	max(views) as impressions, 
	max(clicks) as clicks, 
	max(subscribers) as conversions,
	regexp_replace(regexp_replace(replace(replace(replace(landing_page_url,'http://',''),'https://',''),'.html',''),r'\?.*$',''),r'([/]$)','') as url,
	video_url
	FROM `adp-apprenticeship.agency_data_pipeline.youtube`
	group by channel, platform, account, date, video_url, url
  ) 
GROUP BY date, account, channel, platform, url
  );

    
2018-06-15 16:37:45,646: 16:37:45 | 3 of 21 OK created table model agency_data_pipeline.mappings_ga_proc. [OK in 2.80s]
2018-06-15 16:37:45,860: Bad request while running:
create dataset
2018-06-15 16:37:45,860: 400 GET https://www.googleapis.com/bigquery/v2/projects/adp-apprenticeship/queries/d3ac27ad-833f-4661-a03d-dae5fd551178?maxResults=0: Name date in GROUP BY clause is ambiguous; it may refer to multiple columns in the SELECT-list at [29:46]
2018-06-15 16:37:45,861: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c6f4b993-5d72-42e8-99f6-8b40137e0ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a672b00>]}
2018-06-15 16:37:45,939: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c6f4b993-5d72-42e8-99f6-8b40137e0ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108d27198>]}
2018-06-15 16:37:46,176: 16:37:46 | 7 of 21 ERROR creating table model agency_data_pipeline.youtube_stats [ERROR in 0.54s]
2018-06-15 16:37:46,496: 16:37:46 | 5 of 21 OK created table model agency_data_pipeline.accounts_proc.... [OK in 2.10s]
2018-06-15 16:37:47,137: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c6f4b993-5d72-42e8-99f6-8b40137e0ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a6d82e8>]}
2018-06-15 16:37:47,457: 16:37:47 | 6 of 21 OK created table model agency_data_pipeline.conversion_goals_proc [OK in 2.15s]
2018-06-15 16:37:47,458: 16:37:47 | 8 of 21 START table model agency_data_pipeline.fb_ads_insights....... [RUN]
2018-06-15 16:37:47,458: 16:37:47 | 9 of 21 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-06-15 16:37:47,459: Compiling model.agency_data_pipeline.ga_conversions
2018-06-15 16:37:47,459: Compiling model.agency_data_pipeline.fb_ads_insights
2018-06-15 16:37:47,458: 16:37:47 | 11 of 21 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-06-15 16:37:47,458: 16:37:47 | 10 of 21 START table model agency_data_pipeline.fb_conversions....... [RUN]
2018-06-15 16:37:47,467: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-15 16:37:47,469: Compiling model.agency_data_pipeline.fb_adcreative
2018-06-15 16:37:47,469: Compiling model.agency_data_pipeline.fb_conversions
2018-06-15 16:37:47,478: Acquiring new bigquery connection "fb_ads_insights".
2018-06-15 16:37:47,495: Acquiring new bigquery connection "fb_adcreative".
2018-06-15 16:37:47,501: Writing injected SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-15 16:37:47,501: Re-using an available connection from the pool.
2018-06-15 16:37:47,502: Fetching data for query fb_ads_insights:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:37:47,504: Acquiring new bigquery connection "ga_conversions".
2018-06-15 16:37:47,504: Re-using an available connection from the pool.
2018-06-15 16:37:47,505: Fetching data for query fb_adcreative:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:37:47,506: Re-using an available connection from the pool.
2018-06-15 16:37:47,520: Acquiring new bigquery connection "fb_conversions".
2018-06-15 16:37:47,521: Re-using an available connection from the pool.
2018-06-15 16:37:47,638: Writing runtime SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-15 16:37:47,638: Fetching data for query fb_conversions:
create or replace table `agency_data_pipeline`.`fb_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'FB Ads'
  );

    
2018-06-15 16:37:47,654: Writing runtime SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-15 16:37:47,655: Fetching data for query ga_conversions:
create or replace table `agency_data_pipeline`.`ga_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'Google Analytics'
  );

    
2018-06-15 16:37:49,167: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c6f4b993-5d72-42e8-99f6-8b40137e0ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107ac11d0>]}
2018-06-15 16:37:49,377: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-15 16:37:49,492: 16:37:49 | 8 of 21 ERROR creating table model agency_data_pipeline.fb_ads_insights [ERROR in 1.71s]
2018-06-15 16:37:49,564: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c6f4b993-5d72-42e8-99f6-8b40137e0ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a660128>]}
2018-06-15 16:37:49,568: Writing runtime SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-15 16:37:49,570: Fetching data for query fb_adcreative:
create or replace table `agency_data_pipeline`.`fb_adcreative`
  
  as (
    



with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


  );

    
2018-06-15 16:37:49,805: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c6f4b993-5d72-42e8-99f6-8b40137e0ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a672cf8>]}
2018-06-15 16:37:49,922: 16:37:49 | 9 of 21 OK created table model agency_data_pipeline.ga_conversions... [OK in 2.10s]
2018-06-15 16:37:49,990: Bad request while running:
create dataset
2018-06-15 16:37:49,990: 400 GET https://www.googleapis.com/bigquery/v2/projects/adp-apprenticeship/queries/3d007da6-bca4-4dd8-9a2a-57881b6a11d6?maxResults=0: Unrecognized name: object_url at [14:25]
2018-06-15 16:37:49,990: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c6f4b993-5d72-42e8-99f6-8b40137e0ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a6c4160>]}
2018-06-15 16:37:50,245: 16:37:50 | 10 of 21 OK created table model agency_data_pipeline.fb_conversions.. [OK in 2.34s]
2018-06-15 16:37:50,561: 16:37:50 | 11 of 21 ERROR creating table model agency_data_pipeline.fb_adcreative [ERROR in 2.52s]
2018-06-15 16:37:50,562: 16:37:50 | 12 of 21 SKIP relation agency_data_pipeline.fb_ads................... [SKIP]
2018-06-15 16:37:50,562: 16:37:50 | 13 of 21 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-06-15 16:37:50,562: Compiling model.agency_data_pipeline.adwords_join
2018-06-15 16:37:50,573: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-15 16:37:50,575: Acquiring new bigquery connection "adwords_join".
2018-06-15 16:37:50,575: Re-using an available connection from the pool.
2018-06-15 16:37:50,703: Writing runtime SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-15 16:37:50,703: Fetching data for query adwords_join:
create or replace table `agency_data_pipeline`.`adwords_join`
  
  as (
    SELECT
day,
a.campaign,
a.campaignid, 
account, 
channel,
platform,
b.url,
cost,
impressions,
clicks,
conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_campaigns` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`adwords_urls` b
ON a.campaignid = b.campaignid
  );

    
2018-06-15 16:37:52,986: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c6f4b993-5d72-42e8-99f6-8b40137e0ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a6d82e8>]}
2018-06-15 16:37:53,309: 16:37:53 | 13 of 21 OK created table model agency_data_pipeline.adwords_join.... [OK in 2.42s]
2018-06-15 16:37:53,310: 16:37:53 | 14 of 21 START table model agency_data_pipeline.ga_proc.............. [RUN]
2018-06-15 16:37:53,311: Compiling model.agency_data_pipeline.ga_proc
2018-06-15 16:37:53,310: 16:37:53 | 15 of 21 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-06-15 16:37:53,319: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-15 16:37:53,310: 16:37:53 | 16 of 21 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-06-15 16:37:53,338: Compiling model.agency_data_pipeline.adwords_stats
2018-06-15 16:37:53,343: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-15 16:37:53,344: Acquiring new bigquery connection "ga_proc".
2018-06-15 16:37:53,346: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-06-15 16:37:53,347: Re-using an available connection from the pool.
2018-06-15 16:37:53,347: Fetching data for query ga_proc:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`

        
        ##where 1 = 1
        where platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:37:53,348: Acquiring new bigquery connection "adwords_stats".
2018-06-15 16:37:53,348: Re-using an available connection from the pool.
2018-06-15 16:37:53,349: Fetching data for query fb_ads_insights_conversions:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:37:53,349: Re-using an available connection from the pool.
2018-06-15 16:37:53,500: Writing runtime SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-15 16:37:53,501: Fetching data for query adwords_stats:
create or replace table `agency_data_pipeline`.`adwords_stats`
  
  as (
    SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_join`
GROUP BY date, account, platform, channel, url, campaign
  );

    
2018-06-15 16:37:54,044: Fetching data for query fb_ads_insights_conversions:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`

        
        ##where 1 = 1
        where goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and client_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:37:54,264: Bad request while running:
create dataset
2018-06-15 16:37:54,265: 400 Unrecognized name: client_name at [15:13]
2018-06-15 16:37:54,266: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c6f4b993-5d72-42e8-99f6-8b40137e0ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107ac17f0>]}
2018-06-15 16:37:54,583: 16:37:54 | 15 of 21 ERROR creating table model agency_data_pipeline.fb_ads_insights_conversions [ERROR in 0.95s]
2018-06-15 16:37:55,139: Fetching data for query ga_proc:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:37:55,653: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c6f4b993-5d72-42e8-99f6-8b40137e0ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a648550>]}
2018-06-15 16:37:55,973: 16:37:55 | 16 of 21 OK created table model agency_data_pipeline.adwords_stats... [OK in 2.31s]
2018-06-15 16:37:57,512: Writing injected SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-15 16:37:57,682: Writing runtime SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-15 16:37:57,683: Fetching data for query ga_proc:
create or replace table `agency_data_pipeline`.`ga_proc`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`




with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'cifl' as bigquery_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			sessions,
			## goal completion columns
			
				
					cast(goal1completions as int64) 
					 
					 as goal_completions,  
				
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.ga_.report` 

		    
	   

)


SELECT 
bigquery_name,
lookup_platform,
date,
url,
source,
medium,
sum(sessions) sessions,
sum(goal_completions) goal_completions
FROM ga_report
where lv = _sdc_sequence
group by bigquery_name, lookup_platform, date, url, source, medium


  );

    
2018-06-15 16:37:57,882: Unhandled error while running:
create dataset
2018-06-15 16:37:57,882: 404 Not found: Table adp-apprenticeship:ga_.report. Please verify that the table exists and the correct location was used for the job.
2018-06-15 16:37:57,882: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c6f4b993-5d72-42e8-99f6-8b40137e0ca3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a648a58>]}
2018-06-15 16:37:58,205: 16:37:58 | 14 of 21 ERROR creating table model agency_data_pipeline.ga_proc..... [ERROR in 4.57s]
2018-06-15 16:37:58,205: 16:37:58 | 17 of 21 SKIP relation agency_data_pipeline.ga_stats................. [SKIP]
2018-06-15 16:37:58,206: 16:37:58 | 18 of 21 SKIP relation agency_data_pipeline.fb_ads_stats............. [SKIP]
2018-06-15 16:37:58,207: 16:37:58 | 19 of 21 SKIP relation agency_data_pipeline.agg_platforms_union...... [SKIP]
2018-06-15 16:37:58,207: 16:37:58 | 20 of 21 SKIP relation agency_data_pipeline.agg_platforms_site....... [SKIP]
2018-06-15 16:37:58,208: 16:37:58 | 21 of 21 SKIP relation agency_data_pipeline.agg_platforms_ga......... [SKIP]
2018-06-15 16:37:58,283: 16:37:58 | 
2018-06-15 16:37:58,284: 16:37:58 | Finished running 21 table models in 16.79s.
2018-06-15 16:37:58,284: Connection 'master' was left open.
2018-06-15 16:37:58,284: 
2018-06-15 16:37:58,284: Completed with 6 errors:
2018-06-15 16:37:58,284: 
2018-06-15 16:37:58,284: Database Error in model gsc_stats (models/base/search-console/gsc_stats.sql)
2018-06-15 16:37:58,285:   No matching signature for aggregate function SUM for argument types: STRING. Supported signatures: SUM(INT64); SUM(FLOAT64); SUM(NUMERIC) at [11:1]
2018-06-15 16:37:58,285:   compiled SQL at target/run/agency_data_pipeline/base/search-console/gsc_stats.sql
2018-06-15 16:37:58,285: 
2018-06-15 16:37:58,285: Database Error in model youtube_stats (models/base/youtube/youtube_stats.sql)
2018-06-15 16:37:58,285:   Name date in GROUP BY clause is ambiguous; it may refer to multiple columns in the SELECT-list at [29:46]
2018-06-15 16:37:58,285:   compiled SQL at target/run/agency_data_pipeline/base/youtube/youtube_stats.sql
2018-06-15 16:37:58,286: 
2018-06-15 16:37:58,286: Compilation Error in model fb_ads_insights (models/base/fb-ads/fb_ads_insights.sql)
2018-06-15 16:37:58,286:   Required var 'bigquery-project' not found in config:
2018-06-15 16:37:58,286:   Vars supplied to fb_ads_insights = {}
2018-06-15 16:37:58,286: 
2018-06-15 16:37:58,286: Database Error in model fb_adcreative (models/base/fb-ads/fb_adcreative.sql)
2018-06-15 16:37:58,287:   Unrecognized name: object_url at [14:25]
2018-06-15 16:37:58,287:   compiled SQL at target/run/agency_data_pipeline/base/fb-ads/fb_adcreative.sql
2018-06-15 16:37:58,287: 
2018-06-15 16:37:58,287: Database Error in model fb_ads_insights_conversions (models/base/fb-ads/fb_ads_insights_conversions.sql)
2018-06-15 16:37:58,287:   Unrecognized name: client_name at [15:13]
2018-06-15 16:37:58,287: 
2018-06-15 16:37:58,288: Runtime Error in model ga_proc (models/base/ga/ga_proc.sql)
2018-06-15 16:37:58,288:   404 Not found: Table adp-apprenticeship:ga_.report. Please verify that the table exists and the correct location was used for the job.
2018-06-15 16:37:58,288: 
Done. PASS=9 ERROR=6 SKIP=6 TOTAL=21
2018-06-15 16:37:58,288: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a5887b8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a588940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a5887f0>]}
2018-06-15 16:37:58,608: Flushing usage events
2018-06-15 16:37:58,651: sys:1: ResourceWarning: unclosed <socket.socket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51603), raddr=('172.217.2.10', 443)>

2018-06-15 16:37:58,651: sys:1: ResourceWarning: unclosed <socket.socket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51599), raddr=('172.217.12.13', 443)>

2018-06-15 16:37:58,652: sys:1: ResourceWarning: unclosed <socket.socket fd=17, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51601), raddr=('172.217.2.10', 443)>

2018-06-15 16:37:58,652: sys:1: ResourceWarning: unclosed <socket.socket fd=20, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51604), raddr=('172.217.2.10', 443)>

2018-06-15 16:37:58,652: sys:1: ResourceWarning: unclosed <socket.socket fd=18, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51602), raddr=('172.217.2.10', 443)>

2018-06-15 16:37:58,653: sys:1: ResourceWarning: unclosed <socket.socket fd=16, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51597), raddr=('172.217.12.13', 443)>

2018-06-15 16:37:58,653: sys:1: ResourceWarning: unclosed <socket.socket fd=15, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51598), raddr=('172.217.12.13', 443)>

2018-06-15 16:37:58,654: sys:1: ResourceWarning: unclosed <socket.socket fd=14, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51600), raddr=('172.217.12.13', 443)>

2018-06-15 16:37:58,654: sys:1: ResourceWarning: unclosed <socket.socket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51596), raddr=('172.217.2.10', 443)>

2018-06-15 16:37:58,654: sys:1: ResourceWarning: unclosed <socket.socket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51595), raddr=('172.217.12.13', 443)>

2018-06-15 16:44:13,744: Tracking: tracking
2018-06-15 16:44:13,746: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10597e048>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10597e588>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10597e4e0>]}
2018-06-15 16:44:14,745: Loading dependency project from /usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/include
2018-06-15 16:44:14,769: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/agency-data-pipeline/dbt_modules
2018-06-15 16:44:14,773: Parsing get_column_values.sql
2018-06-15 16:44:14,793: Parsing core.sql
2018-06-15 16:44:14,807: Parsing adapters/bigquery.sql
2018-06-15 16:44:14,816: Parsing adapters/common.sql
2018-06-15 16:44:14,848: Parsing adapters/redshift.sql
2018-06-15 16:44:14,882: Parsing adapters/snowflake.sql
2018-06-15 16:44:14,890: Parsing etc/bigquery.sql
2018-06-15 16:44:14,896: Parsing etc/datetime.sql
2018-06-15 16:44:14,923: Parsing etc/get_custom_schema.sql
2018-06-15 16:44:14,931: Parsing materializations/helpers.sql
2018-06-15 16:44:14,951: Parsing materializations/archive/archive.sql
2018-06-15 16:44:14,993: Parsing materializations/incremental/incremental.sql
2018-06-15 16:44:15,032: Parsing materializations/seed/bigquery.sql
2018-06-15 16:44:15,041: Parsing materializations/seed/seed.sql
2018-06-15 16:44:15,087: Parsing materializations/table/bigquery_table.sql
2018-06-15 16:44:15,117: Parsing materializations/table/table.sql
2018-06-15 16:44:15,144: Parsing materializations/view/bigquery_view.sql
2018-06-15 16:44:15,160: Parsing materializations/view/view.sql
2018-06-15 16:44:15,180: Parsing schema_tests/accepted_values.sql
2018-06-15 16:44:15,190: Parsing schema_tests/not_null.sql
2018-06-15 16:44:15,195: Parsing schema_tests/relationships.sql
2018-06-15 16:44:15,202: Parsing schema_tests/unique.sql
2018-06-15 16:44:15,245: Parsing model.agency_data_pipeline.accounts_proc
2018-06-15 16:44:15,249: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-06-15 16:44:15,253: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-06-15 16:44:15,256: Parsing model.agency_data_pipeline.adwords_campaigns
2018-06-15 16:44:15,261: Parsing model.agency_data_pipeline.adwords_join
2018-06-15 16:44:15,265: Parsing model.agency_data_pipeline.adwords_stats
2018-06-15 16:44:15,268: Parsing model.agency_data_pipeline.adwords_urls
2018-06-15 16:44:15,270: Parsing model.agency_data_pipeline.fb_adcreative
2018-06-15 16:44:15,278: Parsing model.agency_data_pipeline.fb_ads
2018-06-15 16:44:15,285: Parsing model.agency_data_pipeline.fb_ads_insights
2018-06-15 16:44:15,292: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-15 16:44:15,306: Parsing model.agency_data_pipeline.fb_ads_stats
2018-06-15 16:44:15,312: Parsing model.agency_data_pipeline.fb_conversions
2018-06-15 16:44:15,315: Parsing model.agency_data_pipeline.ga_conversions
2018-06-15 16:44:15,317: Parsing model.agency_data_pipeline.ga_proc
2018-06-15 16:44:15,329: Parsing model.agency_data_pipeline.ga_stats
2018-06-15 16:44:15,333: Parsing model.agency_data_pipeline.gsc_stats
2018-06-15 16:44:15,335: Parsing model.agency_data_pipeline.youtube_stats
2018-06-15 16:44:15,338: Parsing model.agency_data_pipeline.agg_platforms_ga
2018-06-15 16:44:15,341: Parsing model.agency_data_pipeline.agg_platforms_site
2018-06-15 16:44:15,344: Parsing model.agency_data_pipeline.agg_platforms_union
2018-06-15 16:44:15,358: Found 21 models, 0 tests, 0 archives, 0 analyses, 57 macros, 0 operations, 0 seed files
2018-06-15 16:44:15,364: 
2018-06-15 16:44:15,369: Acquiring new bigquery connection "master".
2018-06-15 16:44:15,369: Opening a new connection (0 currently allocated)
2018-06-15 16:44:16,694: 16:44:16 | Concurrency: 4 threads (target='dev')
2018-06-15 16:44:16,695: 16:44:16 | 
2018-06-15 16:44:16,766: 16:44:16 | 1 of 21 START table model agency_data_pipeline.youtube_stats......... [RUN]
2018-06-15 16:44:16,767: Compiling model.agency_data_pipeline.youtube_stats
2018-06-15 16:44:16,767: 16:44:16 | 2 of 21 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-06-15 16:44:16,774: Writing injected SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-15 16:44:16,767: 16:44:16 | 3 of 21 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-06-15 16:44:16,775: Compiling model.agency_data_pipeline.adwords_urls
2018-06-15 16:44:16,767: 16:44:16 | 4 of 21 START table model agency_data_pipeline.mappings_ga_proc...... [RUN]
2018-06-15 16:44:16,775: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-06-15 16:44:16,777: Acquiring new bigquery connection "youtube_stats".
2018-06-15 16:44:16,783: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-15 16:44:16,783: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-06-15 16:44:16,793: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-15 16:44:16,794: Opening a new connection (1 currently allocated)
2018-06-15 16:44:16,807: Acquiring new bigquery connection "adwords_urls".
2018-06-15 16:44:16,807: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-15 16:44:16,809: Acquiring new bigquery connection "conversion_goals_proc".
2018-06-15 16:44:16,811: Opening a new connection (2 currently allocated)
2018-06-15 16:44:16,814: Acquiring new bigquery connection "mappings_ga_proc".
2018-06-15 16:44:16,815: Opening a new connection (3 currently allocated)
2018-06-15 16:44:16,820: Opening a new connection (4 currently allocated)
2018-06-15 16:44:17,303: Writing runtime SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-15 16:44:17,310: Writing runtime SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-15 16:44:17,311: Fetching data for query youtube_stats:
create or replace table `agency_data_pipeline`.`youtube_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
FROM 
  ( 
	SELECT  
	date, 
	'Social' as channel,
	'YouTube' as platform,
	'Coding is for Losers' as account,  
	date, 
	0 as cost, 
	max(views) as impressions, 
	max(clicks) as clicks, 
	max(subscribers) as conversions,
	regexp_replace(regexp_replace(replace(replace(replace(landing_page_url,'http://',''),'https://',''),'.html',''),r'\?.*$',''),r'([/]$)','') as url,
	video_url
	FROM `adp-apprenticeship.agency_data_pipeline.youtube`
	group by channel, platform, account, date, video_url, url
  ) 
GROUP BY date, account, channel, platform, url
  );

    
2018-06-15 16:44:17,312: Fetching data for query adwords_urls:
create or replace table `agency_data_pipeline`.`adwords_urls`
  
  as (
    SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url
FROM 
(
	SELECT  
	campaignid,
	max(finalurl) finalurl
	FROM `adp-apprenticeship.adwords.FINAL_URL_REPORT`
	GROUP BY campaignid
)
  );

    
2018-06-15 16:44:17,337: Writing runtime SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-15 16:44:17,345: Writing runtime SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-15 16:44:17,346: Fetching data for query conversion_goals_proc:
create or replace table `agency_data_pipeline`.`conversion_goals_proc`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
FROM  ( 

	SELECT  
	site,
	bigquery_name,
	platform,
	trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
	goal_type,
	account,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by site, bigquery_name, platform, account, goal_name
  );

    
2018-06-15 16:44:17,346: Fetching data for query mappings_ga_proc:
create or replace table `agency_data_pipeline`.`mappings_ga_proc`
  
  as (
    SELECT
site,
account,
bigquery_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
FROM  ( 

	SELECT  
	site,
	account,
	bigquery_name,
	source,
	medium,
	platform as platform_n,
	channel as channel_n,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
group by site, account, bigquery_name, source, medium, platform_n, channel_n, time_of_entry
  );

    
2018-06-15 16:44:17,916: Bad request while running:
create dataset
2018-06-15 16:44:17,917: 400 GET https://www.googleapis.com/bigquery/v2/projects/adp-apprenticeship/queries/62e70cf7-edd6-40ef-891d-f0af568f91a8?maxResults=0: Name date in GROUP BY clause is ambiguous; it may refer to multiple columns in the SELECT-list at [29:46]
2018-06-15 16:44:17,918: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72ada15d-a7b0-4c12-bb66-7e20e4b7c70b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a875c0>]}
2018-06-15 16:44:18,254: 16:44:18 | 1 of 21 ERROR creating table model agency_data_pipeline.youtube_stats [ERROR in 1.15s]
2018-06-15 16:44:18,255: 16:44:18 | 5 of 21 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-06-15 16:44:18,255: Compiling model.agency_data_pipeline.adwords_campaigns
2018-06-15 16:44:18,265: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-15 16:44:18,267: Acquiring new bigquery connection "adwords_campaigns".
2018-06-15 16:44:18,267: Re-using an available connection from the pool.
2018-06-15 16:44:18,384: Writing runtime SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-15 16:44:18,384: Fetching data for query adwords_campaigns:
create or replace table `agency_data_pipeline`.`adwords_campaigns`
  
  as (
    SELECT
day,
campaignid,
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM
( 
	SELECT  
	'Paid' as channel,
	'Adwords' as platform,
	day,
	campaignid,
	campaign,
	account as account,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	conversions,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `adp-apprenticeship.adwords.CAMPAIGN_PERFORMANCE_REPORT`
)
WHERE lv = _sdc_sequence
GROUP BY day, campaignid, account, channel, platform, campaign
  );

    
2018-06-15 16:44:19,409: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72ada15d-a7b0-4c12-bb66-7e20e4b7c70b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b932e8>]}
2018-06-15 16:44:19,725: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72ada15d-a7b0-4c12-bb66-7e20e4b7c70b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b93278>]}
2018-06-15 16:44:19,740: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72ada15d-a7b0-4c12-bb66-7e20e4b7c70b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b934e0>]}
2018-06-15 16:44:19,791: 16:44:19 | 2 of 21 OK created table model agency_data_pipeline.adwords_urls..... [OK in 2.63s]
2018-06-15 16:44:19,793: 16:44:19 | 6 of 21 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-06-15 16:44:19,795: Compiling model.agency_data_pipeline.accounts_proc
2018-06-15 16:44:19,805: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 16:44:19,808: Acquiring new bigquery connection "accounts_proc".
2018-06-15 16:44:19,808: Re-using an available connection from the pool.
2018-06-15 16:44:19,928: Writing runtime SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 16:44:19,930: Fetching data for query accounts_proc:
create or replace table `agency_data_pipeline`.`accounts_proc`
  
  as (
    SELECT
site,
bigquery_name,
account,
platform
FROM  (
 
	SELECT  
	site,
	bigquery_name,
	account,
	platform,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.accounts`
) 

WHERE lv = time_of_entry
  );

    
2018-06-15 16:44:20,122: 16:44:20 | 3 of 21 OK created table model agency_data_pipeline.conversion_goals_proc [OK in 2.95s]
2018-06-15 16:44:20,123: 16:44:20 | 7 of 21 START table model agency_data_pipeline.gsc_stats............. [RUN]
2018-06-15 16:44:20,124: Compiling model.agency_data_pipeline.gsc_stats
2018-06-15 16:44:20,134: Writing injected SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-15 16:44:20,138: Acquiring new bigquery connection "gsc_stats".
2018-06-15 16:44:20,139: Re-using an available connection from the pool.
2018-06-15 16:44:20,256: Writing runtime SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-15 16:44:20,257: Fetching data for query gsc_stats:
create or replace table `agency_data_pipeline`.`gsc_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
0 as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
0 as conversions
FROM 
  ( 
	SELECT  
	date, 
	site as account,
	'Organic' as channel,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(replace(landing_page_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
	max(impressions) as impressions, 
	max(clicks) as clicks
	FROM `adp-apprenticeship.agency_data_pipeline.gsc`
	GROUP BY date, account, channel, platform, url
  ) 
GROUP BY date, account, channel, platform, url
ORDER BY account asc, date asc, url asc
  );

    
2018-06-15 16:44:20,448: 16:44:20 | 4 of 21 OK created table model agency_data_pipeline.mappings_ga_proc. [OK in 2.96s]
2018-06-15 16:44:20,520: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72ada15d-a7b0-4c12-bb66-7e20e4b7c70b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a875c0>]}
2018-06-15 16:44:20,833: 16:44:20 | 5 of 21 OK created table model agency_data_pipeline.adwords_campaigns [OK in 2.27s]
2018-06-15 16:44:21,711: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72ada15d-a7b0-4c12-bb66-7e20e4b7c70b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b932e8>]}
2018-06-15 16:44:22,030: 16:44:22 | 6 of 21 OK created table model agency_data_pipeline.accounts_proc.... [OK in 1.92s]
2018-06-15 16:44:22,684: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72ada15d-a7b0-4c12-bb66-7e20e4b7c70b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b93278>]}
2018-06-15 16:44:23,001: 16:44:23 | 7 of 21 OK created table model agency_data_pipeline.gsc_stats........ [OK in 2.56s]
2018-06-15 16:44:23,001: 16:44:23 | 8 of 21 START table model agency_data_pipeline.fb_adcreative......... [RUN]
2018-06-15 16:44:23,002: Compiling model.agency_data_pipeline.fb_adcreative
2018-06-15 16:44:23,001: 16:44:23 | 9 of 21 START table model agency_data_pipeline.fb_ads_insights....... [RUN]
2018-06-15 16:44:23,010: Acquiring new bigquery connection "fb_adcreative".
2018-06-15 16:44:23,001: 16:44:23 | 10 of 21 START table model agency_data_pipeline.fb_conversions....... [RUN]
2018-06-15 16:44:23,010: Compiling model.agency_data_pipeline.fb_ads_insights
2018-06-15 16:44:23,002: 16:44:23 | 11 of 21 START table model agency_data_pipeline.ga_conversions....... [RUN]
2018-06-15 16:44:23,010: Re-using an available connection from the pool.
2018-06-15 16:44:23,010: Compiling model.agency_data_pipeline.fb_conversions
2018-06-15 16:44:23,011: Compiling model.agency_data_pipeline.ga_conversions
2018-06-15 16:44:23,011: Fetching data for query fb_adcreative:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        and bigquery_name is not null
        
        
        


        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:44:23,016: Writing injected SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-15 16:44:23,022: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-15 16:44:23,029: Acquiring new bigquery connection "fb_ads_insights".
2018-06-15 16:44:23,032: Re-using an available connection from the pool.
2018-06-15 16:44:23,033: Acquiring new bigquery connection "fb_conversions".
2018-06-15 16:44:23,033: Fetching data for query fb_ads_insights:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        and bigquery_name is not null
        
        
        


        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:44:23,034: Re-using an available connection from the pool.
2018-06-15 16:44:23,036: Acquiring new bigquery connection "ga_conversions".
2018-06-15 16:44:23,038: Re-using an available connection from the pool.
2018-06-15 16:44:23,171: Writing runtime SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-15 16:44:23,179: Fetching data for query ga_conversions:
create or replace table `agency_data_pipeline`.`ga_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'Google Analytics'
  );

    
2018-06-15 16:44:23,189: Writing runtime SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-15 16:44:23,193: Fetching data for query fb_conversions:
create or replace table `agency_data_pipeline`.`fb_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'FB Ads'
  );

    
2018-06-15 16:44:24,855: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-15 16:44:24,867: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-15 16:44:24,985: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-15 16:44:24,996: Writing runtime SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-15 16:44:24,998: Fetching data for query fb_ads_insights:
create or replace table `agency_data_pipeline`.`fb_ads_insights`
  
  as (
    



with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


  );

    
2018-06-15 16:44:24,999: Fetching data for query fb_adcreative:
create or replace table `agency_data_pipeline`.`fb_adcreative`
  
  as (
    



with fb_adcreative as (


	    
		   	SELECT 
			id,
			link_url object_url,
			url_tags,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


  );

    
2018-06-15 16:44:25,001: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72ada15d-a7b0-4c12-bb66-7e20e4b7c70b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105afefd0>]}
2018-06-15 16:44:25,296: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72ada15d-a7b0-4c12-bb66-7e20e4b7c70b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105af0048>]}
2018-06-15 16:44:25,329: 16:44:25 | 10 of 21 OK created table model agency_data_pipeline.fb_conversions.. [OK in 1.99s]
2018-06-15 16:44:25,641: 16:44:25 | 11 of 21 OK created table model agency_data_pipeline.ga_conversions.. [OK in 2.29s]
2018-06-15 16:44:26,781: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72ada15d-a7b0-4c12-bb66-7e20e4b7c70b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b93358>]}
2018-06-15 16:44:27,104: 16:44:27 | 8 of 21 OK created table model agency_data_pipeline.fb_adcreative.... [OK in 3.78s]
2018-06-15 16:44:27,142: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72ada15d-a7b0-4c12-bb66-7e20e4b7c70b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105ad57f0>]}
2018-06-15 16:44:27,465: 16:44:27 | 9 of 21 OK created table model agency_data_pipeline.fb_ads_insights.. [OK in 4.13s]
2018-06-15 16:44:27,465: 16:44:27 | 12 of 21 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-06-15 16:44:27,465: 16:44:27 | 13 of 21 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-06-15 16:44:27,465: Compiling model.agency_data_pipeline.fb_ads
2018-06-15 16:44:27,465: Compiling model.agency_data_pipeline.adwords_join
2018-06-15 16:44:27,474: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-15 16:44:27,482: Acquiring new bigquery connection "fb_ads".
2018-06-15 16:44:27,482: Re-using an available connection from the pool.
2018-06-15 16:44:27,483: Acquiring new bigquery connection "adwords_join".
2018-06-15 16:44:27,483: Fetching data for query fb_ads:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        and bigquery_name is not null
        
        
        


        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:44:27,483: Re-using an available connection from the pool.
2018-06-15 16:44:27,611: Writing runtime SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-15 16:44:27,612: Fetching data for query adwords_join:
create or replace table `agency_data_pipeline`.`adwords_join`
  
  as (
    SELECT
day,
a.campaign,
a.campaignid, 
account, 
channel,
platform,
b.url,
cost,
impressions,
clicks,
conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_campaigns` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`adwords_urls` b
ON a.campaignid = b.campaignid
  );

    
2018-06-15 16:44:28,172: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-15 16:44:28,276: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-15 16:44:28,276: Fetching data for query fb_ads:
create or replace table `agency_data_pipeline`.`fb_ads`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


  );

    
2018-06-15 16:44:29,391: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72ada15d-a7b0-4c12-bb66-7e20e4b7c70b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105af0c18>]}
2018-06-15 16:44:29,710: 16:44:29 | 13 of 21 OK created table model agency_data_pipeline.adwords_join.... [OK in 1.93s]
2018-06-15 16:44:31,083: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72ada15d-a7b0-4c12-bb66-7e20e4b7c70b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b93278>]}
2018-06-15 16:44:31,408: 16:44:31 | 12 of 21 OK created table model agency_data_pipeline.fb_ads.......... [OK in 3.62s]
2018-06-15 16:44:31,409: 16:44:31 | 14 of 21 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-06-15 16:44:31,409: 16:44:31 | 15 of 21 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-06-15 16:44:31,410: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-15 16:44:31,410: 16:44:31 | 16 of 21 START table model agency_data_pipeline.ga_proc.............. [RUN]
2018-06-15 16:44:31,410: Compiling model.agency_data_pipeline.adwords_stats
2018-06-15 16:44:31,417: Compiling model.agency_data_pipeline.ga_proc
2018-06-15 16:44:31,431: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-15 16:44:31,442: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-06-15 16:44:31,450: Acquiring new bigquery connection "ga_proc".
2018-06-15 16:44:31,450: Re-using an available connection from the pool.
2018-06-15 16:44:31,452: Acquiring new bigquery connection "adwords_stats".
2018-06-15 16:44:31,452: Fetching data for query fb_ads_insights_conversions:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        and bigquery_name is not null
        
        
        


        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:44:31,452: Re-using an available connection from the pool.
2018-06-15 16:44:31,453: Fetching data for query ga_proc:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`

        
        ##where 1 = 1
        where platform = 'Google Analytics'
        and bigquery_name is not null
        
        
        


        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:44:31,453: Re-using an available connection from the pool.
2018-06-15 16:44:31,574: Writing runtime SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-15 16:44:31,574: Fetching data for query adwords_stats:
create or replace table `agency_data_pipeline`.`adwords_stats`
  
  as (
    SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_join`
GROUP BY date, account, platform, channel, url, campaign
  );

    
2018-06-15 16:44:32,114: Fetching data for query fb_ads_insights_conversions:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`

        
        ##where 1 = 1
        where goal_type = 'Signup'
        and goal_name is not null
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        


        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:44:33,259: Fetching data for query ga_proc:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Signup'
        and goal_name is not null
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        


        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:44:33,738: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72ada15d-a7b0-4c12-bb66-7e20e4b7c70b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b17dd8>]}
2018-06-15 16:44:34,047: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72ada15d-a7b0-4c12-bb66-7e20e4b7c70b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1030739b0>]}
2018-06-15 16:44:34,088: 16:44:34 | 15 of 21 OK created table model agency_data_pipeline.adwords_stats... [OK in 2.33s]
2018-06-15 16:44:34,409: 16:44:34 | 14 of 21 ERROR creating table model agency_data_pipeline.fb_ads_insights_conversions [ERROR in 2.64s]
2018-06-15 16:44:34,921: Writing injected SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-15 16:44:35,047: Writing runtime SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-15 16:44:35,047: Fetching data for query ga_proc:
create or replace table `agency_data_pipeline`.`ga_proc`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`




with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'cifl' as bigquery_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			sessions,
			## goal completion columns
			
				
					cast(goal1completions as int64) 
					 
					 as goal_completions,  
				
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.ga_.report` 

		    
	   

)


SELECT 
bigquery_name,
lookup_platform,
date,
url,
source,
medium,
sum(sessions) sessions,
sum(goal_completions) goal_completions
FROM ga_report
where lv = _sdc_sequence
group by bigquery_name, lookup_platform, date, url, source, medium


  );

    
2018-06-15 16:44:35,197: Unhandled error while running:
create dataset
2018-06-15 16:44:35,198: 404 Not found: Dataset adp-apprenticeship:ga_. Please verify that the dataset exists and the correct location was used for the job.
2018-06-15 16:44:35,198: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '72ada15d-a7b0-4c12-bb66-7e20e4b7c70b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b2cc88>]}
2018-06-15 16:44:35,526: 16:44:35 | 16 of 21 ERROR creating table model agency_data_pipeline.ga_proc..... [ERROR in 3.78s]
2018-06-15 16:44:35,526: 16:44:35 | 17 of 21 SKIP relation agency_data_pipeline.ga_stats................. [SKIP]
2018-06-15 16:44:35,527: 16:44:35 | 18 of 21 SKIP relation agency_data_pipeline.fb_ads_stats............. [SKIP]
2018-06-15 16:44:35,528: 16:44:35 | 19 of 21 SKIP relation agency_data_pipeline.agg_platforms_union...... [SKIP]
2018-06-15 16:44:35,529: 16:44:35 | 20 of 21 SKIP relation agency_data_pipeline.agg_platforms_site....... [SKIP]
2018-06-15 16:44:35,530: 16:44:35 | 21 of 21 SKIP relation agency_data_pipeline.agg_platforms_ga......... [SKIP]
2018-06-15 16:44:35,544: 16:44:35 | 
2018-06-15 16:44:35,544: 16:44:35 | Finished running 21 table models in 20.18s.
2018-06-15 16:44:35,544: Connection 'master' was left open.
2018-06-15 16:44:35,545: 
2018-06-15 16:44:35,545: Completed with 3 errors:
2018-06-15 16:44:35,545: 
2018-06-15 16:44:35,545: Database Error in model youtube_stats (models/base/youtube/youtube_stats.sql)
2018-06-15 16:44:35,546:   Name date in GROUP BY clause is ambiguous; it may refer to multiple columns in the SELECT-list at [29:46]
2018-06-15 16:44:35,546:   compiled SQL at target/run/agency_data_pipeline/base/youtube/youtube_stats.sql
2018-06-15 16:44:35,546: 
2018-06-15 16:44:35,547: Compilation Error in model fb_ads_insights_conversions (models/base/fb-ads/fb_ads_insights_conversions.sql)
2018-06-15 16:44:35,547:   Required var 'bigquery-project' not found in config:
2018-06-15 16:44:35,547:   Vars supplied to fb_ads_insights_conversions = {}
2018-06-15 16:44:35,548: 
2018-06-15 16:44:35,548: Runtime Error in model ga_proc (models/base/ga/ga_proc.sql)
2018-06-15 16:44:35,548:   404 Not found: Dataset adp-apprenticeship:ga_. Please verify that the dataset exists and the correct location was used for the job.
2018-06-15 16:44:35,548: 
Done. PASS=13 ERROR=3 SKIP=5 TOTAL=21
2018-06-15 16:44:35,549: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a458d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a45630>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a45710>]}
2018-06-15 16:44:35,868: Flushing usage events
2018-06-15 16:44:35,917: sys:1: ResourceWarning: unclosed <socket.socket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51645), raddr=('172.217.12.10', 443)>

2018-06-15 16:44:35,918: sys:1: ResourceWarning: unclosed <socket.socket fd=20, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51646), raddr=('172.217.12.10', 443)>

2018-06-15 16:44:35,918: sys:1: ResourceWarning: unclosed <socket.socket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51639), raddr=('172.217.12.13', 443)>

2018-06-15 16:44:35,919: sys:1: ResourceWarning: unclosed <socket.socket fd=18, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51644), raddr=('172.217.12.10', 443)>

2018-06-15 16:44:35,919: sys:1: ResourceWarning: unclosed <socket.socket fd=17, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51643), raddr=('172.217.12.10', 443)>

2018-06-15 16:44:35,919: sys:1: ResourceWarning: unclosed <socket.socket fd=16, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51640), raddr=('172.217.12.13', 443)>

2018-06-15 16:44:35,920: sys:1: ResourceWarning: unclosed <socket.socket fd=14, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51641), raddr=('172.217.12.13', 443)>

2018-06-15 16:44:35,920: sys:1: ResourceWarning: unclosed <socket.socket fd=15, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51642), raddr=('172.217.12.13', 443)>

2018-06-15 16:44:35,920: sys:1: ResourceWarning: unclosed <socket.socket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51638), raddr=('172.217.11.234', 443)>

2018-06-15 16:44:35,920: sys:1: ResourceWarning: unclosed <socket.socket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51637), raddr=('172.217.12.13', 443)>

2018-06-15 16:46:43,046: Tracking: tracking
2018-06-15 16:46:43,048: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106674208>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106674080>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106674710>]}
2018-06-15 16:46:44,082: Loading dependency project from /usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/include
2018-06-15 16:46:44,122: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/agency-data-pipeline/dbt_modules
2018-06-15 16:46:44,128: Parsing get_column_values.sql
2018-06-15 16:46:44,147: Parsing core.sql
2018-06-15 16:46:44,160: Parsing adapters/bigquery.sql
2018-06-15 16:46:44,170: Parsing adapters/common.sql
2018-06-15 16:46:44,195: Parsing adapters/redshift.sql
2018-06-15 16:46:44,220: Parsing adapters/snowflake.sql
2018-06-15 16:46:44,228: Parsing etc/bigquery.sql
2018-06-15 16:46:44,234: Parsing etc/datetime.sql
2018-06-15 16:46:44,264: Parsing etc/get_custom_schema.sql
2018-06-15 16:46:44,272: Parsing materializations/helpers.sql
2018-06-15 16:46:44,292: Parsing materializations/archive/archive.sql
2018-06-15 16:46:44,337: Parsing materializations/incremental/incremental.sql
2018-06-15 16:46:44,377: Parsing materializations/seed/bigquery.sql
2018-06-15 16:46:44,385: Parsing materializations/seed/seed.sql
2018-06-15 16:46:44,437: Parsing materializations/table/bigquery_table.sql
2018-06-15 16:46:44,469: Parsing materializations/table/table.sql
2018-06-15 16:46:44,495: Parsing materializations/view/bigquery_view.sql
2018-06-15 16:46:44,509: Parsing materializations/view/view.sql
2018-06-15 16:46:44,530: Parsing schema_tests/accepted_values.sql
2018-06-15 16:46:44,535: Parsing schema_tests/not_null.sql
2018-06-15 16:46:44,540: Parsing schema_tests/relationships.sql
2018-06-15 16:46:44,545: Parsing schema_tests/unique.sql
2018-06-15 16:46:44,569: Parsing model.agency_data_pipeline.accounts_proc
2018-06-15 16:46:44,574: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-06-15 16:46:44,577: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-06-15 16:46:44,579: Parsing model.agency_data_pipeline.adwords_campaigns
2018-06-15 16:46:44,581: Parsing model.agency_data_pipeline.adwords_join
2018-06-15 16:46:44,584: Parsing model.agency_data_pipeline.adwords_stats
2018-06-15 16:46:44,587: Parsing model.agency_data_pipeline.adwords_urls
2018-06-15 16:46:44,589: Parsing model.agency_data_pipeline.fb_adcreative
2018-06-15 16:46:44,595: Parsing model.agency_data_pipeline.fb_ads
2018-06-15 16:46:44,602: Parsing model.agency_data_pipeline.fb_ads_insights
2018-06-15 16:46:44,608: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-15 16:46:44,621: Parsing model.agency_data_pipeline.fb_ads_stats
2018-06-15 16:46:44,625: Parsing model.agency_data_pipeline.fb_conversions
2018-06-15 16:46:44,628: Parsing model.agency_data_pipeline.ga_conversions
2018-06-15 16:46:44,630: Parsing model.agency_data_pipeline.ga_proc
2018-06-15 16:46:44,642: Parsing model.agency_data_pipeline.ga_stats
2018-06-15 16:46:44,646: Parsing model.agency_data_pipeline.gsc_stats
2018-06-15 16:46:44,648: Parsing model.agency_data_pipeline.youtube_stats
2018-06-15 16:46:44,651: Parsing model.agency_data_pipeline.agg_platforms_ga
2018-06-15 16:46:44,654: Parsing model.agency_data_pipeline.agg_platforms_site
2018-06-15 16:46:44,658: Parsing model.agency_data_pipeline.agg_platforms_union
2018-06-15 16:46:44,673: Found 21 models, 0 tests, 0 archives, 0 analyses, 57 macros, 0 operations, 0 seed files
2018-06-15 16:46:44,679: 
2018-06-15 16:46:44,684: Acquiring new bigquery connection "master".
2018-06-15 16:46:44,685: Opening a new connection (0 currently allocated)
2018-06-15 16:46:45,423: 16:46:45 | Concurrency: 4 threads (target='dev')
2018-06-15 16:46:45,423: 16:46:45 | 
2018-06-15 16:46:45,485: 16:46:45 | 1 of 21 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-06-15 16:46:45,485: Compiling model.agency_data_pipeline.adwords_campaigns
2018-06-15 16:46:45,485: 16:46:45 | 2 of 21 START table model agency_data_pipeline.youtube_stats......... [RUN]
2018-06-15 16:46:45,490: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-15 16:46:45,485: 16:46:45 | 3 of 21 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-06-15 16:46:45,491: Compiling model.agency_data_pipeline.youtube_stats
2018-06-15 16:46:45,485: 16:46:45 | 4 of 21 START table model agency_data_pipeline.mappings_ga_proc...... [RUN]
2018-06-15 16:46:45,491: Compiling model.agency_data_pipeline.adwords_urls
2018-06-15 16:46:45,496: Writing injected SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-15 16:46:45,497: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-06-15 16:46:45,502: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-15 16:46:45,503: Acquiring new bigquery connection "adwords_campaigns".
2018-06-15 16:46:45,510: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-15 16:46:45,512: Acquiring new bigquery connection "youtube_stats".
2018-06-15 16:46:45,512: Opening a new connection (1 currently allocated)
2018-06-15 16:46:45,515: Acquiring new bigquery connection "mappings_ga_proc".
2018-06-15 16:46:45,516: Acquiring new bigquery connection "adwords_urls".
2018-06-15 16:46:45,518: Opening a new connection (2 currently allocated)
2018-06-15 16:46:45,524: Opening a new connection (3 currently allocated)
2018-06-15 16:46:45,530: Opening a new connection (4 currently allocated)
2018-06-15 16:46:46,021: Writing runtime SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-15 16:46:46,021: Fetching data for query adwords_urls:
create or replace table `agency_data_pipeline`.`adwords_urls`
  
  as (
    SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url
FROM 
(
	SELECT  
	campaignid,
	max(finalurl) finalurl
	FROM `adp-apprenticeship.adwords.FINAL_URL_REPORT`
	GROUP BY campaignid
)
  );

    
2018-06-15 16:46:46,113: Writing runtime SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-15 16:46:46,114: Fetching data for query mappings_ga_proc:
create or replace table `agency_data_pipeline`.`mappings_ga_proc`
  
  as (
    SELECT
site,
account,
bigquery_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
FROM  ( 

	SELECT  
	site,
	account,
	bigquery_name,
	source,
	medium,
	platform as platform_n,
	channel as channel_n,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
group by site, account, bigquery_name, source, medium, platform_n, channel_n, time_of_entry
  );

    
2018-06-15 16:46:46,175: Writing runtime SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-15 16:46:46,175: Fetching data for query adwords_campaigns:
create or replace table `agency_data_pipeline`.`adwords_campaigns`
  
  as (
    SELECT
day,
campaignid,
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM
( 
	SELECT  
	'Paid' as channel,
	'Adwords' as platform,
	day,
	campaignid,
	campaign,
	account as account,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	conversions,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `adp-apprenticeship.adwords.CAMPAIGN_PERFORMANCE_REPORT`
)
WHERE lv = _sdc_sequence
GROUP BY day, campaignid, account, channel, platform, campaign
  );

    
2018-06-15 16:46:46,359: Writing runtime SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-15 16:46:46,360: Fetching data for query youtube_stats:
create or replace table `agency_data_pipeline`.`youtube_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
FROM 
  ( 
	SELECT  
	date, 
	'Social' as channel,
	'YouTube' as platform,
	'Coding is for Losers' as account,  
	0 as cost, 
	max(views) as impressions, 
	max(clicks) as clicks, 
	max(subscribers) as conversions,
	regexp_replace(regexp_replace(replace(replace(replace(landing_page_url,'http://',''),'https://',''),'.html',''),r'\?.*$',''),r'([/]$)','') as url,
	video_url
	FROM `adp-apprenticeship.agency_data_pipeline.youtube`
	group by channel, platform, account, date, video_url, url
  ) 
GROUP BY date, account, channel, platform, url
  );

    
2018-06-15 16:46:47,950: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa67c741-0857-4ddb-b639-170374841042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1069963c8>]}
2018-06-15 16:46:48,268: 16:46:48 | 3 of 21 OK created table model agency_data_pipeline.adwords_urls..... [OK in 2.46s]
2018-06-15 16:46:48,269: 16:46:48 | 5 of 21 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-06-15 16:46:48,269: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-06-15 16:46:48,277: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-15 16:46:48,281: Acquiring new bigquery connection "conversion_goals_proc".
2018-06-15 16:46:48,282: Re-using an available connection from the pool.
2018-06-15 16:46:48,404: Writing runtime SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-15 16:46:48,404: Fetching data for query conversion_goals_proc:
create or replace table `agency_data_pipeline`.`conversion_goals_proc`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
FROM  ( 

	SELECT  
	site,
	bigquery_name,
	platform,
	trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
	goal_type,
	account,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by site, bigquery_name, platform, account, goal_name
  );

    
2018-06-15 16:46:48,433: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa67c741-0857-4ddb-b639-170374841042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1069960b8>]}
2018-06-15 16:46:48,615: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa67c741-0857-4ddb-b639-170374841042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106996438>]}
2018-06-15 16:46:48,642: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa67c741-0857-4ddb-b639-170374841042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106996550>]}
2018-06-15 16:46:48,754: 16:46:48 | 4 of 21 OK created table model agency_data_pipeline.mappings_ga_proc. [OK in 2.94s]
2018-06-15 16:46:48,755: 16:46:48 | 6 of 21 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-06-15 16:46:48,756: Compiling model.agency_data_pipeline.accounts_proc
2018-06-15 16:46:48,766: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 16:46:48,768: Acquiring new bigquery connection "accounts_proc".
2018-06-15 16:46:48,769: Re-using an available connection from the pool.
2018-06-15 16:46:48,926: Writing runtime SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 16:46:48,927: Fetching data for query accounts_proc:
create or replace table `agency_data_pipeline`.`accounts_proc`
  
  as (
    SELECT
site,
bigquery_name,
account,
platform
FROM  (
 
	SELECT  
	site,
	bigquery_name,
	account,
	platform,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.accounts`
) 

WHERE lv = time_of_entry
  );

    
2018-06-15 16:46:49,084: 16:46:49 | 1 of 21 OK created table model agency_data_pipeline.adwords_campaigns [OK in 3.13s]
2018-06-15 16:46:49,086: 16:46:49 | 7 of 21 START table model agency_data_pipeline.gsc_stats............. [RUN]
2018-06-15 16:46:49,088: Compiling model.agency_data_pipeline.gsc_stats
2018-06-15 16:46:49,097: Writing injected SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-15 16:46:49,100: Acquiring new bigquery connection "gsc_stats".
2018-06-15 16:46:49,100: Re-using an available connection from the pool.
2018-06-15 16:46:49,218: Writing runtime SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-15 16:46:49,218: Fetching data for query gsc_stats:
create or replace table `agency_data_pipeline`.`gsc_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
0 as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
0 as conversions
FROM 
  ( 
	SELECT  
	date, 
	site as account,
	'Organic' as channel,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(replace(landing_page_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
	max(impressions) as impressions, 
	max(clicks) as clicks
	FROM `adp-apprenticeship.agency_data_pipeline.gsc`
	GROUP BY date, account, channel, platform, url
  ) 
GROUP BY date, account, channel, platform, url
ORDER BY account asc, date asc, url asc
  );

    
2018-06-15 16:46:49,416: 16:46:49 | 2 of 21 OK created table model agency_data_pipeline.youtube_stats.... [OK in 3.15s]
2018-06-15 16:46:50,516: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa67c741-0857-4ddb-b639-170374841042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1069963c8>]}
2018-06-15 16:46:50,836: 16:46:50 | 5 of 21 OK created table model agency_data_pipeline.conversion_goals_proc [OK in 2.25s]
2018-06-15 16:46:51,219: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa67c741-0857-4ddb-b639-170374841042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1069960b8>]}
2018-06-15 16:46:51,546: 16:46:51 | 6 of 21 OK created table model agency_data_pipeline.accounts_proc.... [OK in 2.46s]
2018-06-15 16:46:51,581: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa67c741-0857-4ddb-b639-170374841042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106996438>]}
2018-06-15 16:46:51,906: 16:46:51 | 7 of 21 OK created table model agency_data_pipeline.gsc_stats........ [OK in 2.49s]
2018-06-15 16:46:51,907: 16:46:51 | 8 of 21 START table model agency_data_pipeline.fb_adcreative......... [RUN]
2018-06-15 16:46:51,907: Compiling model.agency_data_pipeline.fb_adcreative
2018-06-15 16:46:51,913: 16:46:51 | 9 of 21 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-06-15 16:46:51,917: Acquiring new bigquery connection "fb_adcreative".
2018-06-15 16:46:51,917: 16:46:51 | 10 of 21 START table model agency_data_pipeline.fb_conversions....... [RUN]
2018-06-15 16:46:51,918: Compiling model.agency_data_pipeline.ga_conversions
2018-06-15 16:46:51,918: 16:46:51 | 11 of 21 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-06-15 16:46:51,918: Re-using an available connection from the pool.
2018-06-15 16:46:51,918: Compiling model.agency_data_pipeline.fb_conversions
2018-06-15 16:46:51,919: Compiling model.agency_data_pipeline.fb_ads_insights
2018-06-15 16:46:51,920: Fetching data for query fb_adcreative:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:46:51,925: Writing injected SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-15 16:46:51,937: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-15 16:46:51,939: Acquiring new bigquery connection "fb_ads_insights".
2018-06-15 16:46:51,942: Re-using an available connection from the pool.
2018-06-15 16:46:51,942: Fetching data for query fb_ads_insights:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:46:51,943: Acquiring new bigquery connection "fb_conversions".
2018-06-15 16:46:51,946: Acquiring new bigquery connection "ga_conversions".
2018-06-15 16:46:51,950: Re-using an available connection from the pool.
2018-06-15 16:46:51,956: Re-using an available connection from the pool.
2018-06-15 16:46:52,097: Writing runtime SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-15 16:46:52,097: Fetching data for query fb_conversions:
create or replace table `agency_data_pipeline`.`fb_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'FB Ads'
  );

    
2018-06-15 16:46:52,190: Writing runtime SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-15 16:46:52,191: Fetching data for query ga_conversions:
create or replace table `agency_data_pipeline`.`ga_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'Google Analytics'
  );

    
2018-06-15 16:46:53,865: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-15 16:46:53,923: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-15 16:46:54,027: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-15 16:46:54,035: Fetching data for query fb_ads_insights:
create or replace table `agency_data_pipeline`.`fb_ads_insights`
  
  as (
    



with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


  );

    
2018-06-15 16:46:54,038: Writing runtime SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-15 16:46:54,040: Fetching data for query fb_adcreative:
create or replace table `agency_data_pipeline`.`fb_adcreative`
  
  as (
    



with fb_adcreative as (


	    
		   	SELECT 
			id,
			link_url object_url,
			url_tags,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


  );

    
2018-06-15 16:46:54,200: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa67c741-0857-4ddb-b639-170374841042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068f2eb8>]}
2018-06-15 16:46:54,426: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa67c741-0857-4ddb-b639-170374841042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068d0f28>]}
2018-06-15 16:46:54,528: 16:46:54 | 10 of 21 OK created table model agency_data_pipeline.fb_conversions.. [OK in 2.28s]
2018-06-15 16:46:54,850: 16:46:54 | 9 of 21 OK created table model agency_data_pipeline.ga_conversions... [OK in 2.51s]
2018-06-15 16:46:56,205: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa67c741-0857-4ddb-b639-170374841042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068fc5c0>]}
2018-06-15 16:46:56,300: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa67c741-0857-4ddb-b639-170374841042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106996400>]}
2018-06-15 16:46:56,530: 16:46:56 | 11 of 21 OK created table model agency_data_pipeline.fb_ads_insights. [OK in 4.29s]
2018-06-15 16:46:56,857: 16:46:56 | 8 of 21 OK created table model agency_data_pipeline.fb_adcreative.... [OK in 4.39s]
2018-06-15 16:46:56,858: 16:46:56 | 12 of 21 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-06-15 16:46:56,859: Compiling model.agency_data_pipeline.adwords_join
2018-06-15 16:46:56,859: 16:46:56 | 13 of 21 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-06-15 16:46:56,866: Compiling model.agency_data_pipeline.fb_ads
2018-06-15 16:46:56,874: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-15 16:46:56,881: Acquiring new bigquery connection "fb_ads".
2018-06-15 16:46:56,881: Re-using an available connection from the pool.
2018-06-15 16:46:56,881: Fetching data for query fb_ads:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:46:56,884: Acquiring new bigquery connection "adwords_join".
2018-06-15 16:46:56,884: Re-using an available connection from the pool.
2018-06-15 16:46:57,056: Writing runtime SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-15 16:46:57,056: Fetching data for query adwords_join:
create or replace table `agency_data_pipeline`.`adwords_join`
  
  as (
    SELECT
day,
a.campaign,
a.campaignid, 
account, 
channel,
platform,
b.url,
cost,
impressions,
clicks,
conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_campaigns` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`adwords_urls` b
ON a.campaignid = b.campaignid
  );

    
2018-06-15 16:46:57,489: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-15 16:46:57,623: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-15 16:46:57,624: Fetching data for query fb_ads:
create or replace table `agency_data_pipeline`.`fb_ads`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


  );

    
2018-06-15 16:47:00,229: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa67c741-0857-4ddb-b639-170374841042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106996438>]}
2018-06-15 16:47:00,552: 16:47:00 | 12 of 21 OK created table model agency_data_pipeline.adwords_join.... [OK in 3.37s]
2018-06-15 16:47:01,538: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa67c741-0857-4ddb-b639-170374841042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108d3ada0>]}
2018-06-15 16:47:01,859: 16:47:01 | 13 of 21 OK created table model agency_data_pipeline.fb_ads.......... [OK in 4.67s]
2018-06-15 16:47:01,860: 16:47:01 | 14 of 21 START table model agency_data_pipeline.ga_proc.............. [RUN]
2018-06-15 16:47:01,860: 16:47:01 | 15 of 21 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-06-15 16:47:01,861: Compiling model.agency_data_pipeline.ga_proc
2018-06-15 16:47:01,861: 16:47:01 | 16 of 21 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-06-15 16:47:01,861: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-15 16:47:01,868: Compiling model.agency_data_pipeline.adwords_stats
2018-06-15 16:47:01,881: Acquiring new bigquery connection "ga_proc".
2018-06-15 16:47:01,887: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-15 16:47:01,887: Re-using an available connection from the pool.
2018-06-15 16:47:01,888: Fetching data for query ga_proc:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:47:01,910: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-06-15 16:47:01,911: Re-using an available connection from the pool.
2018-06-15 16:47:01,911: Fetching data for query fb_ads_insights_conversions:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:47:01,921: Acquiring new bigquery connection "adwords_stats".
2018-06-15 16:47:01,921: Re-using an available connection from the pool.
2018-06-15 16:47:02,058: Writing runtime SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-15 16:47:02,059: Fetching data for query adwords_stats:
create or replace table `agency_data_pipeline`.`adwords_stats`
  
  as (
    SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_join`
GROUP BY date, account, platform, channel, url, campaign
  );

    
2018-06-15 16:47:02,616: Fetching data for query fb_ads_insights_conversions:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`
        where goal_name is not null
        and goal_name != ''

        
        ##where 1 = 1
        and goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:47:03,651: Fetching data for query ga_proc:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`
        where goal_name is not null
        and goal_name != ''

        
        ##where 1 = 1
        and goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:47:03,958: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa67c741-0857-4ddb-b639-170374841042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108d87710>]}
2018-06-15 16:47:04,279: 16:47:04 | 16 of 21 OK created table model agency_data_pipeline.adwords_stats... [OK in 2.09s]
2018-06-15 16:47:04,615: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-06-15 16:47:04,755: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-06-15 16:47:04,755: Fetching data for query fb_ads_insights_conversions:
create or replace table `agency_data_pipeline`.`fb_ads_insights_conversions`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`





with fb_ads_insights_conversions as (

	    

	    	

		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			_sdc_sequence,
			action_type,
			_28d_click conversions,
			null as revenue
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
			cross join unnest(actions)

			## goal completion columns
			
				where action type in (
				
					"'"offsite_conversion.fb_pixel_lead"'"
					 
				
				)
			
			
			UNION ALL

		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			_sdc_sequence,
			action_type,
			null as conversions,
			_28d_click as revenue
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
			cross join unnest(action_values)
			
			## goal completion columns
			
				where action type in (
				
					"'"offsite_conversion.fb_pixel_lead"'"
					 
				
				)
			

		    
	   

)

SELECT 
date,
campaign_id,
campaign,
ad_id,
account,
sum(conversions) conversions,
sum(revenue) revenue
FROM 
		(
	    SELECT
	    date_start date,
	    campaign_id,
	    campaign_name campaign,
	    ad_id,
	    account_name account,
	    action_type,
	    conversions,
	    revenue,
	    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
	    _sdc_sequence
	    FROM fb_ads_insights_conversions
	   	)
where lv = _sdc_sequence
group by date, campaign_id, campaign, ad_id, account



  );

    
2018-06-15 16:47:04,898: Bad request while running:
create dataset
2018-06-15 16:47:04,898: 400 Syntax error: Expected ")" but got identifier "type" at [31:46]
2018-06-15 16:47:04,898: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa67c741-0857-4ddb-b639-170374841042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108d78ac8>]}
2018-06-15 16:47:05,221: 16:47:05 | 15 of 21 ERROR creating table model agency_data_pipeline.fb_ads_insights_conversions [ERROR in 3.04s]
2018-06-15 16:47:05,309: Writing injected SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-15 16:47:05,439: Writing runtime SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-15 16:47:05,440: Fetching data for query ga_proc:
create or replace table `agency_data_pipeline`.`ga_proc`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`




with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'cifl' as bigquery_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			sessions,
			## goal completion columns
			
				
					cast(goal1completions as int64) 
					 
					 as goal_completions,  
				
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.ga_.report` 

		    
	   

)


SELECT 
bigquery_name,
lookup_platform,
date,
url,
source,
medium,
sum(sessions) sessions,
sum(goal_completions) goal_completions
FROM ga_report
where lv = _sdc_sequence
group by bigquery_name, lookup_platform, date, url, source, medium


  );

    
2018-06-15 16:47:05,572: Unhandled error while running:
create dataset
2018-06-15 16:47:05,573: 404 Not found: Table adp-apprenticeship:ga_.report. Please verify that the table exists and the correct location was used for the job.
2018-06-15 16:47:05,573: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa67c741-0857-4ddb-b639-170374841042', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108d852e8>]}
2018-06-15 16:47:05,903: 16:47:05 | 14 of 21 ERROR creating table model agency_data_pipeline.ga_proc..... [ERROR in 3.71s]
2018-06-15 16:47:05,903: 16:47:05 | 17 of 21 SKIP relation agency_data_pipeline.ga_stats................. [SKIP]
2018-06-15 16:47:05,904: 16:47:05 | 18 of 21 SKIP relation agency_data_pipeline.fb_ads_stats............. [SKIP]
2018-06-15 16:47:05,904: 16:47:05 | 19 of 21 SKIP relation agency_data_pipeline.agg_platforms_union...... [SKIP]
2018-06-15 16:47:05,905: 16:47:05 | 20 of 21 SKIP relation agency_data_pipeline.agg_platforms_site....... [SKIP]
2018-06-15 16:47:05,905: 16:47:05 | 21 of 21 SKIP relation agency_data_pipeline.agg_platforms_ga......... [SKIP]
2018-06-15 16:47:05,987: 16:47:05 | 
2018-06-15 16:47:05,988: 16:47:05 | Finished running 21 table models in 21.31s.
2018-06-15 16:47:05,988: Connection 'master' was left open.
2018-06-15 16:47:05,988: 
2018-06-15 16:47:05,989: Completed with 2 errors:
2018-06-15 16:47:05,989: 
2018-06-15 16:47:05,989: Database Error in model fb_ads_insights_conversions (models/base/fb-ads/fb_ads_insights_conversions.sql)
2018-06-15 16:47:05,989:   Syntax error: Expected ")" but got identifier "type" at [31:46]
2018-06-15 16:47:05,990:   compiled SQL at target/run/agency_data_pipeline/base/fb-ads/fb_ads_insights_conversions.sql
2018-06-15 16:47:05,990: 
2018-06-15 16:47:05,990: Runtime Error in model ga_proc (models/base/ga/ga_proc.sql)
2018-06-15 16:47:05,990:   404 Not found: Table adp-apprenticeship:ga_.report. Please verify that the table exists and the correct location was used for the job.
2018-06-15 16:47:05,991: 
Done. PASS=14 ERROR=2 SKIP=5 TOTAL=21
2018-06-15 16:47:05,991: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1066745f8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10693ae10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10693a588>]}
2018-06-15 16:47:06,315: Flushing usage events
2018-06-15 16:47:06,365: sys:1: ResourceWarning: unclosed <socket.socket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51680), raddr=('172.217.11.234', 443)>

2018-06-15 16:47:06,366: sys:1: ResourceWarning: unclosed <socket.socket fd=17, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51678), raddr=('172.217.11.234', 443)>

2018-06-15 16:47:06,366: sys:1: ResourceWarning: unclosed <socket.socket fd=14, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51676), raddr=('172.217.12.13', 443)>

2018-06-15 16:47:06,367: sys:1: ResourceWarning: unclosed <socket.socket fd=20, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51681), raddr=('172.217.11.234', 443)>

2018-06-15 16:47:06,367: sys:1: ResourceWarning: unclosed <socket.socket fd=18, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51679), raddr=('172.217.11.234', 443)>

2018-06-15 16:47:06,368: sys:1: ResourceWarning: unclosed <socket.socket fd=16, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51674), raddr=('172.217.12.13', 443)>

2018-06-15 16:47:06,368: sys:1: ResourceWarning: unclosed <socket.socket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51675), raddr=('172.217.12.13', 443)>

2018-06-15 16:47:06,369: sys:1: ResourceWarning: unclosed <socket.socket fd=15, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51677), raddr=('172.217.12.13', 443)>

2018-06-15 16:47:06,369: sys:1: ResourceWarning: unclosed <socket.socket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51673), raddr=('172.217.11.234', 443)>

2018-06-15 16:47:06,370: sys:1: ResourceWarning: unclosed <socket.socket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51672), raddr=('172.217.12.13', 443)>

2018-06-15 16:51:26,662: Tracking: tracking
2018-06-15 16:51:26,664: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110661860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110661f98>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110661518>]}
2018-06-15 16:51:27,609: Loading dependency project from /usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/include
2018-06-15 16:51:27,635: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/agency-data-pipeline/dbt_modules
2018-06-15 16:51:27,642: Parsing get_column_values.sql
2018-06-15 16:51:27,662: Parsing core.sql
2018-06-15 16:51:27,677: Parsing adapters/bigquery.sql
2018-06-15 16:51:27,686: Parsing adapters/common.sql
2018-06-15 16:51:27,712: Parsing adapters/redshift.sql
2018-06-15 16:51:27,736: Parsing adapters/snowflake.sql
2018-06-15 16:51:27,742: Parsing etc/bigquery.sql
2018-06-15 16:51:27,747: Parsing etc/datetime.sql
2018-06-15 16:51:27,776: Parsing etc/get_custom_schema.sql
2018-06-15 16:51:27,785: Parsing materializations/helpers.sql
2018-06-15 16:51:27,812: Parsing materializations/archive/archive.sql
2018-06-15 16:51:27,861: Parsing materializations/incremental/incremental.sql
2018-06-15 16:51:27,905: Parsing materializations/seed/bigquery.sql
2018-06-15 16:51:27,913: Parsing materializations/seed/seed.sql
2018-06-15 16:51:27,966: Parsing materializations/table/bigquery_table.sql
2018-06-15 16:51:28,002: Parsing materializations/table/table.sql
2018-06-15 16:51:28,030: Parsing materializations/view/bigquery_view.sql
2018-06-15 16:51:28,045: Parsing materializations/view/view.sql
2018-06-15 16:51:28,073: Parsing schema_tests/accepted_values.sql
2018-06-15 16:51:28,079: Parsing schema_tests/not_null.sql
2018-06-15 16:51:28,084: Parsing schema_tests/relationships.sql
2018-06-15 16:51:28,089: Parsing schema_tests/unique.sql
2018-06-15 16:51:28,105: Parsing model.agency_data_pipeline.accounts_proc
2018-06-15 16:51:28,109: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-06-15 16:51:28,112: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-06-15 16:51:28,114: Parsing model.agency_data_pipeline.adwords_campaigns
2018-06-15 16:51:28,117: Parsing model.agency_data_pipeline.adwords_join
2018-06-15 16:51:28,120: Parsing model.agency_data_pipeline.adwords_stats
2018-06-15 16:51:28,124: Parsing model.agency_data_pipeline.adwords_urls
2018-06-15 16:51:28,126: Parsing model.agency_data_pipeline.fb_adcreative
2018-06-15 16:51:28,133: Parsing model.agency_data_pipeline.fb_ads
2018-06-15 16:51:28,140: Parsing model.agency_data_pipeline.fb_ads_insights
2018-06-15 16:51:28,147: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-15 16:51:28,164: Parsing model.agency_data_pipeline.fb_ads_stats
2018-06-15 16:51:28,169: Parsing model.agency_data_pipeline.fb_conversions
2018-06-15 16:51:28,172: Parsing model.agency_data_pipeline.ga_conversions
2018-06-15 16:51:28,175: Parsing model.agency_data_pipeline.ga_proc
2018-06-15 16:51:28,187: Parsing model.agency_data_pipeline.ga_stats
2018-06-15 16:51:28,192: Parsing model.agency_data_pipeline.gsc_stats
2018-06-15 16:51:28,195: Parsing model.agency_data_pipeline.youtube_stats
2018-06-15 16:51:28,198: Parsing model.agency_data_pipeline.agg_platforms_ga
2018-06-15 16:51:28,202: Parsing model.agency_data_pipeline.agg_platforms_site
2018-06-15 16:51:28,205: Parsing model.agency_data_pipeline.agg_platforms_union
2018-06-15 16:51:28,222: Found 21 models, 0 tests, 0 archives, 0 analyses, 57 macros, 0 operations, 0 seed files
2018-06-15 16:51:28,229: 
2018-06-15 16:51:28,236: Acquiring new bigquery connection "master".
2018-06-15 16:51:28,236: Opening a new connection (0 currently allocated)
2018-06-15 16:51:29,720: 16:51:29 | Concurrency: 4 threads (target='dev')
2018-06-15 16:51:29,720: 16:51:29 | 
2018-06-15 16:51:29,786: 16:51:29 | 1 of 21 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-06-15 16:51:29,787: Compiling model.agency_data_pipeline.adwords_urls
2018-06-15 16:51:29,787: 16:51:29 | 2 of 21 START table model agency_data_pipeline.gsc_stats............. [RUN]
2018-06-15 16:51:29,794: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-15 16:51:29,794: Compiling model.agency_data_pipeline.gsc_stats
2018-06-15 16:51:29,787: 16:51:29 | 3 of 21 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-06-15 16:51:29,787: 16:51:29 | 4 of 21 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-06-15 16:51:29,801: Compiling model.agency_data_pipeline.accounts_proc
2018-06-15 16:51:29,801: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-06-15 16:51:29,802: Writing injected SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-15 16:51:29,807: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 16:51:29,809: Acquiring new bigquery connection "adwords_urls".
2018-06-15 16:51:29,817: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-15 16:51:29,818: Opening a new connection (1 currently allocated)
2018-06-15 16:51:29,821: Acquiring new bigquery connection "conversion_goals_proc".
2018-06-15 16:51:29,824: Acquiring new bigquery connection "accounts_proc".
2018-06-15 16:51:29,831: Acquiring new bigquery connection "gsc_stats".
2018-06-15 16:51:29,831: Opening a new connection (2 currently allocated)
2018-06-15 16:51:29,836: Opening a new connection (3 currently allocated)
2018-06-15 16:51:29,839: Opening a new connection (4 currently allocated)
2018-06-15 16:51:30,327: Writing runtime SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-15 16:51:30,339: Writing runtime SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-15 16:51:30,339: Fetching data for query gsc_stats:
create or replace table `agency_data_pipeline`.`gsc_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
0 as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
0 as conversions
FROM 
  ( 
	SELECT  
	date, 
	site as account,
	'Organic' as channel,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(replace(landing_page_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
	max(impressions) as impressions, 
	max(clicks) as clicks
	FROM `adp-apprenticeship.agency_data_pipeline.gsc`
	GROUP BY date, account, channel, platform, url
  ) 
GROUP BY date, account, channel, platform, url
ORDER BY account asc, date asc, url asc
  );

    
2018-06-15 16:51:30,359: Writing runtime SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-15 16:51:30,360: Fetching data for query adwords_urls:
create or replace table `agency_data_pipeline`.`adwords_urls`
  
  as (
    SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url
FROM 
(
	SELECT  
	campaignid,
	max(finalurl) finalurl
	FROM `adp-apprenticeship.adwords.FINAL_URL_REPORT`
	GROUP BY campaignid
)
  );

    
2018-06-15 16:51:30,364: Fetching data for query conversion_goals_proc:
create or replace table `agency_data_pipeline`.`conversion_goals_proc`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
FROM  ( 

	SELECT  
	site,
	bigquery_name,
	platform,
	trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
	goal_type,
	account,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by site, bigquery_name, platform, account, goal_name
  );

    
2018-06-15 16:51:30,428: Writing runtime SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 16:51:30,428: Fetching data for query accounts_proc:
create or replace table `agency_data_pipeline`.`accounts_proc`
  
  as (
    SELECT
site,
bigquery_name,
account,
platform
FROM  (
 
	SELECT  
	site,
	bigquery_name,
	account,
	platform,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.accounts`
) 

WHERE lv = time_of_entry
  );

    
2018-06-15 16:51:32,249: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '538bd6ee-d0ed-4b8a-a1c3-d774ea4ed0ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11085f470>]}
2018-06-15 16:51:32,478: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '538bd6ee-d0ed-4b8a-a1c3-d774ea4ed0ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11085f3c8>]}
2018-06-15 16:51:32,576: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '538bd6ee-d0ed-4b8a-a1c3-d774ea4ed0ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11085f2b0>]}
2018-06-15 16:51:32,587: 16:51:32 | 2 of 21 OK created table model agency_data_pipeline.gsc_stats........ [OK in 2.46s]
2018-06-15 16:51:32,588: 16:51:32 | 5 of 21 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-06-15 16:51:32,591: Compiling model.agency_data_pipeline.adwords_campaigns
2018-06-15 16:51:32,600: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '538bd6ee-d0ed-4b8a-a1c3-d774ea4ed0ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11085f358>]}
2018-06-15 16:51:32,607: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-15 16:51:32,609: Acquiring new bigquery connection "adwords_campaigns".
2018-06-15 16:51:32,609: Re-using an available connection from the pool.
2018-06-15 16:51:32,730: Writing runtime SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-15 16:51:32,731: Fetching data for query adwords_campaigns:
create or replace table `agency_data_pipeline`.`adwords_campaigns`
  
  as (
    SELECT
day,
campaignid,
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM
( 
	SELECT  
	'Paid' as channel,
	'Adwords' as platform,
	day,
	campaignid,
	campaign,
	account as account,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	conversions,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `adp-apprenticeship.adwords.CAMPAIGN_PERFORMANCE_REPORT`
)
WHERE lv = _sdc_sequence
GROUP BY day, campaignid, account, channel, platform, campaign
  );

    
2018-06-15 16:51:32,927: 16:51:32 | 4 of 21 OK created table model agency_data_pipeline.conversion_goals_proc [OK in 2.68s]
2018-06-15 16:51:32,928: 16:51:32 | 6 of 21 START table model agency_data_pipeline.mappings_ga_proc...... [RUN]
2018-06-15 16:51:32,929: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-06-15 16:51:32,942: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-15 16:51:32,947: Acquiring new bigquery connection "mappings_ga_proc".
2018-06-15 16:51:32,947: Re-using an available connection from the pool.
2018-06-15 16:51:33,090: Writing runtime SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-15 16:51:33,091: Fetching data for query mappings_ga_proc:
create or replace table `agency_data_pipeline`.`mappings_ga_proc`
  
  as (
    SELECT
site,
account,
bigquery_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
FROM  ( 

	SELECT  
	site,
	account,
	bigquery_name,
	source,
	medium,
	platform as platform_n,
	channel as channel_n,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
group by site, account, bigquery_name, source, medium, platform_n, channel_n, time_of_entry
  );

    
2018-06-15 16:51:33,279: 16:51:33 | 3 of 21 OK created table model agency_data_pipeline.accounts_proc.... [OK in 2.78s]
2018-06-15 16:51:33,280: 16:51:33 | 7 of 21 START table model agency_data_pipeline.youtube_stats......... [RUN]
2018-06-15 16:51:33,281: Compiling model.agency_data_pipeline.youtube_stats
2018-06-15 16:51:33,291: Writing injected SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-15 16:51:33,297: Acquiring new bigquery connection "youtube_stats".
2018-06-15 16:51:33,298: Re-using an available connection from the pool.
2018-06-15 16:51:33,421: Writing runtime SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-15 16:51:33,421: Fetching data for query youtube_stats:
create or replace table `agency_data_pipeline`.`youtube_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
FROM 
  ( 
	SELECT  
	date, 
	'Social' as channel,
	'YouTube' as platform,
	'Coding is for Losers' as account,  
	0 as cost, 
	max(views) as impressions, 
	max(clicks) as clicks, 
	max(subscribers) as conversions,
	regexp_replace(regexp_replace(replace(replace(replace(landing_page_url,'http://',''),'https://',''),'.html',''),r'\?.*$',''),r'([/]$)','') as url,
	video_url
	FROM `adp-apprenticeship.agency_data_pipeline.youtube`
	group by channel, platform, account, date, video_url, url
  ) 
GROUP BY date, account, channel, platform, url
  );

    
2018-06-15 16:51:33,620: 16:51:33 | 1 of 21 OK created table model agency_data_pipeline.adwords_urls..... [OK in 2.81s]
2018-06-15 16:51:34,596: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '538bd6ee-d0ed-4b8a-a1c3-d774ea4ed0ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11085f470>]}
2018-06-15 16:51:34,912: 16:51:34 | 5 of 21 OK created table model agency_data_pipeline.adwords_campaigns [OK in 2.00s]
2018-06-15 16:51:35,170: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '538bd6ee-d0ed-4b8a-a1c3-d774ea4ed0ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11085f3c8>]}
2018-06-15 16:51:35,489: 16:51:35 | 6 of 21 OK created table model agency_data_pipeline.mappings_ga_proc. [OK in 2.24s]
2018-06-15 16:51:35,600: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '538bd6ee-d0ed-4b8a-a1c3-d774ea4ed0ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11085f2b0>]}
2018-06-15 16:51:35,908: 16:51:35 | 7 of 21 OK created table model agency_data_pipeline.youtube_stats.... [OK in 2.32s]
2018-06-15 16:51:35,909: 16:51:35 | 8 of 21 START table model agency_data_pipeline.fb_conversions........ [RUN]
2018-06-15 16:51:35,909: 16:51:35 | 9 of 21 START table model agency_data_pipeline.fb_ads_insights....... [RUN]
2018-06-15 16:51:35,909: 16:51:35 | 10 of 21 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-06-15 16:51:35,909: 16:51:35 | 11 of 21 START table model agency_data_pipeline.ga_conversions....... [RUN]
2018-06-15 16:51:35,910: Compiling model.agency_data_pipeline.fb_conversions
2018-06-15 16:51:35,910: Compiling model.agency_data_pipeline.fb_ads_insights
2018-06-15 16:51:35,910: Compiling model.agency_data_pipeline.fb_adcreative
2018-06-15 16:51:35,910: Compiling model.agency_data_pipeline.ga_conversions
2018-06-15 16:51:35,915: Writing injected SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-15 16:51:35,925: Acquiring new bigquery connection "fb_adcreative".
2018-06-15 16:51:35,930: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-15 16:51:35,931: Re-using an available connection from the pool.
2018-06-15 16:51:35,931: Fetching data for query fb_adcreative:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:51:35,939: Acquiring new bigquery connection "fb_conversions".
2018-06-15 16:51:35,943: Acquiring new bigquery connection "ga_conversions".
2018-06-15 16:51:35,946: Acquiring new bigquery connection "fb_ads_insights".
2018-06-15 16:51:35,948: Re-using an available connection from the pool.
2018-06-15 16:51:35,950: Re-using an available connection from the pool.
2018-06-15 16:51:35,952: Re-using an available connection from the pool.
2018-06-15 16:51:35,954: Fetching data for query fb_ads_insights:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:51:36,087: Writing runtime SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-15 16:51:36,095: Fetching data for query fb_conversions:
create or replace table `agency_data_pipeline`.`fb_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'FB Ads'
  );

    
2018-06-15 16:51:36,106: Writing runtime SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-15 16:51:36,107: Fetching data for query ga_conversions:
create or replace table `agency_data_pipeline`.`ga_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'Google Analytics'
  );

    
2018-06-15 16:51:37,710: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-15 16:51:37,714: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-15 16:51:37,841: Writing runtime SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-15 16:51:37,854: Fetching data for query fb_adcreative:
create or replace table `agency_data_pipeline`.`fb_adcreative`
  
  as (
    



with fb_adcreative as (


	    
		   	SELECT 
			id,
			link_url object_url,
			url_tags,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


  );

    
2018-06-15 16:51:37,858: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-15 16:51:37,862: Fetching data for query fb_ads_insights:
create or replace table `agency_data_pipeline`.`fb_ads_insights`
  
  as (
    



with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


  );

    
2018-06-15 16:51:38,166: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '538bd6ee-d0ed-4b8a-a1c3-d774ea4ed0ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1107a0dd8>]}
2018-06-15 16:51:38,188: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '538bd6ee-d0ed-4b8a-a1c3-d774ea4ed0ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dc959e8>]}
2018-06-15 16:51:38,484: 16:51:38 | 8 of 21 OK created table model agency_data_pipeline.fb_conversions... [OK in 2.26s]
2018-06-15 16:51:38,798: 16:51:38 | 11 of 21 OK created table model agency_data_pipeline.ga_conversions.. [OK in 2.28s]
2018-06-15 16:51:39,665: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '538bd6ee-d0ed-4b8a-a1c3-d774ea4ed0ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110775b38>]}
2018-06-15 16:51:39,771: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '538bd6ee-d0ed-4b8a-a1c3-d774ea4ed0ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ef6e390>]}
2018-06-15 16:51:39,979: 16:51:39 | 9 of 21 OK created table model agency_data_pipeline.fb_ads_insights.. [OK in 3.76s]
2018-06-15 16:51:40,298: 16:51:40 | 10 of 21 OK created table model agency_data_pipeline.fb_adcreative... [OK in 3.86s]
2018-06-15 16:51:40,299: 16:51:40 | 12 of 21 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-06-15 16:51:40,299: Compiling model.agency_data_pipeline.adwords_join
2018-06-15 16:51:40,299: 16:51:40 | 13 of 21 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-06-15 16:51:40,301: Compiling model.agency_data_pipeline.fb_ads
2018-06-15 16:51:40,309: Acquiring new bigquery connection "fb_ads".
2018-06-15 16:51:40,309: Re-using an available connection from the pool.
2018-06-15 16:51:40,309: Fetching data for query fb_ads:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:51:40,318: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-15 16:51:40,320: Acquiring new bigquery connection "adwords_join".
2018-06-15 16:51:40,320: Re-using an available connection from the pool.
2018-06-15 16:51:40,445: Writing runtime SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-15 16:51:40,446: Fetching data for query adwords_join:
create or replace table `agency_data_pipeline`.`adwords_join`
  
  as (
    SELECT
day,
a.campaign,
a.campaignid, 
account, 
channel,
platform,
b.url,
cost,
impressions,
clicks,
conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_campaigns` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`adwords_urls` b
ON a.campaignid = b.campaignid
  );

    
2018-06-15 16:51:40,946: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-15 16:51:41,084: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-15 16:51:41,085: Fetching data for query fb_ads:
create or replace table `agency_data_pipeline`.`fb_ads`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


  );

    
2018-06-15 16:51:42,261: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '538bd6ee-d0ed-4b8a-a1c3-d774ea4ed0ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e7db438>]}
2018-06-15 16:51:42,581: 16:51:42 | 12 of 21 OK created table model agency_data_pipeline.adwords_join.... [OK in 1.96s]
2018-06-15 16:51:43,199: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '538bd6ee-d0ed-4b8a-a1c3-d774ea4ed0ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1107a0dd8>]}
2018-06-15 16:51:43,511: 16:51:43 | 13 of 21 OK created table model agency_data_pipeline.fb_ads.......... [OK in 2.90s]
2018-06-15 16:51:43,512: 16:51:43 | 14 of 21 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-06-15 16:51:43,512: 16:51:43 | 15 of 21 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-06-15 16:51:43,512: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-15 16:51:43,512: 16:51:43 | 16 of 21 START table model agency_data_pipeline.ga_proc.............. [RUN]
2018-06-15 16:51:43,512: Compiling model.agency_data_pipeline.adwords_stats
2018-06-15 16:51:43,518: Compiling model.agency_data_pipeline.ga_proc
2018-06-15 16:51:43,549: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-15 16:51:43,552: Acquiring new bigquery connection "ga_proc".
2018-06-15 16:51:43,553: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-06-15 16:51:43,553: Re-using an available connection from the pool.
2018-06-15 16:51:43,553: Fetching data for query ga_proc:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:51:43,554: Re-using an available connection from the pool.
2018-06-15 16:51:43,555: Acquiring new bigquery connection "adwords_stats".
2018-06-15 16:51:43,555: Fetching data for query fb_ads_insights_conversions:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:51:43,556: Re-using an available connection from the pool.
2018-06-15 16:51:43,702: Writing runtime SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-15 16:51:43,703: Fetching data for query adwords_stats:
create or replace table `agency_data_pipeline`.`adwords_stats`
  
  as (
    SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_join`
GROUP BY date, account, platform, channel, url, campaign
  );

    
2018-06-15 16:51:44,241: Fetching data for query fb_ads_insights_conversions:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`
        where goal_name is not null
        and goal_name != ''

        
        ##where 1 = 1
        and goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:51:45,370: Fetching data for query ga_proc:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`
        where goal_name is not null
        and goal_name != ''

        
        ##where 1 = 1
        and goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:51:45,469: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '538bd6ee-d0ed-4b8a-a1c3-d774ea4ed0ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110756ef0>]}
2018-06-15 16:51:45,782: 16:51:45 | 15 of 21 OK created table model agency_data_pipeline.adwords_stats... [OK in 1.96s]
2018-06-15 16:51:45,865: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-06-15 16:51:46,004: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-06-15 16:51:46,004: Fetching data for query fb_ads_insights_conversions:
create or replace table `agency_data_pipeline`.`fb_ads_insights_conversions`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`





with fb_ads_insights_conversions as (

	    

	    	

		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			_sdc_sequence,
			action_type,
			_28d_click conversions,
			null as revenue
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
			cross join unnest(actions)

			## goal completion columns
			
				where action type in (
				
					'offsite_conversion.fb_pixel_lead'
					 
				
				)
			
			
			UNION ALL

		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			_sdc_sequence,
			action_type,
			null as conversions,
			_28d_click as revenue
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
			cross join unnest(action_values)
			
			## goal completion columns
			
				where action type in (
				
					"'"offsite_conversion.fb_pixel_lead"'"
					 
				
				)
			

		    
	   

)

SELECT 
date,
campaign_id,
campaign,
ad_id,
account,
sum(conversions) conversions,
sum(revenue) revenue
FROM 
		(
	    SELECT
	    date_start date,
	    campaign_id,
	    campaign_name campaign,
	    ad_id,
	    account_name account,
	    action_type,
	    conversions,
	    revenue,
	    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
	    _sdc_sequence
	    FROM fb_ads_insights_conversions
	   	)
where lv = _sdc_sequence
group by date, campaign_id, campaign, ad_id, account



  );

    
2018-06-15 16:51:46,169: Bad request while running:
create dataset
2018-06-15 16:51:46,169: 400 Syntax error: Expected ")" but got identifier "type" at [31:46]
2018-06-15 16:51:46,170: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '538bd6ee-d0ed-4b8a-a1c3-d774ea4ed0ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dcd9c88>]}
2018-06-15 16:51:46,484: 16:51:46 | 14 of 21 ERROR creating table model agency_data_pipeline.fb_ads_insights_conversions [ERROR in 2.66s]
2018-06-15 16:51:47,070: Writing injected SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-15 16:51:47,187: Writing runtime SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-15 16:51:47,187: Fetching data for query ga_proc:
create or replace table `agency_data_pipeline`.`ga_proc`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`




with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'cifl' as bigquery_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			sessions,
			## goal completion columns
			
				
					cast(goal1completions as int64) 
					 
					 as goal_completions,  
				
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.ga_cifl.report` 

		    
	   

)


SELECT 
bigquery_name,
lookup_platform,
date,
url,
source,
medium,
sum(sessions) sessions,
sum(goal_completions) goal_completions
FROM ga_report
where lv = _sdc_sequence
group by bigquery_name, lookup_platform, date, url, source, medium


  );

    
2018-06-15 16:51:49,342: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '538bd6ee-d0ed-4b8a-a1c3-d774ea4ed0ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110783278>]}
2018-06-15 16:51:49,756: 16:51:49 | 16 of 21 OK created table model agency_data_pipeline.ga_proc......... [OK in 5.82s]
2018-06-15 16:51:49,756: 16:51:49 | 17 of 21 START table model agency_data_pipeline.ga_stats............. [RUN]
2018-06-15 16:51:49,757: Compiling model.agency_data_pipeline.ga_stats
2018-06-15 16:51:49,765: Writing injected SQL for node "model.agency_data_pipeline.ga_stats"
2018-06-15 16:51:49,766: Acquiring new bigquery connection "ga_stats".
2018-06-15 16:51:49,766: Re-using an available connection from the pool.
2018-06-15 16:51:49,887: Writing runtime SQL for node "model.agency_data_pipeline.ga_stats"
2018-06-15 16:51:49,888: Fetching data for query ga_stats:
create or replace table `agency_data_pipeline`.`ga_stats`
  
  as (
    SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
url,
sum(sessions) sessions,
sum(goal_completions) goal_completions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`ga_proc` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.bigquery_name = b.bigquery_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.bigquery_name = c.bigquery_name )
GROUP BY date, account, client, source, medium, source_medium, platform, channel, url
  );

    
2018-06-15 16:51:50,278: Bad request while running:
create dataset
2018-06-15 16:51:50,278: 400 GET https://www.googleapis.com/bigquery/v2/projects/adp-apprenticeship/queries/93960081-03a0-4438-ab9b-25cd66b92480?maxResults=0: Name client not found inside b at [7:3]
2018-06-15 16:51:50,278: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '538bd6ee-d0ed-4b8a-a1c3-d774ea4ed0ec', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110752828>]}
2018-06-15 16:51:50,594: 16:51:50 | 17 of 21 ERROR creating table model agency_data_pipeline.ga_stats.... [ERROR in 0.52s]
2018-06-15 16:51:50,594: 16:51:50 | 18 of 21 SKIP relation agency_data_pipeline.fb_ads_stats............. [SKIP]
2018-06-15 16:51:50,595: 16:51:50 | 19 of 21 SKIP relation agency_data_pipeline.agg_platforms_union...... [SKIP]
2018-06-15 16:51:50,595: 16:51:50 | 20 of 21 SKIP relation agency_data_pipeline.agg_platforms_site....... [SKIP]
2018-06-15 16:51:50,596: 16:51:50 | 21 of 21 SKIP relation agency_data_pipeline.agg_platforms_ga......... [SKIP]
2018-06-15 16:51:50,672: 16:51:50 | 
2018-06-15 16:51:50,673: 16:51:50 | Finished running 21 table models in 22.44s.
2018-06-15 16:51:50,673: Connection 'master' was left open.
2018-06-15 16:51:50,673: 
2018-06-15 16:51:50,673: Completed with 2 errors:
2018-06-15 16:51:50,673: 
2018-06-15 16:51:50,674: Database Error in model fb_ads_insights_conversions (models/base/fb-ads/fb_ads_insights_conversions.sql)
2018-06-15 16:51:50,674:   Syntax error: Expected ")" but got identifier "type" at [31:46]
2018-06-15 16:51:50,674:   compiled SQL at target/run/agency_data_pipeline/base/fb-ads/fb_ads_insights_conversions.sql
2018-06-15 16:51:50,674: 
2018-06-15 16:51:50,674: Database Error in model ga_stats (models/base/ga/ga_stats.sql)
2018-06-15 16:51:50,674:   Name client not found inside b at [7:3]
2018-06-15 16:51:50,675:   compiled SQL at target/run/agency_data_pipeline/base/ga/ga_stats.sql
2018-06-15 16:51:50,675: 
Done. PASS=15 ERROR=2 SKIP=4 TOTAL=21
2018-06-15 16:51:50,675: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110661860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110711780>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110711908>]}
2018-06-15 16:51:50,994: Flushing usage events
2018-06-15 16:51:51,046: sys:1: ResourceWarning: unclosed <socket.socket fd=14, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51714), raddr=('172.217.12.13', 443)>

2018-06-15 16:51:51,047: sys:1: ResourceWarning: unclosed <socket.socket fd=15, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51715), raddr=('172.217.12.13', 443)>

2018-06-15 16:51:51,047: sys:1: ResourceWarning: unclosed <socket.socket fd=20, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51719), raddr=('172.217.1.202', 443)>

2018-06-15 16:51:51,048: sys:1: ResourceWarning: unclosed <socket.socket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51712), raddr=('172.217.12.13', 443)>

2018-06-15 16:51:51,048: sys:1: ResourceWarning: unclosed <socket.socket fd=17, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51716), raddr=('172.217.1.202', 443)>

2018-06-15 16:51:51,049: sys:1: ResourceWarning: unclosed <socket.socket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51718), raddr=('172.217.1.202', 443)>

2018-06-15 16:51:51,049: sys:1: ResourceWarning: unclosed <socket.socket fd=18, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51717), raddr=('172.217.1.202', 443)>

2018-06-15 16:51:51,050: sys:1: ResourceWarning: unclosed <socket.socket fd=16, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51713), raddr=('172.217.12.13', 443)>

2018-06-15 16:51:51,050: sys:1: ResourceWarning: unclosed <socket.socket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51711), raddr=('172.217.12.10', 443)>

2018-06-15 16:51:51,051: sys:1: ResourceWarning: unclosed <socket.socket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51709), raddr=('172.217.12.13', 443)>

2018-06-15 16:55:57,139: Tracking: tracking
2018-06-15 16:55:57,141: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11333dfd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11345d2b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11345d208>]}
2018-06-15 16:55:58,107: Loading dependency project from /usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/include
2018-06-15 16:55:58,132: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/agency-data-pipeline/dbt_modules
2018-06-15 16:55:58,136: Parsing get_column_values.sql
2018-06-15 16:55:58,154: Parsing core.sql
2018-06-15 16:55:58,169: Parsing adapters/bigquery.sql
2018-06-15 16:55:58,178: Parsing adapters/common.sql
2018-06-15 16:55:58,205: Parsing adapters/redshift.sql
2018-06-15 16:55:58,227: Parsing adapters/snowflake.sql
2018-06-15 16:55:58,233: Parsing etc/bigquery.sql
2018-06-15 16:55:58,238: Parsing etc/datetime.sql
2018-06-15 16:55:58,267: Parsing etc/get_custom_schema.sql
2018-06-15 16:55:58,276: Parsing materializations/helpers.sql
2018-06-15 16:55:58,297: Parsing materializations/archive/archive.sql
2018-06-15 16:55:58,339: Parsing materializations/incremental/incremental.sql
2018-06-15 16:55:58,374: Parsing materializations/seed/bigquery.sql
2018-06-15 16:55:58,383: Parsing materializations/seed/seed.sql
2018-06-15 16:55:58,435: Parsing materializations/table/bigquery_table.sql
2018-06-15 16:55:58,468: Parsing materializations/table/table.sql
2018-06-15 16:55:58,495: Parsing materializations/view/bigquery_view.sql
2018-06-15 16:55:58,511: Parsing materializations/view/view.sql
2018-06-15 16:55:58,534: Parsing schema_tests/accepted_values.sql
2018-06-15 16:55:58,540: Parsing schema_tests/not_null.sql
2018-06-15 16:55:58,545: Parsing schema_tests/relationships.sql
2018-06-15 16:55:58,552: Parsing schema_tests/unique.sql
2018-06-15 16:55:58,572: Parsing model.agency_data_pipeline.accounts_proc
2018-06-15 16:55:58,575: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-06-15 16:55:58,580: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-06-15 16:55:58,582: Parsing model.agency_data_pipeline.adwords_campaigns
2018-06-15 16:55:58,585: Parsing model.agency_data_pipeline.adwords_join
2018-06-15 16:55:58,588: Parsing model.agency_data_pipeline.adwords_stats
2018-06-15 16:55:58,592: Parsing model.agency_data_pipeline.adwords_urls
2018-06-15 16:55:58,594: Parsing model.agency_data_pipeline.fb_adcreative
2018-06-15 16:55:58,601: Parsing model.agency_data_pipeline.fb_ads
2018-06-15 16:55:58,609: Parsing model.agency_data_pipeline.fb_ads_insights
2018-06-15 16:55:58,616: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-15 16:55:58,632: Parsing model.agency_data_pipeline.fb_ads_stats
2018-06-15 16:55:58,637: Parsing model.agency_data_pipeline.fb_conversions
2018-06-15 16:55:58,640: Parsing model.agency_data_pipeline.ga_conversions
2018-06-15 16:55:58,642: Parsing model.agency_data_pipeline.ga_proc
2018-06-15 16:55:58,655: Parsing model.agency_data_pipeline.ga_stats
2018-06-15 16:55:58,660: Parsing model.agency_data_pipeline.gsc_stats
2018-06-15 16:55:58,662: Parsing model.agency_data_pipeline.youtube_stats
2018-06-15 16:55:58,664: Parsing model.agency_data_pipeline.agg_platforms_ga
2018-06-15 16:55:58,669: Parsing model.agency_data_pipeline.agg_platforms_site
2018-06-15 16:55:58,673: Parsing model.agency_data_pipeline.agg_platforms_union
2018-06-15 16:55:58,690: Found 21 models, 0 tests, 0 archives, 0 analyses, 57 macros, 0 operations, 0 seed files
2018-06-15 16:55:58,697: 
2018-06-15 16:55:58,706: Acquiring new bigquery connection "master".
2018-06-15 16:55:58,706: Opening a new connection (0 currently allocated)
2018-06-15 16:56:00,161: 16:56:00 | Concurrency: 4 threads (target='dev')
2018-06-15 16:56:00,161: 16:56:00 | 
2018-06-15 16:56:00,240: 16:56:00 | 1 of 21 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-06-15 16:56:00,240: Compiling model.agency_data_pipeline.adwords_campaigns
2018-06-15 16:56:00,250: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-15 16:56:00,245: 16:56:00 | 2 of 21 START table model agency_data_pipeline.youtube_stats......... [RUN]
2018-06-15 16:56:00,251: Compiling model.agency_data_pipeline.youtube_stats
2018-06-15 16:56:00,245: 16:56:00 | 3 of 21 START table model agency_data_pipeline.mappings_ga_proc...... [RUN]
2018-06-15 16:56:00,261: Writing injected SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-15 16:56:00,245: 16:56:00 | 4 of 21 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-06-15 16:56:00,262: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-06-15 16:56:00,264: Acquiring new bigquery connection "adwords_campaigns".
2018-06-15 16:56:00,272: Opening a new connection (1 currently allocated)
2018-06-15 16:56:00,264: Compiling model.agency_data_pipeline.adwords_urls
2018-06-15 16:56:00,286: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-15 16:56:00,272: Acquiring new bigquery connection "youtube_stats".
2018-06-15 16:56:00,297: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-15 16:56:00,302: Acquiring new bigquery connection "mappings_ga_proc".
2018-06-15 16:56:00,303: Opening a new connection (2 currently allocated)
2018-06-15 16:56:00,309: Acquiring new bigquery connection "adwords_urls".
2018-06-15 16:56:00,313: Opening a new connection (3 currently allocated)
2018-06-15 16:56:00,316: Opening a new connection (4 currently allocated)
2018-06-15 16:56:00,766: Writing runtime SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-15 16:56:00,767: Fetching data for query adwords_campaigns:
create or replace table `agency_data_pipeline`.`adwords_campaigns`
  
  as (
    SELECT
day,
campaignid,
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM
( 
	SELECT  
	'Paid' as channel,
	'Adwords' as platform,
	day,
	campaignid,
	campaign,
	account as account,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	conversions,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `adp-apprenticeship.adwords.CAMPAIGN_PERFORMANCE_REPORT`
)
WHERE lv = _sdc_sequence
GROUP BY day, campaignid, account, channel, platform, campaign
  );

    
2018-06-15 16:56:00,796: Writing runtime SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-15 16:56:00,797: Fetching data for query mappings_ga_proc:
create or replace table `agency_data_pipeline`.`mappings_ga_proc`
  
  as (
    SELECT
site,
account,
bigquery_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
FROM  ( 

	SELECT  
	site,
	account,
	bigquery_name,
	source,
	medium,
	platform as platform_n,
	channel as channel_n,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
group by site, account, bigquery_name, source, medium, platform_n, channel_n, time_of_entry
  );

    
2018-06-15 16:56:00,815: Writing runtime SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-15 16:56:00,822: Fetching data for query youtube_stats:
create or replace table `agency_data_pipeline`.`youtube_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
FROM 
  ( 
	SELECT  
	date, 
	'Social' as channel,
	'YouTube' as platform,
	'Coding is for Losers' as account,  
	0 as cost, 
	max(views) as impressions, 
	max(clicks) as clicks, 
	max(subscribers) as conversions,
	regexp_replace(regexp_replace(replace(replace(replace(landing_page_url,'http://',''),'https://',''),'.html',''),r'\?.*$',''),r'([/]$)','') as url,
	video_url
	FROM `adp-apprenticeship.agency_data_pipeline.youtube`
	group by channel, platform, account, date, video_url, url
  ) 
GROUP BY date, account, channel, platform, url
  );

    
2018-06-15 16:56:00,826: Writing runtime SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-15 16:56:00,829: Fetching data for query adwords_urls:
create or replace table `agency_data_pipeline`.`adwords_urls`
  
  as (
    SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url
FROM 
(
	SELECT  
	campaignid,
	max(finalurl) finalurl
	FROM `adp-apprenticeship.adwords.FINAL_URL_REPORT`
	GROUP BY campaignid
)
  );

    
2018-06-15 16:56:02,667: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c09dc6d3-8c3b-434b-88b3-a3692dac63ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1136730b8>]}
2018-06-15 16:56:02,984: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c09dc6d3-8c3b-434b-88b3-a3692dac63ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11356a1d0>]}
2018-06-15 16:56:02,989: 16:56:02 | 1 of 21 OK created table model agency_data_pipeline.adwords_campaigns [OK in 2.43s]
2018-06-15 16:56:02,990: 16:56:02 | 5 of 21 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-06-15 16:56:02,990: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-06-15 16:56:02,997: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-15 16:56:03,000: Acquiring new bigquery connection "conversion_goals_proc".
2018-06-15 16:56:03,000: Re-using an available connection from the pool.
2018-06-15 16:56:03,040: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c09dc6d3-8c3b-434b-88b3-a3692dac63ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11359b710>]}
2018-06-15 16:56:03,134: Writing runtime SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-15 16:56:03,134: Fetching data for query conversion_goals_proc:
create or replace table `agency_data_pipeline`.`conversion_goals_proc`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
FROM  ( 

	SELECT  
	site,
	bigquery_name,
	platform,
	trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
	goal_type,
	account,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by site, bigquery_name, platform, account, goal_name
  );

    
2018-06-15 16:56:03,260: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c09dc6d3-8c3b-434b-88b3-a3692dac63ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11359bc88>]}
2018-06-15 16:56:03,316: 16:56:03 | 2 of 21 OK created table model agency_data_pipeline.youtube_stats.... [OK in 2.73s]
2018-06-15 16:56:03,317: 16:56:03 | 6 of 21 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-06-15 16:56:03,319: Compiling model.agency_data_pipeline.accounts_proc
2018-06-15 16:56:03,327: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 16:56:03,329: Acquiring new bigquery connection "accounts_proc".
2018-06-15 16:56:03,329: Re-using an available connection from the pool.
2018-06-15 16:56:03,450: Writing runtime SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 16:56:03,451: Fetching data for query accounts_proc:
create or replace table `agency_data_pipeline`.`accounts_proc`
  
  as (
    SELECT
site,
bigquery_name,
account,
platform
FROM  (
 
	SELECT  
	site,
	bigquery_name,
	account,
	platform,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.accounts`
) 

WHERE lv = time_of_entry
  );

    
2018-06-15 16:56:03,649: 16:56:03 | 3 of 21 OK created table model agency_data_pipeline.mappings_ga_proc. [OK in 2.78s]
2018-06-15 16:56:03,650: 16:56:03 | 7 of 21 START table model agency_data_pipeline.gsc_stats............. [RUN]
2018-06-15 16:56:03,651: Compiling model.agency_data_pipeline.gsc_stats
2018-06-15 16:56:03,666: Writing injected SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-15 16:56:03,668: Acquiring new bigquery connection "gsc_stats".
2018-06-15 16:56:03,669: Re-using an available connection from the pool.
2018-06-15 16:56:03,785: Writing runtime SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-15 16:56:03,786: Fetching data for query gsc_stats:
create or replace table `agency_data_pipeline`.`gsc_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
0 as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
0 as conversions
FROM 
  ( 
	SELECT  
	date, 
	site as account,
	'Organic' as channel,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(replace(landing_page_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
	max(impressions) as impressions, 
	max(clicks) as clicks
	FROM `adp-apprenticeship.agency_data_pipeline.gsc`
	GROUP BY date, account, channel, platform, url
  ) 
GROUP BY date, account, channel, platform, url
ORDER BY account asc, date asc, url asc
  );

    
2018-06-15 16:56:03,985: 16:56:03 | 4 of 21 OK created table model agency_data_pipeline.adwords_urls..... [OK in 3.00s]
2018-06-15 16:56:05,059: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c09dc6d3-8c3b-434b-88b3-a3692dac63ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1136730b8>]}
2018-06-15 16:56:05,272: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c09dc6d3-8c3b-434b-88b3-a3692dac63ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11356a1d0>]}
2018-06-15 16:56:05,372: 16:56:05 | 5 of 21 OK created table model agency_data_pipeline.conversion_goals_proc [OK in 2.07s]
2018-06-15 16:56:05,610: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c09dc6d3-8c3b-434b-88b3-a3692dac63ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11359b710>]}
2018-06-15 16:56:05,689: 16:56:05 | 6 of 21 OK created table model agency_data_pipeline.accounts_proc.... [OK in 1.95s]
2018-06-15 16:56:06,004: 16:56:06 | 7 of 21 OK created table model agency_data_pipeline.gsc_stats........ [OK in 1.96s]
2018-06-15 16:56:06,005: 16:56:06 | 8 of 21 START table model agency_data_pipeline.fb_conversions........ [RUN]
2018-06-15 16:56:06,005: 16:56:06 | 9 of 21 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-06-15 16:56:06,005: 16:56:06 | 10 of 21 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-06-15 16:56:06,005: 16:56:06 | 11 of 21 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-06-15 16:56:06,005: Compiling model.agency_data_pipeline.fb_conversions
2018-06-15 16:56:06,006: Compiling model.agency_data_pipeline.ga_conversions
2018-06-15 16:56:06,006: Compiling model.agency_data_pipeline.fb_ads_insights
2018-06-15 16:56:06,006: Compiling model.agency_data_pipeline.fb_adcreative
2018-06-15 16:56:06,013: Writing injected SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-15 16:56:06,026: Acquiring new bigquery connection "fb_ads_insights".
2018-06-15 16:56:06,028: Acquiring new bigquery connection "fb_adcreative".
2018-06-15 16:56:06,028: Re-using an available connection from the pool.
2018-06-15 16:56:06,033: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-15 16:56:06,034: Fetching data for query fb_ads_insights:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:56:06,034: Re-using an available connection from the pool.
2018-06-15 16:56:06,036: Acquiring new bigquery connection "fb_conversions".
2018-06-15 16:56:06,037: Fetching data for query fb_adcreative:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:56:06,039: Re-using an available connection from the pool.
2018-06-15 16:56:06,041: Acquiring new bigquery connection "ga_conversions".
2018-06-15 16:56:06,052: Re-using an available connection from the pool.
2018-06-15 16:56:06,174: Writing runtime SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-15 16:56:06,189: Fetching data for query fb_conversions:
create or replace table `agency_data_pipeline`.`fb_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'FB Ads'
  );

    
2018-06-15 16:56:06,195: Writing runtime SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-15 16:56:06,197: Fetching data for query ga_conversions:
create or replace table `agency_data_pipeline`.`ga_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'Google Analytics'
  );

    
2018-06-15 16:56:07,882: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-15 16:56:07,910: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-15 16:56:07,960: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c09dc6d3-8c3b-434b-88b3-a3692dac63ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x115a18f60>]}
2018-06-15 16:56:08,010: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-15 16:56:08,011: Fetching data for query fb_ads_insights:
create or replace table `agency_data_pipeline`.`fb_ads_insights`
  
  as (
    



with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


  );

    
2018-06-15 16:56:08,043: Writing runtime SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-15 16:56:08,044: Fetching data for query fb_adcreative:
create or replace table `agency_data_pipeline`.`fb_adcreative`
  
  as (
    



with fb_adcreative as (


	    
		   	SELECT 
			id,
			link_url object_url,
			url_tags,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


  );

    
2018-06-15 16:56:08,282: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c09dc6d3-8c3b-434b-88b3-a3692dac63ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1136dd2b0>]}
2018-06-15 16:56:08,285: 16:56:08 | 9 of 21 OK created table model agency_data_pipeline.ga_conversions... [OK in 1.95s]
2018-06-15 16:56:08,597: 16:56:08 | 8 of 21 OK created table model agency_data_pipeline.fb_conversions... [OK in 2.28s]
2018-06-15 16:56:09,841: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c09dc6d3-8c3b-434b-88b3-a3692dac63ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1136735c0>]}
2018-06-15 16:56:09,943: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c09dc6d3-8c3b-434b-88b3-a3692dac63ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11359b710>]}
2018-06-15 16:56:10,156: 16:56:10 | 11 of 21 OK created table model agency_data_pipeline.fb_adcreative... [OK in 3.84s]
2018-06-15 16:56:10,469: 16:56:10 | 10 of 21 OK created table model agency_data_pipeline.fb_ads_insights. [OK in 3.94s]
2018-06-15 16:56:10,470: 16:56:10 | 12 of 21 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-06-15 16:56:10,470: Compiling model.agency_data_pipeline.adwords_join
2018-06-15 16:56:10,470: 16:56:10 | 13 of 21 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-06-15 16:56:10,472: Compiling model.agency_data_pipeline.fb_ads
2018-06-15 16:56:10,480: Acquiring new bigquery connection "fb_ads".
2018-06-15 16:56:10,480: Re-using an available connection from the pool.
2018-06-15 16:56:10,480: Fetching data for query fb_ads:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:56:10,489: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-15 16:56:10,492: Acquiring new bigquery connection "adwords_join".
2018-06-15 16:56:10,492: Re-using an available connection from the pool.
2018-06-15 16:56:10,623: Writing runtime SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-15 16:56:10,624: Fetching data for query adwords_join:
create or replace table `agency_data_pipeline`.`adwords_join`
  
  as (
    SELECT
day,
a.campaign,
a.campaignid, 
account, 
channel,
platform,
b.url,
cost,
impressions,
clicks,
conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_campaigns` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`adwords_urls` b
ON a.campaignid = b.campaignid
  );

    
2018-06-15 16:56:11,116: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-15 16:56:11,245: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-15 16:56:11,248: Fetching data for query fb_ads:
create or replace table `agency_data_pipeline`.`fb_ads`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


  );

    
2018-06-15 16:56:13,232: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c09dc6d3-8c3b-434b-88b3-a3692dac63ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1136dd5f8>]}
2018-06-15 16:56:13,545: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c09dc6d3-8c3b-434b-88b3-a3692dac63ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113630a58>]}
2018-06-15 16:56:13,548: 16:56:13 | 13 of 21 OK created table model agency_data_pipeline.fb_ads.......... [OK in 2.76s]
2018-06-15 16:56:13,865: 16:56:13 | 12 of 21 OK created table model agency_data_pipeline.adwords_join.... [OK in 3.07s]
2018-06-15 16:56:13,866: 16:56:13 | 14 of 21 START table model agency_data_pipeline.ga_proc.............. [RUN]
2018-06-15 16:56:13,866: 16:56:13 | 15 of 21 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-06-15 16:56:13,867: Compiling model.agency_data_pipeline.ga_proc
2018-06-15 16:56:13,867: 16:56:13 | 16 of 21 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-06-15 16:56:13,867: Compiling model.agency_data_pipeline.adwords_stats
2018-06-15 16:56:13,879: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-15 16:56:13,881: Acquiring new bigquery connection "ga_proc".
2018-06-15 16:56:13,900: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-15 16:56:13,900: Re-using an available connection from the pool.
2018-06-15 16:56:13,905: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-06-15 16:56:13,905: Fetching data for query ga_proc:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:56:13,906: Re-using an available connection from the pool.
2018-06-15 16:56:13,906: Fetching data for query fb_ads_insights_conversions:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:56:13,907: Acquiring new bigquery connection "adwords_stats".
2018-06-15 16:56:13,910: Re-using an available connection from the pool.
2018-06-15 16:56:14,042: Writing runtime SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-15 16:56:14,043: Fetching data for query adwords_stats:
create or replace table `agency_data_pipeline`.`adwords_stats`
  
  as (
    SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_join`
GROUP BY date, account, platform, channel, url, campaign
  );

    
2018-06-15 16:56:14,569: Fetching data for query fb_ads_insights_conversions:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`
        where goal_name is not null
        and goal_name != ''

        
        ##where 1 = 1
        and goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:56:15,463: Fetching data for query ga_proc:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`
        where goal_name is not null
        and goal_name != ''

        
        ##where 1 = 1
        and goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:56:15,899: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c09dc6d3-8c3b-434b-88b3-a3692dac63ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113630940>]}
2018-06-15 16:56:16,212: 16:56:16 | 15 of 21 OK created table model agency_data_pipeline.adwords_stats... [OK in 2.03s]
2018-06-15 16:56:16,299: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-06-15 16:56:16,434: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-06-15 16:56:16,434: Fetching data for query fb_ads_insights_conversions:
create or replace table `agency_data_pipeline`.`fb_ads_insights_conversions`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`





with fb_ads_insights_conversions as (

	    

	    	

		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			_sdc_sequence,
			action_type,
			_28d_click conversions,
			null as revenue
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
			cross join unnest(actions)

			## goal completion columns
			
				where action_type in (
				
					'offsite_conversion.fb_pixel_lead'
					 
				
				)
			
			
			UNION ALL

		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			_sdc_sequence,
			action_type,
			null as conversions,
			_28d_click as revenue
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
			cross join unnest(action_values)
			
			## goal completion columns
			
				where action_type in (
				
					'offsite_conversion.fb_pixel_lead'
					 
				
				)
			

		    
	   

)

SELECT 
date,
campaign_id,
campaign,
ad_id,
account,
sum(conversions) conversions,
sum(revenue) revenue
FROM 
		(
	    SELECT
	    date_start date,
	    campaign_id,
	    campaign_name campaign,
	    ad_id,
	    account_name account,
	    action_type,
	    conversions,
	    revenue,
	    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
	    _sdc_sequence
	    FROM fb_ads_insights_conversions
	   	)
where lv = _sdc_sequence
group by date, campaign_id, campaign, ad_id, account



  );

    
2018-06-15 16:56:17,017: Writing injected SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-15 16:56:17,122: Writing runtime SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-15 16:56:17,123: Fetching data for query ga_proc:
create or replace table `agency_data_pipeline`.`ga_proc`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`




with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'cifl' as bigquery_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			sessions,
			## goal completion columns
			
				
					cast(goal1completions as int64) 
					 
					 as goal_completions,  
				
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.ga_cifl.report` 

		    
	   

)


SELECT 
bigquery_name,
lookup_platform,
date,
url,
source,
medium,
sum(sessions) sessions,
sum(goal_completions) goal_completions
FROM ga_report
where lv = _sdc_sequence
group by bigquery_name, lookup_platform, date, url, source, medium


  );

    
2018-06-15 16:56:18,257: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c09dc6d3-8c3b-434b-88b3-a3692dac63ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x115a65630>]}
2018-06-15 16:56:18,576: 16:56:18 | 16 of 21 OK created table model agency_data_pipeline.fb_ads_insights_conversions [OK in 4.38s]
2018-06-15 16:56:19,157: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c09dc6d3-8c3b-434b-88b3-a3692dac63ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x115a5f780>]}
2018-06-15 16:56:19,518: 16:56:19 | 14 of 21 OK created table model agency_data_pipeline.ga_proc......... [OK in 5.29s]
2018-06-15 16:56:19,518: 16:56:19 | 17 of 21 START table model agency_data_pipeline.ga_stats............. [RUN]
2018-06-15 16:56:19,518: Compiling model.agency_data_pipeline.ga_stats
2018-06-15 16:56:19,526: Writing injected SQL for node "model.agency_data_pipeline.ga_stats"
2018-06-15 16:56:19,528: Acquiring new bigquery connection "ga_stats".
2018-06-15 16:56:19,529: Re-using an available connection from the pool.
2018-06-15 16:56:19,729: Writing runtime SQL for node "model.agency_data_pipeline.ga_stats"
2018-06-15 16:56:19,730: Fetching data for query ga_stats:
create or replace table `agency_data_pipeline`.`ga_stats`
  
  as (
    SELECT  
cast(date as date) date,
b.account,
b.site site,
c.source source,
c.medium medium,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
url,
sum(sessions) sessions,
sum(goal_completions) goal_completions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`ga_proc` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.bigquery_name = b.bigquery_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.bigquery_name = c.bigquery_name )
GROUP BY date, account, site, source, medium, source_medium, platform, channel, url
  );

    
2018-06-15 16:56:22,405: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c09dc6d3-8c3b-434b-88b3-a3692dac63ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x115a5fcc0>]}
2018-06-15 16:56:22,719: 16:56:22 | 17 of 21 OK created table model agency_data_pipeline.ga_stats........ [OK in 2.89s]
2018-06-15 16:56:22,720: 16:56:22 | 18 of 21 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-06-15 16:56:22,720: Compiling model.agency_data_pipeline.fb_ads_stats
2018-06-15 16:56:22,732: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-06-15 16:56:22,734: Acquiring new bigquery connection "fb_ads_stats".
2018-06-15 16:56:22,735: Re-using an available connection from the pool.
2018-06-15 16:56:22,861: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-06-15 16:56:22,862: Fetching data for query fb_ads_stats:
create or replace table `agency_data_pipeline`.`fb_ads_stats`
  
  as (
    with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions, null as revenue
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions, revenue
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) transactions,
    sum(revenue) revenue
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign
  );

    
2018-06-15 16:56:24,440: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c09dc6d3-8c3b-434b-88b3-a3692dac63ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x115a5f780>]}
2018-06-15 16:56:24,757: 16:56:24 | 18 of 21 OK created table model agency_data_pipeline.fb_ads_stats.... [OK in 1.72s]
2018-06-15 16:56:24,758: 16:56:24 | 19 of 21 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-06-15 16:56:24,758: Compiling model.agency_data_pipeline.agg_platforms_union
2018-06-15 16:56:24,765: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-06-15 16:56:24,767: Acquiring new bigquery connection "agg_platforms_union".
2018-06-15 16:56:24,767: Re-using an available connection from the pool.
2018-06-15 16:56:24,888: Writing runtime SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-06-15 16:56:24,888: Fetching data for query agg_platforms_union:
create or replace table `agency_data_pipeline`.`agg_platforms_union`
  
  as (
    SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`adwords_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`gsc_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`youtube_stats`
  );

    
2018-06-15 16:56:25,230: Bad request while running:
create dataset
2018-06-15 16:56:25,230: 400 GET https://www.googleapis.com/bigquery/v2/projects/adp-apprenticeship/queries/aedb17df-215b-44cf-a769-6b705fc4b055?maxResults=0: Unrecognized name: conversions at [28:1]
2018-06-15 16:56:25,230: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c09dc6d3-8c3b-434b-88b3-a3692dac63ba', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1135cfcc0>]}
2018-06-15 16:56:25,542: 16:56:25 | 19 of 21 ERROR creating table model agency_data_pipeline.agg_platforms_union [ERROR in 0.47s]
2018-06-15 16:56:25,543: 16:56:25 | 20 of 21 SKIP relation agency_data_pipeline.agg_platforms_site....... [SKIP]
2018-06-15 16:56:25,543: 16:56:25 | 21 of 21 SKIP relation agency_data_pipeline.agg_platforms_ga......... [SKIP]
2018-06-15 16:56:25,617: 16:56:25 | 
2018-06-15 16:56:25,618: 16:56:25 | Finished running 21 table models in 26.92s.
2018-06-15 16:56:25,618: Connection 'master' was left open.
2018-06-15 16:56:25,618: 
2018-06-15 16:56:25,618: Completed with 1 errors:
2018-06-15 16:56:25,618: 
2018-06-15 16:56:25,619: Database Error in model agg_platforms_union (models/join/agg_platforms_union.sql)
2018-06-15 16:56:25,619:   Unrecognized name: conversions at [28:1]
2018-06-15 16:56:25,619:   compiled SQL at target/run/agency_data_pipeline/join/agg_platforms_union.sql
2018-06-15 16:56:25,619: 
Done. PASS=18 ERROR=1 SKIP=2 TOTAL=21
2018-06-15 16:56:25,619: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11333dfd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113524780>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113524908>]}
2018-06-15 16:56:25,938: Flushing usage events
2018-06-15 16:56:25,979: sys:1: ResourceWarning: unclosed <socket.socket fd=16, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51752), raddr=('172.217.12.13', 443)>

2018-06-15 16:56:25,979: sys:1: ResourceWarning: unclosed <socket.socket fd=14, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51749), raddr=('172.217.12.13', 443)>

2018-06-15 16:56:25,979: sys:1: ResourceWarning: unclosed <socket.socket fd=17, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51753), raddr=('172.217.3.10', 443)>

2018-06-15 16:56:25,979: sys:1: ResourceWarning: unclosed <socket.socket fd=18, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51754), raddr=('172.217.3.10', 443)>

2018-06-15 16:56:25,980: sys:1: ResourceWarning: unclosed <socket.socket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51756), raddr=('172.217.3.10', 443)>

2018-06-15 16:56:25,980: sys:1: ResourceWarning: unclosed <socket.socket fd=20, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51755), raddr=('172.217.3.10', 443)>

2018-06-15 16:56:25,980: sys:1: ResourceWarning: unclosed <socket.socket fd=15, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51750), raddr=('172.217.12.13', 443)>

2018-06-15 16:56:25,981: sys:1: ResourceWarning: unclosed <socket.socket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51751), raddr=('172.217.12.13', 443)>

2018-06-15 16:56:25,981: sys:1: ResourceWarning: unclosed <socket.socket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51748), raddr=('172.217.2.10', 443)>

2018-06-15 16:56:25,981: sys:1: ResourceWarning: unclosed <socket.socket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51747), raddr=('172.217.12.13', 443)>

2018-06-15 16:58:03,955: Tracking: tracking
2018-06-15 16:58:03,957: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107da8fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107da83c8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107da8a90>]}
2018-06-15 16:58:04,963: Loading dependency project from /usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/include
2018-06-15 16:58:04,993: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/agency-data-pipeline/dbt_modules
2018-06-15 16:58:04,995: Parsing get_column_values.sql
2018-06-15 16:58:05,013: Parsing core.sql
2018-06-15 16:58:05,031: Parsing adapters/bigquery.sql
2018-06-15 16:58:05,039: Parsing adapters/common.sql
2018-06-15 16:58:05,072: Parsing adapters/redshift.sql
2018-06-15 16:58:05,104: Parsing adapters/snowflake.sql
2018-06-15 16:58:05,112: Parsing etc/bigquery.sql
2018-06-15 16:58:05,116: Parsing etc/datetime.sql
2018-06-15 16:58:05,149: Parsing etc/get_custom_schema.sql
2018-06-15 16:58:05,160: Parsing materializations/helpers.sql
2018-06-15 16:58:05,184: Parsing materializations/archive/archive.sql
2018-06-15 16:58:05,244: Parsing materializations/incremental/incremental.sql
2018-06-15 16:58:05,281: Parsing materializations/seed/bigquery.sql
2018-06-15 16:58:05,289: Parsing materializations/seed/seed.sql
2018-06-15 16:58:05,338: Parsing materializations/table/bigquery_table.sql
2018-06-15 16:58:05,374: Parsing materializations/table/table.sql
2018-06-15 16:58:05,400: Parsing materializations/view/bigquery_view.sql
2018-06-15 16:58:05,414: Parsing materializations/view/view.sql
2018-06-15 16:58:05,436: Parsing schema_tests/accepted_values.sql
2018-06-15 16:58:05,443: Parsing schema_tests/not_null.sql
2018-06-15 16:58:05,448: Parsing schema_tests/relationships.sql
2018-06-15 16:58:05,457: Parsing schema_tests/unique.sql
2018-06-15 16:58:05,486: Parsing model.agency_data_pipeline.accounts_proc
2018-06-15 16:58:05,489: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-06-15 16:58:05,493: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-06-15 16:58:05,496: Parsing model.agency_data_pipeline.adwords_campaigns
2018-06-15 16:58:05,499: Parsing model.agency_data_pipeline.adwords_join
2018-06-15 16:58:05,503: Parsing model.agency_data_pipeline.adwords_stats
2018-06-15 16:58:05,506: Parsing model.agency_data_pipeline.adwords_urls
2018-06-15 16:58:05,509: Parsing model.agency_data_pipeline.fb_adcreative
2018-06-15 16:58:05,516: Parsing model.agency_data_pipeline.fb_ads
2018-06-15 16:58:05,523: Parsing model.agency_data_pipeline.fb_ads_insights
2018-06-15 16:58:05,530: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-15 16:58:05,552: Parsing model.agency_data_pipeline.fb_ads_stats
2018-06-15 16:58:05,556: Parsing model.agency_data_pipeline.fb_conversions
2018-06-15 16:58:05,559: Parsing model.agency_data_pipeline.ga_conversions
2018-06-15 16:58:05,561: Parsing model.agency_data_pipeline.ga_proc
2018-06-15 16:58:05,573: Parsing model.agency_data_pipeline.ga_stats
2018-06-15 16:58:05,578: Parsing model.agency_data_pipeline.gsc_stats
2018-06-15 16:58:05,580: Parsing model.agency_data_pipeline.youtube_stats
2018-06-15 16:58:05,583: Parsing model.agency_data_pipeline.agg_platforms_ga
2018-06-15 16:58:05,586: Parsing model.agency_data_pipeline.agg_platforms_site
2018-06-15 16:58:05,589: Parsing model.agency_data_pipeline.agg_platforms_union
2018-06-15 16:58:05,607: Found 21 models, 0 tests, 0 archives, 0 analyses, 57 macros, 0 operations, 0 seed files
2018-06-15 16:58:05,613: 
2018-06-15 16:58:05,620: Acquiring new bigquery connection "master".
2018-06-15 16:58:05,621: Opening a new connection (0 currently allocated)
2018-06-15 16:58:06,987: 16:58:06 | Concurrency: 4 threads (target='dev')
2018-06-15 16:58:06,987: 16:58:06 | 
2018-06-15 16:58:07,054: 16:58:07 | 1 of 21 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-06-15 16:58:07,055: Compiling model.agency_data_pipeline.accounts_proc
2018-06-15 16:58:07,054: 16:58:07 | 2 of 21 START table model agency_data_pipeline.mappings_ga_proc...... [RUN]
2018-06-15 16:58:07,060: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-06-15 16:58:07,067: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 16:58:07,054: 16:58:07 | 3 of 21 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-06-15 16:58:07,068: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-15 16:58:07,055: 16:58:07 | 4 of 21 START table model agency_data_pipeline.youtube_stats......... [RUN]
2018-06-15 16:58:07,069: Compiling model.agency_data_pipeline.adwords_urls
2018-06-15 16:58:07,069: Compiling model.agency_data_pipeline.youtube_stats
2018-06-15 16:58:07,071: Acquiring new bigquery connection "accounts_proc".
2018-06-15 16:58:07,082: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-15 16:58:07,086: Writing injected SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-15 16:58:07,086: Opening a new connection (1 currently allocated)
2018-06-15 16:58:07,088: Acquiring new bigquery connection "mappings_ga_proc".
2018-06-15 16:58:07,091: Acquiring new bigquery connection "adwords_urls".
2018-06-15 16:58:07,095: Acquiring new bigquery connection "youtube_stats".
2018-06-15 16:58:07,098: Opening a new connection (2 currently allocated)
2018-06-15 16:58:07,100: Opening a new connection (3 currently allocated)
2018-06-15 16:58:07,106: Opening a new connection (4 currently allocated)
2018-06-15 16:58:07,619: Writing runtime SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 16:58:07,621: Fetching data for query accounts_proc:
create or replace table `agency_data_pipeline`.`accounts_proc`
  
  as (
    SELECT
site,
bigquery_name,
account,
platform
FROM  (
 
	SELECT  
	site,
	bigquery_name,
	account,
	platform,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.accounts`
) 

WHERE lv = time_of_entry
  );

    
2018-06-15 16:58:07,635: Writing runtime SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-15 16:58:07,657: Writing runtime SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-15 16:58:07,659: Fetching data for query mappings_ga_proc:
create or replace table `agency_data_pipeline`.`mappings_ga_proc`
  
  as (
    SELECT
site,
account,
bigquery_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
FROM  ( 

	SELECT  
	site,
	account,
	bigquery_name,
	source,
	medium,
	platform as platform_n,
	channel as channel_n,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
group by site, account, bigquery_name, source, medium, platform_n, channel_n, time_of_entry
  );

    
2018-06-15 16:58:07,662: Fetching data for query adwords_urls:
create or replace table `agency_data_pipeline`.`adwords_urls`
  
  as (
    SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url
FROM 
(
	SELECT  
	campaignid,
	max(finalurl) finalurl
	FROM `adp-apprenticeship.adwords.FINAL_URL_REPORT`
	GROUP BY campaignid
)
  );

    
2018-06-15 16:58:07,684: Writing runtime SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-15 16:58:07,685: Fetching data for query youtube_stats:
create or replace table `agency_data_pipeline`.`youtube_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
FROM 
  ( 
	SELECT  
	date, 
	'Social' as channel,
	'YouTube' as platform,
	'Coding is for Losers' as account,  
	0 as cost, 
	max(views) as impressions, 
	max(clicks) as clicks, 
	max(subscribers) as conversions,
	regexp_replace(regexp_replace(replace(replace(replace(landing_page_url,'http://',''),'https://',''),'.html',''),r'\?.*$',''),r'([/]$)','') as url,
	video_url
	FROM `adp-apprenticeship.agency_data_pipeline.youtube`
	group by channel, platform, account, date, video_url, url
  ) 
GROUP BY date, account, channel, platform, url
  );

    
2018-06-15 16:58:09,800: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '77a9a022-1364-4590-afe0-feaf5af88bcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fbe5f8>]}
2018-06-15 16:58:09,816: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '77a9a022-1364-4590-afe0-feaf5af88bcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fbe2e8>]}
2018-06-15 16:58:09,818: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '77a9a022-1364-4590-afe0-feaf5af88bcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fbe048>]}
2018-06-15 16:58:09,831: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '77a9a022-1364-4590-afe0-feaf5af88bcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fbe390>]}
2018-06-15 16:58:10,124: 16:58:10 | 4 of 21 OK created table model agency_data_pipeline.youtube_stats.... [OK in 2.73s]
2018-06-15 16:58:10,128: 16:58:10 | 5 of 21 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-06-15 16:58:10,129: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-06-15 16:58:10,137: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-15 16:58:10,139: Acquiring new bigquery connection "conversion_goals_proc".
2018-06-15 16:58:10,140: Re-using an available connection from the pool.
2018-06-15 16:58:10,449: 16:58:10 | 2 of 21 OK created table model agency_data_pipeline.mappings_ga_proc. [OK in 2.76s]
2018-06-15 16:58:10,450: 16:58:10 | 6 of 21 START table model agency_data_pipeline.gsc_stats............. [RUN]
2018-06-15 16:58:10,451: Compiling model.agency_data_pipeline.gsc_stats
2018-06-15 16:58:10,461: Writing injected SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-15 16:58:10,464: Acquiring new bigquery connection "gsc_stats".
2018-06-15 16:58:10,464: Re-using an available connection from the pool.
2018-06-15 16:58:10,651: Writing runtime SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-15 16:58:10,667: Writing runtime SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-15 16:58:10,667: Fetching data for query gsc_stats:
create or replace table `agency_data_pipeline`.`gsc_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
0 as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
0 as conversions
FROM 
  ( 
	SELECT  
	date, 
	site as account,
	'Organic' as channel,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(replace(landing_page_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
	max(impressions) as impressions, 
	max(clicks) as clicks
	FROM `adp-apprenticeship.agency_data_pipeline.gsc`
	GROUP BY date, account, channel, platform, url
  ) 
GROUP BY date, account, channel, platform, url
ORDER BY account asc, date asc, url asc
  );

    
2018-06-15 16:58:10,671: Fetching data for query conversion_goals_proc:
create or replace table `agency_data_pipeline`.`conversion_goals_proc`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
FROM  ( 

	SELECT  
	site,
	bigquery_name,
	platform,
	trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
	goal_type,
	account,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by site, bigquery_name, platform, account, goal_name
  );

    
2018-06-15 16:58:10,774: 16:58:10 | 1 of 21 OK created table model agency_data_pipeline.accounts_proc.... [OK in 2.76s]
2018-06-15 16:58:10,775: 16:58:10 | 7 of 21 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-06-15 16:58:10,775: Compiling model.agency_data_pipeline.adwords_campaigns
2018-06-15 16:58:10,783: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-15 16:58:10,787: Acquiring new bigquery connection "adwords_campaigns".
2018-06-15 16:58:10,788: Re-using an available connection from the pool.
2018-06-15 16:58:11,106: 16:58:11 | 3 of 21 OK created table model agency_data_pipeline.adwords_urls..... [OK in 2.76s]
2018-06-15 16:58:11,169: Writing runtime SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-15 16:58:11,170: Fetching data for query adwords_campaigns:
create or replace table `agency_data_pipeline`.`adwords_campaigns`
  
  as (
    SELECT
day,
campaignid,
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM
( 
	SELECT  
	'Paid' as channel,
	'Adwords' as platform,
	day,
	campaignid,
	campaign,
	account as account,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	conversions,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `adp-apprenticeship.adwords.CAMPAIGN_PERFORMANCE_REPORT`
)
WHERE lv = _sdc_sequence
GROUP BY day, campaignid, account, channel, platform, campaign
  );

    
2018-06-15 16:58:13,370: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '77a9a022-1364-4590-afe0-feaf5af88bcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fbe5f8>]}
2018-06-15 16:58:13,375: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '77a9a022-1364-4590-afe0-feaf5af88bcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fbe2e8>]}
2018-06-15 16:58:13,699: 16:58:13 | 5 of 21 OK created table model agency_data_pipeline.conversion_goals_proc [OK in 3.24s]
2018-06-15 16:58:13,853: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '77a9a022-1364-4590-afe0-feaf5af88bcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108033dd8>]}
2018-06-15 16:58:14,024: 16:58:14 | 6 of 21 OK created table model agency_data_pipeline.gsc_stats........ [OK in 2.92s]
2018-06-15 16:58:14,350: 16:58:14 | 7 of 21 OK created table model agency_data_pipeline.adwords_campaigns [OK in 3.08s]
2018-06-15 16:58:14,351: 16:58:14 | 8 of 21 START table model agency_data_pipeline.fb_adcreative......... [RUN]
2018-06-15 16:58:14,351: Compiling model.agency_data_pipeline.fb_adcreative
2018-06-15 16:58:14,351: 16:58:14 | 9 of 21 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-06-15 16:58:14,351: 16:58:14 | 10 of 21 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-06-15 16:58:14,354: Compiling model.agency_data_pipeline.ga_conversions
2018-06-15 16:58:14,351: 16:58:14 | 11 of 21 START table model agency_data_pipeline.fb_conversions....... [RUN]
2018-06-15 16:58:14,361: Compiling model.agency_data_pipeline.fb_ads_insights
2018-06-15 16:58:14,362: Acquiring new bigquery connection "fb_adcreative".
2018-06-15 16:58:14,367: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-15 16:58:14,367: Compiling model.agency_data_pipeline.fb_conversions
2018-06-15 16:58:14,374: Re-using an available connection from the pool.
2018-06-15 16:58:14,382: Acquiring new bigquery connection "fb_ads_insights".
2018-06-15 16:58:14,387: Fetching data for query fb_adcreative:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:58:14,387: Writing injected SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-15 16:58:14,388: Re-using an available connection from the pool.
2018-06-15 16:58:14,397: Fetching data for query fb_ads_insights:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:58:14,391: Acquiring new bigquery connection "ga_conversions".
2018-06-15 16:58:14,401: Re-using an available connection from the pool.
2018-06-15 16:58:14,396: Acquiring new bigquery connection "fb_conversions".
2018-06-15 16:58:14,401: Re-using an available connection from the pool.
2018-06-15 16:58:14,944: Writing runtime SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-15 16:58:14,954: Writing runtime SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-15 16:58:14,954: Fetching data for query ga_conversions:
create or replace table `agency_data_pipeline`.`ga_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'Google Analytics'
  );

    
2018-06-15 16:58:14,957: Fetching data for query fb_conversions:
create or replace table `agency_data_pipeline`.`fb_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'FB Ads'
  );

    
2018-06-15 16:58:17,150: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '77a9a022-1364-4590-afe0-feaf5af88bcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107f3b5c0>]}
2018-06-15 16:58:17,201: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-15 16:58:17,467: 16:58:17 | 11 of 21 OK created table model agency_data_pipeline.fb_conversions.. [OK in 2.78s]
2018-06-15 16:58:17,740: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '77a9a022-1364-4590-afe0-feaf5af88bcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fbe080>]}
2018-06-15 16:58:17,763: Writing runtime SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-15 16:58:17,763: Fetching data for query fb_adcreative:
create or replace table `agency_data_pipeline`.`fb_adcreative`
  
  as (
    



with fb_adcreative as (


	    
		   	SELECT 
			id,
			link_url object_url,
			url_tags,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


  );

    
2018-06-15 16:58:18,064: 16:58:18 | 9 of 21 OK created table model agency_data_pipeline.ga_conversions... [OK in 3.39s]
2018-06-15 16:58:20,025: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '77a9a022-1364-4590-afe0-feaf5af88bcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107f30908>]}
2018-06-15 16:58:20,039: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-15 16:58:20,356: 16:58:20 | 8 of 21 OK created table model agency_data_pipeline.fb_adcreative.... [OK in 5.67s]
2018-06-15 16:58:20,584: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-15 16:58:20,584: Fetching data for query fb_ads_insights:
create or replace table `agency_data_pipeline`.`fb_ads_insights`
  
  as (
    



with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


  );

    
2018-06-15 16:58:23,200: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '77a9a022-1364-4590-afe0-feaf5af88bcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fbe4a8>]}
2018-06-15 16:58:23,518: 16:58:23 | 10 of 21 OK created table model agency_data_pipeline.fb_ads_insights. [OK in 8.84s]
2018-06-15 16:58:23,518: 16:58:23 | 12 of 21 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-06-15 16:58:23,519: Compiling model.agency_data_pipeline.fb_ads
2018-06-15 16:58:23,519: 16:58:23 | 13 of 21 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-06-15 16:58:23,523: Compiling model.agency_data_pipeline.adwords_join
2018-06-15 16:58:23,535: Acquiring new bigquery connection "fb_ads".
2018-06-15 16:58:23,539: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-15 16:58:23,540: Re-using an available connection from the pool.
2018-06-15 16:58:23,541: Fetching data for query fb_ads:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:58:23,548: Acquiring new bigquery connection "adwords_join".
2018-06-15 16:58:23,549: Re-using an available connection from the pool.
2018-06-15 16:58:24,020: Writing runtime SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-15 16:58:24,020: Fetching data for query adwords_join:
create or replace table `agency_data_pipeline`.`adwords_join`
  
  as (
    SELECT
day,
a.campaign,
a.campaignid, 
account, 
channel,
platform,
b.url,
cost,
impressions,
clicks,
conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_campaigns` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`adwords_urls` b
ON a.campaignid = b.campaignid
  );

    
2018-06-15 16:58:25,631: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-15 16:58:26,116: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-15 16:58:26,116: Fetching data for query fb_ads:
create or replace table `agency_data_pipeline`.`fb_ads`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


  );

    
2018-06-15 16:58:26,601: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '77a9a022-1364-4590-afe0-feaf5af88bcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107f40f28>]}
2018-06-15 16:58:26,922: 16:58:26 | 13 of 21 OK created table model agency_data_pipeline.adwords_join.... [OK in 3.08s]
2018-06-15 16:58:29,677: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '77a9a022-1364-4590-afe0-feaf5af88bcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b04e80>]}
2018-06-15 16:58:30,007: 16:58:30 | 12 of 21 OK created table model agency_data_pipeline.fb_ads.......... [OK in 6.16s]
2018-06-15 16:58:30,009: 16:58:30 | 14 of 21 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-06-15 16:58:30,011: Compiling model.agency_data_pipeline.adwords_stats
2018-06-15 16:58:30,024: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-15 16:58:30,009: 16:58:30 | 15 of 21 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-06-15 16:58:30,025: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-15 16:58:30,010: 16:58:30 | 16 of 21 START table model agency_data_pipeline.ga_proc.............. [RUN]
2018-06-15 16:58:30,031: Compiling model.agency_data_pipeline.ga_proc
2018-06-15 16:58:30,054: Acquiring new bigquery connection "adwords_stats".
2018-06-15 16:58:30,054: Re-using an available connection from the pool.
2018-06-15 16:58:30,109: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-06-15 16:58:30,109: Re-using an available connection from the pool.
2018-06-15 16:58:30,110: Fetching data for query fb_ads_insights_conversions:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:58:30,120: Acquiring new bigquery connection "ga_proc".
2018-06-15 16:58:30,120: Re-using an available connection from the pool.
2018-06-15 16:58:30,121: Fetching data for query ga_proc:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:58:30,555: Writing runtime SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-15 16:58:30,556: Fetching data for query adwords_stats:
create or replace table `agency_data_pipeline`.`adwords_stats`
  
  as (
    SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_join`
GROUP BY date, account, platform, channel, url, campaign
  );

    
2018-06-15 16:58:32,184: Fetching data for query fb_ads_insights_conversions:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`
        where goal_name is not null
        and goal_name != ''

        
        ##where 1 = 1
        and goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:58:32,698: Fetching data for query ga_proc:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`
        where goal_name is not null
        and goal_name != ''

        
        ##where 1 = 1
        and goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:58:33,235: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '77a9a022-1364-4590-afe0-feaf5af88bcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108034c18>]}
2018-06-15 16:58:33,564: 16:58:33 | 14 of 21 OK created table model agency_data_pipeline.adwords_stats... [OK in 3.22s]
2018-06-15 16:58:34,985: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-06-15 16:58:35,437: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-06-15 16:58:35,438: Fetching data for query fb_ads_insights_conversions:
create or replace table `agency_data_pipeline`.`fb_ads_insights_conversions`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`





with fb_ads_insights_conversions as (

	    

	    	

		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			_sdc_sequence,
			action_type,
			_28d_click conversions,
			null as revenue
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
			cross join unnest(actions)

			## goal completion columns
			
				where action_type in (
				
					'offsite_conversion.fb_pixel_lead'
					 
				
				)
			
			
			UNION ALL

		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			_sdc_sequence,
			action_type,
			null as conversions,
			_28d_click as revenue
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
			cross join unnest(action_values)
			
			## goal completion columns
			
				where action_type in (
				
					'offsite_conversion.fb_pixel_lead'
					 
				
				)
			

		    
	   

)

SELECT 
date,
campaign_id,
campaign,
ad_id,
account,
sum(conversions) conversions,
sum(revenue) revenue
FROM 
		(
	    SELECT
	    date_start date,
	    campaign_id,
	    campaign_name campaign,
	    ad_id,
	    account_name account,
	    action_type,
	    conversions,
	    revenue,
	    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
	    _sdc_sequence
	    FROM fb_ads_insights_conversions
	   	)
where lv = _sdc_sequence
group by date, campaign_id, campaign, ad_id, account



  );

    
2018-06-15 16:58:35,473: Writing injected SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-15 16:58:35,913: Writing runtime SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-15 16:58:35,914: Fetching data for query ga_proc:
create or replace table `agency_data_pipeline`.`ga_proc`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`




with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'cifl' as bigquery_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			sessions,
			## goal completion columns
			
				
					cast(goal1completions as int64) 
					 
					 as goal_completions,  
				
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.ga_cifl.report` 

		    
	   

)


SELECT 
bigquery_name,
lookup_platform,
date,
url,
source,
medium,
sum(sessions) sessions,
sum(goal_completions) goal_completions
FROM ga_report
where lv = _sdc_sequence
group by bigquery_name, lookup_platform, date, url, source, medium


  );

    
2018-06-15 16:58:38,030: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '77a9a022-1364-4590-afe0-feaf5af88bcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107f025f8>]}
2018-06-15 16:58:38,355: 16:58:38 | 15 of 21 OK created table model agency_data_pipeline.fb_ads_insights_conversions [OK in 8.01s]
2018-06-15 16:58:38,987: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '77a9a022-1364-4590-afe0-feaf5af88bcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080348d0>]}
2018-06-15 16:58:39,320: 16:58:39 | 16 of 21 OK created table model agency_data_pipeline.ga_proc......... [OK in 8.96s]
2018-06-15 16:58:39,321: 16:58:39 | 17 of 21 START table model agency_data_pipeline.ga_stats............. [RUN]
2018-06-15 16:58:39,321: Compiling model.agency_data_pipeline.ga_stats
2018-06-15 16:58:39,330: Writing injected SQL for node "model.agency_data_pipeline.ga_stats"
2018-06-15 16:58:39,334: Acquiring new bigquery connection "ga_stats".
2018-06-15 16:58:39,335: Re-using an available connection from the pool.
2018-06-15 16:58:39,829: Writing runtime SQL for node "model.agency_data_pipeline.ga_stats"
2018-06-15 16:58:39,830: Fetching data for query ga_stats:
create or replace table `agency_data_pipeline`.`ga_stats`
  
  as (
    SELECT  
cast(date as date) date,
b.account,
b.site site,
c.source source,
c.medium medium,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
url,
sum(sessions) sessions,
sum(goal_completions) goal_completions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`ga_proc` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.bigquery_name = b.bigquery_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.bigquery_name = c.bigquery_name )
GROUP BY date, account, site, source, medium, source_medium, platform, channel, url
  );

    
2018-06-15 16:58:42,834: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '77a9a022-1364-4590-afe0-feaf5af88bcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b1b320>]}
2018-06-15 16:58:43,157: 16:58:43 | 17 of 21 OK created table model agency_data_pipeline.ga_stats........ [OK in 3.51s]
2018-06-15 16:58:43,158: 16:58:43 | 18 of 21 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-06-15 16:58:43,158: Compiling model.agency_data_pipeline.fb_ads_stats
2018-06-15 16:58:43,172: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-06-15 16:58:43,177: Acquiring new bigquery connection "fb_ads_stats".
2018-06-15 16:58:43,177: Re-using an available connection from the pool.
2018-06-15 16:58:43,305: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-06-15 16:58:43,306: Fetching data for query fb_ads_stats:
create or replace table `agency_data_pipeline`.`fb_ads_stats`
  
  as (
    with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions,
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) conversions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign
  );

    
2018-06-15 16:58:43,463: Bad request while running:
create dataset
2018-06-15 16:58:43,463: 400 Syntax error: Trailing comma before the FROM clause is not allowed at [9:5]
2018-06-15 16:58:43,463: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '77a9a022-1364-4590-afe0-feaf5af88bcc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104afc710>]}
2018-06-15 16:58:43,781: 16:58:43 | 18 of 21 ERROR creating table model agency_data_pipeline.fb_ads_stats [ERROR in 0.31s]
2018-06-15 16:58:43,782: 16:58:43 | 19 of 21 SKIP relation agency_data_pipeline.agg_platforms_union...... [SKIP]
2018-06-15 16:58:43,783: 16:58:43 | 20 of 21 SKIP relation agency_data_pipeline.agg_platforms_site....... [SKIP]
2018-06-15 16:58:43,783: 16:58:43 | 21 of 21 SKIP relation agency_data_pipeline.agg_platforms_ga......... [SKIP]
2018-06-15 16:58:43,870: 16:58:43 | 
2018-06-15 16:58:43,871: 16:58:43 | Finished running 21 table models in 38.26s.
2018-06-15 16:58:43,871: Connection 'master' was left open.
2018-06-15 16:58:43,871: 
2018-06-15 16:58:43,871: Completed with 1 errors:
2018-06-15 16:58:43,871: 
2018-06-15 16:58:43,872: Database Error in model fb_ads_stats (models/base/fb-ads/fb_ads_stats.sql)
2018-06-15 16:58:43,872:   Syntax error: Trailing comma before the FROM clause is not allowed at [9:5]
2018-06-15 16:58:43,872:   compiled SQL at target/run/agency_data_pipeline/base/fb-ads/fb_ads_stats.sql
2018-06-15 16:58:43,872: 
Done. PASS=17 ERROR=1 SKIP=3 TOTAL=21
2018-06-15 16:58:43,872: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107e13e80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107da8a20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107e6e7b8>]}
2018-06-15 16:58:44,184: Flushing usage events
2018-06-15 16:58:44,232: sys:1: ResourceWarning: unclosed <socket.socket fd=15, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51788), raddr=('172.217.12.13', 443)>

2018-06-15 16:58:44,232: sys:1: ResourceWarning: unclosed <socket.socket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51790), raddr=('172.217.1.74', 443)>

2018-06-15 16:58:44,232: sys:1: ResourceWarning: unclosed <socket.socket fd=18, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51791), raddr=('172.217.1.74', 443)>

2018-06-15 16:58:44,233: sys:1: ResourceWarning: unclosed <socket.socket fd=20, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51792), raddr=('172.217.1.74', 443)>

2018-06-15 16:58:44,233: sys:1: ResourceWarning: unclosed <socket.socket fd=17, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51789), raddr=('172.217.1.74', 443)>

2018-06-15 16:58:44,233: sys:1: ResourceWarning: unclosed <socket.socket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51785), raddr=('172.217.12.13', 443)>

2018-06-15 16:58:44,233: sys:1: ResourceWarning: unclosed <socket.socket fd=16, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51786), raddr=('172.217.12.13', 443)>

2018-06-15 16:58:44,234: sys:1: ResourceWarning: unclosed <socket.socket fd=14, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51787), raddr=('172.217.12.13', 443)>

2018-06-15 16:58:44,234: sys:1: ResourceWarning: unclosed <socket.socket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51784), raddr=('172.217.1.74', 443)>

2018-06-15 16:58:44,234: sys:1: ResourceWarning: unclosed <socket.socket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51783), raddr=('172.217.12.13', 443)>

2018-06-15 16:59:42,092: Tracking: tracking
2018-06-15 16:59:42,093: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114775c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111477898>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114773c8>]}
2018-06-15 16:59:43,099: Loading dependency project from /usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/include
2018-06-15 16:59:43,124: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/agency-data-pipeline/dbt_modules
2018-06-15 16:59:43,131: Parsing get_column_values.sql
2018-06-15 16:59:43,157: Parsing core.sql
2018-06-15 16:59:43,180: Parsing adapters/bigquery.sql
2018-06-15 16:59:43,192: Parsing adapters/common.sql
2018-06-15 16:59:43,216: Parsing adapters/redshift.sql
2018-06-15 16:59:43,236: Parsing adapters/snowflake.sql
2018-06-15 16:59:43,242: Parsing etc/bigquery.sql
2018-06-15 16:59:43,247: Parsing etc/datetime.sql
2018-06-15 16:59:43,274: Parsing etc/get_custom_schema.sql
2018-06-15 16:59:43,287: Parsing materializations/helpers.sql
2018-06-15 16:59:43,309: Parsing materializations/archive/archive.sql
2018-06-15 16:59:43,349: Parsing materializations/incremental/incremental.sql
2018-06-15 16:59:43,382: Parsing materializations/seed/bigquery.sql
2018-06-15 16:59:43,390: Parsing materializations/seed/seed.sql
2018-06-15 16:59:43,446: Parsing materializations/table/bigquery_table.sql
2018-06-15 16:59:43,480: Parsing materializations/table/table.sql
2018-06-15 16:59:43,512: Parsing materializations/view/bigquery_view.sql
2018-06-15 16:59:43,537: Parsing materializations/view/view.sql
2018-06-15 16:59:43,564: Parsing schema_tests/accepted_values.sql
2018-06-15 16:59:43,570: Parsing schema_tests/not_null.sql
2018-06-15 16:59:43,575: Parsing schema_tests/relationships.sql
2018-06-15 16:59:43,580: Parsing schema_tests/unique.sql
2018-06-15 16:59:43,602: Parsing model.agency_data_pipeline.accounts_proc
2018-06-15 16:59:43,607: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-06-15 16:59:43,613: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-06-15 16:59:43,616: Parsing model.agency_data_pipeline.adwords_campaigns
2018-06-15 16:59:43,618: Parsing model.agency_data_pipeline.adwords_join
2018-06-15 16:59:43,621: Parsing model.agency_data_pipeline.adwords_stats
2018-06-15 16:59:43,624: Parsing model.agency_data_pipeline.adwords_urls
2018-06-15 16:59:43,626: Parsing model.agency_data_pipeline.fb_adcreative
2018-06-15 16:59:43,632: Parsing model.agency_data_pipeline.fb_ads
2018-06-15 16:59:43,639: Parsing model.agency_data_pipeline.fb_ads_insights
2018-06-15 16:59:43,645: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-15 16:59:43,662: Parsing model.agency_data_pipeline.fb_ads_stats
2018-06-15 16:59:43,667: Parsing model.agency_data_pipeline.fb_conversions
2018-06-15 16:59:43,670: Parsing model.agency_data_pipeline.ga_conversions
2018-06-15 16:59:43,672: Parsing model.agency_data_pipeline.ga_proc
2018-06-15 16:59:43,684: Parsing model.agency_data_pipeline.ga_stats
2018-06-15 16:59:43,688: Parsing model.agency_data_pipeline.gsc_stats
2018-06-15 16:59:43,690: Parsing model.agency_data_pipeline.youtube_stats
2018-06-15 16:59:43,692: Parsing model.agency_data_pipeline.agg_platforms_ga
2018-06-15 16:59:43,696: Parsing model.agency_data_pipeline.agg_platforms_site
2018-06-15 16:59:43,699: Parsing model.agency_data_pipeline.agg_platforms_union
2018-06-15 16:59:43,726: Found 21 models, 0 tests, 0 archives, 0 analyses, 57 macros, 0 operations, 0 seed files
2018-06-15 16:59:43,734: 
2018-06-15 16:59:43,740: Acquiring new bigquery connection "master".
2018-06-15 16:59:43,740: Opening a new connection (0 currently allocated)
2018-06-15 16:59:45,086: 16:59:45 | Concurrency: 4 threads (target='dev')
2018-06-15 16:59:45,087: 16:59:45 | 
2018-06-15 16:59:45,151: 16:59:45 | 1 of 21 START table model agency_data_pipeline.mappings_ga_proc...... [RUN]
2018-06-15 16:59:45,151: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-06-15 16:59:45,156: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-15 16:59:45,151: 16:59:45 | 2 of 21 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-06-15 16:59:45,157: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-06-15 16:59:45,161: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-15 16:59:45,151: 16:59:45 | 3 of 21 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-06-15 16:59:45,151: 16:59:45 | 4 of 21 START table model agency_data_pipeline.gsc_stats............. [RUN]
2018-06-15 16:59:45,163: Acquiring new bigquery connection "mappings_ga_proc".
2018-06-15 16:59:45,163: Compiling model.agency_data_pipeline.adwords_campaigns
2018-06-15 16:59:45,163: Compiling model.agency_data_pipeline.gsc_stats
2018-06-15 16:59:45,165: Acquiring new bigquery connection "conversion_goals_proc".
2018-06-15 16:59:45,165: Opening a new connection (1 currently allocated)
2018-06-15 16:59:45,173: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-15 16:59:45,180: Writing injected SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-15 16:59:45,183: Opening a new connection (2 currently allocated)
2018-06-15 16:59:45,187: Acquiring new bigquery connection "adwords_campaigns".
2018-06-15 16:59:45,194: Acquiring new bigquery connection "gsc_stats".
2018-06-15 16:59:45,195: Opening a new connection (3 currently allocated)
2018-06-15 16:59:45,201: Opening a new connection (4 currently allocated)
2018-06-15 16:59:45,665: Writing runtime SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-15 16:59:45,696: Writing runtime SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-15 16:59:45,702: Writing runtime SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-15 16:59:45,706: Writing runtime SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-15 16:59:45,707: Fetching data for query mappings_ga_proc:
create or replace table `agency_data_pipeline`.`mappings_ga_proc`
  
  as (
    SELECT
site,
account,
bigquery_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
FROM  ( 

	SELECT  
	site,
	account,
	bigquery_name,
	source,
	medium,
	platform as platform_n,
	channel as channel_n,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
group by site, account, bigquery_name, source, medium, platform_n, channel_n, time_of_entry
  );

    
2018-06-15 16:59:45,708: Fetching data for query gsc_stats:
create or replace table `agency_data_pipeline`.`gsc_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
0 as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
0 as conversions
FROM 
  ( 
	SELECT  
	date, 
	site as account,
	'Organic' as channel,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(replace(landing_page_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
	max(impressions) as impressions, 
	max(clicks) as clicks
	FROM `adp-apprenticeship.agency_data_pipeline.gsc`
	GROUP BY date, account, channel, platform, url
  ) 
GROUP BY date, account, channel, platform, url
ORDER BY account asc, date asc, url asc
  );

    
2018-06-15 16:59:45,708: Fetching data for query adwords_campaigns:
create or replace table `agency_data_pipeline`.`adwords_campaigns`
  
  as (
    SELECT
day,
campaignid,
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM
( 
	SELECT  
	'Paid' as channel,
	'Adwords' as platform,
	day,
	campaignid,
	campaign,
	account as account,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	conversions,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `adp-apprenticeship.adwords.CAMPAIGN_PERFORMANCE_REPORT`
)
WHERE lv = _sdc_sequence
GROUP BY day, campaignid, account, channel, platform, campaign
  );

    
2018-06-15 16:59:45,709: Fetching data for query conversion_goals_proc:
create or replace table `agency_data_pipeline`.`conversion_goals_proc`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
FROM  ( 

	SELECT  
	site,
	bigquery_name,
	platform,
	trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
	goal_type,
	account,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by site, bigquery_name, platform, account, goal_name
  );

    
2018-06-15 16:59:47,955: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d1e791-6063-4597-8611-d06c162238ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11168e320>]}
2018-06-15 16:59:47,964: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d1e791-6063-4597-8611-d06c162238ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11159eda0>]}
2018-06-15 16:59:48,147: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d1e791-6063-4597-8611-d06c162238ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11168e4e0>]}
2018-06-15 16:59:48,180: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d1e791-6063-4597-8611-d06c162238ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11168e518>]}
2018-06-15 16:59:48,300: 16:59:48 | 3 of 21 OK created table model agency_data_pipeline.adwords_campaigns [OK in 2.79s]
2018-06-15 16:59:48,302: 16:59:48 | 5 of 21 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-06-15 16:59:48,304: Compiling model.agency_data_pipeline.adwords_urls
2018-06-15 16:59:48,314: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-15 16:59:48,317: Acquiring new bigquery connection "adwords_urls".
2018-06-15 16:59:48,318: Re-using an available connection from the pool.
2018-06-15 16:59:48,430: Writing runtime SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-15 16:59:48,430: Fetching data for query adwords_urls:
create or replace table `agency_data_pipeline`.`adwords_urls`
  
  as (
    SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url
FROM 
(
	SELECT  
	campaignid,
	max(finalurl) finalurl
	FROM `adp-apprenticeship.adwords.FINAL_URL_REPORT`
	GROUP BY campaignid
)
  );

    
2018-06-15 16:59:48,647: 16:59:48 | 1 of 21 OK created table model agency_data_pipeline.mappings_ga_proc. [OK in 2.81s]
2018-06-15 16:59:48,650: 16:59:48 | 6 of 21 START table model agency_data_pipeline.youtube_stats......... [RUN]
2018-06-15 16:59:48,652: Compiling model.agency_data_pipeline.youtube_stats
2018-06-15 16:59:48,661: Writing injected SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-15 16:59:48,663: Acquiring new bigquery connection "youtube_stats".
2018-06-15 16:59:48,663: Re-using an available connection from the pool.
2018-06-15 16:59:48,779: Writing runtime SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-15 16:59:48,780: Fetching data for query youtube_stats:
create or replace table `agency_data_pipeline`.`youtube_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
FROM 
  ( 
	SELECT  
	date, 
	'Social' as channel,
	'YouTube' as platform,
	'Coding is for Losers' as account,  
	0 as cost, 
	max(views) as impressions, 
	max(clicks) as clicks, 
	max(subscribers) as conversions,
	regexp_replace(regexp_replace(replace(replace(replace(landing_page_url,'http://',''),'https://',''),'.html',''),r'\?.*$',''),r'([/]$)','') as url,
	video_url
	FROM `adp-apprenticeship.agency_data_pipeline.youtube`
	group by channel, platform, account, date, video_url, url
  ) 
GROUP BY date, account, channel, platform, url
  );

    
2018-06-15 16:59:48,983: 16:59:48 | 4 of 21 OK created table model agency_data_pipeline.gsc_stats........ [OK in 2.98s]
2018-06-15 16:59:48,985: 16:59:48 | 7 of 21 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-06-15 16:59:48,986: Compiling model.agency_data_pipeline.accounts_proc
2018-06-15 16:59:48,991: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 16:59:48,993: Acquiring new bigquery connection "accounts_proc".
2018-06-15 16:59:48,994: Re-using an available connection from the pool.
2018-06-15 16:59:49,104: Writing runtime SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 16:59:49,105: Fetching data for query accounts_proc:
create or replace table `agency_data_pipeline`.`accounts_proc`
  
  as (
    SELECT
site,
bigquery_name,
account,
platform
FROM  (
 
	SELECT  
	site,
	bigquery_name,
	account,
	platform,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.accounts`
) 

WHERE lv = time_of_entry
  );

    
2018-06-15 16:59:49,296: 16:59:49 | 2 of 21 OK created table model agency_data_pipeline.conversion_goals_proc [OK in 3.02s]
2018-06-15 16:59:50,003: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d1e791-6063-4597-8611-d06c162238ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f60c438>]}
2018-06-15 16:59:50,327: 16:59:50 | 5 of 21 OK created table model agency_data_pipeline.adwords_urls..... [OK in 1.70s]
2018-06-15 16:59:50,617: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d1e791-6063-4597-8611-d06c162238ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11159eda0>]}
2018-06-15 16:59:50,877: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d1e791-6063-4597-8611-d06c162238ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11159e6d8>]}
2018-06-15 16:59:50,940: 16:59:50 | 6 of 21 OK created table model agency_data_pipeline.youtube_stats.... [OK in 1.97s]
2018-06-15 16:59:51,259: 16:59:51 | 7 of 21 OK created table model agency_data_pipeline.accounts_proc.... [OK in 1.89s]
2018-06-15 16:59:51,260: 16:59:51 | 8 of 21 START table model agency_data_pipeline.fb_adcreative......... [RUN]
2018-06-15 16:59:51,261: Compiling model.agency_data_pipeline.fb_adcreative
2018-06-15 16:59:51,260: 16:59:51 | 9 of 21 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-06-15 16:59:51,273: Compiling model.agency_data_pipeline.ga_conversions
2018-06-15 16:59:51,275: Acquiring new bigquery connection "fb_adcreative".
2018-06-15 16:59:51,275: Re-using an available connection from the pool.
2018-06-15 16:59:51,275: Fetching data for query fb_adcreative:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:59:51,260: 16:59:51 | 10 of 21 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-06-15 16:59:51,276: Compiling model.agency_data_pipeline.fb_ads_insights
2018-06-15 16:59:51,283: Acquiring new bigquery connection "fb_ads_insights".
2018-06-15 16:59:51,261: 16:59:51 | 11 of 21 START table model agency_data_pipeline.fb_conversions....... [RUN]
2018-06-15 16:59:51,283: Re-using an available connection from the pool.
2018-06-15 16:59:51,288: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-15 16:59:51,288: Compiling model.agency_data_pipeline.fb_conversions
2018-06-15 16:59:51,289: Fetching data for query fb_ads_insights:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:59:51,298: Writing injected SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-15 16:59:51,300: Acquiring new bigquery connection "ga_conversions".
2018-06-15 16:59:51,301: Re-using an available connection from the pool.
2018-06-15 16:59:51,312: Acquiring new bigquery connection "fb_conversions".
2018-06-15 16:59:51,312: Re-using an available connection from the pool.
2018-06-15 16:59:51,425: Writing runtime SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-15 16:59:51,437: Writing runtime SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-15 16:59:51,437: Fetching data for query ga_conversions:
create or replace table `agency_data_pipeline`.`ga_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'Google Analytics'
  );

    
2018-06-15 16:59:51,439: Fetching data for query fb_conversions:
create or replace table `agency_data_pipeline`.`fb_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'FB Ads'
  );

    
2018-06-15 16:59:52,830: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-15 16:59:52,831: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-15 16:59:52,945: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-15 16:59:52,945: Fetching data for query fb_ads_insights:
create or replace table `agency_data_pipeline`.`fb_ads_insights`
  
  as (
    



with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


  );

    
2018-06-15 16:59:52,963: Writing runtime SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-15 16:59:52,963: Fetching data for query fb_adcreative:
create or replace table `agency_data_pipeline`.`fb_adcreative`
  
  as (
    



with fb_adcreative as (


	    
		   	SELECT 
			id,
			link_url object_url,
			url_tags,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


  );

    
2018-06-15 16:59:53,196: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d1e791-6063-4597-8611-d06c162238ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e13f7b8>]}
2018-06-15 16:59:53,517: 16:59:53 | 11 of 21 OK created table model agency_data_pipeline.fb_conversions.. [OK in 1.91s]
2018-06-15 16:59:53,536: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d1e791-6063-4597-8611-d06c162238ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111645908>]}
2018-06-15 16:59:53,856: 16:59:53 | 9 of 21 OK created table model agency_data_pipeline.ga_conversions... [OK in 2.26s]
2018-06-15 16:59:54,514: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d1e791-6063-4597-8611-d06c162238ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11168e4a8>]}
2018-06-15 16:59:54,777: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d1e791-6063-4597-8611-d06c162238ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11159e6d8>]}
2018-06-15 16:59:54,839: 16:59:54 | 8 of 21 OK created table model agency_data_pipeline.fb_adcreative.... [OK in 3.25s]
2018-06-15 16:59:55,159: 16:59:55 | 10 of 21 OK created table model agency_data_pipeline.fb_ads_insights. [OK in 3.50s]
2018-06-15 16:59:55,160: 16:59:55 | 12 of 21 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-06-15 16:59:55,160: 16:59:55 | 13 of 21 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-06-15 16:59:55,160: Compiling model.agency_data_pipeline.fb_ads
2018-06-15 16:59:55,161: Compiling model.agency_data_pipeline.adwords_join
2018-06-15 16:59:55,176: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-15 16:59:55,177: Acquiring new bigquery connection "adwords_join".
2018-06-15 16:59:55,180: Acquiring new bigquery connection "fb_ads".
2018-06-15 16:59:55,180: Re-using an available connection from the pool.
2018-06-15 16:59:55,181: Re-using an available connection from the pool.
2018-06-15 16:59:55,181: Fetching data for query fb_ads:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:59:55,315: Writing runtime SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-15 16:59:55,316: Fetching data for query adwords_join:
create or replace table `agency_data_pipeline`.`adwords_join`
  
  as (
    SELECT
day,
a.campaign,
a.campaignid, 
account, 
channel,
platform,
b.url,
cost,
impressions,
clicks,
conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_campaigns` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`adwords_urls` b
ON a.campaignid = b.campaignid
  );

    
2018-06-15 16:59:55,875: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-15 16:59:56,027: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-15 16:59:56,028: Fetching data for query fb_ads:
create or replace table `agency_data_pipeline`.`fb_ads`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


  );

    
2018-06-15 16:59:57,171: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d1e791-6063-4597-8611-d06c162238ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fd9f390>]}
2018-06-15 16:59:57,495: 16:59:57 | 13 of 21 OK created table model agency_data_pipeline.adwords_join.... [OK in 2.01s]
2018-06-15 16:59:58,184: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d1e791-6063-4597-8611-d06c162238ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1116f9ac8>]}
2018-06-15 16:59:58,517: 16:59:58 | 12 of 21 OK created table model agency_data_pipeline.fb_ads.......... [OK in 3.02s]
2018-06-15 16:59:58,518: 16:59:58 | 14 of 21 START table model agency_data_pipeline.ga_proc.............. [RUN]
2018-06-15 16:59:58,518: 16:59:58 | 15 of 21 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-06-15 16:59:58,518: Compiling model.agency_data_pipeline.ga_proc
2018-06-15 16:59:58,519: 16:59:58 | 16 of 21 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-06-15 16:59:58,519: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-15 16:59:58,526: Compiling model.agency_data_pipeline.adwords_stats
2018-06-15 16:59:58,541: Acquiring new bigquery connection "ga_proc".
2018-06-15 16:59:58,545: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-15 16:59:58,546: Re-using an available connection from the pool.
2018-06-15 16:59:58,546: Fetching data for query ga_proc:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:59:58,562: Acquiring new bigquery connection "adwords_stats".
2018-06-15 16:59:58,569: Re-using an available connection from the pool.
2018-06-15 16:59:58,578: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-06-15 16:59:58,579: Re-using an available connection from the pool.
2018-06-15 16:59:58,579: Fetching data for query fb_ads_insights_conversions:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 16:59:58,712: Writing runtime SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-15 16:59:58,713: Fetching data for query adwords_stats:
create or replace table `agency_data_pipeline`.`adwords_stats`
  
  as (
    SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_join`
GROUP BY date, account, platform, channel, url, campaign
  );

    
2018-06-15 16:59:59,288: Fetching data for query fb_ads_insights_conversions:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`
        where goal_name is not null
        and goal_name != ''

        
        ##where 1 = 1
        and goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 17:00:00,258: Fetching data for query ga_proc:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`
        where goal_name is not null
        and goal_name != ''

        
        ##where 1 = 1
        and goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 17:00:00,601: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d1e791-6063-4597-8611-d06c162238ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11165c940>]}
2018-06-15 17:00:00,930: 17:00:00 | 16 of 21 OK created table model agency_data_pipeline.adwords_stats... [OK in 2.08s]
2018-06-15 17:00:01,274: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-06-15 17:00:01,410: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-06-15 17:00:01,411: Fetching data for query fb_ads_insights_conversions:
create or replace table `agency_data_pipeline`.`fb_ads_insights_conversions`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`





with fb_ads_insights_conversions as (

	    

	    	

		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			_sdc_sequence,
			action_type,
			_28d_click conversions,
			null as revenue
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
			cross join unnest(actions)

			## goal completion columns
			
				where action_type in (
				
					'offsite_conversion.fb_pixel_lead'
					 
				
				)
			
			
			UNION ALL

		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			_sdc_sequence,
			action_type,
			null as conversions,
			_28d_click as revenue
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
			cross join unnest(action_values)
			
			## goal completion columns
			
				where action_type in (
				
					'offsite_conversion.fb_pixel_lead'
					 
				
				)
			

		    
	   

)

SELECT 
date,
campaign_id,
campaign,
ad_id,
account,
sum(conversions) conversions,
sum(revenue) revenue
FROM 
		(
	    SELECT
	    date_start date,
	    campaign_id,
	    campaign_name campaign,
	    ad_id,
	    account_name account,
	    action_type,
	    conversions,
	    revenue,
	    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
	    _sdc_sequence
	    FROM fb_ads_insights_conversions
	   	)
where lv = _sdc_sequence
group by date, campaign_id, campaign, ad_id, account



  );

    
2018-06-15 17:00:01,985: Writing injected SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-15 17:00:02,093: Writing runtime SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-15 17:00:02,095: Fetching data for query ga_proc:
create or replace table `agency_data_pipeline`.`ga_proc`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`




with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'cifl' as bigquery_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			sessions,
			## goal completion columns
			
				
					cast(goal1completions as int64) 
					 
					 as goal_completions,  
				
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.ga_cifl.report` 

		    
	   

)


SELECT 
bigquery_name,
lookup_platform,
date,
url,
source,
medium,
sum(sessions) sessions,
sum(goal_completions) goal_completions
FROM ga_report
where lv = _sdc_sequence
group by bigquery_name, lookup_platform, date, url, source, medium


  );

    
2018-06-15 17:00:04,111: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d1e791-6063-4597-8611-d06c162238ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11159e6d8>]}
2018-06-15 17:00:04,431: 17:00:04 | 14 of 21 OK created table model agency_data_pipeline.ga_proc......... [OK in 5.59s]
2018-06-15 17:00:06,785: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d1e791-6063-4597-8611-d06c162238ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ea9d208>]}
2018-06-15 17:00:07,111: 17:00:07 | 15 of 21 OK created table model agency_data_pipeline.fb_ads_insights_conversions [OK in 8.27s]
2018-06-15 17:00:07,112: 17:00:07 | 17 of 21 START table model agency_data_pipeline.ga_stats............. [RUN]
2018-06-15 17:00:07,112: Compiling model.agency_data_pipeline.ga_stats
2018-06-15 17:00:07,123: Writing injected SQL for node "model.agency_data_pipeline.ga_stats"
2018-06-15 17:00:07,124: Acquiring new bigquery connection "ga_stats".
2018-06-15 17:00:07,124: Re-using an available connection from the pool.
2018-06-15 17:00:07,247: Writing runtime SQL for node "model.agency_data_pipeline.ga_stats"
2018-06-15 17:00:07,248: Fetching data for query ga_stats:
create or replace table `agency_data_pipeline`.`ga_stats`
  
  as (
    SELECT  
cast(date as date) date,
b.account,
b.site site,
c.source source,
c.medium medium,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
url,
sum(sessions) sessions,
sum(goal_completions) goal_completions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`ga_proc` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.bigquery_name = b.bigquery_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.bigquery_name = c.bigquery_name )
GROUP BY date, account, site, source, medium, source_medium, platform, channel, url
  );

    
2018-06-15 17:00:11,196: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d1e791-6063-4597-8611-d06c162238ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1116f9ac8>]}
2018-06-15 17:00:11,516: 17:00:11 | 17 of 21 OK created table model agency_data_pipeline.ga_stats........ [OK in 4.08s]
2018-06-15 17:00:11,517: 17:00:11 | 18 of 21 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-06-15 17:00:11,518: Compiling model.agency_data_pipeline.fb_ads_stats
2018-06-15 17:00:11,530: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-06-15 17:00:11,532: Acquiring new bigquery connection "fb_ads_stats".
2018-06-15 17:00:11,532: Re-using an available connection from the pool.
2018-06-15 17:00:11,652: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-06-15 17:00:11,653: Fetching data for query fb_ads_stats:
create or replace table `agency_data_pipeline`.`fb_ads_stats`
  
  as (
    with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) conversions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign
  );

    
2018-06-15 17:00:15,476: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d1e791-6063-4597-8611-d06c162238ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ea95c50>]}
2018-06-15 17:00:15,795: 17:00:15 | 18 of 21 OK created table model agency_data_pipeline.fb_ads_stats.... [OK in 3.96s]
2018-06-15 17:00:15,796: 17:00:15 | 19 of 21 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-06-15 17:00:15,796: Compiling model.agency_data_pipeline.agg_platforms_union
2018-06-15 17:00:15,811: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-06-15 17:00:15,814: Acquiring new bigquery connection "agg_platforms_union".
2018-06-15 17:00:15,815: Re-using an available connection from the pool.
2018-06-15 17:00:15,928: Writing runtime SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-06-15 17:00:15,929: Fetching data for query agg_platforms_union:
create or replace table `agency_data_pipeline`.`agg_platforms_union`
  
  as (
    SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`adwords_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`gsc_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`youtube_stats`
  );

    
2018-06-15 17:00:17,752: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d1e791-6063-4597-8611-d06c162238ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1116f9ac8>]}
2018-06-15 17:00:18,073: 17:00:18 | 19 of 21 OK created table model agency_data_pipeline.agg_platforms_union [OK in 1.96s]
2018-06-15 17:00:18,074: 17:00:18 | 20 of 21 START table model agency_data_pipeline.agg_platforms_site... [RUN]
2018-06-15 17:00:18,074: Compiling model.agency_data_pipeline.agg_platforms_site
2018-06-15 17:00:18,083: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_site"
2018-06-15 17:00:18,085: Acquiring new bigquery connection "agg_platforms_site".
2018-06-15 17:00:18,085: Re-using an available connection from the pool.
2018-06-15 17:00:18,214: Writing runtime SQL for node "model.agency_data_pipeline.agg_platforms_site"
2018-06-15 17:00:18,215: Fetching data for query agg_platforms_site:
create or replace table `agency_data_pipeline`.`agg_platforms_site`
  
  as (
    SELECT 
date, 
a.account account, 
b.site site,
a.platform platform,
a.channel channel,
url,
cost,
impressions,
clicks,
conversions
FROM 
  `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_union` a
LEFT JOIN 
  `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc` b
ON ( 
  a.account = b.account AND
  a.platform = b.platform
)
  );

    
2018-06-15 17:00:20,019: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d1e791-6063-4597-8611-d06c162238ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111613278>]}
2018-06-15 17:00:20,346: 17:00:20 | 20 of 21 OK created table model agency_data_pipeline.agg_platforms_site [OK in 1.94s]
2018-06-15 17:00:20,346: 17:00:20 | 21 of 21 START table model agency_data_pipeline.agg_platforms_ga..... [RUN]
2018-06-15 17:00:20,346: Compiling model.agency_data_pipeline.agg_platforms_ga
2018-06-15 17:00:20,355: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_ga"
2018-06-15 17:00:20,357: Acquiring new bigquery connection "agg_platforms_ga".
2018-06-15 17:00:20,357: Re-using an available connection from the pool.
2018-06-15 17:00:20,502: Writing runtime SQL for node "model.agency_data_pipeline.agg_platforms_ga"
2018-06-15 17:00:20,502: Fetching data for query agg_platforms_ga:
create or replace table `agency_data_pipeline`.`agg_platforms_ga`
  
  as (
    with ga as (

	select 
		date, account, site, channel, platform, url,
		sessions, goal_completions,
		null as cost, null as impressions, null as clicks, null as conversions
	from `adp-apprenticeship`.`agency_data_pipeline`.`ga_stats`

),

platforms as (

	select 
		date, account, site, channel, platform, url,
		null as sessions, null as goal_completions,
		cost, impressions, clicks, conversions
	from `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_site`

)


SELECT
    date, 
    site,
    platform,
    channel, 
    url,
    sum(cost) cost,
	sum(impressions) impressions,
	sum(clicks) clicks,
	sum(conversions) conversions,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      platforms 
) 
GROUP BY
    date, site, platform, channel, url
  );

    
2018-06-15 17:00:22,621: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '85d1e791-6063-4597-8611-d06c162238ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ea95160>]}
2018-06-15 17:00:22,943: 17:00:22 | 21 of 21 OK created table model agency_data_pipeline.agg_platforms_ga [OK in 2.27s]
2018-06-15 17:00:22,998: 17:00:22 | 
2018-06-15 17:00:22,998: 17:00:22 | Finished running 21 table models in 39.26s.
2018-06-15 17:00:22,998: Connection 'master' was left open.
2018-06-15 17:00:22,999: 
2018-06-15 17:00:22,999: Completed successfully
2018-06-15 17:00:22,999: 
Done. PASS=21 ERROR=0 SKIP=0 TOTAL=21
2018-06-15 17:00:22,999: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1114775c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11168e748>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11168ec18>]}
2018-06-15 17:00:23,317: Flushing usage events
2018-06-15 17:00:23,389: sys:1: ResourceWarning: unclosed <socket.socket fd=18, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51822), raddr=('172.217.2.10', 443)>

2018-06-15 17:00:23,389: sys:1: ResourceWarning: unclosed <socket.socket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51823), raddr=('172.217.2.10', 443)>

2018-06-15 17:00:23,390: sys:1: ResourceWarning: unclosed <socket.socket fd=17, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51821), raddr=('172.217.2.10', 443)>

2018-06-15 17:00:23,390: sys:1: ResourceWarning: unclosed <socket.socket fd=21, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51824), raddr=('172.217.2.10', 443)>

2018-06-15 17:00:23,391: sys:1: ResourceWarning: unclosed <socket.socket fd=14, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51817), raddr=('172.217.12.13', 443)>

2018-06-15 17:00:23,391: sys:1: ResourceWarning: unclosed <socket.socket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51818), raddr=('172.217.12.13', 443)>

2018-06-15 17:00:23,392: sys:1: ResourceWarning: unclosed <socket.socket fd=15, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51819), raddr=('172.217.12.13', 443)>

2018-06-15 17:00:23,392: sys:1: ResourceWarning: unclosed <socket.socket fd=16, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51820), raddr=('172.217.12.13', 443)>

2018-06-15 17:00:23,392: sys:1: ResourceWarning: unclosed <socket.socket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51816), raddr=('172.217.1.202', 443)>

2018-06-15 17:00:23,393: sys:1: ResourceWarning: unclosed <socket.socket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51815), raddr=('172.217.12.13', 443)>

2018-06-15 17:36:11,646: Tracking: tracking
2018-06-15 17:36:11,648: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ed214a8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ed21f98>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ed21d68>]}
2018-06-15 17:36:12,642: Loading dependency project from /usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/include
2018-06-15 17:36:12,665: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/agency-data-pipeline/dbt_modules
2018-06-15 17:36:12,668: Parsing get_column_values.sql
2018-06-15 17:36:12,695: Parsing core.sql
2018-06-15 17:36:12,709: Parsing adapters/bigquery.sql
2018-06-15 17:36:12,719: Parsing adapters/common.sql
2018-06-15 17:36:12,749: Parsing adapters/redshift.sql
2018-06-15 17:36:12,771: Parsing adapters/snowflake.sql
2018-06-15 17:36:12,778: Parsing etc/bigquery.sql
2018-06-15 17:36:12,784: Parsing etc/datetime.sql
2018-06-15 17:36:12,815: Parsing etc/get_custom_schema.sql
2018-06-15 17:36:12,824: Parsing materializations/helpers.sql
2018-06-15 17:36:12,843: Parsing materializations/archive/archive.sql
2018-06-15 17:36:12,881: Parsing materializations/incremental/incremental.sql
2018-06-15 17:36:12,924: Parsing materializations/seed/bigquery.sql
2018-06-15 17:36:12,935: Parsing materializations/seed/seed.sql
2018-06-15 17:36:12,993: Parsing materializations/table/bigquery_table.sql
2018-06-15 17:36:13,027: Parsing materializations/table/table.sql
2018-06-15 17:36:13,055: Parsing materializations/view/bigquery_view.sql
2018-06-15 17:36:13,073: Parsing materializations/view/view.sql
2018-06-15 17:36:13,104: Parsing schema_tests/accepted_values.sql
2018-06-15 17:36:13,110: Parsing schema_tests/not_null.sql
2018-06-15 17:36:13,115: Parsing schema_tests/relationships.sql
2018-06-15 17:36:13,120: Parsing schema_tests/unique.sql
2018-06-15 17:36:13,173: Parsing model.agency_data_pipeline.accounts_proc
2018-06-15 17:36:13,176: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-06-15 17:36:13,179: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-06-15 17:36:13,181: Parsing model.agency_data_pipeline.adwords_campaigns
2018-06-15 17:36:13,183: Parsing model.agency_data_pipeline.adwords_join
2018-06-15 17:36:13,186: Parsing model.agency_data_pipeline.adwords_stats
2018-06-15 17:36:13,189: Parsing model.agency_data_pipeline.adwords_urls
2018-06-15 17:36:13,191: Parsing model.agency_data_pipeline.fb_adcreative
2018-06-15 17:36:13,197: Parsing model.agency_data_pipeline.fb_ads
2018-06-15 17:36:13,204: Parsing model.agency_data_pipeline.fb_ads_insights
2018-06-15 17:36:13,209: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-15 17:36:13,223: Parsing model.agency_data_pipeline.fb_ads_stats
2018-06-15 17:36:13,227: Parsing model.agency_data_pipeline.fb_conversions
2018-06-15 17:36:13,229: Parsing model.agency_data_pipeline.ga_conversions
2018-06-15 17:36:13,232: Parsing model.agency_data_pipeline.ga_proc
2018-06-15 17:36:13,243: Parsing model.agency_data_pipeline.ga_stats
2018-06-15 17:36:13,247: Parsing model.agency_data_pipeline.gsc_stats
2018-06-15 17:36:13,249: Parsing model.agency_data_pipeline.youtube_stats
2018-06-15 17:36:13,251: Parsing model.agency_data_pipeline.agg_platforms_ga
2018-06-15 17:36:13,254: Parsing model.agency_data_pipeline.agg_platforms_site
2018-06-15 17:36:13,257: Parsing model.agency_data_pipeline.agg_platforms_union
2018-06-15 17:36:13,263: Parsing model.agency_data_pipeline.landing_page_by_month
2018-06-15 17:36:13,265: Parsing model.agency_data_pipeline.landing_page_index
2018-06-15 17:36:13,268: Parsing model.agency_data_pipeline.platform_by_month
2018-06-15 17:36:13,271: Parsing model.agency_data_pipeline.platform_index
2018-06-15 17:36:13,273: Parsing model.agency_data_pipeline.landing_page_viz
2018-06-15 17:36:13,278: Parsing model.agency_data_pipeline.platform_viz
2018-06-15 17:36:13,292: Found 27 models, 0 tests, 0 archives, 0 analyses, 57 macros, 0 operations, 0 seed files
2018-06-15 17:36:13,300: 
2018-06-15 17:36:13,306: Acquiring new bigquery connection "master".
2018-06-15 17:36:13,306: Opening a new connection (0 currently allocated)
2018-06-15 17:36:14,708: 17:36:14 | Concurrency: 4 threads (target='dev')
2018-06-15 17:36:14,708: 17:36:14 | 
2018-06-15 17:36:14,813: 17:36:14 | 1 of 27 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-06-15 17:36:14,813: Compiling model.agency_data_pipeline.adwords_urls
2018-06-15 17:36:14,818: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-15 17:36:14,813: 17:36:14 | 2 of 27 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-06-15 17:36:14,819: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-06-15 17:36:14,813: 17:36:14 | 3 of 27 START table model agency_data_pipeline.mappings_ga_proc...... [RUN]
2018-06-15 17:36:14,824: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-15 17:36:14,813: 17:36:14 | 4 of 27 START table model agency_data_pipeline.youtube_stats......... [RUN]
2018-06-15 17:36:14,824: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-06-15 17:36:14,826: Acquiring new bigquery connection "adwords_urls".
2018-06-15 17:36:14,826: Compiling model.agency_data_pipeline.youtube_stats
2018-06-15 17:36:14,833: Acquiring new bigquery connection "conversion_goals_proc".
2018-06-15 17:36:14,831: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-15 17:36:14,833: Opening a new connection (1 currently allocated)
2018-06-15 17:36:14,842: Writing injected SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-15 17:36:14,844: Opening a new connection (2 currently allocated)
2018-06-15 17:36:14,846: Acquiring new bigquery connection "mappings_ga_proc".
2018-06-15 17:36:14,850: Acquiring new bigquery connection "youtube_stats".
2018-06-15 17:36:14,856: Opening a new connection (3 currently allocated)
2018-06-15 17:36:14,863: Opening a new connection (4 currently allocated)
2018-06-15 17:36:15,351: Writing runtime SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-15 17:36:15,386: Writing runtime SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-15 17:36:15,388: Writing runtime SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-15 17:36:15,396: Writing runtime SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-15 17:36:15,397: Fetching data for query mappings_ga_proc:
create or replace table `agency_data_pipeline`.`mappings_ga_proc`
  
  as (
    SELECT
site,
account,
bigquery_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
FROM  ( 

	SELECT  
	site,
	account,
	bigquery_name,
	source,
	medium,
	platform as platform_n,
	channel as channel_n,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
group by site, account, bigquery_name, source, medium, platform_n, channel_n, time_of_entry
  );

    
2018-06-15 17:36:15,397: Fetching data for query adwords_urls:
create or replace table `agency_data_pipeline`.`adwords_urls`
  
  as (
    SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url
FROM 
(
	SELECT  
	campaignid,
	max(finalurl) finalurl
	FROM `adp-apprenticeship.adwords.FINAL_URL_REPORT`
	GROUP BY campaignid
)
  );

    
2018-06-15 17:36:15,398: Fetching data for query youtube_stats:
create or replace table `agency_data_pipeline`.`youtube_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
FROM 
  ( 
	SELECT  
	date, 
	'Social' as channel,
	'YouTube' as platform,
	'Coding is for Losers' as account,  
	0 as cost, 
	max(views) as impressions, 
	max(clicks) as clicks, 
	max(subscribers) as conversions,
	regexp_replace(regexp_replace(replace(replace(replace(landing_page_url,'http://',''),'https://',''),'.html',''),r'\?.*$',''),r'([/]$)','') as url,
	video_url
	FROM `adp-apprenticeship.agency_data_pipeline.youtube`
	group by channel, platform, account, date, video_url, url
  ) 
GROUP BY date, account, channel, platform, url
  );

    
2018-06-15 17:36:15,401: Fetching data for query conversion_goals_proc:
create or replace table `agency_data_pipeline`.`conversion_goals_proc`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
FROM  ( 

	SELECT  
	site,
	bigquery_name,
	platform,
	trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
	goal_type,
	account,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by site, bigquery_name, platform, account, goal_name
  );

    
2018-06-15 17:36:17,207: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1120b8c18>]}
2018-06-15 17:36:17,477: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1120b8b70>]}
2018-06-15 17:36:17,545: 17:36:17 | 4 of 27 OK created table model agency_data_pipeline.youtube_stats.... [OK in 2.38s]
2018-06-15 17:36:17,547: 17:36:17 | 5 of 27 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-06-15 17:36:17,549: Compiling model.agency_data_pipeline.accounts_proc
2018-06-15 17:36:17,558: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 17:36:17,561: Acquiring new bigquery connection "accounts_proc".
2018-06-15 17:36:17,562: Re-using an available connection from the pool.
2018-06-15 17:36:17,667: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1120b86d8>]}
2018-06-15 17:36:17,684: Writing runtime SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 17:36:17,685: Fetching data for query accounts_proc:
create or replace table `agency_data_pipeline`.`accounts_proc`
  
  as (
    SELECT
site,
bigquery_name,
account,
platform
FROM  (
 
	SELECT  
	site,
	bigquery_name,
	account,
	platform,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.accounts`
) 

WHERE lv = time_of_entry
  );

    
2018-06-15 17:36:17,888: 17:36:17 | 3 of 27 OK created table model agency_data_pipeline.mappings_ga_proc. [OK in 2.65s]
2018-06-15 17:36:17,888: 17:36:17 | 6 of 27 START table model agency_data_pipeline.gsc_stats............. [RUN]
2018-06-15 17:36:17,889: Compiling model.agency_data_pipeline.gsc_stats
2018-06-15 17:36:17,895: Writing injected SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-15 17:36:17,900: Acquiring new bigquery connection "gsc_stats".
2018-06-15 17:36:17,900: Re-using an available connection from the pool.
2018-06-15 17:36:18,042: Writing runtime SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-15 17:36:18,046: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1120b8cc0>]}
2018-06-15 17:36:18,047: Fetching data for query gsc_stats:
create or replace table `agency_data_pipeline`.`gsc_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
0 as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
0 as conversions
FROM 
  ( 
	SELECT  
	date, 
	site as account,
	'Organic' as channel,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(replace(landing_page_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
	max(impressions) as impressions, 
	max(clicks) as clicks
	FROM `adp-apprenticeship.agency_data_pipeline.gsc`
	GROUP BY date, account, channel, platform, url
  ) 
GROUP BY date, account, channel, platform, url
ORDER BY account asc, date asc, url asc
  );

    
2018-06-15 17:36:18,223: 17:36:18 | 1 of 27 OK created table model agency_data_pipeline.adwords_urls..... [OK in 2.85s]
2018-06-15 17:36:18,224: 17:36:18 | 7 of 27 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-06-15 17:36:18,225: Compiling model.agency_data_pipeline.adwords_campaigns
2018-06-15 17:36:18,238: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-15 17:36:18,245: Acquiring new bigquery connection "adwords_campaigns".
2018-06-15 17:36:18,246: Re-using an available connection from the pool.
2018-06-15 17:36:18,375: Writing runtime SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-15 17:36:18,375: Fetching data for query adwords_campaigns:
create or replace table `agency_data_pipeline`.`adwords_campaigns`
  
  as (
    SELECT
day,
campaignid,
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM
( 
	SELECT  
	'Paid' as channel,
	'Adwords' as platform,
	day,
	campaignid,
	campaign,
	account as account,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	conversions,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `adp-apprenticeship.adwords.CAMPAIGN_PERFORMANCE_REPORT`
)
WHERE lv = _sdc_sequence
GROUP BY day, campaignid, account, channel, platform, campaign
  );

    
2018-06-15 17:36:18,577: 17:36:18 | 2 of 27 OK created table model agency_data_pipeline.conversion_goals_proc [OK in 3.23s]
2018-06-15 17:36:19,311: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111fd7400>]}
2018-06-15 17:36:19,753: 17:36:19 | 5 of 27 OK created table model agency_data_pipeline.accounts_proc.... [OK in 1.76s]
2018-06-15 17:36:19,800: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11204f400>]}
2018-06-15 17:36:20,132: 17:36:20 | 6 of 27 OK created table model agency_data_pipeline.gsc_stats........ [OK in 1.91s]
2018-06-15 17:36:20,212: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1120e74e0>]}
2018-06-15 17:36:20,547: 17:36:20 | 7 of 27 OK created table model agency_data_pipeline.adwords_campaigns [OK in 1.99s]
2018-06-15 17:36:20,548: 17:36:20 | 8 of 27 START table model agency_data_pipeline.fb_ads_insights....... [RUN]
2018-06-15 17:36:20,548: 17:36:20 | 9 of 27 START table model agency_data_pipeline.fb_adcreative......... [RUN]
2018-06-15 17:36:20,548: 17:36:20 | 10 of 27 START table model agency_data_pipeline.ga_conversions....... [RUN]
2018-06-15 17:36:20,549: 17:36:20 | 11 of 27 START table model agency_data_pipeline.fb_conversions....... [RUN]
2018-06-15 17:36:20,549: Compiling model.agency_data_pipeline.fb_ads_insights
2018-06-15 17:36:20,549: Compiling model.agency_data_pipeline.fb_adcreative
2018-06-15 17:36:20,550: Compiling model.agency_data_pipeline.ga_conversions
2018-06-15 17:36:20,550: Compiling model.agency_data_pipeline.fb_conversions
2018-06-15 17:36:20,560: Acquiring new bigquery connection "fb_ads_insights".
2018-06-15 17:36:20,566: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-15 17:36:20,571: Writing injected SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-15 17:36:20,571: Re-using an available connection from the pool.
2018-06-15 17:36:20,572: Fetching data for query fb_ads_insights:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 17:36:20,582: Acquiring new bigquery connection "ga_conversions".
2018-06-15 17:36:20,582: Acquiring new bigquery connection "fb_adcreative".
2018-06-15 17:36:20,586: Acquiring new bigquery connection "fb_conversions".
2018-06-15 17:36:20,587: Re-using an available connection from the pool.
2018-06-15 17:36:20,588: Re-using an available connection from the pool.
2018-06-15 17:36:20,590: Fetching data for query fb_adcreative:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 17:36:20,591: Re-using an available connection from the pool.
2018-06-15 17:36:20,719: Writing runtime SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-15 17:36:20,729: Writing runtime SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-15 17:36:20,730: Fetching data for query fb_conversions:
create or replace table `agency_data_pipeline`.`fb_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'FB Ads'
  );

    
2018-06-15 17:36:20,731: Fetching data for query ga_conversions:
create or replace table `agency_data_pipeline`.`ga_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'Google Analytics'
  );

    
2018-06-15 17:36:22,171: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-15 17:36:22,299: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-15 17:36:22,318: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-15 17:36:22,321: Fetching data for query fb_ads_insights:
create or replace table `agency_data_pipeline`.`fb_ads_insights`
  
  as (
    



with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


  );

    
2018-06-15 17:36:22,449: Writing runtime SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-15 17:36:22,450: Fetching data for query fb_adcreative:
create or replace table `agency_data_pipeline`.`fb_adcreative`
  
  as (
    



with fb_adcreative as (


	    
		   	SELECT 
			id,
			link_url object_url,
			url_tags,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


  );

    
2018-06-15 17:36:22,563: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112051128>]}
2018-06-15 17:36:22,851: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111ffe748>]}
2018-06-15 17:36:22,904: 17:36:22 | 11 of 27 OK created table model agency_data_pipeline.fb_conversions.. [OK in 2.01s]
2018-06-15 17:36:23,246: 17:36:23 | 10 of 27 OK created table model agency_data_pipeline.ga_conversions.. [OK in 2.30s]
2018-06-15 17:36:24,148: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f66c748>]}
2018-06-15 17:36:24,482: 17:36:24 | 8 of 27 OK created table model agency_data_pipeline.fb_ads_insights.. [OK in 3.60s]
2018-06-15 17:36:24,494: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111ffe9b0>]}
2018-06-15 17:36:24,835: 17:36:24 | 9 of 27 OK created table model agency_data_pipeline.fb_adcreative.... [OK in 3.94s]
2018-06-15 17:36:24,836: 17:36:24 | 12 of 27 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-06-15 17:36:24,836: Compiling model.agency_data_pipeline.fb_ads
2018-06-15 17:36:24,836: 17:36:24 | 13 of 27 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-06-15 17:36:24,843: Compiling model.agency_data_pipeline.adwords_join
2018-06-15 17:36:24,854: Acquiring new bigquery connection "fb_ads".
2018-06-15 17:36:24,855: Re-using an available connection from the pool.
2018-06-15 17:36:24,855: Fetching data for query fb_ads:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 17:36:24,867: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-15 17:36:24,869: Acquiring new bigquery connection "adwords_join".
2018-06-15 17:36:24,870: Re-using an available connection from the pool.
2018-06-15 17:36:25,007: Writing runtime SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-15 17:36:25,008: Fetching data for query adwords_join:
create or replace table `agency_data_pipeline`.`adwords_join`
  
  as (
    SELECT
day,
a.campaign,
a.campaignid, 
account, 
channel,
platform,
b.url,
cost,
impressions,
clicks,
conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_campaigns` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`adwords_urls` b
ON a.campaignid = b.campaignid
  );

    
2018-06-15 17:36:25,593: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-15 17:36:25,734: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-15 17:36:25,734: Fetching data for query fb_ads:
create or replace table `agency_data_pipeline`.`fb_ads`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


  );

    
2018-06-15 17:36:27,197: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1105dd048>]}
2018-06-15 17:36:27,521: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1120e74e0>]}
2018-06-15 17:36:27,534: 17:36:27 | 13 of 27 OK created table model agency_data_pipeline.adwords_join.... [OK in 2.35s]
2018-06-15 17:36:27,867: 17:36:27 | 12 of 27 OK created table model agency_data_pipeline.fb_ads.......... [OK in 2.69s]
2018-06-15 17:36:27,868: 17:36:27 | 14 of 27 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-06-15 17:36:27,868: 17:36:27 | 15 of 27 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-06-15 17:36:27,868: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-15 17:36:27,869: 17:36:27 | 16 of 27 START table model agency_data_pipeline.ga_proc.............. [RUN]
2018-06-15 17:36:27,869: Compiling model.agency_data_pipeline.adwords_stats
2018-06-15 17:36:27,876: Compiling model.agency_data_pipeline.ga_proc
2018-06-15 17:36:27,885: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-15 17:36:27,896: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-06-15 17:36:27,909: Acquiring new bigquery connection "ga_proc".
2018-06-15 17:36:27,909: Re-using an available connection from the pool.
2018-06-15 17:36:27,909: Fetching data for query fb_ads_insights_conversions:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 17:36:27,910: Re-using an available connection from the pool.
2018-06-15 17:36:27,912: Acquiring new bigquery connection "adwords_stats".
2018-06-15 17:36:27,912: Fetching data for query ga_proc:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 17:36:27,913: Re-using an available connection from the pool.
2018-06-15 17:36:28,039: Writing runtime SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-15 17:36:28,040: Fetching data for query adwords_stats:
create or replace table `agency_data_pipeline`.`adwords_stats`
  
  as (
    SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_join`
GROUP BY date, account, platform, channel, url, campaign
  );

    
2018-06-15 17:36:28,546: Fetching data for query fb_ads_insights_conversions:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`
        where goal_name is not null
        and goal_name != ''

        
        ##where 1 = 1
        and goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 17:36:29,427: Fetching data for query ga_proc:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`
        where goal_name is not null
        and goal_name != ''

        
        ##where 1 = 1
        and goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 17:36:29,883: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f696940>]}
2018-06-15 17:36:30,215: 17:36:30 | 15 of 27 OK created table model agency_data_pipeline.adwords_stats... [OK in 2.01s]
2018-06-15 17:36:30,232: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-06-15 17:36:30,374: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-06-15 17:36:30,375: Fetching data for query fb_ads_insights_conversions:
create or replace table `agency_data_pipeline`.`fb_ads_insights_conversions`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`





with fb_ads_insights_conversions as (

	    

	    	

		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			_sdc_sequence,
			action_type,
			_28d_click conversions,
			null as revenue
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
			cross join unnest(actions)

			## goal completion columns
			
				where action_type in (
				
					'offsite_conversion.fb_pixel_lead'
					 
				
				)
			
			
			UNION ALL

		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			_sdc_sequence,
			action_type,
			null as conversions,
			_28d_click as revenue
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
			cross join unnest(action_values)
			
			## goal completion columns
			
				where action_type in (
				
					'offsite_conversion.fb_pixel_lead'
					 
				
				)
			

		    
	   

)

SELECT 
date,
campaign_id,
campaign,
ad_id,
account,
sum(conversions) conversions,
sum(revenue) revenue
FROM 
		(
	    SELECT
	    date_start date,
	    campaign_id,
	    campaign_name campaign,
	    ad_id,
	    account_name account,
	    action_type,
	    conversions,
	    revenue,
	    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
	    _sdc_sequence
	    FROM fb_ads_insights_conversions
	   	)
where lv = _sdc_sequence
group by date, campaign_id, campaign, ad_id, account



  );

    
2018-06-15 17:36:31,317: Writing injected SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-15 17:36:31,442: Writing runtime SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-15 17:36:31,443: Fetching data for query ga_proc:
create or replace table `agency_data_pipeline`.`ga_proc`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`




with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'cifl' as bigquery_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			sessions,
			## goal completion columns
			
				
					cast(goal1completions as int64) 
					 
					 as goal_completions,  
				
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.ga_cifl.report` 

		    
	   

)


SELECT 
bigquery_name,
lookup_platform,
date,
url,
source,
medium,
sum(sessions) sessions,
sum(goal_completions) goal_completions
FROM ga_report
where lv = _sdc_sequence
group by bigquery_name, lookup_platform, date, url, source, medium


  );

    
2018-06-15 17:36:32,201: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f692828>]}
2018-06-15 17:36:32,536: 17:36:32 | 14 of 27 OK created table model agency_data_pipeline.fb_ads_insights_conversions [OK in 4.33s]
2018-06-15 17:36:33,751: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114477cf8>]}
2018-06-15 17:36:34,092: 17:36:34 | 16 of 27 OK created table model agency_data_pipeline.ga_proc......... [OK in 5.88s]
2018-06-15 17:36:34,093: 17:36:34 | 17 of 27 START table model agency_data_pipeline.ga_stats............. [RUN]
2018-06-15 17:36:34,094: Compiling model.agency_data_pipeline.ga_stats
2018-06-15 17:36:34,106: Writing injected SQL for node "model.agency_data_pipeline.ga_stats"
2018-06-15 17:36:34,111: Acquiring new bigquery connection "ga_stats".
2018-06-15 17:36:34,111: Re-using an available connection from the pool.
2018-06-15 17:36:34,248: Writing runtime SQL for node "model.agency_data_pipeline.ga_stats"
2018-06-15 17:36:34,249: Fetching data for query ga_stats:
create or replace table `agency_data_pipeline`.`ga_stats`
  
  as (
    SELECT  
cast(date as date) date,
b.account,
b.site site,
c.source source,
c.medium medium,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
url,
sum(sessions) sessions,
sum(goal_completions) goal_completions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`ga_proc` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.bigquery_name = b.bigquery_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.bigquery_name = c.bigquery_name )
GROUP BY date, account, site, source, medium, source_medium, platform, channel, url
  );

    
2018-06-15 17:36:36,725: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1120e74e0>]}
2018-06-15 17:36:37,060: 17:36:37 | 17 of 27 OK created table model agency_data_pipeline.ga_stats........ [OK in 2.63s]
2018-06-15 17:36:37,061: 17:36:37 | 18 of 27 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-06-15 17:36:37,062: Compiling model.agency_data_pipeline.fb_ads_stats
2018-06-15 17:36:37,072: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-06-15 17:36:37,074: Acquiring new bigquery connection "fb_ads_stats".
2018-06-15 17:36:37,074: Re-using an available connection from the pool.
2018-06-15 17:36:37,232: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-06-15 17:36:37,233: Fetching data for query fb_ads_stats:
create or replace table `agency_data_pipeline`.`fb_ads_stats`
  
  as (
    with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) conversions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign
  );

    
2018-06-15 17:36:39,628: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f678278>]}
2018-06-15 17:36:39,965: 17:36:39 | 18 of 27 OK created table model agency_data_pipeline.fb_ads_stats.... [OK in 2.57s]
2018-06-15 17:36:39,966: 17:36:39 | 19 of 27 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-06-15 17:36:39,967: Compiling model.agency_data_pipeline.agg_platforms_union
2018-06-15 17:36:39,979: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-06-15 17:36:39,981: Acquiring new bigquery connection "agg_platforms_union".
2018-06-15 17:36:39,981: Re-using an available connection from the pool.
2018-06-15 17:36:40,132: Writing runtime SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-06-15 17:36:40,132: Fetching data for query agg_platforms_union:
create or replace table `agency_data_pipeline`.`agg_platforms_union`
  
  as (
    SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`adwords_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`gsc_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`youtube_stats`
  );

    
2018-06-15 17:36:42,159: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1120e74e0>]}
2018-06-15 17:36:42,504: 17:36:42 | 19 of 27 OK created table model agency_data_pipeline.agg_platforms_union [OK in 2.19s]
2018-06-15 17:36:42,505: 17:36:42 | 20 of 27 START table model agency_data_pipeline.agg_platforms_site... [RUN]
2018-06-15 17:36:42,505: Compiling model.agency_data_pipeline.agg_platforms_site
2018-06-15 17:36:42,514: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_site"
2018-06-15 17:36:42,516: Acquiring new bigquery connection "agg_platforms_site".
2018-06-15 17:36:42,516: Re-using an available connection from the pool.
2018-06-15 17:36:42,645: Writing runtime SQL for node "model.agency_data_pipeline.agg_platforms_site"
2018-06-15 17:36:42,646: Fetching data for query agg_platforms_site:
create or replace table `agency_data_pipeline`.`agg_platforms_site`
  
  as (
    SELECT 
date, 
a.account account, 
b.site site,
a.platform platform,
a.channel channel,
url,
cost,
impressions,
clicks,
conversions
FROM 
  `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_union` a
LEFT JOIN 
  `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc` b
ON ( 
  a.account = b.account AND
  a.platform = b.platform
)
  );

    
2018-06-15 17:36:45,558: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f678278>]}
2018-06-15 17:36:45,899: 17:36:45 | 20 of 27 OK created table model agency_data_pipeline.agg_platforms_site [OK in 3.05s]
2018-06-15 17:36:45,900: 17:36:45 | 21 of 27 START table model agency_data_pipeline.agg_platforms_ga..... [RUN]
2018-06-15 17:36:45,901: Compiling model.agency_data_pipeline.agg_platforms_ga
2018-06-15 17:36:45,913: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_ga"
2018-06-15 17:36:45,918: Acquiring new bigquery connection "agg_platforms_ga".
2018-06-15 17:36:45,918: Re-using an available connection from the pool.
2018-06-15 17:36:46,071: Writing runtime SQL for node "model.agency_data_pipeline.agg_platforms_ga"
2018-06-15 17:36:46,071: Fetching data for query agg_platforms_ga:
create or replace table `agency_data_pipeline`.`agg_platforms_ga`
  
  as (
    with ga as (

	select 
		date, account, site, channel, platform, url,
		sessions, goal_completions,
		null as cost, null as impressions, null as clicks, null as conversions
	from `adp-apprenticeship`.`agency_data_pipeline`.`ga_stats`

),

platforms as (

	select 
		date, account, site, channel, platform, url,
		null as sessions, null as goal_completions,
		cost, impressions, clicks, conversions
	from `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_site`

)


SELECT
    date, 
    site,
    platform,
    channel, 
    url,
    sum(cost) cost,
	sum(impressions) impressions,
	sum(clicks) clicks,
	sum(conversions) conversions,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      platforms 
) 
GROUP BY
    date, site, platform, channel, url
  );

    
2018-06-15 17:36:48,795: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1120e74e0>]}
2018-06-15 17:36:49,132: 17:36:49 | 21 of 27 OK created table model agency_data_pipeline.agg_platforms_ga [OK in 2.89s]
2018-06-15 17:36:49,133: 17:36:49 | 22 of 27 START table model agency_data_pipeline.platform_by_month.... [RUN]
2018-06-15 17:36:49,133: 17:36:49 | 23 of 27 START table model agency_data_pipeline.landing_page_by_month [RUN]
2018-06-15 17:36:49,134: Compiling model.agency_data_pipeline.platform_by_month
2018-06-15 17:36:49,134: Compiling model.agency_data_pipeline.landing_page_by_month
2018-06-15 17:36:49,143: Writing injected SQL for node "model.agency_data_pipeline.platform_by_month"
2018-06-15 17:36:49,155: Writing injected SQL for node "model.agency_data_pipeline.landing_page_by_month"
2018-06-15 17:36:49,158: Acquiring new bigquery connection "platform_by_month".
2018-06-15 17:36:49,158: Re-using an available connection from the pool.
2018-06-15 17:36:49,166: Acquiring new bigquery connection "landing_page_by_month".
2018-06-15 17:36:49,166: Re-using an available connection from the pool.
2018-06-15 17:36:49,299: Writing runtime SQL for node "model.agency_data_pipeline.landing_page_by_month"
2018-06-15 17:36:49,314: Writing runtime SQL for node "model.agency_data_pipeline.platform_by_month"
2018-06-15 17:36:49,315: Fetching data for query landing_page_by_month:
create or replace table `agency_data_pipeline`.`landing_page_by_month`
  
  as (
    SELECT
yyyymm, 
site,
platform,
channel, 
url,
cost,
impressions,
clicks,
conversions,
sessions,
sum(sessions) OVER w1 total_sessions,
goal_completions,
sum(goal_completions) OVER w1 total_goal_completions
FROM (
    SELECT 
    FORMAT_DATE("%Y-%m", date) AS yyyymm,
    site,
    platform,
    channel, 
    url,
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) conversions,
    sum(sessions) sessions,
    sum(goal_completions) goal_completions
    FROM `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_ga`
    GROUP BY yyyymm, site, platform, channel, url
)
WINDOW w1 as (PARTITION BY yyyymm, site)
  );

    
2018-06-15 17:36:49,316: Fetching data for query platform_by_month:
create or replace table `agency_data_pipeline`.`platform_by_month`
  
  as (
    SELECT
yyyymm, 
site,
platform,
channel, 
cost,
impressions,
clicks,
conversions,
sessions,
sum(sessions) OVER w1 total_sessions,
goal_completions,
sum(goal_completions) OVER w1 total_goal_completions
FROM (
    SELECT 
    FORMAT_DATE("%Y-%m", date) AS yyyymm,
    site,
    platform,
    channel, 
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) conversions,
    sum(sessions) sessions,
    sum(goal_completions) goal_completions
    FROM `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_ga`
    GROUP BY yyyymm, site, channel, url
)
WINDOW w1 as (PARTITION BY yyyymm, site)
  );

    
2018-06-15 17:36:49,714: Bad request while running:
create dataset
2018-06-15 17:36:49,715: 400 GET https://www.googleapis.com/bigquery/v2/projects/adp-apprenticeship/queries/8c156555-d059-4076-a708-c4500e040d89?maxResults=0: SELECT list expression references column platform which is neither grouped nor aggregated at [21:5]
2018-06-15 17:36:49,715: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ec5d7b8>]}
2018-06-15 17:36:50,048: 17:36:50 | 22 of 27 ERROR creating table model agency_data_pipeline.platform_by_month [ERROR in 0.58s]
2018-06-15 17:36:52,475: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1144545c0>]}
2018-06-15 17:36:52,812: 17:36:52 | 23 of 27 OK created table model agency_data_pipeline.landing_page_by_month [OK in 3.34s]
2018-06-15 17:36:52,813: 17:36:52 | 24 of 27 START table model agency_data_pipeline.landing_page_index... [RUN]
2018-06-15 17:36:52,813: 17:36:52 | 25 of 27 SKIP relation agency_data_pipeline.platform_index........... [SKIP]
2018-06-15 17:36:52,814: Compiling model.agency_data_pipeline.landing_page_index
2018-06-15 17:36:52,824: Writing injected SQL for node "model.agency_data_pipeline.landing_page_index"
2018-06-15 17:36:52,829: Acquiring new bigquery connection "landing_page_index".
2018-06-15 17:36:52,829: Re-using an available connection from the pool.
2018-06-15 17:36:52,946: Writing runtime SQL for node "model.agency_data_pipeline.landing_page_index"
2018-06-15 17:36:52,947: Fetching data for query landing_page_index:
create or replace table `agency_data_pipeline`.`landing_page_index`
  
  as (
    SELECT 
yyyymm, 
site,
platform,
channel, 
url,
cost,
impressions,
clicks,
conversions,
sessions,
pct_sessions,
goal_completions,
pct_goal_completions,
case when pct_sessions > 0 then pct_goal_completions / pct_sessions else null end as conversion_index
FROM (
    SELECT
    yyyymm, 
    site,
    platform,
    channel, 
    url,
    cost,
    impressions,
    clicks,
    conversions,
    sessions,
    case when total_sessions > 0 then sessions / total_sessions else null end as pct_sessions,
    goal_completions,
    case when total_goal_completions > 0 then goal_completions / total_goal_completions else null end as pct_goal_completions
    FROM `adp-apprenticeship`.`agency_data_pipeline`.`landing_page_by_month`
)
  );

    
2018-06-15 17:36:54,510: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11202e048>]}
2018-06-15 17:36:54,845: 17:36:54 | 24 of 27 OK created table model agency_data_pipeline.landing_page_index [OK in 1.70s]
2018-06-15 17:36:54,846: 17:36:54 | 26 of 27 START table model agency_data_pipeline.platform_viz......... [RUN]
2018-06-15 17:36:54,847: Compiling model.agency_data_pipeline.platform_viz
2018-06-15 17:36:54,846: 17:36:54 | 27 of 27 START table model agency_data_pipeline.landing_page_viz..... [RUN]
2018-06-15 17:36:54,854: Compiling model.agency_data_pipeline.landing_page_viz
2018-06-15 17:36:54,857: Writing injected SQL for node "model.agency_data_pipeline.platform_viz"
2018-06-15 17:36:54,863: Writing injected SQL for node "model.agency_data_pipeline.landing_page_viz"
2018-06-15 17:36:54,865: Acquiring new bigquery connection "platform_viz".
2018-06-15 17:36:54,865: Re-using an available connection from the pool.
2018-06-15 17:36:54,868: Acquiring new bigquery connection "landing_page_viz".
2018-06-15 17:36:54,868: Re-using an available connection from the pool.
2018-06-15 17:36:55,006: Writing runtime SQL for node "model.agency_data_pipeline.platform_viz"
2018-06-15 17:36:55,018: Writing runtime SQL for node "model.agency_data_pipeline.landing_page_viz"
2018-06-15 17:36:55,019: Fetching data for query landing_page_viz:
create or replace table `agency_data_pipeline`.`landing_page_viz`
  
  as (
    SELECT 
yyyymm Month, 
site Site,
platform Platform,
channel Channel, 
url URL,
ifnull(cost, 0) Cost,
ifnull(impressions, 0) Impressions,
ifnull(clicks, 0) Clicks,
ifnull(conversions, 0) Conversions,
ifnull(sessions, 0) Sessions,
ifnull(pct_sessions, 0) PctSessions,
ifnull(goal_completions, 0) GoalCompletions,
ifnull(pct_goal_completions, 0) PctGoalCompletions,
ifnull(conversion_index, 0) ConversionIndex
FROM `adp-apprenticeship`.`agency_data_pipeline`.`landing_page_index`
  );

    
2018-06-15 17:36:55,019: Fetching data for query platform_viz:
create or replace table `agency_data_pipeline`.`platform_viz`
  
  as (
    SELECT 
yyyymm Month, 
site Site,
platform Platform,
channel Channel, 
ifnull(cost, 0) Cost,
ifnull(impressions, 0) Impressions,
ifnull(clicks, 0) Clicks,
ifnull(conversions, 0) Conversions,
ifnull(sessions, 0) Sessions,
ifnull(pct_sessions, 0) PctSessions,
ifnull(goal_completions, 0) GoalCompletions,
ifnull(pct_goal_completions, 0) PctGoalCompletions,
ifnull(conversion_index, 0) ConversionIndex
FROM `adp-apprenticeship`.`agency_data_pipeline`.`landing_page_index`
WHERE yyyymm >= '2017-06'
  );

    
2018-06-15 17:36:56,564: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1120ae860>]}
2018-06-15 17:36:56,872: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5e29d8a8-7254-49e3-9c10-5345da60fa8f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1120ae358>]}
2018-06-15 17:36:56,904: 17:36:56 | 27 of 27 OK created table model agency_data_pipeline.landing_page_viz [OK in 1.71s]
2018-06-15 17:36:57,231: 17:36:57 | 26 of 27 OK created table model agency_data_pipeline.platform_viz.... [OK in 2.03s]
2018-06-15 17:36:57,320: 17:36:57 | 
2018-06-15 17:36:57,320: 17:36:57 | Finished running 27 table models in 44.02s.
2018-06-15 17:36:57,321: Connection 'master' was left open.
2018-06-15 17:36:57,321: 
2018-06-15 17:36:57,321: Completed with 1 errors:
2018-06-15 17:36:57,322: 
2018-06-15 17:36:57,322: Database Error in model platform_by_month (models/math/platform_by_month.sql)
2018-06-15 17:36:57,322:   SELECT list expression references column platform which is neither grouped nor aggregated at [21:5]
2018-06-15 17:36:57,323:   compiled SQL at target/run/agency_data_pipeline/math/platform_by_month.sql
2018-06-15 17:36:57,323: 
Done. PASS=25 ERROR=1 SKIP=1 TOTAL=27
2018-06-15 17:36:57,324: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ed214a8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ed21da0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f637780>]}
2018-06-15 17:36:57,657: Flushing usage events
2018-06-15 17:36:57,706: sys:1: ResourceWarning: unclosed <socket.socket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51893), raddr=('172.217.11.234', 443)>

2018-06-15 17:36:57,706: sys:1: ResourceWarning: unclosed <socket.socket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51892), raddr=('172.217.12.13', 443)>

2018-06-15 17:36:57,707: sys:1: ResourceWarning: unclosed <socket.socket fd=17, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51898), raddr=('172.217.1.202', 443)>

2018-06-15 17:36:57,707: sys:1: ResourceWarning: unclosed <socket.socket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51900), raddr=('172.217.1.202', 443)>

2018-06-15 17:36:57,707: sys:1: ResourceWarning: unclosed <socket.socket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51894), raddr=('172.217.12.13', 443)>

2018-06-15 17:36:57,708: sys:1: ResourceWarning: unclosed <socket.socket fd=18, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51899), raddr=('172.217.1.202', 443)>

2018-06-15 17:36:57,708: sys:1: ResourceWarning: unclosed <socket.socket fd=20, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51901), raddr=('172.217.1.202', 443)>

2018-06-15 17:36:57,708: sys:1: ResourceWarning: unclosed <socket.socket fd=16, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51895), raddr=('172.217.12.13', 443)>

2018-06-15 17:36:57,709: sys:1: ResourceWarning: unclosed <socket.socket fd=14, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51896), raddr=('172.217.12.13', 443)>

2018-06-15 17:36:57,709: sys:1: ResourceWarning: unclosed <socket.socket fd=15, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51897), raddr=('172.217.12.13', 443)>

2018-06-15 17:37:32,991: Tracking: tracking
2018-06-15 17:37:32,991: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc45fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc45c88>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc45dd8>]}
2018-06-15 17:37:33,883: Loading dependency project from /usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/include
2018-06-15 17:37:33,904: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/agency-data-pipeline/dbt_modules
2018-06-15 17:37:33,905: Parsing get_column_values.sql
2018-06-15 17:37:33,917: Parsing core.sql
2018-06-15 17:37:33,928: Parsing adapters/bigquery.sql
2018-06-15 17:37:33,935: Parsing adapters/common.sql
2018-06-15 17:37:33,956: Parsing adapters/redshift.sql
2018-06-15 17:37:33,984: Parsing adapters/snowflake.sql
2018-06-15 17:37:33,986: Parsing etc/bigquery.sql
2018-06-15 17:37:33,988: Parsing etc/datetime.sql
2018-06-15 17:37:34,011: Parsing etc/get_custom_schema.sql
2018-06-15 17:37:34,016: Parsing materializations/helpers.sql
2018-06-15 17:37:34,034: Parsing materializations/archive/archive.sql
2018-06-15 17:37:34,069: Parsing materializations/incremental/incremental.sql
2018-06-15 17:37:34,099: Parsing materializations/seed/bigquery.sql
2018-06-15 17:37:34,105: Parsing materializations/seed/seed.sql
2018-06-15 17:37:34,155: Parsing materializations/table/bigquery_table.sql
2018-06-15 17:37:34,185: Parsing materializations/table/table.sql
2018-06-15 17:37:34,208: Parsing materializations/view/bigquery_view.sql
2018-06-15 17:37:34,219: Parsing materializations/view/view.sql
2018-06-15 17:37:34,237: Parsing schema_tests/accepted_values.sql
2018-06-15 17:37:34,240: Parsing schema_tests/not_null.sql
2018-06-15 17:37:34,241: Parsing schema_tests/relationships.sql
2018-06-15 17:37:34,244: Parsing schema_tests/unique.sql
2018-06-15 17:37:34,273: Parsing model.agency_data_pipeline.accounts_proc
2018-06-15 17:37:34,278: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-06-15 17:37:34,282: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-06-15 17:37:34,285: Parsing model.agency_data_pipeline.adwords_campaigns
2018-06-15 17:37:34,287: Parsing model.agency_data_pipeline.adwords_join
2018-06-15 17:37:34,290: Parsing model.agency_data_pipeline.adwords_stats
2018-06-15 17:37:34,293: Parsing model.agency_data_pipeline.adwords_urls
2018-06-15 17:37:34,295: Parsing model.agency_data_pipeline.fb_adcreative
2018-06-15 17:37:34,301: Parsing model.agency_data_pipeline.fb_ads
2018-06-15 17:37:34,308: Parsing model.agency_data_pipeline.fb_ads_insights
2018-06-15 17:37:34,314: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-15 17:37:34,328: Parsing model.agency_data_pipeline.fb_ads_stats
2018-06-15 17:37:34,332: Parsing model.agency_data_pipeline.fb_conversions
2018-06-15 17:37:34,334: Parsing model.agency_data_pipeline.ga_conversions
2018-06-15 17:37:34,337: Parsing model.agency_data_pipeline.ga_proc
2018-06-15 17:37:34,348: Parsing model.agency_data_pipeline.ga_stats
2018-06-15 17:37:34,352: Parsing model.agency_data_pipeline.gsc_stats
2018-06-15 17:37:34,355: Parsing model.agency_data_pipeline.youtube_stats
2018-06-15 17:37:34,357: Parsing model.agency_data_pipeline.agg_platforms_ga
2018-06-15 17:37:34,360: Parsing model.agency_data_pipeline.agg_platforms_site
2018-06-15 17:37:34,363: Parsing model.agency_data_pipeline.agg_platforms_union
2018-06-15 17:37:34,369: Parsing model.agency_data_pipeline.landing_page_by_month
2018-06-15 17:37:34,372: Parsing model.agency_data_pipeline.landing_page_index
2018-06-15 17:37:34,374: Parsing model.agency_data_pipeline.platform_by_month
2018-06-15 17:37:34,377: Parsing model.agency_data_pipeline.platform_index
2018-06-15 17:37:34,379: Parsing model.agency_data_pipeline.landing_page_viz
2018-06-15 17:37:34,382: Parsing model.agency_data_pipeline.platform_viz
2018-06-15 17:37:34,395: Found 27 models, 0 tests, 0 archives, 0 analyses, 57 macros, 0 operations, 0 seed files
2018-06-15 17:37:34,402: 
2018-06-15 17:37:34,409: Acquiring new bigquery connection "master".
2018-06-15 17:37:34,410: Opening a new connection (0 currently allocated)
2018-06-15 17:37:35,344: 17:37:35 | Concurrency: 4 threads (target='dev')
2018-06-15 17:37:35,344: 17:37:35 | 
2018-06-15 17:37:35,418: 17:37:35 | 1 of 27 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-06-15 17:37:35,418: 17:37:35 | 2 of 27 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-06-15 17:37:35,418: 17:37:35 | 3 of 27 START table model agency_data_pipeline.gsc_stats............. [RUN]
2018-06-15 17:37:35,418: 17:37:35 | 4 of 27 START table model agency_data_pipeline.mappings_ga_proc...... [RUN]
2018-06-15 17:37:35,419: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-06-15 17:37:35,419: Compiling model.agency_data_pipeline.adwords_urls
2018-06-15 17:37:35,419: Compiling model.agency_data_pipeline.gsc_stats
2018-06-15 17:37:35,419: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-06-15 17:37:35,424: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-15 17:37:35,429: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-15 17:37:35,433: Writing injected SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-15 17:37:35,439: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-15 17:37:35,441: Acquiring new bigquery connection "adwords_urls".
2018-06-15 17:37:35,441: Opening a new connection (1 currently allocated)
2018-06-15 17:37:35,443: Acquiring new bigquery connection "mappings_ga_proc".
2018-06-15 17:37:35,444: Acquiring new bigquery connection "gsc_stats".
2018-06-15 17:37:35,445: Acquiring new bigquery connection "conversion_goals_proc".
2018-06-15 17:37:35,446: Opening a new connection (2 currently allocated)
2018-06-15 17:37:35,447: Opening a new connection (3 currently allocated)
2018-06-15 17:37:35,448: Opening a new connection (4 currently allocated)
2018-06-15 17:37:35,939: Writing runtime SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-15 17:37:35,971: Writing runtime SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-15 17:37:35,971: Fetching data for query mappings_ga_proc:
create or replace table `agency_data_pipeline`.`mappings_ga_proc`
  
  as (
    SELECT
site,
account,
bigquery_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
FROM  ( 

	SELECT  
	site,
	account,
	bigquery_name,
	source,
	medium,
	platform as platform_n,
	channel as channel_n,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
group by site, account, bigquery_name, source, medium, platform_n, channel_n, time_of_entry
  );

    
2018-06-15 17:37:35,991: Writing runtime SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-15 17:37:35,992: Writing runtime SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-15 17:37:35,993: Fetching data for query adwords_urls:
create or replace table `agency_data_pipeline`.`adwords_urls`
  
  as (
    SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url
FROM 
(
	SELECT  
	campaignid,
	max(finalurl) finalurl
	FROM `adp-apprenticeship.adwords.FINAL_URL_REPORT`
	GROUP BY campaignid
)
  );

    
2018-06-15 17:37:35,997: Fetching data for query gsc_stats:
create or replace table `agency_data_pipeline`.`gsc_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
0 as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
0 as conversions
FROM 
  ( 
	SELECT  
	date, 
	site as account,
	'Organic' as channel,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(replace(landing_page_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
	max(impressions) as impressions, 
	max(clicks) as clicks
	FROM `adp-apprenticeship.agency_data_pipeline.gsc`
	GROUP BY date, account, channel, platform, url
  ) 
GROUP BY date, account, channel, platform, url
ORDER BY account asc, date asc, url asc
  );

    
2018-06-15 17:37:35,997: Fetching data for query conversion_goals_proc:
create or replace table `agency_data_pipeline`.`conversion_goals_proc`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
FROM  ( 

	SELECT  
	site,
	bigquery_name,
	platform,
	trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
	goal_type,
	account,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by site, bigquery_name, platform, account, goal_name
  );

    
2018-06-15 17:37:37,893: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd84c18>]}
2018-06-15 17:37:37,903: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd84358>]}
2018-06-15 17:37:38,166: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd84fd0>]}
2018-06-15 17:37:38,236: 17:37:38 | 2 of 27 OK created table model agency_data_pipeline.adwords_urls..... [OK in 2.47s]
2018-06-15 17:37:38,238: 17:37:38 | 5 of 27 START table model agency_data_pipeline.youtube_stats......... [RUN]
2018-06-15 17:37:38,238: Compiling model.agency_data_pipeline.youtube_stats
2018-06-15 17:37:38,247: Writing injected SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-15 17:37:38,250: Acquiring new bigquery connection "youtube_stats".
2018-06-15 17:37:38,251: Re-using an available connection from the pool.
2018-06-15 17:37:38,387: Writing runtime SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-15 17:37:38,388: Fetching data for query youtube_stats:
create or replace table `agency_data_pipeline`.`youtube_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
FROM 
  ( 
	SELECT  
	date, 
	'Social' as channel,
	'YouTube' as platform,
	'Coding is for Losers' as account,  
	0 as cost, 
	max(views) as impressions, 
	max(clicks) as clicks, 
	max(subscribers) as conversions,
	regexp_replace(regexp_replace(replace(replace(replace(landing_page_url,'http://',''),'https://',''),'.html',''),r'\?.*$',''),r'([/]$)','') as url,
	video_url
	FROM `adp-apprenticeship.agency_data_pipeline.youtube`
	group by channel, platform, account, date, video_url, url
  ) 
GROUP BY date, account, channel, platform, url
  );

    
2018-06-15 17:37:38,466: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd849e8>]}
2018-06-15 17:37:38,571: 17:37:38 | 3 of 27 OK created table model agency_data_pipeline.gsc_stats........ [OK in 2.48s]
2018-06-15 17:37:38,572: 17:37:38 | 6 of 27 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-06-15 17:37:38,572: Compiling model.agency_data_pipeline.adwords_campaigns
2018-06-15 17:37:38,583: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-15 17:37:38,589: Acquiring new bigquery connection "adwords_campaigns".
2018-06-15 17:37:38,589: Re-using an available connection from the pool.
2018-06-15 17:37:38,734: Writing runtime SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-15 17:37:38,735: Fetching data for query adwords_campaigns:
create or replace table `agency_data_pipeline`.`adwords_campaigns`
  
  as (
    SELECT
day,
campaignid,
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM
( 
	SELECT  
	'Paid' as channel,
	'Adwords' as platform,
	day,
	campaignid,
	campaign,
	account as account,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	conversions,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `adp-apprenticeship.adwords.CAMPAIGN_PERFORMANCE_REPORT`
)
WHERE lv = _sdc_sequence
GROUP BY day, campaignid, account, channel, platform, campaign
  );

    
2018-06-15 17:37:38,922: 17:37:38 | 4 of 27 OK created table model agency_data_pipeline.mappings_ga_proc. [OK in 2.75s]
2018-06-15 17:37:38,923: 17:37:38 | 7 of 27 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-06-15 17:37:38,923: Compiling model.agency_data_pipeline.accounts_proc
2018-06-15 17:37:38,929: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 17:37:38,935: Acquiring new bigquery connection "accounts_proc".
2018-06-15 17:37:38,935: Re-using an available connection from the pool.
2018-06-15 17:37:39,085: Writing runtime SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-15 17:37:39,086: Fetching data for query accounts_proc:
create or replace table `agency_data_pipeline`.`accounts_proc`
  
  as (
    SELECT
site,
bigquery_name,
account,
platform
FROM  (
 
	SELECT  
	site,
	bigquery_name,
	account,
	platform,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.accounts`
) 

WHERE lv = time_of_entry
  );

    
2018-06-15 17:37:39,256: 17:37:39 | 1 of 27 OK created table model agency_data_pipeline.conversion_goals_proc [OK in 3.05s]
2018-06-15 17:37:40,002: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd84c18>]}
2018-06-15 17:37:40,344: 17:37:40 | 5 of 27 OK created table model agency_data_pipeline.youtube_stats.... [OK in 1.76s]
2018-06-15 17:37:40,588: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd84358>]}
2018-06-15 17:37:40,933: 17:37:40 | 6 of 27 OK created table model agency_data_pipeline.adwords_campaigns [OK in 2.02s]
2018-06-15 17:37:41,543: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd84fd0>]}
2018-06-15 17:37:41,872: 17:37:41 | 7 of 27 OK created table model agency_data_pipeline.accounts_proc.... [OK in 2.62s]
2018-06-15 17:37:41,873: 17:37:41 | 8 of 27 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-06-15 17:37:41,873: 17:37:41 | 9 of 27 START table model agency_data_pipeline.fb_conversions........ [RUN]
2018-06-15 17:37:41,874: 17:37:41 | 10 of 27 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-06-15 17:37:41,874: 17:37:41 | 11 of 27 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-06-15 17:37:41,875: Compiling model.agency_data_pipeline.ga_conversions
2018-06-15 17:37:41,875: Compiling model.agency_data_pipeline.fb_conversions
2018-06-15 17:37:41,876: Compiling model.agency_data_pipeline.fb_ads_insights
2018-06-15 17:37:41,876: Compiling model.agency_data_pipeline.fb_adcreative
2018-06-15 17:37:41,883: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-15 17:37:41,898: Acquiring new bigquery connection "fb_ads_insights".
2018-06-15 17:37:41,899: Acquiring new bigquery connection "fb_adcreative".
2018-06-15 17:37:41,906: Re-using an available connection from the pool.
2018-06-15 17:37:41,906: Writing injected SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-15 17:37:41,907: Fetching data for query fb_ads_insights:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 17:37:41,907: Re-using an available connection from the pool.
2018-06-15 17:37:41,908: Acquiring new bigquery connection "ga_conversions".
2018-06-15 17:37:41,909: Fetching data for query fb_adcreative:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 17:37:41,909: Re-using an available connection from the pool.
2018-06-15 17:37:41,912: Acquiring new bigquery connection "fb_conversions".
2018-06-15 17:37:41,920: Re-using an available connection from the pool.
2018-06-15 17:37:42,046: Writing runtime SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-15 17:37:42,063: Fetching data for query ga_conversions:
create or replace table `agency_data_pipeline`.`ga_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'Google Analytics'
  );

    
2018-06-15 17:37:42,065: Writing runtime SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-15 17:37:42,067: Fetching data for query fb_conversions:
create or replace table `agency_data_pipeline`.`fb_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'FB Ads'
  );

    
2018-06-15 17:37:43,639: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-15 17:37:43,684: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-15 17:37:43,792: Writing runtime SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-15 17:37:43,792: Fetching data for query fb_adcreative:
create or replace table `agency_data_pipeline`.`fb_adcreative`
  
  as (
    



with fb_adcreative as (


	    
		   	SELECT 
			id,
			link_url object_url,
			url_tags,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


  );

    
2018-06-15 17:37:43,823: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-15 17:37:43,824: Fetching data for query fb_ads_insights:
create or replace table `agency_data_pipeline`.`fb_ads_insights`
  
  as (
    



with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


  );

    
2018-06-15 17:37:43,853: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cecedd8>]}
2018-06-15 17:37:44,179: 17:37:44 | 9 of 27 OK created table model agency_data_pipeline.fb_conversions... [OK in 1.98s]
2018-06-15 17:37:44,199: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd84908>]}
2018-06-15 17:37:44,536: 17:37:44 | 8 of 27 OK created table model agency_data_pipeline.ga_conversions... [OK in 2.32s]
2018-06-15 17:37:45,718: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109969cf8>]}
2018-06-15 17:37:45,878: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cdfdeb8>]}
2018-06-15 17:37:46,052: 17:37:46 | 10 of 27 OK created table model agency_data_pipeline.fb_ads_insights. [OK in 3.84s]
2018-06-15 17:37:46,388: 17:37:46 | 11 of 27 OK created table model agency_data_pipeline.fb_adcreative... [OK in 4.00s]
2018-06-15 17:37:46,389: 17:37:46 | 12 of 27 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-06-15 17:37:46,389: 17:37:46 | 13 of 27 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-06-15 17:37:46,390: Compiling model.agency_data_pipeline.fb_ads
2018-06-15 17:37:46,390: Compiling model.agency_data_pipeline.adwords_join
2018-06-15 17:37:46,404: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-15 17:37:46,410: Acquiring new bigquery connection "fb_ads".
2018-06-15 17:37:46,410: Re-using an available connection from the pool.
2018-06-15 17:37:46,410: Fetching data for query fb_ads:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 17:37:46,412: Acquiring new bigquery connection "adwords_join".
2018-06-15 17:37:46,412: Re-using an available connection from the pool.
2018-06-15 17:37:46,548: Writing runtime SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-15 17:37:46,549: Fetching data for query adwords_join:
create or replace table `agency_data_pipeline`.`adwords_join`
  
  as (
    SELECT
day,
a.campaign,
a.campaignid, 
account, 
channel,
platform,
b.url,
cost,
impressions,
clicks,
conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_campaigns` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`adwords_urls` b
ON a.campaignid = b.campaignid
  );

    
2018-06-15 17:37:47,166: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-15 17:37:47,319: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-15 17:37:47,320: Fetching data for query fb_ads:
create or replace table `agency_data_pipeline`.`fb_ads`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


  );

    
2018-06-15 17:37:49,021: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10997abe0>]}
2018-06-15 17:37:49,259: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd84fd0>]}
2018-06-15 17:37:49,358: 17:37:49 | 13 of 27 OK created table model agency_data_pipeline.adwords_join.... [OK in 2.63s]
2018-06-15 17:37:49,785: 17:37:49 | 12 of 27 OK created table model agency_data_pipeline.fb_ads.......... [OK in 2.87s]
2018-06-15 17:37:49,786: 17:37:49 | 14 of 27 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-06-15 17:37:49,787: 17:37:49 | 15 of 27 START table model agency_data_pipeline.ga_proc.............. [RUN]
2018-06-15 17:37:49,787: Compiling model.agency_data_pipeline.adwords_stats
2018-06-15 17:37:49,787: 17:37:49 | 16 of 27 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-06-15 17:37:49,787: Compiling model.agency_data_pipeline.ga_proc
2018-06-15 17:37:49,794: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-15 17:37:49,824: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-15 17:37:49,827: Acquiring new bigquery connection "ga_proc".
2018-06-15 17:37:49,832: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-06-15 17:37:49,833: Re-using an available connection from the pool.
2018-06-15 17:37:49,833: Fetching data for query ga_proc:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 17:37:49,833: Re-using an available connection from the pool.
2018-06-15 17:37:49,834: Fetching data for query fb_ads_insights_conversions:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 17:37:49,838: Acquiring new bigquery connection "adwords_stats".
2018-06-15 17:37:49,838: Re-using an available connection from the pool.
2018-06-15 17:37:49,972: Writing runtime SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-15 17:37:49,973: Fetching data for query adwords_stats:
create or replace table `agency_data_pipeline`.`adwords_stats`
  
  as (
    SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_join`
GROUP BY date, account, platform, channel, url, campaign
  );

    
2018-06-15 17:37:50,476: Fetching data for query fb_ads_insights_conversions:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`
        where goal_name is not null
        and goal_name != ''

        
        ##where 1 = 1
        and goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 17:37:51,615: Fetching data for query ga_proc:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`
        where goal_name is not null
        and goal_name != ''

        
        ##where 1 = 1
        and goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-15 17:37:51,736: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd3b5f8>]}
2018-06-15 17:37:51,919: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-06-15 17:37:52,043: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-06-15 17:37:52,044: Fetching data for query fb_ads_insights_conversions:
create or replace table `agency_data_pipeline`.`fb_ads_insights_conversions`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`





with fb_ads_insights_conversions as (

	    

	    	

		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			_sdc_sequence,
			action_type,
			_28d_click conversions,
			null as revenue
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
			cross join unnest(actions)

			## goal completion columns
			
				where action_type in (
				
					'offsite_conversion.fb_pixel_lead'
					 
				
				)
			
			
			UNION ALL

		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			_sdc_sequence,
			action_type,
			null as conversions,
			_28d_click as revenue
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
			cross join unnest(action_values)
			
			## goal completion columns
			
				where action_type in (
				
					'offsite_conversion.fb_pixel_lead'
					 
				
				)
			

		    
	   

)

SELECT 
date,
campaign_id,
campaign,
ad_id,
account,
sum(conversions) conversions,
sum(revenue) revenue
FROM 
		(
	    SELECT
	    date_start date,
	    campaign_id,
	    campaign_name campaign,
	    ad_id,
	    account_name account,
	    action_type,
	    conversions,
	    revenue,
	    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
	    _sdc_sequence
	    FROM fb_ads_insights_conversions
	   	)
where lv = _sdc_sequence
group by date, campaign_id, campaign, ad_id, account



  );

    
2018-06-15 17:37:52,081: 17:37:52 | 14 of 27 OK created table model agency_data_pipeline.adwords_stats... [OK in 1.95s]
2018-06-15 17:37:53,146: Writing injected SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-15 17:37:53,286: Writing runtime SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-15 17:37:53,287: Fetching data for query ga_proc:
create or replace table `agency_data_pipeline`.`ga_proc`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`




with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'cifl' as bigquery_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			sessions,
			## goal completion columns
			
				
					cast(goal1completions as int64) 
					 
					 as goal_completions,  
				
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.ga_cifl.report` 

		    
	   

)


SELECT 
bigquery_name,
lookup_platform,
date,
url,
source,
medium,
sum(sessions) sessions,
sum(goal_completions) goal_completions
FROM ga_report
where lv = _sdc_sequence
group by bigquery_name, lookup_platform, date, url, source, medium


  );

    
2018-06-15 17:37:54,224: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd7cf98>]}
2018-06-15 17:37:54,557: 17:37:54 | 16 of 27 OK created table model agency_data_pipeline.fb_ads_insights_conversions [OK in 4.43s]
2018-06-15 17:37:55,589: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cddec50>]}
2018-06-15 17:37:55,923: 17:37:55 | 15 of 27 OK created table model agency_data_pipeline.ga_proc......... [OK in 5.80s]
2018-06-15 17:37:55,924: 17:37:55 | 17 of 27 START table model agency_data_pipeline.ga_stats............. [RUN]
2018-06-15 17:37:55,925: Compiling model.agency_data_pipeline.ga_stats
2018-06-15 17:37:55,938: Writing injected SQL for node "model.agency_data_pipeline.ga_stats"
2018-06-15 17:37:55,939: Acquiring new bigquery connection "ga_stats".
2018-06-15 17:37:55,940: Re-using an available connection from the pool.
2018-06-15 17:37:56,077: Writing runtime SQL for node "model.agency_data_pipeline.ga_stats"
2018-06-15 17:37:56,077: Fetching data for query ga_stats:
create or replace table `agency_data_pipeline`.`ga_stats`
  
  as (
    SELECT  
cast(date as date) date,
b.account,
b.site site,
c.source source,
c.medium medium,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
url,
sum(sessions) sessions,
sum(goal_completions) goal_completions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`ga_proc` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.bigquery_name = b.bigquery_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.bigquery_name = c.bigquery_name )
GROUP BY date, account, site, source, medium, source_medium, platform, channel, url
  );

    
2018-06-15 17:37:58,545: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd84fd0>]}
2018-06-15 17:37:58,884: 17:37:58 | 17 of 27 OK created table model agency_data_pipeline.ga_stats........ [OK in 2.62s]
2018-06-15 17:37:58,885: 17:37:58 | 18 of 27 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-06-15 17:37:58,885: Compiling model.agency_data_pipeline.fb_ads_stats
2018-06-15 17:37:58,894: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-06-15 17:37:58,895: Acquiring new bigquery connection "fb_ads_stats".
2018-06-15 17:37:58,895: Re-using an available connection from the pool.
2018-06-15 17:37:59,060: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-06-15 17:37:59,061: Fetching data for query fb_ads_stats:
create or replace table `agency_data_pipeline`.`fb_ads_stats`
  
  as (
    with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) conversions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign
  );

    
2018-06-15 17:38:01,023: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce044a8>]}
2018-06-15 17:38:01,356: 17:38:01 | 18 of 27 OK created table model agency_data_pipeline.fb_ads_stats.... [OK in 2.14s]
2018-06-15 17:38:01,357: 17:38:01 | 19 of 27 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-06-15 17:38:01,357: Compiling model.agency_data_pipeline.agg_platforms_union
2018-06-15 17:38:01,370: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-06-15 17:38:01,372: Acquiring new bigquery connection "agg_platforms_union".
2018-06-15 17:38:01,372: Re-using an available connection from the pool.
2018-06-15 17:38:01,506: Writing runtime SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-06-15 17:38:01,506: Fetching data for query agg_platforms_union:
create or replace table `agency_data_pipeline`.`agg_platforms_union`
  
  as (
    SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`adwords_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`gsc_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`youtube_stats`
  );

    
2018-06-15 17:38:03,362: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd84fd0>]}
2018-06-15 17:38:03,699: 17:38:03 | 19 of 27 OK created table model agency_data_pipeline.agg_platforms_union [OK in 2.00s]
2018-06-15 17:38:03,699: 17:38:03 | 20 of 27 START table model agency_data_pipeline.agg_platforms_site... [RUN]
2018-06-15 17:38:03,700: Compiling model.agency_data_pipeline.agg_platforms_site
2018-06-15 17:38:03,711: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_site"
2018-06-15 17:38:03,713: Acquiring new bigquery connection "agg_platforms_site".
2018-06-15 17:38:03,713: Re-using an available connection from the pool.
2018-06-15 17:38:03,842: Writing runtime SQL for node "model.agency_data_pipeline.agg_platforms_site"
2018-06-15 17:38:03,843: Fetching data for query agg_platforms_site:
create or replace table `agency_data_pipeline`.`agg_platforms_site`
  
  as (
    SELECT 
date, 
a.account account, 
b.site site,
a.platform platform,
a.channel channel,
url,
cost,
impressions,
clicks,
conversions
FROM 
  `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_union` a
LEFT JOIN 
  `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc` b
ON ( 
  a.account = b.account AND
  a.platform = b.platform
)
  );

    
2018-06-15 17:38:05,698: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce044a8>]}
2018-06-15 17:38:06,032: 17:38:06 | 20 of 27 OK created table model agency_data_pipeline.agg_platforms_site [OK in 2.00s]
2018-06-15 17:38:06,033: 17:38:06 | 21 of 27 START table model agency_data_pipeline.agg_platforms_ga..... [RUN]
2018-06-15 17:38:06,033: Compiling model.agency_data_pipeline.agg_platforms_ga
2018-06-15 17:38:06,046: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_ga"
2018-06-15 17:38:06,049: Acquiring new bigquery connection "agg_platforms_ga".
2018-06-15 17:38:06,049: Re-using an available connection from the pool.
2018-06-15 17:38:06,181: Writing runtime SQL for node "model.agency_data_pipeline.agg_platforms_ga"
2018-06-15 17:38:06,181: Fetching data for query agg_platforms_ga:
create or replace table `agency_data_pipeline`.`agg_platforms_ga`
  
  as (
    with ga as (

	select 
		date, account, site, channel, platform, url,
		sessions, goal_completions,
		null as cost, null as impressions, null as clicks, null as conversions
	from `adp-apprenticeship`.`agency_data_pipeline`.`ga_stats`

),

platforms as (

	select 
		date, account, site, channel, platform, url,
		null as sessions, null as goal_completions,
		cost, impressions, clicks, conversions
	from `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_site`

)


SELECT
    date, 
    site,
    platform,
    channel, 
    url,
    sum(cost) cost,
	sum(impressions) impressions,
	sum(clicks) clicks,
	sum(conversions) conversions,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      platforms 
) 
GROUP BY
    date, site, platform, channel, url
  );

    
2018-06-15 17:38:08,811: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd84fd0>]}
2018-06-15 17:38:09,150: 17:38:09 | 21 of 27 OK created table model agency_data_pipeline.agg_platforms_ga [OK in 2.78s]
2018-06-15 17:38:09,150: 17:38:09 | 22 of 27 START table model agency_data_pipeline.platform_by_month.... [RUN]
2018-06-15 17:38:09,151: Compiling model.agency_data_pipeline.platform_by_month
2018-06-15 17:38:09,151: 17:38:09 | 23 of 27 START table model agency_data_pipeline.landing_page_by_month [RUN]
2018-06-15 17:38:09,160: Compiling model.agency_data_pipeline.landing_page_by_month
2018-06-15 17:38:09,170: Writing injected SQL for node "model.agency_data_pipeline.platform_by_month"
2018-06-15 17:38:09,174: Writing injected SQL for node "model.agency_data_pipeline.landing_page_by_month"
2018-06-15 17:38:09,176: Acquiring new bigquery connection "platform_by_month".
2018-06-15 17:38:09,177: Re-using an available connection from the pool.
2018-06-15 17:38:09,180: Acquiring new bigquery connection "landing_page_by_month".
2018-06-15 17:38:09,180: Re-using an available connection from the pool.
2018-06-15 17:38:09,736: Writing runtime SQL for node "model.agency_data_pipeline.platform_by_month"
2018-06-15 17:38:09,750: Writing runtime SQL for node "model.agency_data_pipeline.landing_page_by_month"
2018-06-15 17:38:09,751: Fetching data for query landing_page_by_month:
create or replace table `agency_data_pipeline`.`landing_page_by_month`
  
  as (
    SELECT
yyyymm, 
site,
platform,
channel, 
url,
cost,
impressions,
clicks,
conversions,
sessions,
sum(sessions) OVER w1 total_sessions,
goal_completions,
sum(goal_completions) OVER w1 total_goal_completions
FROM (
    SELECT 
    FORMAT_DATE("%Y-%m", date) AS yyyymm,
    site,
    platform,
    channel, 
    url,
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) conversions,
    sum(sessions) sessions,
    sum(goal_completions) goal_completions
    FROM `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_ga`
    GROUP BY yyyymm, site, platform, channel, url
)
WINDOW w1 as (PARTITION BY yyyymm, site)
  );

    
2018-06-15 17:38:09,752: Fetching data for query platform_by_month:
create or replace table `agency_data_pipeline`.`platform_by_month`
  
  as (
    SELECT
yyyymm, 
site,
platform,
channel, 
cost,
impressions,
clicks,
conversions,
sessions,
sum(sessions) OVER w1 total_sessions,
goal_completions,
sum(goal_completions) OVER w1 total_goal_completions
FROM (
    SELECT 
    FORMAT_DATE("%Y-%m", date) AS yyyymm,
    site,
    platform,
    channel, 
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) conversions,
    sum(sessions) sessions,
    sum(goal_completions) goal_completions
    FROM `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_ga`
    GROUP BY yyyymm, site, channel, platform
)
WINDOW w1 as (PARTITION BY yyyymm, site)
  );

    
2018-06-15 17:38:12,377: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce044a8>]}
2018-06-15 17:38:12,401: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f216710>]}
2018-06-15 17:38:12,711: 17:38:12 | 22 of 27 OK created table model agency_data_pipeline.platform_by_month [OK in 3.23s]
2018-06-15 17:38:13,042: 17:38:13 | 23 of 27 OK created table model agency_data_pipeline.landing_page_by_month [OK in 3.24s]
2018-06-15 17:38:13,043: 17:38:13 | 24 of 27 START table model agency_data_pipeline.landing_page_index... [RUN]
2018-06-15 17:38:13,043: Compiling model.agency_data_pipeline.landing_page_index
2018-06-15 17:38:13,043: 17:38:13 | 25 of 27 START table model agency_data_pipeline.platform_index....... [RUN]
2018-06-15 17:38:13,049: Compiling model.agency_data_pipeline.platform_index
2018-06-15 17:38:13,056: Writing injected SQL for node "model.agency_data_pipeline.landing_page_index"
2018-06-15 17:38:13,060: Writing injected SQL for node "model.agency_data_pipeline.platform_index"
2018-06-15 17:38:13,061: Acquiring new bigquery connection "landing_page_index".
2018-06-15 17:38:13,062: Re-using an available connection from the pool.
2018-06-15 17:38:13,066: Acquiring new bigquery connection "platform_index".
2018-06-15 17:38:13,066: Re-using an available connection from the pool.
2018-06-15 17:38:13,623: Writing runtime SQL for node "model.agency_data_pipeline.platform_index"
2018-06-15 17:38:13,637: Fetching data for query platform_index:
create or replace table `agency_data_pipeline`.`platform_index`
  
  as (
    SELECT 
yyyymm, 
site,
platform,
channel, 
cost,
impressions,
clicks,
conversions,
sessions,
pct_sessions,
goal_completions,
pct_goal_completions,
case when pct_sessions > 0 then pct_goal_completions / pct_sessions else null end as conversion_index
FROM (
    SELECT
    yyyymm, 
    site,
    platform,
    channel, 
    cost,
    impressions,
    clicks,
    conversions,
    sessions,
    case when total_sessions > 0 then sessions / total_sessions else null end as pct_sessions,
    goal_completions,
    case when total_goal_completions > 0 then goal_completions / total_goal_completions else null end as pct_goal_completions
    FROM `adp-apprenticeship`.`agency_data_pipeline`.`platform_by_month`
)
  );

    
2018-06-15 17:38:13,645: Writing runtime SQL for node "model.agency_data_pipeline.landing_page_index"
2018-06-15 17:38:13,647: Fetching data for query landing_page_index:
create or replace table `agency_data_pipeline`.`landing_page_index`
  
  as (
    SELECT 
yyyymm, 
site,
platform,
channel, 
url,
cost,
impressions,
clicks,
conversions,
sessions,
pct_sessions,
goal_completions,
pct_goal_completions,
case when pct_sessions > 0 then pct_goal_completions / pct_sessions else null end as conversion_index
FROM (
    SELECT
    yyyymm, 
    site,
    platform,
    channel, 
    url,
    cost,
    impressions,
    clicks,
    conversions,
    sessions,
    case when total_sessions > 0 then sessions / total_sessions else null end as pct_sessions,
    goal_completions,
    case when total_goal_completions > 0 then goal_completions / total_goal_completions else null end as pct_goal_completions
    FROM `adp-apprenticeship`.`agency_data_pipeline`.`landing_page_by_month`
)
  );

    
2018-06-15 17:38:15,900: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cdb5f98>]}
2018-06-15 17:38:16,238: 17:38:16 | 25 of 27 OK created table model agency_data_pipeline.platform_index.. [OK in 2.85s]
2018-06-15 17:38:16,458: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cdb5cf8>]}
2018-06-15 17:38:16,790: 17:38:16 | 24 of 27 OK created table model agency_data_pipeline.landing_page_index [OK in 3.41s]
2018-06-15 17:38:16,791: 17:38:16 | 26 of 27 START table model agency_data_pipeline.platform_viz......... [RUN]
2018-06-15 17:38:16,791: Compiling model.agency_data_pipeline.platform_viz
2018-06-15 17:38:16,791: 17:38:16 | 27 of 27 START table model agency_data_pipeline.landing_page_viz..... [RUN]
2018-06-15 17:38:16,798: Compiling model.agency_data_pipeline.landing_page_viz
2018-06-15 17:38:16,802: Writing injected SQL for node "model.agency_data_pipeline.platform_viz"
2018-06-15 17:38:16,807: Writing injected SQL for node "model.agency_data_pipeline.landing_page_viz"
2018-06-15 17:38:16,808: Acquiring new bigquery connection "landing_page_viz".
2018-06-15 17:38:16,808: Re-using an available connection from the pool.
2018-06-15 17:38:16,810: Acquiring new bigquery connection "platform_viz".
2018-06-15 17:38:16,810: Re-using an available connection from the pool.
2018-06-15 17:38:17,385: Writing runtime SQL for node "model.agency_data_pipeline.landing_page_viz"
2018-06-15 17:38:17,401: Writing runtime SQL for node "model.agency_data_pipeline.platform_viz"
2018-06-15 17:38:17,401: Fetching data for query landing_page_viz:
create or replace table `agency_data_pipeline`.`landing_page_viz`
  
  as (
    SELECT 
yyyymm Month, 
site Site,
platform Platform,
channel Channel, 
url URL,
ifnull(cost, 0) Cost,
ifnull(impressions, 0) Impressions,
ifnull(clicks, 0) Clicks,
ifnull(conversions, 0) Conversions,
ifnull(sessions, 0) Sessions,
ifnull(pct_sessions, 0) PctSessions,
ifnull(goal_completions, 0) GoalCompletions,
ifnull(pct_goal_completions, 0) PctGoalCompletions,
ifnull(conversion_index, 0) ConversionIndex
FROM `adp-apprenticeship`.`agency_data_pipeline`.`landing_page_index`
  );

    
2018-06-15 17:38:17,402: Fetching data for query platform_viz:
create or replace table `agency_data_pipeline`.`platform_viz`
  
  as (
    SELECT 
yyyymm Month, 
site Site,
platform Platform,
channel Channel, 
ifnull(cost, 0) Cost,
ifnull(impressions, 0) Impressions,
ifnull(clicks, 0) Clicks,
ifnull(conversions, 0) Conversions,
ifnull(sessions, 0) Sessions,
ifnull(pct_sessions, 0) PctSessions,
ifnull(goal_completions, 0) GoalCompletions,
ifnull(pct_goal_completions, 0) PctGoalCompletions,
ifnull(conversion_index, 0) ConversionIndex
FROM `adp-apprenticeship`.`agency_data_pipeline`.`landing_page_index`
WHERE yyyymm >= '2017-06'
  );

    
2018-06-15 17:38:19,960: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce044a8>]}
2018-06-15 17:38:19,967: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f7c9be44-17ff-4b72-be5d-4349c5270e56', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cec4f28>]}
2018-06-15 17:38:20,300: 17:38:20 | 26 of 27 OK created table model agency_data_pipeline.platform_viz.... [OK in 3.17s]
2018-06-15 17:38:20,639: 17:38:20 | 27 of 27 OK created table model agency_data_pipeline.landing_page_viz [OK in 3.17s]
2018-06-15 17:38:20,681: 17:38:20 | 
2018-06-15 17:38:20,681: 17:38:20 | Finished running 27 table models in 46.28s.
2018-06-15 17:38:20,681: Connection 'master' was left open.
2018-06-15 17:38:20,681: 
2018-06-15 17:38:20,682: Completed successfully
2018-06-15 17:38:20,682: 
Done. PASS=27 ERROR=0 SKIP=0 TOTAL=27
2018-06-15 17:38:20,682: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc45fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd087b8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd08a90>]}
2018-06-15 17:38:21,026: Flushing usage events
2018-06-15 17:38:21,074: sys:1: ResourceWarning: unclosed <socket.socket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51934), raddr=('172.217.12.10', 443)>

2018-06-15 17:38:21,074: sys:1: ResourceWarning: unclosed <socket.socket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51933), raddr=('172.217.12.13', 443)>

2018-06-15 17:38:21,075: sys:1: ResourceWarning: unclosed <socket.socket fd=14, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51936), raddr=('172.217.12.13', 443)>

2018-06-15 17:38:21,075: sys:1: ResourceWarning: unclosed <socket.socket fd=20, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51942), raddr=('172.217.12.10', 443)>

2018-06-15 17:38:21,076: sys:1: ResourceWarning: unclosed <socket.socket fd=18, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51940), raddr=('172.217.12.10', 443)>

2018-06-15 17:38:21,076: sys:1: ResourceWarning: unclosed <socket.socket fd=17, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51939), raddr=('172.217.12.10', 443)>

2018-06-15 17:38:21,076: sys:1: ResourceWarning: unclosed <socket.socket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51941), raddr=('172.217.12.10', 443)>

2018-06-15 17:38:21,077: sys:1: ResourceWarning: unclosed <socket.socket fd=16, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51937), raddr=('172.217.12.13', 443)>

2018-06-15 17:38:21,077: sys:1: ResourceWarning: unclosed <socket.socket fd=15, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51935), raddr=('172.217.12.13', 443)>

2018-06-15 17:38:21,078: sys:1: ResourceWarning: unclosed <socket.socket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 51938), raddr=('172.217.12.13', 443)>

2018-06-16 10:50:13,665: Tracking: tracking
2018-06-16 10:50:13,668: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111981a90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111981e10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111981e80>]}
2018-06-16 10:50:14,651: Loading dependency project from /usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/include
2018-06-16 10:50:14,681: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/agency-data-pipeline/dbt_modules
2018-06-16 10:50:14,687: Parsing get_column_values.sql
2018-06-16 10:50:14,715: Parsing core.sql
2018-06-16 10:50:14,732: Parsing adapters/bigquery.sql
2018-06-16 10:50:14,745: Parsing adapters/common.sql
2018-06-16 10:50:14,776: Parsing adapters/redshift.sql
2018-06-16 10:50:14,799: Parsing adapters/snowflake.sql
2018-06-16 10:50:14,805: Parsing etc/bigquery.sql
2018-06-16 10:50:14,814: Parsing etc/datetime.sql
2018-06-16 10:50:14,848: Parsing etc/get_custom_schema.sql
2018-06-16 10:50:14,857: Parsing materializations/helpers.sql
2018-06-16 10:50:14,895: Parsing materializations/archive/archive.sql
2018-06-16 10:50:14,941: Parsing materializations/incremental/incremental.sql
2018-06-16 10:50:14,985: Parsing materializations/seed/bigquery.sql
2018-06-16 10:50:14,993: Parsing materializations/seed/seed.sql
2018-06-16 10:50:15,044: Parsing materializations/table/bigquery_table.sql
2018-06-16 10:50:15,082: Parsing materializations/table/table.sql
2018-06-16 10:50:15,112: Parsing materializations/view/bigquery_view.sql
2018-06-16 10:50:15,134: Parsing materializations/view/view.sql
2018-06-16 10:50:15,155: Parsing schema_tests/accepted_values.sql
2018-06-16 10:50:15,162: Parsing schema_tests/not_null.sql
2018-06-16 10:50:15,166: Parsing schema_tests/relationships.sql
2018-06-16 10:50:15,174: Parsing schema_tests/unique.sql
2018-06-16 10:50:15,207: Parsing model.agency_data_pipeline.accounts_proc
2018-06-16 10:50:15,211: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-06-16 10:50:15,213: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-06-16 10:50:15,216: Parsing model.agency_data_pipeline.adwords_campaigns
2018-06-16 10:50:15,219: Parsing model.agency_data_pipeline.adwords_join
2018-06-16 10:50:15,222: Parsing model.agency_data_pipeline.adwords_stats
2018-06-16 10:50:15,226: Parsing model.agency_data_pipeline.adwords_urls
2018-06-16 10:50:15,228: Parsing model.agency_data_pipeline.fb_adcreative
2018-06-16 10:50:15,235: Parsing model.agency_data_pipeline.fb_ads
2018-06-16 10:50:15,242: Parsing model.agency_data_pipeline.fb_ads_insights
2018-06-16 10:50:15,253: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-16 10:50:15,267: Parsing model.agency_data_pipeline.fb_ads_stats
2018-06-16 10:50:15,272: Parsing model.agency_data_pipeline.fb_conversions
2018-06-16 10:50:15,275: Parsing model.agency_data_pipeline.ga_conversions
2018-06-16 10:50:15,279: Parsing model.agency_data_pipeline.ga_proc
2018-06-16 10:50:15,290: Parsing model.agency_data_pipeline.ga_stats
2018-06-16 10:50:15,295: Parsing model.agency_data_pipeline.gsc_stats
2018-06-16 10:50:15,297: Parsing model.agency_data_pipeline.youtube_stats
2018-06-16 10:50:15,299: Parsing model.agency_data_pipeline.agg_platforms_ga
2018-06-16 10:50:15,303: Parsing model.agency_data_pipeline.agg_platforms_site
2018-06-16 10:50:15,306: Parsing model.agency_data_pipeline.agg_platforms_union
2018-06-16 10:50:15,313: Parsing model.agency_data_pipeline.landing_page_by_month
2018-06-16 10:50:15,315: Parsing model.agency_data_pipeline.landing_page_index
2018-06-16 10:50:15,318: Parsing model.agency_data_pipeline.platform_by_month
2018-06-16 10:50:15,321: Parsing model.agency_data_pipeline.platform_index
2018-06-16 10:50:15,323: Parsing model.agency_data_pipeline.landing_page_viz
2018-06-16 10:50:15,328: Parsing model.agency_data_pipeline.platform_viz
2018-06-16 10:50:15,348: Found 27 models, 0 tests, 0 archives, 0 analyses, 57 macros, 0 operations, 0 seed files
2018-06-16 10:50:15,355: 
2018-06-16 10:50:15,362: Acquiring new bigquery connection "master".
2018-06-16 10:50:15,362: Opening a new connection (0 currently allocated)
2018-06-16 10:50:16,687: 10:50:16 | Concurrency: 4 threads (target='dev')
2018-06-16 10:50:16,687: 10:50:16 | 
2018-06-16 10:50:16,782: 10:50:16 | 1 of 27 START table model agency_data_pipeline.youtube_stats......... [RUN]
2018-06-16 10:50:16,782: 10:50:16 | 2 of 27 START table model agency_data_pipeline.gsc_stats............. [RUN]
2018-06-16 10:50:16,782: Compiling model.agency_data_pipeline.youtube_stats
2018-06-16 10:50:16,782: 10:50:16 | 3 of 27 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-06-16 10:50:16,783: Compiling model.agency_data_pipeline.gsc_stats
2018-06-16 10:50:16,788: Writing injected SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-16 10:50:16,782: 10:50:16 | 4 of 27 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-06-16 10:50:16,788: Compiling model.agency_data_pipeline.accounts_proc
2018-06-16 10:50:16,793: Writing injected SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-16 10:50:16,794: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-06-16 10:50:16,799: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-16 10:50:16,805: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-16 10:50:16,806: Acquiring new bigquery connection "youtube_stats".
2018-06-16 10:50:16,809: Acquiring new bigquery connection "gsc_stats".
2018-06-16 10:50:16,810: Opening a new connection (1 currently allocated)
2018-06-16 10:50:16,811: Acquiring new bigquery connection "accounts_proc".
2018-06-16 10:50:16,813: Acquiring new bigquery connection "conversion_goals_proc".
2018-06-16 10:50:16,816: Opening a new connection (2 currently allocated)
2018-06-16 10:50:16,818: Opening a new connection (3 currently allocated)
2018-06-16 10:50:16,825: Opening a new connection (4 currently allocated)
2018-06-16 10:50:17,330: Writing runtime SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-16 10:50:17,330: Fetching data for query gsc_stats:
create or replace table `agency_data_pipeline`.`gsc_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
0 as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
0 as conversions
FROM 
  ( 
	SELECT  
	date, 
	site as account,
	'Organic' as channel,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(replace(landing_page_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
	max(impressions) as impressions, 
	max(clicks) as clicks
	FROM `adp-apprenticeship.agency_data_pipeline.gsc`
	GROUP BY date, account, channel, platform, url
  ) 
GROUP BY date, account, channel, platform, url
ORDER BY account asc, date asc, url asc
  );

    
2018-06-16 10:50:17,361: Writing runtime SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-16 10:50:17,380: Writing runtime SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-16 10:50:17,388: Writing runtime SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-16 10:50:17,388: Fetching data for query conversion_goals_proc:
create or replace table `agency_data_pipeline`.`conversion_goals_proc`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
FROM  ( 

	SELECT  
	site,
	bigquery_name,
	platform,
	trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
	goal_type,
	account,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by site, bigquery_name, platform, account, goal_name
  );

    
2018-06-16 10:50:17,389: Fetching data for query accounts_proc:
create or replace table `agency_data_pipeline`.`accounts_proc`
  
  as (
    SELECT
site,
bigquery_name,
account,
platform
FROM  (
 
	SELECT  
	site,
	bigquery_name,
	account,
	platform,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.accounts`
) 

WHERE lv = time_of_entry
  );

    
2018-06-16 10:50:17,389: Fetching data for query youtube_stats:
create or replace table `agency_data_pipeline`.`youtube_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
FROM 
  ( 
	SELECT  
	date, 
	'Social' as channel,
	'YouTube' as platform,
	'Coding is for Losers' as account,  
	0 as cost, 
	max(views) as impressions, 
	max(clicks) as clicks, 
	max(subscribers) as conversions,
	regexp_replace(regexp_replace(replace(replace(replace(landing_page_url,'http://',''),'https://',''),'.html',''),r'\?.*$',''),r'([/]$)','') as url,
	video_url
	FROM `adp-apprenticeship.agency_data_pipeline.youtube`
	group by channel, platform, account, date, video_url, url
  ) 
GROUP BY date, account, channel, platform, url
  );

    
2018-06-16 10:50:18,968: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b9d588>]}
2018-06-16 10:50:19,250: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b9dcc0>]}
2018-06-16 10:50:19,335: 10:50:19 | 2 of 27 OK created table model agency_data_pipeline.gsc_stats........ [OK in 2.19s]
2018-06-16 10:50:19,335: 10:50:19 | 5 of 27 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-06-16 10:50:19,337: Compiling model.agency_data_pipeline.adwords_urls
2018-06-16 10:50:19,351: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-16 10:50:19,354: Acquiring new bigquery connection "adwords_urls".
2018-06-16 10:50:19,354: Re-using an available connection from the pool.
2018-06-16 10:50:19,562: Writing runtime SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-16 10:50:19,564: Fetching data for query adwords_urls:
create or replace table `agency_data_pipeline`.`adwords_urls`
  
  as (
    SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url
FROM 
(
	SELECT  
	campaignid,
	max(finalurl) finalurl
	FROM `adp-apprenticeship.adwords.FINAL_URL_REPORT`
	GROUP BY campaignid
)
  );

    
2018-06-16 10:50:19,573: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a8a4e0>]}
2018-06-16 10:50:19,814: 10:50:19 | 1 of 27 OK created table model agency_data_pipeline.youtube_stats.... [OK in 2.47s]
2018-06-16 10:50:19,818: 10:50:19 | 6 of 27 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-06-16 10:50:19,819: Compiling model.agency_data_pipeline.adwords_campaigns
2018-06-16 10:50:19,829: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-16 10:50:19,832: Acquiring new bigquery connection "adwords_campaigns".
2018-06-16 10:50:19,834: Re-using an available connection from the pool.
2018-06-16 10:50:19,865: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a8a588>]}
2018-06-16 10:50:19,964: Writing runtime SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-16 10:50:19,965: Fetching data for query adwords_campaigns:
create or replace table `agency_data_pipeline`.`adwords_campaigns`
  
  as (
    SELECT
day,
campaignid,
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM
( 
	SELECT  
	'Paid' as channel,
	'Adwords' as platform,
	day,
	campaignid,
	campaign,
	account as account,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	conversions,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `adp-apprenticeship.adwords.CAMPAIGN_PERFORMANCE_REPORT`
)
WHERE lv = _sdc_sequence
GROUP BY day, campaignid, account, channel, platform, campaign
  );

    
2018-06-16 10:50:20,154: 10:50:20 | 3 of 27 OK created table model agency_data_pipeline.accounts_proc.... [OK in 2.79s]
2018-06-16 10:50:20,155: 10:50:20 | 7 of 27 START table model agency_data_pipeline.mappings_ga_proc...... [RUN]
2018-06-16 10:50:20,156: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-06-16 10:50:20,168: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-16 10:50:20,170: Acquiring new bigquery connection "mappings_ga_proc".
2018-06-16 10:50:20,171: Re-using an available connection from the pool.
2018-06-16 10:50:20,314: Writing runtime SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-16 10:50:20,315: Fetching data for query mappings_ga_proc:
create or replace table `agency_data_pipeline`.`mappings_ga_proc`
  
  as (
    SELECT
site,
account,
bigquery_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
FROM  ( 

	SELECT  
	site,
	account,
	bigquery_name,
	source,
	medium,
	platform as platform_n,
	channel as channel_n,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
group by site, account, bigquery_name, source, medium, platform_n, channel_n, time_of_entry
  );

    
2018-06-16 10:50:20,501: 10:50:20 | 4 of 27 OK created table model agency_data_pipeline.conversion_goals_proc [OK in 3.07s]
2018-06-16 10:50:21,128: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b9d588>]}
2018-06-16 10:50:21,460: 10:50:21 | 5 of 27 OK created table model agency_data_pipeline.adwords_urls..... [OK in 1.79s]
2018-06-16 10:50:21,790: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b9dcc0>]}
2018-06-16 10:50:22,131: 10:50:22 | 6 of 27 OK created table model agency_data_pipeline.adwords_campaigns [OK in 1.97s]
2018-06-16 10:50:22,450: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a8a4e0>]}
2018-06-16 10:50:22,784: 10:50:22 | 7 of 27 OK created table model agency_data_pipeline.mappings_ga_proc. [OK in 2.29s]
2018-06-16 10:50:22,785: 10:50:22 | 8 of 27 START table model agency_data_pipeline.fb_conversions........ [RUN]
2018-06-16 10:50:22,785: 10:50:22 | 9 of 27 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-06-16 10:50:22,785: 10:50:22 | 10 of 27 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-06-16 10:50:22,785: 10:50:22 | 11 of 27 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-06-16 10:50:22,786: Compiling model.agency_data_pipeline.fb_conversions
2018-06-16 10:50:22,786: Compiling model.agency_data_pipeline.ga_conversions
2018-06-16 10:50:22,786: Compiling model.agency_data_pipeline.fb_adcreative
2018-06-16 10:50:22,786: Compiling model.agency_data_pipeline.fb_ads_insights
2018-06-16 10:50:22,806: Acquiring new bigquery connection "fb_adcreative".
2018-06-16 10:50:22,806: Re-using an available connection from the pool.
2018-06-16 10:50:22,807: Fetching data for query fb_adcreative:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-16 10:50:22,808: Writing injected SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-16 10:50:22,809: Acquiring new bigquery connection "fb_ads_insights".
2018-06-16 10:50:22,809: Re-using an available connection from the pool.
2018-06-16 10:50:22,809: Fetching data for query fb_ads_insights:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-16 10:50:22,817: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-16 10:50:22,822: Acquiring new bigquery connection "ga_conversions".
2018-06-16 10:50:22,824: Re-using an available connection from the pool.
2018-06-16 10:50:22,823: Acquiring new bigquery connection "fb_conversions".
2018-06-16 10:50:22,825: Re-using an available connection from the pool.
2018-06-16 10:50:22,964: Writing runtime SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-16 10:50:22,970: Fetching data for query ga_conversions:
create or replace table `agency_data_pipeline`.`ga_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'Google Analytics'
  );

    
2018-06-16 10:50:22,985: Writing runtime SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-16 10:50:22,987: Fetching data for query fb_conversions:
create or replace table `agency_data_pipeline`.`fb_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'FB Ads'
  );

    
2018-06-16 10:50:24,328: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-16 10:50:24,488: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-16 10:50:24,489: Fetching data for query fb_ads_insights:
create or replace table `agency_data_pipeline`.`fb_ads_insights`
  
  as (
    



with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


  );

    
2018-06-16 10:50:24,597: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-16 10:50:24,746: Writing runtime SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-16 10:50:24,747: Fetching data for query fb_adcreative:
create or replace table `agency_data_pipeline`.`fb_adcreative`
  
  as (
    



with fb_adcreative as (


	    
		   	SELECT 
			id,
			link_url object_url,
			url_tags,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


  );

    
2018-06-16 10:50:24,841: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b94fd0>]}
2018-06-16 10:50:25,146: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b9ddd8>]}
2018-06-16 10:50:25,175: 10:50:25 | 9 of 27 OK created table model agency_data_pipeline.ga_conversions... [OK in 2.06s]
2018-06-16 10:50:25,511: 10:50:25 | 8 of 27 OK created table model agency_data_pipeline.fb_conversions... [OK in 2.36s]
2018-06-16 10:50:26,386: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a8a4e0>]}
2018-06-16 10:50:26,593: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c09358>]}
2018-06-16 10:50:26,725: 10:50:26 | 11 of 27 OK created table model agency_data_pipeline.fb_ads_insights. [OK in 3.60s]
2018-06-16 10:50:27,066: 10:50:27 | 10 of 27 OK created table model agency_data_pipeline.fb_adcreative... [OK in 3.81s]
2018-06-16 10:50:27,067: 10:50:27 | 12 of 27 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-06-16 10:50:27,068: Compiling model.agency_data_pipeline.adwords_join
2018-06-16 10:50:27,067: 10:50:27 | 13 of 27 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-06-16 10:50:27,075: Compiling model.agency_data_pipeline.fb_ads
2018-06-16 10:50:27,081: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-16 10:50:27,082: Acquiring new bigquery connection "adwords_join".
2018-06-16 10:50:27,083: Re-using an available connection from the pool.
2018-06-16 10:50:27,092: Acquiring new bigquery connection "fb_ads".
2018-06-16 10:50:27,094: Re-using an available connection from the pool.
2018-06-16 10:50:27,094: Fetching data for query fb_ads:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-16 10:50:27,235: Writing runtime SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-16 10:50:27,235: Fetching data for query adwords_join:
create or replace table `agency_data_pipeline`.`adwords_join`
  
  as (
    SELECT
day,
a.campaign,
a.campaignid, 
account, 
channel,
platform,
b.url,
cost,
impressions,
clicks,
conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_campaigns` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`adwords_urls` b
ON a.campaignid = b.campaignid
  );

    
2018-06-16 10:50:27,727: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-16 10:50:27,855: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-16 10:50:27,855: Fetching data for query fb_ads:
create or replace table `agency_data_pipeline`.`fb_ads`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


  );

    
2018-06-16 10:50:29,132: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e6ee668>]}
2018-06-16 10:50:29,467: 10:50:29 | 12 of 27 OK created table model agency_data_pipeline.adwords_join.... [OK in 2.06s]
2018-06-16 10:50:30,056: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e71d518>]}
2018-06-16 10:50:30,390: 10:50:30 | 13 of 27 OK created table model agency_data_pipeline.fb_ads.......... [OK in 2.98s]
2018-06-16 10:50:30,390: 10:50:30 | 14 of 27 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-06-16 10:50:30,391: Compiling model.agency_data_pipeline.adwords_stats
2018-06-16 10:50:30,391: 10:50:30 | 15 of 27 START table model agency_data_pipeline.ga_proc.............. [RUN]
2018-06-16 10:50:30,391: 10:50:30 | 16 of 27 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-06-16 10:50:30,398: Compiling model.agency_data_pipeline.ga_proc
2018-06-16 10:50:30,402: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-16 10:50:30,403: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-16 10:50:30,428: Acquiring new bigquery connection "ga_proc".
2018-06-16 10:50:30,428: Re-using an available connection from the pool.
2018-06-16 10:50:30,428: Fetching data for query ga_proc:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-16 10:50:30,441: Acquiring new bigquery connection "adwords_stats".
2018-06-16 10:50:30,448: Re-using an available connection from the pool.
2018-06-16 10:50:30,462: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-06-16 10:50:30,462: Re-using an available connection from the pool.
2018-06-16 10:50:30,463: Fetching data for query fb_ads_insights_conversions:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-16 10:50:30,591: Writing runtime SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-16 10:50:30,592: Fetching data for query adwords_stats:
create or replace table `agency_data_pipeline`.`adwords_stats`
  
  as (
    SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_join`
GROUP BY date, account, platform, channel, url, campaign
  );

    
2018-06-16 10:50:31,150: Fetching data for query fb_ads_insights_conversions:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`
        where goal_name is not null
        and goal_name != ''

        
        ##where 1 = 1
        and goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-16 10:50:32,201: Fetching data for query ga_proc:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`
        where goal_name is not null
        and goal_name != ''

        
        ##where 1 = 1
        and goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-16 10:50:32,419: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e70e668>]}
2018-06-16 10:50:32,753: 10:50:32 | 14 of 27 OK created table model agency_data_pipeline.adwords_stats... [OK in 2.03s]
2018-06-16 10:50:33,723: Writing injected SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-16 10:50:33,849: Writing runtime SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-16 10:50:33,849: Fetching data for query ga_proc:
create or replace table `agency_data_pipeline`.`ga_proc`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`




with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'cifl' as bigquery_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			sessions,
			## goal completion columns
			
				
					cast(goal1completions as int64) 
					 
					 as goal_completions,  
				
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.ga_cifl.report` 

		    
	   

)


SELECT 
bigquery_name,
lookup_platform,
date,
url,
source,
medium,
sum(sessions) sessions,
sum(goal_completions) goal_completions
FROM ga_report
where lv = _sdc_sequence
group by bigquery_name, lookup_platform, date, url, source, medium


  );

    
2018-06-16 10:50:36,172: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e6ee278>]}
2018-06-16 10:50:36,507: 10:50:36 | 15 of 27 OK created table model agency_data_pipeline.ga_proc......... [OK in 5.77s]
2018-06-16 10:51:24,598: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-06-16 10:51:24,753: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-06-16 10:51:24,756: Fetching data for query fb_ads_insights_conversions:
create or replace table `agency_data_pipeline`.`fb_ads_insights_conversions`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`





with fb_ads_insights_conversions as (

	    

	    	

		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			_sdc_sequence,
			action_type,
			_28d_click conversions,
			null as revenue
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
			cross join unnest(actions)

			## goal completion columns
			
				where action_type in (
				
					'offsite_conversion.fb_pixel_lead'
					 
				
				)
			
			
			UNION ALL

		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			_sdc_sequence,
			action_type,
			null as conversions,
			_28d_click as revenue
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
			cross join unnest(action_values)
			
			## goal completion columns
			
				where action_type in (
				
					'offsite_conversion.fb_pixel_lead'
					 
				
				)
			

		    
	   

)

SELECT 
date,
campaign_id,
campaign,
ad_id,
account,
sum(conversions) conversions,
sum(revenue) revenue
FROM 
		(
	    SELECT
	    date_start date,
	    campaign_id,
	    campaign_name campaign,
	    ad_id,
	    account_name account,
	    action_type,
	    conversions,
	    revenue,
	    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
	    _sdc_sequence
	    FROM fb_ads_insights_conversions
	   	)
where lv = _sdc_sequence
group by date, campaign_id, campaign, ad_id, account



  );

    
2018-06-16 10:51:26,589: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e6eee10>]}
2018-06-16 10:51:27,859: 10:51:27 | 16 of 27 OK created table model agency_data_pipeline.fb_ads_insights_conversions [OK in 56.19s]
2018-06-16 10:51:27,860: 10:51:27 | 17 of 27 START table model agency_data_pipeline.ga_stats............. [RUN]
2018-06-16 10:51:27,860: Compiling model.agency_data_pipeline.ga_stats
2018-06-16 10:51:27,868: Writing injected SQL for node "model.agency_data_pipeline.ga_stats"
2018-06-16 10:51:27,870: Acquiring new bigquery connection "ga_stats".
2018-06-16 10:51:27,870: Re-using an available connection from the pool.
2018-06-16 10:51:28,013: Writing runtime SQL for node "model.agency_data_pipeline.ga_stats"
2018-06-16 10:51:28,014: Fetching data for query ga_stats:
create or replace table `agency_data_pipeline`.`ga_stats`
  
  as (
    SELECT  
cast(date as date) date,
b.account,
b.site site,
c.source source,
c.medium medium,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
url,
sum(sessions) sessions,
sum(goal_completions) goal_completions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`ga_proc` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.bigquery_name = b.bigquery_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.bigquery_name = c.bigquery_name )
GROUP BY date, account, site, source, medium, source_medium, platform, channel, url
  );

    
2018-06-16 10:51:30,770: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b94d68>]}
2018-06-16 10:51:31,095: 10:51:31 | 17 of 27 OK created table model agency_data_pipeline.ga_stats........ [OK in 2.91s]
2018-06-16 10:51:31,096: 10:51:31 | 18 of 27 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-06-16 10:51:31,096: Compiling model.agency_data_pipeline.fb_ads_stats
2018-06-16 10:51:31,106: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-06-16 10:51:31,107: Acquiring new bigquery connection "fb_ads_stats".
2018-06-16 10:51:31,108: Re-using an available connection from the pool.
2018-06-16 10:51:31,230: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-06-16 10:51:31,231: Fetching data for query fb_ads_stats:
create or replace table `agency_data_pipeline`.`fb_ads_stats`
  
  as (
    with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) conversions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign
  );

    
2018-06-16 10:51:33,056: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c095c0>]}
2018-06-16 10:51:33,369: 10:51:33 | 18 of 27 OK created table model agency_data_pipeline.fb_ads_stats.... [OK in 1.96s]
2018-06-16 10:51:33,370: 10:51:33 | 19 of 27 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-06-16 10:51:33,370: Compiling model.agency_data_pipeline.agg_platforms_union
2018-06-16 10:51:33,378: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-06-16 10:51:33,382: Acquiring new bigquery connection "agg_platforms_union".
2018-06-16 10:51:33,382: Re-using an available connection from the pool.
2018-06-16 10:51:33,529: Writing runtime SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-06-16 10:51:33,530: Fetching data for query agg_platforms_union:
create or replace table `agency_data_pipeline`.`agg_platforms_union`
  
  as (
    SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`adwords_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`gsc_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`youtube_stats`
  );

    
2018-06-16 10:51:35,061: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b94d68>]}
2018-06-16 10:51:35,383: 10:51:35 | 19 of 27 OK created table model agency_data_pipeline.agg_platforms_union [OK in 1.69s]
2018-06-16 10:51:35,384: 10:51:35 | 20 of 27 START table model agency_data_pipeline.agg_platforms_site... [RUN]
2018-06-16 10:51:35,384: Compiling model.agency_data_pipeline.agg_platforms_site
2018-06-16 10:51:35,392: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_site"
2018-06-16 10:51:35,394: Acquiring new bigquery connection "agg_platforms_site".
2018-06-16 10:51:35,394: Re-using an available connection from the pool.
2018-06-16 10:51:35,521: Writing runtime SQL for node "model.agency_data_pipeline.agg_platforms_site"
2018-06-16 10:51:35,522: Fetching data for query agg_platforms_site:
create or replace table `agency_data_pipeline`.`agg_platforms_site`
  
  as (
    SELECT 
date, 
a.account account, 
b.site site,
a.platform platform,
a.channel channel,
url,
cost,
impressions,
clicks,
conversions
FROM 
  `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_union` a
LEFT JOIN 
  `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc` b
ON ( 
  a.account = b.account AND
  a.platform = b.platform
)
  );

    
2018-06-16 10:51:37,519: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c09ef0>]}
2018-06-16 10:51:37,838: 10:51:37 | 20 of 27 OK created table model agency_data_pipeline.agg_platforms_site [OK in 2.13s]
2018-06-16 10:51:37,839: 10:51:37 | 21 of 27 START table model agency_data_pipeline.agg_platforms_ga..... [RUN]
2018-06-16 10:51:37,839: Compiling model.agency_data_pipeline.agg_platforms_ga
2018-06-16 10:51:37,845: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_ga"
2018-06-16 10:51:37,847: Acquiring new bigquery connection "agg_platforms_ga".
2018-06-16 10:51:37,847: Re-using an available connection from the pool.
2018-06-16 10:51:37,986: Writing runtime SQL for node "model.agency_data_pipeline.agg_platforms_ga"
2018-06-16 10:51:37,987: Fetching data for query agg_platforms_ga:
create or replace table `agency_data_pipeline`.`agg_platforms_ga`
  
  as (
    with ga as (

	select 
		date, account, site, channel, platform, url,
		sessions, goal_completions,
		null as cost, null as impressions, null as clicks, null as conversions
	from `adp-apprenticeship`.`agency_data_pipeline`.`ga_stats`

),

platforms as (

	select 
		date, account, site, channel, platform, url,
		null as sessions, null as goal_completions,
		cost, impressions, clicks, conversions
	from `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_site`

)


SELECT
    date, 
    site,
    platform,
    channel, 
    url,
    sum(cost) cost,
	sum(impressions) impressions,
	sum(clicks) clicks,
	sum(conversions) conversions,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      platforms 
) 
GROUP BY
    date, site, platform, channel, url
  );

    
2018-06-16 10:51:39,794: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a86630>]}
2018-06-16 10:51:40,108: 10:51:40 | 21 of 27 OK created table model agency_data_pipeline.agg_platforms_ga [OK in 1.96s]
2018-06-16 10:51:40,108: 10:51:40 | 22 of 27 START table model agency_data_pipeline.platform_by_month.... [RUN]
2018-06-16 10:51:40,109: 10:51:40 | 23 of 27 START table model agency_data_pipeline.landing_page_by_month [RUN]
2018-06-16 10:51:40,109: Compiling model.agency_data_pipeline.platform_by_month
2018-06-16 10:51:40,109: Compiling model.agency_data_pipeline.landing_page_by_month
2018-06-16 10:51:40,116: Writing injected SQL for node "model.agency_data_pipeline.platform_by_month"
2018-06-16 10:51:40,122: Writing injected SQL for node "model.agency_data_pipeline.landing_page_by_month"
2018-06-16 10:51:40,126: Acquiring new bigquery connection "landing_page_by_month".
2018-06-16 10:51:40,127: Re-using an available connection from the pool.
2018-06-16 10:51:40,128: Acquiring new bigquery connection "platform_by_month".
2018-06-16 10:51:40,128: Re-using an available connection from the pool.
2018-06-16 10:51:40,264: Writing runtime SQL for node "model.agency_data_pipeline.landing_page_by_month"
2018-06-16 10:51:40,265: Fetching data for query landing_page_by_month:
create or replace table `agency_data_pipeline`.`landing_page_by_month`
  
  as (
    SELECT
yyyymm, 
site,
platform,
channel, 
url,
cost,
impressions,
clicks,
conversions,
sessions,
sum(sessions) OVER w1 total_sessions,
goal_completions,
sum(goal_completions) OVER w1 total_goal_completions
FROM (
    SELECT 
    FORMAT_DATE("%Y-%m", date) AS yyyymm,
    site,
    platform,
    channel, 
    url,
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) conversions,
    sum(sessions) sessions,
    sum(goal_completions) goal_completions
    FROM `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_ga`
    GROUP BY yyyymm, site, platform, channel, url
)
WINDOW w1 as (PARTITION BY yyyymm, site)
  );

    
2018-06-16 10:51:40,297: Writing runtime SQL for node "model.agency_data_pipeline.platform_by_month"
2018-06-16 10:51:40,298: Fetching data for query platform_by_month:
create or replace table `agency_data_pipeline`.`platform_by_month`
  
  as (
    SELECT
yyyymm, 
site,
platform,
channel, 
cost,
impressions,
clicks,
conversions,
sessions,
sum(sessions) OVER w1 total_sessions,
goal_completions,
sum(goal_completions) OVER w1 total_goal_completions
FROM (
    SELECT 
    FORMAT_DATE("%Y-%m", date) AS yyyymm,
    site,
    platform,
    channel, 
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) conversions,
    sum(sessions) sessions,
    sum(goal_completions) goal_completions
    FROM `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_ga`
    GROUP BY yyyymm, site, channel, platform
)
WINDOW w1 as (PARTITION BY yyyymm, site)
  );

    
2018-06-16 10:51:41,924: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e6a32e8>]}
2018-06-16 10:51:42,177: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111c09ef0>]}
2018-06-16 10:51:42,243: 10:51:42 | 23 of 27 OK created table model agency_data_pipeline.landing_page_by_month [OK in 1.82s]
2018-06-16 10:51:42,561: 10:51:42 | 22 of 27 OK created table model agency_data_pipeline.platform_by_month [OK in 2.07s]
2018-06-16 10:51:42,562: 10:51:42 | 24 of 27 START table model agency_data_pipeline.landing_page_index... [RUN]
2018-06-16 10:51:42,562: Compiling model.agency_data_pipeline.landing_page_index
2018-06-16 10:51:42,562: 10:51:42 | 25 of 27 START table model agency_data_pipeline.platform_index....... [RUN]
2018-06-16 10:51:42,566: Compiling model.agency_data_pipeline.platform_index
2018-06-16 10:51:42,569: Writing injected SQL for node "model.agency_data_pipeline.landing_page_index"
2018-06-16 10:51:42,576: Writing injected SQL for node "model.agency_data_pipeline.platform_index"
2018-06-16 10:51:42,578: Acquiring new bigquery connection "landing_page_index".
2018-06-16 10:51:42,578: Re-using an available connection from the pool.
2018-06-16 10:51:42,579: Acquiring new bigquery connection "platform_index".
2018-06-16 10:51:42,580: Re-using an available connection from the pool.
2018-06-16 10:51:42,716: Writing runtime SQL for node "model.agency_data_pipeline.landing_page_index"
2018-06-16 10:51:42,724: Fetching data for query landing_page_index:
create or replace table `agency_data_pipeline`.`landing_page_index`
  
  as (
    SELECT 
yyyymm, 
site,
platform,
channel, 
url,
cost,
impressions,
clicks,
conversions,
sessions,
pct_sessions,
goal_completions,
pct_goal_completions,
case when pct_sessions > 0 then pct_goal_completions / pct_sessions else null end as conversion_index
FROM (
    SELECT
    yyyymm, 
    site,
    platform,
    channel, 
    url,
    cost,
    impressions,
    clicks,
    conversions,
    sessions,
    case when total_sessions > 0 then sessions / total_sessions else null end as pct_sessions,
    goal_completions,
    case when total_goal_completions > 0 then goal_completions / total_goal_completions else null end as pct_goal_completions
    FROM `adp-apprenticeship`.`agency_data_pipeline`.`landing_page_by_month`
)
  );

    
2018-06-16 10:51:42,741: Writing runtime SQL for node "model.agency_data_pipeline.platform_index"
2018-06-16 10:51:42,742: Fetching data for query platform_index:
create or replace table `agency_data_pipeline`.`platform_index`
  
  as (
    SELECT 
yyyymm, 
site,
platform,
channel, 
cost,
impressions,
clicks,
conversions,
sessions,
pct_sessions,
goal_completions,
pct_goal_completions,
case when pct_sessions > 0 then pct_goal_completions / pct_sessions else null end as conversion_index
FROM (
    SELECT
    yyyymm, 
    site,
    platform,
    channel, 
    cost,
    impressions,
    clicks,
    conversions,
    sessions,
    case when total_sessions > 0 then sessions / total_sessions else null end as pct_sessions,
    goal_completions,
    case when total_goal_completions > 0 then goal_completions / total_goal_completions else null end as pct_goal_completions
    FROM `adp-apprenticeship`.`agency_data_pipeline`.`platform_by_month`
)
  );

    
2018-06-16 10:51:44,251: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a86630>]}
2018-06-16 10:51:44,258: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111b94fd0>]}
2018-06-16 10:51:44,567: 10:51:44 | 24 of 27 OK created table model agency_data_pipeline.landing_page_index [OK in 1.69s]
2018-06-16 10:51:44,878: 10:51:44 | 25 of 27 OK created table model agency_data_pipeline.platform_index.. [OK in 1.69s]
2018-06-16 10:51:44,878: 10:51:44 | 26 of 27 START table model agency_data_pipeline.landing_page_viz..... [RUN]
2018-06-16 10:51:44,879: Compiling model.agency_data_pipeline.landing_page_viz
2018-06-16 10:51:44,879: 10:51:44 | 27 of 27 START table model agency_data_pipeline.platform_viz......... [RUN]
2018-06-16 10:51:44,885: Writing injected SQL for node "model.agency_data_pipeline.landing_page_viz"
2018-06-16 10:51:44,885: Compiling model.agency_data_pipeline.platform_viz
2018-06-16 10:51:44,895: Writing injected SQL for node "model.agency_data_pipeline.platform_viz"
2018-06-16 10:51:44,899: Acquiring new bigquery connection "landing_page_viz".
2018-06-16 10:51:44,899: Re-using an available connection from the pool.
2018-06-16 10:51:44,904: Acquiring new bigquery connection "platform_viz".
2018-06-16 10:51:44,905: Re-using an available connection from the pool.
2018-06-16 10:51:45,046: Writing runtime SQL for node "model.agency_data_pipeline.landing_page_viz"
2018-06-16 10:51:45,069: Writing runtime SQL for node "model.agency_data_pipeline.platform_viz"
2018-06-16 10:51:45,073: Fetching data for query platform_viz:
create or replace table `agency_data_pipeline`.`platform_viz`
  
  as (
    SELECT 
yyyymm Month, 
site Site,
platform Platform,
channel Channel, 
ifnull(cost, 0) Cost,
ifnull(impressions, 0) Impressions,
ifnull(clicks, 0) Clicks,
ifnull(conversions, 0) Conversions,
ifnull(sessions, 0) Sessions,
ifnull(pct_sessions, 0) PctSessions,
ifnull(goal_completions, 0) GoalCompletions,
ifnull(pct_goal_completions, 0) PctGoalCompletions,
ifnull(conversion_index, 0) ConversionIndex
FROM `adp-apprenticeship`.`agency_data_pipeline`.`platform_index`
WHERE yyyymm >= '2017-06'
  );

    
2018-06-16 10:51:45,074: Fetching data for query landing_page_viz:
create or replace table `agency_data_pipeline`.`landing_page_viz`
  
  as (
    SELECT 
yyyymm Month, 
site Site,
platform Platform,
channel Channel, 
url URL,
ifnull(cost, 0) Cost,
ifnull(impressions, 0) Impressions,
ifnull(clicks, 0) Clicks,
ifnull(conversions, 0) Conversions,
ifnull(sessions, 0) Sessions,
ifnull(pct_sessions, 0) PctSessions,
ifnull(goal_completions, 0) GoalCompletions,
ifnull(pct_goal_completions, 0) PctGoalCompletions,
ifnull(conversion_index, 0) ConversionIndex
FROM `adp-apprenticeship`.`agency_data_pipeline`.`landing_page_index`
  );

    
2018-06-16 10:51:46,642: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e6ac0b8>]}
2018-06-16 10:51:46,891: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3a2fa0cf-6ada-4710-979e-c2a2e5c126d6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e6ac320>]}
2018-06-16 10:51:46,956: 10:51:46 | 26 of 27 OK created table model agency_data_pipeline.landing_page_viz [OK in 1.76s]
2018-06-16 10:51:47,271: 10:51:47 | 27 of 27 OK created table model agency_data_pipeline.platform_viz.... [OK in 2.01s]
2018-06-16 10:51:47,343: 10:51:47 | 
2018-06-16 10:51:47,343: 10:51:47 | Finished running 27 table models in 91.99s.
2018-06-16 10:51:47,344: Connection 'master' was left open.
2018-06-16 10:51:47,344: 
2018-06-16 10:51:47,344: Completed successfully
2018-06-16 10:51:47,344: 
Done. PASS=27 ERROR=0 SKIP=0 TOTAL=27
2018-06-16 10:51:47,345: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111981a90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a45780>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a45a58>]}
2018-06-16 10:51:47,657: Flushing usage events
2018-06-16 10:51:47,712: sys:1: ResourceWarning: unclosed <socket.socket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 55994), raddr=('172.217.1.202', 443)>

2018-06-16 10:51:47,713: sys:1: ResourceWarning: unclosed <socket.socket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 55992), raddr=('172.217.12.13', 443)>

2018-06-16 10:51:47,713: sys:1: ResourceWarning: unclosed <socket.socket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 56001), raddr=('172.217.11.234', 443)>

2018-06-16 10:51:47,714: sys:1: ResourceWarning: unclosed <socket.socket fd=20, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 56002), raddr=('172.217.11.234', 443)>

2018-06-16 10:51:47,714: sys:1: ResourceWarning: unclosed <socket.socket fd=18, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 56000), raddr=('172.217.11.234', 443)>

2018-06-16 10:51:47,714: sys:1: ResourceWarning: unclosed <socket.socket fd=17, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 55999), raddr=('172.217.11.234', 443)>

2018-06-16 10:51:47,715: sys:1: ResourceWarning: unclosed <socket.socket fd=14, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 55996), raddr=('172.217.12.13', 443)>

2018-06-16 10:51:47,715: sys:1: ResourceWarning: unclosed <socket.socket fd=15, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 55997), raddr=('172.217.12.13', 443)>

2018-06-16 10:51:47,715: sys:1: ResourceWarning: unclosed <socket.socket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 55995), raddr=('172.217.12.13', 443)>

2018-06-16 10:51:47,715: sys:1: ResourceWarning: unclosed <socket.socket fd=16, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 55998), raddr=('172.217.12.13', 443)>

2018-06-16 11:10:48,674: Tracking: tracking
2018-06-16 11:10:48,677: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109cdb4a8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109cdbf98>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109cdbd68>]}
2018-06-16 11:10:49,737: Loading dependency project from /usr/local/Cellar/dbt/0.10.1/libexec/lib/python3.6/site-packages/dbt/include
2018-06-16 11:10:49,787: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/agency-data-pipeline/dbt_modules
2018-06-16 11:10:49,793: Parsing get_column_values.sql
2018-06-16 11:10:49,818: Parsing core.sql
2018-06-16 11:10:49,832: Parsing adapters/bigquery.sql
2018-06-16 11:10:49,841: Parsing adapters/common.sql
2018-06-16 11:10:49,870: Parsing adapters/redshift.sql
2018-06-16 11:10:49,903: Parsing adapters/snowflake.sql
2018-06-16 11:10:49,911: Parsing etc/bigquery.sql
2018-06-16 11:10:49,917: Parsing etc/datetime.sql
2018-06-16 11:10:49,948: Parsing etc/get_custom_schema.sql
2018-06-16 11:10:49,956: Parsing materializations/helpers.sql
2018-06-16 11:10:49,984: Parsing materializations/archive/archive.sql
2018-06-16 11:10:50,044: Parsing materializations/incremental/incremental.sql
2018-06-16 11:10:50,083: Parsing materializations/seed/bigquery.sql
2018-06-16 11:10:50,096: Parsing materializations/seed/seed.sql
2018-06-16 11:10:50,143: Parsing materializations/table/bigquery_table.sql
2018-06-16 11:10:50,184: Parsing materializations/table/table.sql
2018-06-16 11:10:50,218: Parsing materializations/view/bigquery_view.sql
2018-06-16 11:10:50,241: Parsing materializations/view/view.sql
2018-06-16 11:10:50,272: Parsing schema_tests/accepted_values.sql
2018-06-16 11:10:50,278: Parsing schema_tests/not_null.sql
2018-06-16 11:10:50,282: Parsing schema_tests/relationships.sql
2018-06-16 11:10:50,287: Parsing schema_tests/unique.sql
2018-06-16 11:10:50,349: Parsing model.agency_data_pipeline.accounts_proc
2018-06-16 11:10:50,354: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-06-16 11:10:50,357: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-06-16 11:10:50,359: Parsing model.agency_data_pipeline.adwords_campaigns
2018-06-16 11:10:50,362: Parsing model.agency_data_pipeline.adwords_join
2018-06-16 11:10:50,368: Parsing model.agency_data_pipeline.adwords_stats
2018-06-16 11:10:50,372: Parsing model.agency_data_pipeline.adwords_urls
2018-06-16 11:10:50,375: Parsing model.agency_data_pipeline.fb_adcreative
2018-06-16 11:10:50,381: Parsing model.agency_data_pipeline.fb_ads
2018-06-16 11:10:50,387: Parsing model.agency_data_pipeline.fb_ads_insights
2018-06-16 11:10:50,393: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-16 11:10:50,406: Parsing model.agency_data_pipeline.fb_ads_stats
2018-06-16 11:10:50,410: Parsing model.agency_data_pipeline.fb_conversions
2018-06-16 11:10:50,413: Parsing model.agency_data_pipeline.ga_conversions
2018-06-16 11:10:50,415: Parsing model.agency_data_pipeline.ga_proc
2018-06-16 11:10:50,441: Parsing model.agency_data_pipeline.ga_stats
2018-06-16 11:10:50,447: Parsing model.agency_data_pipeline.gsc_stats
2018-06-16 11:10:50,450: Parsing model.agency_data_pipeline.youtube_stats
2018-06-16 11:10:50,455: Parsing model.agency_data_pipeline.agg_platforms_ga
2018-06-16 11:10:50,459: Parsing model.agency_data_pipeline.agg_platforms_site
2018-06-16 11:10:50,463: Parsing model.agency_data_pipeline.agg_platforms_union
2018-06-16 11:10:50,469: Parsing model.agency_data_pipeline.landing_page_by_month
2018-06-16 11:10:50,472: Parsing model.agency_data_pipeline.landing_page_index
2018-06-16 11:10:50,480: Parsing model.agency_data_pipeline.platform_by_month
2018-06-16 11:10:50,485: Parsing model.agency_data_pipeline.platform_index
2018-06-16 11:10:50,488: Parsing model.agency_data_pipeline.landing_page_viz
2018-06-16 11:10:50,492: Parsing model.agency_data_pipeline.platform_viz
2018-06-16 11:10:50,513: Found 27 models, 0 tests, 0 archives, 0 analyses, 57 macros, 0 operations, 0 seed files
2018-06-16 11:10:50,523: 
2018-06-16 11:10:50,538: Acquiring new bigquery connection "master".
2018-06-16 11:10:50,538: Opening a new connection (0 currently allocated)
2018-06-16 11:10:52,034: 11:10:52 | Concurrency: 4 threads (target='dev')
2018-06-16 11:10:52,034: 11:10:52 | 
2018-06-16 11:10:52,122: 11:10:52 | 1 of 27 START table model agency_data_pipeline.gsc_stats............. [RUN]
2018-06-16 11:10:52,123: Compiling model.agency_data_pipeline.gsc_stats
2018-06-16 11:10:52,128: Writing injected SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-16 11:10:52,122: 11:10:52 | 2 of 27 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-06-16 11:10:52,122: 11:10:52 | 3 of 27 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-06-16 11:10:52,128: Compiling model.agency_data_pipeline.adwords_urls
2018-06-16 11:10:52,123: 11:10:52 | 4 of 27 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-06-16 11:10:52,128: Compiling model.agency_data_pipeline.adwords_campaigns
2018-06-16 11:10:52,133: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-16 11:10:52,133: Compiling model.agency_data_pipeline.accounts_proc
2018-06-16 11:10:52,138: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-16 11:10:52,145: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-16 11:10:52,147: Acquiring new bigquery connection "gsc_stats".
2018-06-16 11:10:52,147: Opening a new connection (1 currently allocated)
2018-06-16 11:10:52,157: Acquiring new bigquery connection "accounts_proc".
2018-06-16 11:10:52,157: Opening a new connection (2 currently allocated)
2018-06-16 11:10:52,164: Acquiring new bigquery connection "adwords_urls".
2018-06-16 11:10:52,164: Opening a new connection (3 currently allocated)
2018-06-16 11:10:52,168: Acquiring new bigquery connection "adwords_campaigns".
2018-06-16 11:10:52,169: Opening a new connection (4 currently allocated)
2018-06-16 11:10:52,693: Writing runtime SQL for node "model.agency_data_pipeline.accounts_proc"
2018-06-16 11:10:52,721: Writing runtime SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-06-16 11:10:52,721: Fetching data for query accounts_proc:
create or replace table `agency_data_pipeline`.`accounts_proc`
  
  as (
    SELECT
site,
bigquery_name,
account,
platform
FROM  (
 
	SELECT  
	site,
	bigquery_name,
	account,
	platform,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.accounts`
) 

WHERE lv = time_of_entry
  );

    
2018-06-16 11:10:52,725: Writing runtime SQL for node "model.agency_data_pipeline.gsc_stats"
2018-06-16 11:10:52,730: Fetching data for query adwords_campaigns:
create or replace table `agency_data_pipeline`.`adwords_campaigns`
  
  as (
    SELECT
day,
campaignid,
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM
( 
	SELECT  
	'Paid' as channel,
	'Adwords' as platform,
	day,
	campaignid,
	campaign,
	account as account,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	conversions,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `adp-apprenticeship.adwords.CAMPAIGN_PERFORMANCE_REPORT`
)
WHERE lv = _sdc_sequence
GROUP BY day, campaignid, account, channel, platform, campaign
  );

    
2018-06-16 11:10:52,731: Fetching data for query gsc_stats:
create or replace table `agency_data_pipeline`.`gsc_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
0 as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
0 as conversions
FROM 
  ( 
	SELECT  
	date, 
	site as account,
	'Organic' as channel,
	'Organic' as platform,
	lower(trim(regexp_replace(replace(replace(replace(replace(landing_page_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
	max(impressions) as impressions, 
	max(clicks) as clicks
	FROM `adp-apprenticeship.agency_data_pipeline.gsc`
	GROUP BY date, account, channel, platform, url
  ) 
GROUP BY date, account, channel, platform, url
ORDER BY account asc, date asc, url asc
  );

    
2018-06-16 11:10:52,803: Writing runtime SQL for node "model.agency_data_pipeline.adwords_urls"
2018-06-16 11:10:52,804: Fetching data for query adwords_urls:
create or replace table `agency_data_pipeline`.`adwords_urls`
  
  as (
    SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url
FROM 
(
	SELECT  
	campaignid,
	max(finalurl) finalurl
	FROM `adp-apprenticeship.adwords.FINAL_URL_REPORT`
	GROUP BY campaignid
)
  );

    
2018-06-16 11:10:54,420: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e10d30>]}
2018-06-16 11:10:54,684: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e10278>]}
2018-06-16 11:10:54,723: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e10828>]}
2018-06-16 11:10:54,755: 11:10:54 | 4 of 27 OK created table model agency_data_pipeline.accounts_proc.... [OK in 2.29s]
2018-06-16 11:10:54,757: 11:10:54 | 5 of 27 START table model agency_data_pipeline.mappings_ga_proc...... [RUN]
2018-06-16 11:10:54,760: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-06-16 11:10:54,772: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-16 11:10:54,774: Acquiring new bigquery connection "mappings_ga_proc".
2018-06-16 11:10:54,774: Re-using an available connection from the pool.
2018-06-16 11:10:54,921: Writing runtime SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-06-16 11:10:54,921: Fetching data for query mappings_ga_proc:
create or replace table `agency_data_pipeline`.`mappings_ga_proc`
  
  as (
    SELECT
site,
account,
bigquery_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
FROM  ( 

	SELECT  
	site,
	account,
	bigquery_name,
	source,
	medium,
	platform as platform_n,
	channel as channel_n,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY site ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
group by site, account, bigquery_name, source, medium, platform_n, channel_n, time_of_entry
  );

    
2018-06-16 11:10:55,003: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e105c0>]}
2018-06-16 11:10:55,096: 11:10:55 | 2 of 27 OK created table model agency_data_pipeline.adwords_urls..... [OK in 2.56s]
2018-06-16 11:10:55,098: 11:10:55 | 6 of 27 START table model agency_data_pipeline.youtube_stats......... [RUN]
2018-06-16 11:10:55,099: Compiling model.agency_data_pipeline.youtube_stats
2018-06-16 11:10:55,105: Writing injected SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-16 11:10:55,106: Acquiring new bigquery connection "youtube_stats".
2018-06-16 11:10:55,106: Re-using an available connection from the pool.
2018-06-16 11:10:55,247: Writing runtime SQL for node "model.agency_data_pipeline.youtube_stats"
2018-06-16 11:10:55,248: Fetching data for query youtube_stats:
create or replace table `agency_data_pipeline`.`youtube_stats`
  
  as (
    SELECT
date, 
account, 
channel,
platform,
url,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
FROM 
  ( 
	SELECT  
	date, 
	'Social' as channel,
	'YouTube' as platform,
	'Coding is for Losers' as account,  
	0 as cost, 
	max(views) as impressions, 
	max(clicks) as clicks, 
	max(subscribers) as conversions,
	regexp_replace(regexp_replace(replace(replace(replace(landing_page_url,'http://',''),'https://',''),'.html',''),r'\?.*$',''),r'([/]$)','') as url,
	video_url
	FROM `adp-apprenticeship.agency_data_pipeline.youtube`
	group by channel, platform, account, date, video_url, url
  ) 
GROUP BY date, account, channel, platform, url
  );

    
2018-06-16 11:10:55,433: 11:10:55 | 1 of 27 OK created table model agency_data_pipeline.gsc_stats........ [OK in 2.60s]
2018-06-16 11:10:55,434: 11:10:55 | 7 of 27 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-06-16 11:10:55,434: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-06-16 11:10:55,449: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-16 11:10:55,452: Acquiring new bigquery connection "conversion_goals_proc".
2018-06-16 11:10:55,452: Re-using an available connection from the pool.
2018-06-16 11:10:55,593: Writing runtime SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-06-16 11:10:55,594: Fetching data for query conversion_goals_proc:
create or replace table `agency_data_pipeline`.`conversion_goals_proc`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
FROM  ( 

	SELECT  
	site,
	bigquery_name,
	platform,
	trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
	goal_type,
	account,
	time_of_entry,
	first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
	FROM `adp-apprenticeship.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by site, bigquery_name, platform, account, goal_name
  );

    
2018-06-16 11:10:55,778: 11:10:55 | 3 of 27 OK created table model agency_data_pipeline.adwords_campaigns [OK in 2.87s]
2018-06-16 11:10:57,084: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e4c630>]}
2018-06-16 11:10:57,105: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e10d30>]}
2018-06-16 11:10:57,419: 11:10:57 | 6 of 27 OK created table model agency_data_pipeline.youtube_stats.... [OK in 1.99s]
2018-06-16 11:10:57,641: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e10828>]}
2018-06-16 11:10:57,753: 11:10:57 | 5 of 27 OK created table model agency_data_pipeline.mappings_ga_proc. [OK in 2.35s]
2018-06-16 11:10:58,085: 11:10:58 | 7 of 27 OK created table model agency_data_pipeline.conversion_goals_proc [OK in 2.21s]
2018-06-16 11:10:58,086: 11:10:58 | 8 of 27 START table model agency_data_pipeline.fb_conversions........ [RUN]
2018-06-16 11:10:58,086: 11:10:58 | 9 of 27 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-06-16 11:10:58,087: 11:10:58 | 10 of 27 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-06-16 11:10:58,087: 11:10:58 | 11 of 27 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-06-16 11:10:58,087: Compiling model.agency_data_pipeline.fb_conversions
2018-06-16 11:10:58,088: Compiling model.agency_data_pipeline.ga_conversions
2018-06-16 11:10:58,088: Compiling model.agency_data_pipeline.fb_ads_insights
2018-06-16 11:10:58,088: Compiling model.agency_data_pipeline.fb_adcreative
2018-06-16 11:10:58,104: Writing injected SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-16 11:10:58,125: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-16 11:10:58,129: Acquiring new bigquery connection "fb_adcreative".
2018-06-16 11:10:58,131: Acquiring new bigquery connection "fb_ads_insights".
2018-06-16 11:10:58,131: Re-using an available connection from the pool.
2018-06-16 11:10:58,133: Acquiring new bigquery connection "fb_conversions".
2018-06-16 11:10:58,133: Fetching data for query fb_adcreative:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-16 11:10:58,133: Re-using an available connection from the pool.
2018-06-16 11:10:58,135: Acquiring new bigquery connection "ga_conversions".
2018-06-16 11:10:58,135: Fetching data for query fb_ads_insights:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-16 11:10:58,137: Re-using an available connection from the pool.
2018-06-16 11:10:58,140: Re-using an available connection from the pool.
2018-06-16 11:10:58,285: Writing runtime SQL for node "model.agency_data_pipeline.fb_conversions"
2018-06-16 11:10:58,308: Writing runtime SQL for node "model.agency_data_pipeline.ga_conversions"
2018-06-16 11:10:58,309: Fetching data for query fb_conversions:
create or replace table `agency_data_pipeline`.`fb_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'FB Ads'
  );

    
2018-06-16 11:10:58,312: Fetching data for query ga_conversions:
create or replace table `agency_data_pipeline`.`ga_conversions`
  
  as (
    SELECT 
site,
bigquery_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
FROM `adp-apprenticeship`.`agency_data_pipeline`.`conversion_goals_proc`
WHERE platform = 'Google Analytics'
  );

    
2018-06-16 11:10:59,702: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-16 11:10:59,828: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-16 11:10:59,844: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-06-16 11:10:59,850: Fetching data for query fb_ads_insights:
create or replace table `agency_data_pipeline`.`fb_ads_insights`
  
  as (
    



with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


  );

    
2018-06-16 11:11:00,005: Writing runtime SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-06-16 11:11:00,005: Fetching data for query fb_adcreative:
create or replace table `agency_data_pipeline`.`fb_adcreative`
  
  as (
    



with fb_adcreative as (


	    
		   	SELECT 
			id,
			link_url object_url,
			url_tags,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


  );

    
2018-06-16 11:11:00,247: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e4cda0>]}
2018-06-16 11:11:00,449: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e10eb8>]}
2018-06-16 11:11:00,588: 11:11:00 | 8 of 27 OK created table model agency_data_pipeline.fb_conversions... [OK in 2.16s]
2018-06-16 11:11:00,926: 11:11:00 | 9 of 27 OK created table model agency_data_pipeline.ga_conversions... [OK in 2.36s]
2018-06-16 11:11:01,899: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e8bef0>]}
2018-06-16 11:11:02,233: 11:11:02 | 11 of 27 OK created table model agency_data_pipeline.fb_adcreative... [OK in 3.81s]
2018-06-16 11:11:02,546: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e10d30>]}
2018-06-16 11:11:02,885: 11:11:02 | 10 of 27 OK created table model agency_data_pipeline.fb_ads_insights. [OK in 4.46s]
2018-06-16 11:11:02,886: 11:11:02 | 12 of 27 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-06-16 11:11:02,887: Compiling model.agency_data_pipeline.fb_ads
2018-06-16 11:11:02,887: 11:11:02 | 13 of 27 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-06-16 11:11:02,893: Compiling model.agency_data_pipeline.adwords_join
2018-06-16 11:11:02,901: Acquiring new bigquery connection "fb_ads".
2018-06-16 11:11:02,901: Re-using an available connection from the pool.
2018-06-16 11:11:02,902: Fetching data for query fb_ads:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-16 11:11:02,912: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-16 11:11:02,915: Acquiring new bigquery connection "adwords_join".
2018-06-16 11:11:02,915: Re-using an available connection from the pool.
2018-06-16 11:11:03,071: Writing runtime SQL for node "model.agency_data_pipeline.adwords_join"
2018-06-16 11:11:03,072: Fetching data for query adwords_join:
create or replace table `agency_data_pipeline`.`adwords_join`
  
  as (
    SELECT
day,
a.campaign,
a.campaignid, 
account, 
channel,
platform,
b.url,
cost,
impressions,
clicks,
conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_campaigns` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`adwords_urls` b
ON a.campaignid = b.campaignid
  );

    
2018-06-16 11:11:03,621: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-16 11:11:03,763: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads"
2018-06-16 11:11:03,764: Fetching data for query fb_ads:
create or replace table `agency_data_pipeline`.`fb_ads`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `adp-apprenticeship.fb_ads_cifl.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


  );

    
2018-06-16 11:11:05,178: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106ae3ba8>]}
2018-06-16 11:11:05,519: 11:11:05 | 13 of 27 OK created table model agency_data_pipeline.adwords_join.... [OK in 2.29s]
2018-06-16 11:11:05,827: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ef4550>]}
2018-06-16 11:11:06,162: 11:11:06 | 12 of 27 OK created table model agency_data_pipeline.fb_ads.......... [OK in 2.94s]
2018-06-16 11:11:06,163: 11:11:06 | 14 of 27 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-06-16 11:11:06,163: 11:11:06 | 15 of 27 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-06-16 11:11:06,164: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-06-16 11:11:06,164: 11:11:06 | 16 of 27 START table model agency_data_pipeline.ga_proc.............. [RUN]
2018-06-16 11:11:06,164: Compiling model.agency_data_pipeline.adwords_stats
2018-06-16 11:11:06,171: Compiling model.agency_data_pipeline.ga_proc
2018-06-16 11:11:06,184: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-16 11:11:06,198: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-06-16 11:11:06,209: Acquiring new bigquery connection "ga_proc".
2018-06-16 11:11:06,209: Re-using an available connection from the pool.
2018-06-16 11:11:06,209: Fetching data for query fb_ads_insights_conversions:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-16 11:11:06,209: Re-using an available connection from the pool.
2018-06-16 11:11:06,210: Fetching data for query ga_proc:


        select
            bigquery_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc`
        where bigquery_name is not null
        and bigquery_name != ''

        
        ##where 1 = 1
        and platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-16 11:11:06,216: Acquiring new bigquery connection "adwords_stats".
2018-06-16 11:11:06,218: Re-using an available connection from the pool.
2018-06-16 11:11:06,339: Writing runtime SQL for node "model.agency_data_pipeline.adwords_stats"
2018-06-16 11:11:06,340: Fetching data for query adwords_stats:
create or replace table `agency_data_pipeline`.`adwords_stats`
  
  as (
    SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(conversions) conversions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`adwords_join`
GROUP BY date, account, platform, channel, url, campaign
  );

    
2018-06-16 11:11:06,937: Fetching data for query fb_ads_insights_conversions:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`
        where goal_name is not null
        and goal_name != ''

        
        ##where 1 = 1
        and goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-16 11:11:07,962: Fetching data for query ga_proc:


        select
            goal_name as value

        from `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`
        where goal_name is not null
        and goal_name != ''

        
        ##where 1 = 1
        and goal_type = 'Signup'
        
        
        
        ##and 2 = 2
        and bigquery_name = 'cifl'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-06-16 11:11:08,362: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-06-16 11:11:08,507: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-06-16 11:11:08,508: Fetching data for query fb_ads_insights_conversions:
create or replace table `agency_data_pipeline`.`fb_ads_insights_conversions`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`fb_conversions`





with fb_ads_insights_conversions as (

	    

	    	

		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			_sdc_sequence,
			action_type,
			_28d_click conversions,
			null as revenue
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
			cross join unnest(actions)

			## goal completion columns
			
				where action_type in (
				
					'offsite_conversion.fb_pixel_lead'
					 
				
				)
			
			
			UNION ALL

		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			_sdc_sequence,
			action_type,
			null as conversions,
			_28d_click as revenue
			FROM `adp-apprenticeship.fb_ads_cifl.ads_insights`
			cross join unnest(action_values)
			
			## goal completion columns
			
				where action_type in (
				
					'offsite_conversion.fb_pixel_lead'
					 
				
				)
			

		    
	   

)

SELECT 
date,
campaign_id,
campaign,
ad_id,
account,
sum(conversions) conversions,
sum(revenue) revenue
FROM 
		(
	    SELECT
	    date_start date,
	    campaign_id,
	    campaign_name campaign,
	    ad_id,
	    account_name account,
	    action_type,
	    conversions,
	    revenue,
	    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
	    _sdc_sequence
	    FROM fb_ads_insights_conversions
	   	)
where lv = _sdc_sequence
group by date, campaign_id, campaign, ad_id, account



  );

    
2018-06-16 11:11:09,390: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109f31b00>]}
2018-06-16 11:11:09,638: Writing injected SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-16 11:11:09,733: 11:11:09 | 15 of 27 OK created table model agency_data_pipeline.adwords_stats... [OK in 3.23s]
2018-06-16 11:11:09,772: Writing runtime SQL for node "model.agency_data_pipeline.ga_proc"
2018-06-16 11:11:09,773: Fetching data for query ga_proc:
create or replace table `agency_data_pipeline`.`ga_proc`
  
  as (
    -- depends_on: `adp-apprenticeship`.`agency_data_pipeline`.`ga_conversions`




with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'cifl' as bigquery_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			sessions,
			## goal completion columns
			
				
					cast(goal1completions as int64) 
					 
					 as goal_completions,  
				
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium ORDER BY _sdc_sequence DESC) lv
			FROM `adp-apprenticeship.ga_cifl.report` 

		    
	   

)


SELECT 
bigquery_name,
lookup_platform,
date,
url,
source,
medium,
sum(sessions) sessions,
sum(goal_completions) goal_completions
FROM ga_report
where lv = _sdc_sequence
group by bigquery_name, lookup_platform, date, url, source, medium


  );

    
2018-06-16 11:11:10,305: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e10d30>]}
2018-06-16 11:11:10,630: 11:11:10 | 14 of 27 OK created table model agency_data_pipeline.fb_ads_insights_conversions [OK in 4.14s]
2018-06-16 11:11:12,523: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106adbe80>]}
2018-06-16 11:11:12,856: 11:11:12 | 16 of 27 OK created table model agency_data_pipeline.ga_proc......... [OK in 6.35s]
2018-06-16 11:11:12,857: 11:11:12 | 17 of 27 START table model agency_data_pipeline.ga_stats............. [RUN]
2018-06-16 11:11:12,857: Compiling model.agency_data_pipeline.ga_stats
2018-06-16 11:11:12,871: Writing injected SQL for node "model.agency_data_pipeline.ga_stats"
2018-06-16 11:11:12,875: Acquiring new bigquery connection "ga_stats".
2018-06-16 11:11:12,875: Re-using an available connection from the pool.
2018-06-16 11:11:13,038: Writing runtime SQL for node "model.agency_data_pipeline.ga_stats"
2018-06-16 11:11:13,039: Fetching data for query ga_stats:
create or replace table `agency_data_pipeline`.`ga_stats`
  
  as (
    SELECT  
cast(date as date) date,
b.account,
b.site site,
c.source source,
c.medium medium,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
url,
sum(sessions) sessions,
sum(goal_completions) goal_completions
FROM `adp-apprenticeship`.`agency_data_pipeline`.`ga_proc` a
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.bigquery_name = b.bigquery_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `adp-apprenticeship`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.bigquery_name = c.bigquery_name )
GROUP BY date, account, site, source, medium, source_medium, platform, channel, url
  );

    
2018-06-16 11:11:16,009: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ef4550>]}
2018-06-16 11:11:16,350: 11:11:16 | 17 of 27 OK created table model agency_data_pipeline.ga_stats........ [OK in 3.15s]
2018-06-16 11:11:16,352: 11:11:16 | 18 of 27 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-06-16 11:11:16,352: Compiling model.agency_data_pipeline.fb_ads_stats
2018-06-16 11:11:16,365: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-06-16 11:11:16,368: Acquiring new bigquery connection "fb_ads_stats".
2018-06-16 11:11:16,368: Re-using an available connection from the pool.
2018-06-16 11:11:16,514: Writing runtime SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-06-16 11:11:16,515: Fetching data for query fb_ads_stats:
create or replace table `agency_data_pipeline`.`fb_ads_stats`
  
  as (
    with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `adp-apprenticeship`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) conversions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign
  );

    
2018-06-16 11:11:18,916: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e10d30>]}
2018-06-16 11:11:19,254: 11:11:19 | 18 of 27 OK created table model agency_data_pipeline.fb_ads_stats.... [OK in 2.56s]
2018-06-16 11:11:19,254: 11:11:19 | 19 of 27 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-06-16 11:11:19,255: Compiling model.agency_data_pipeline.agg_platforms_union
2018-06-16 11:11:19,270: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-06-16 11:11:19,275: Acquiring new bigquery connection "agg_platforms_union".
2018-06-16 11:11:19,275: Re-using an available connection from the pool.
2018-06-16 11:11:19,482: Writing runtime SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-06-16 11:11:19,483: Fetching data for query agg_platforms_union:
create or replace table `agency_data_pipeline`.`agg_platforms_union`
  
  as (
    SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`adwords_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`fb_ads_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`gsc_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
cost,
impressions,
clicks,
conversions
FROM 
`adp-apprenticeship`.`agency_data_pipeline`.`youtube_stats`
  );

    
2018-06-16 11:11:21,374: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ef4550>]}
2018-06-16 11:11:21,712: 11:11:21 | 19 of 27 OK created table model agency_data_pipeline.agg_platforms_union [OK in 2.12s]
2018-06-16 11:11:21,713: 11:11:21 | 20 of 27 START table model agency_data_pipeline.agg_platforms_site... [RUN]
2018-06-16 11:11:21,713: Compiling model.agency_data_pipeline.agg_platforms_site
2018-06-16 11:11:21,723: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_site"
2018-06-16 11:11:21,724: Acquiring new bigquery connection "agg_platforms_site".
2018-06-16 11:11:21,725: Re-using an available connection from the pool.
2018-06-16 11:11:21,857: Writing runtime SQL for node "model.agency_data_pipeline.agg_platforms_site"
2018-06-16 11:11:21,858: Fetching data for query agg_platforms_site:
create or replace table `agency_data_pipeline`.`agg_platforms_site`
  
  as (
    SELECT 
date, 
a.account account, 
b.site site,
a.platform platform,
a.channel channel,
url,
cost,
impressions,
clicks,
conversions
FROM 
  `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_union` a
LEFT JOIN 
  `adp-apprenticeship`.`agency_data_pipeline`.`accounts_proc` b
ON ( 
  a.account = b.account AND
  a.platform = b.platform
)
  );

    
2018-06-16 11:11:23,833: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e10d30>]}
2018-06-16 11:11:24,170: 11:11:24 | 20 of 27 OK created table model agency_data_pipeline.agg_platforms_site [OK in 2.12s]
2018-06-16 11:11:24,172: 11:11:24 | 21 of 27 START table model agency_data_pipeline.agg_platforms_ga..... [RUN]
2018-06-16 11:11:24,172: Compiling model.agency_data_pipeline.agg_platforms_ga
2018-06-16 11:11:24,181: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_ga"
2018-06-16 11:11:24,182: Acquiring new bigquery connection "agg_platforms_ga".
2018-06-16 11:11:24,183: Re-using an available connection from the pool.
2018-06-16 11:11:24,312: Writing runtime SQL for node "model.agency_data_pipeline.agg_platforms_ga"
2018-06-16 11:11:24,313: Fetching data for query agg_platforms_ga:
create or replace table `agency_data_pipeline`.`agg_platforms_ga`
  
  as (
    with ga as (

	select 
		date, account, site, channel, platform, url,
		sessions, goal_completions,
		null as cost, null as impressions, null as clicks, null as conversions
	from `adp-apprenticeship`.`agency_data_pipeline`.`ga_stats`

),

platforms as (

	select 
		date, account, site, channel, platform, url,
		null as sessions, null as goal_completions,
		cost, impressions, clicks, conversions
	from `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_site`

)


SELECT
    date, 
    site,
    platform,
    channel, 
    url,
    sum(cost) cost,
	sum(impressions) impressions,
	sum(clicks) clicks,
	sum(conversions) conversions,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      platforms 
) 
GROUP BY
    date, site, platform, channel, url
  );

    
2018-06-16 11:11:26,498: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ef4550>]}
2018-06-16 11:11:26,836: 11:11:26 | 21 of 27 OK created table model agency_data_pipeline.agg_platforms_ga [OK in 2.33s]
2018-06-16 11:11:26,837: 11:11:26 | 22 of 27 START table model agency_data_pipeline.landing_page_by_month [RUN]
2018-06-16 11:11:26,838: Compiling model.agency_data_pipeline.landing_page_by_month
2018-06-16 11:11:26,838: 11:11:26 | 23 of 27 START table model agency_data_pipeline.platform_by_month.... [RUN]
2018-06-16 11:11:26,840: Compiling model.agency_data_pipeline.platform_by_month
2018-06-16 11:11:26,853: Writing injected SQL for node "model.agency_data_pipeline.platform_by_month"
2018-06-16 11:11:26,855: Writing injected SQL for node "model.agency_data_pipeline.landing_page_by_month"
2018-06-16 11:11:26,856: Acquiring new bigquery connection "landing_page_by_month".
2018-06-16 11:11:26,857: Re-using an available connection from the pool.
2018-06-16 11:11:26,860: Acquiring new bigquery connection "platform_by_month".
2018-06-16 11:11:26,860: Re-using an available connection from the pool.
2018-06-16 11:11:26,996: Writing runtime SQL for node "model.agency_data_pipeline.platform_by_month"
2018-06-16 11:11:27,023: Writing runtime SQL for node "model.agency_data_pipeline.landing_page_by_month"
2018-06-16 11:11:27,023: Fetching data for query platform_by_month:
create or replace table `agency_data_pipeline`.`platform_by_month`
  
  as (
    SELECT
yyyymm, 
site,
platform,
channel, 
cost,
impressions,
clicks,
conversions,
sessions,
sum(sessions) OVER w1 total_sessions,
goal_completions,
sum(goal_completions) OVER w1 total_goal_completions
FROM (
    SELECT 
    FORMAT_DATE("%Y-%m", date) AS yyyymm,
    site,
    platform,
    channel, 
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) conversions,
    sum(sessions) sessions,
    sum(goal_completions) goal_completions
    FROM `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_ga`
    GROUP BY yyyymm, site, channel, platform
)
WINDOW w1 as (PARTITION BY yyyymm, site)
  );

    
2018-06-16 11:11:27,024: Fetching data for query landing_page_by_month:
create or replace table `agency_data_pipeline`.`landing_page_by_month`
  
  as (
    SELECT
yyyymm, 
site,
platform,
channel, 
url,
cost,
impressions,
clicks,
conversions,
sessions,
sum(sessions) OVER w1 total_sessions,
goal_completions,
sum(goal_completions) OVER w1 total_goal_completions
FROM (
    SELECT 
    FORMAT_DATE("%Y-%m", date) AS yyyymm,
    site,
    platform,
    channel, 
    url,
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) conversions,
    sum(sessions) sessions,
    sum(goal_completions) goal_completions
    FROM `adp-apprenticeship`.`agency_data_pipeline`.`agg_platforms_ga`
    GROUP BY yyyymm, site, platform, channel, url
)
WINDOW w1 as (PARTITION BY yyyymm, site)
  );

    
2018-06-16 11:11:28,919: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e108d0>]}
2018-06-16 11:11:28,928: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e10d30>]}
2018-06-16 11:11:29,260: 11:11:29 | 23 of 27 OK created table model agency_data_pipeline.platform_by_month [OK in 2.08s]
2018-06-16 11:11:29,595: 11:11:29 | 22 of 27 OK created table model agency_data_pipeline.landing_page_by_month [OK in 2.09s]
2018-06-16 11:11:29,596: 11:11:29 | 24 of 27 START table model agency_data_pipeline.platform_index....... [RUN]
2018-06-16 11:11:29,597: 11:11:29 | 25 of 27 START table model agency_data_pipeline.landing_page_index... [RUN]
2018-06-16 11:11:29,597: Compiling model.agency_data_pipeline.platform_index
2018-06-16 11:11:29,597: Compiling model.agency_data_pipeline.landing_page_index
2018-06-16 11:11:29,608: Writing injected SQL for node "model.agency_data_pipeline.landing_page_index"
2018-06-16 11:11:29,611: Writing injected SQL for node "model.agency_data_pipeline.platform_index"
2018-06-16 11:11:29,612: Acquiring new bigquery connection "platform_index".
2018-06-16 11:11:29,614: Acquiring new bigquery connection "landing_page_index".
2018-06-16 11:11:29,614: Re-using an available connection from the pool.
2018-06-16 11:11:29,614: Re-using an available connection from the pool.
2018-06-16 11:11:29,732: Writing runtime SQL for node "model.agency_data_pipeline.platform_index"
2018-06-16 11:11:29,744: Writing runtime SQL for node "model.agency_data_pipeline.landing_page_index"
2018-06-16 11:11:29,744: Fetching data for query platform_index:
create or replace table `agency_data_pipeline`.`platform_index`
  
  as (
    SELECT 
yyyymm, 
site,
platform,
channel, 
cost,
impressions,
clicks,
conversions,
sessions,
pct_sessions,
goal_completions,
pct_goal_completions,
case when pct_sessions > 0 then pct_goal_completions / pct_sessions else null end as conversion_index
FROM (
    SELECT
    yyyymm, 
    site,
    platform,
    channel, 
    cost,
    impressions,
    clicks,
    conversions,
    sessions,
    case when total_sessions > 0 then sessions / total_sessions else null end as pct_sessions,
    goal_completions,
    case when total_goal_completions > 0 then goal_completions / total_goal_completions else null end as pct_goal_completions
    FROM `adp-apprenticeship`.`agency_data_pipeline`.`platform_by_month`
)
  );

    
2018-06-16 11:11:29,745: Fetching data for query landing_page_index:
create or replace table `agency_data_pipeline`.`landing_page_index`
  
  as (
    SELECT 
yyyymm, 
site,
platform,
channel, 
url,
cost,
impressions,
clicks,
conversions,
sessions,
pct_sessions,
goal_completions,
pct_goal_completions,
case when pct_sessions > 0 then pct_goal_completions / pct_sessions else null end as conversion_index
FROM (
    SELECT
    yyyymm, 
    site,
    platform,
    channel, 
    url,
    cost,
    impressions,
    clicks,
    conversions,
    sessions,
    case when total_sessions > 0 then sessions / total_sessions else null end as pct_sessions,
    goal_completions,
    case when total_goal_completions > 0 then goal_completions / total_goal_completions else null end as pct_goal_completions
    FROM `adp-apprenticeship`.`agency_data_pipeline`.`landing_page_by_month`
)
  );

    
2018-06-16 11:11:31,212: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109f31e48>]}
2018-06-16 11:11:31,551: 11:11:31 | 25 of 27 OK created table model agency_data_pipeline.landing_page_index [OK in 1.61s]
2018-06-16 11:11:31,559: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ef4550>]}
2018-06-16 11:11:31,894: 11:11:31 | 24 of 27 OK created table model agency_data_pipeline.platform_index.. [OK in 1.96s]
2018-06-16 11:11:31,895: 11:11:31 | 26 of 27 START table model agency_data_pipeline.landing_page_viz..... [RUN]
2018-06-16 11:11:31,895: 11:11:31 | 27 of 27 START table model agency_data_pipeline.platform_viz......... [RUN]
2018-06-16 11:11:31,895: Compiling model.agency_data_pipeline.landing_page_viz
2018-06-16 11:11:31,896: Compiling model.agency_data_pipeline.platform_viz
2018-06-16 11:11:31,906: Writing injected SQL for node "model.agency_data_pipeline.landing_page_viz"
2018-06-16 11:11:31,918: Writing injected SQL for node "model.agency_data_pipeline.platform_viz"
2018-06-16 11:11:31,920: Acquiring new bigquery connection "landing_page_viz".
2018-06-16 11:11:31,921: Re-using an available connection from the pool.
2018-06-16 11:11:31,923: Acquiring new bigquery connection "platform_viz".
2018-06-16 11:11:31,926: Re-using an available connection from the pool.
2018-06-16 11:11:32,063: Writing runtime SQL for node "model.agency_data_pipeline.platform_viz"
2018-06-16 11:11:32,070: Fetching data for query platform_viz:
create or replace table `agency_data_pipeline`.`platform_viz`
  
  as (
    SELECT 
yyyymm Month, 
site Site,
platform Platform,
channel Channel, 
ifnull(cost, 0) Cost,
ifnull(impressions, 0) Impressions,
ifnull(clicks, 0) Clicks,
ifnull(conversions, 0) Conversions,
ifnull(sessions, 0) Sessions,
ifnull(pct_sessions, 0) PctSessions,
ifnull(goal_completions, 0) GoalCompletions,
ifnull(pct_goal_completions, 0) PctGoalCompletions,
ifnull(conversion_index, 0) ConversionIndex
FROM `adp-apprenticeship`.`agency_data_pipeline`.`platform_index`
WHERE yyyymm >= '2017-06'
  );

    
2018-06-16 11:11:32,082: Writing runtime SQL for node "model.agency_data_pipeline.landing_page_viz"
2018-06-16 11:11:32,085: Fetching data for query landing_page_viz:
create or replace table `agency_data_pipeline`.`landing_page_viz`
  
  as (
    SELECT 
yyyymm Month, 
site Site,
platform Platform,
channel Channel, 
url URL,
ifnull(cost, 0) Cost,
ifnull(impressions, 0) Impressions,
ifnull(clicks, 0) Clicks,
ifnull(conversions, 0) Conversions,
ifnull(sessions, 0) Sessions,
ifnull(pct_sessions, 0) PctSessions,
ifnull(goal_completions, 0) GoalCompletions,
ifnull(pct_goal_completions, 0) PctGoalCompletions,
ifnull(conversion_index, 0) ConversionIndex
FROM `adp-apprenticeship`.`agency_data_pipeline`.`landing_page_index`
  );

    
2018-06-16 11:11:33,649: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106a9e320>]}
2018-06-16 11:11:33,795: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '557b125f-ff12-4d26-a21d-760a7310cfae', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109dac0f0>]}
2018-06-16 11:11:33,985: 11:11:33 | 27 of 27 OK created table model agency_data_pipeline.platform_viz.... [OK in 1.75s]
2018-06-16 11:11:34,337: 11:11:34 | 26 of 27 OK created table model agency_data_pipeline.landing_page_viz [OK in 1.90s]
2018-06-16 11:11:34,351: 11:11:34 | 
2018-06-16 11:11:34,351: 11:11:34 | Finished running 27 table models in 43.83s.
2018-06-16 11:11:34,351: Connection 'master' was left open.
2018-06-16 11:11:34,352: 
2018-06-16 11:11:34,352: Completed successfully
2018-06-16 11:11:34,352: 
Done. PASS=27 ERROR=0 SKIP=0 TOTAL=27
2018-06-16 11:11:34,352: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109cdb4a8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d9f780>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d9fa58>]}
2018-06-16 11:11:34,688: Flushing usage events
2018-06-16 11:11:34,756: sys:1: ResourceWarning: unclosed <socket.socket fd=12, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 56592), raddr=('172.217.2.10', 443)>

2018-06-16 11:11:34,757: sys:1: ResourceWarning: unclosed <socket.socket fd=11, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 56591), raddr=('172.217.12.13', 443)>

2018-06-16 11:11:34,758: sys:1: ResourceWarning: unclosed <socket.socket fd=18, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 56598), raddr=('172.217.3.10', 443)>

2018-06-16 11:11:34,758: sys:1: ResourceWarning: unclosed <socket.socket fd=17, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 56597), raddr=('172.217.3.10', 443)>

2018-06-16 11:11:34,759: sys:1: ResourceWarning: unclosed <socket.socket fd=19, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 56599), raddr=('172.217.3.10', 443)>

2018-06-16 11:11:34,760: sys:1: ResourceWarning: unclosed <socket.socket fd=15, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 56593), raddr=('172.217.12.13', 443)>

2018-06-16 11:11:34,760: sys:1: ResourceWarning: unclosed <socket.socket fd=16, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 56594), raddr=('172.217.12.13', 443)>

2018-06-16 11:11:34,761: sys:1: ResourceWarning: unclosed <socket.socket fd=20, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 56600), raddr=('172.217.3.10', 443)>

2018-06-16 11:11:34,761: sys:1: ResourceWarning: unclosed <socket.socket fd=13, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 56595), raddr=('172.217.12.13', 443)>

2018-06-16 11:11:34,762: sys:1: ResourceWarning: unclosed <socket.socket fd=14, family=AddressFamily.AF_INET, type=SocketKind.SOCK_STREAM, proto=6, laddr=('192.168.0.75', 56596), raddr=('172.217.12.13', 443)>

